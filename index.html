<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>Dashboard Carris</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" crossorigin="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');

    :root {
      color-scheme: light dark;
      --floating-width: clamp(210px, 23vw, 270px);
      --mobile-safe-top: max(12px, env(safe-area-inset-top, 0px));
      --mobile-safe-start: max(12px, env(safe-area-inset-left, 0px));
      --mobile-safe-end: max(12px, env(safe-area-inset-right, 0px));
      --mobile-action-diameter: 48px;
      --mobile-context-gap: 10px;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      overflow: hidden;
    }

    body {
      --bg-app: #f6f8fb;
      --sidebar-bg: rgba(255, 255, 255, 0.95);
      --sidebar-border: rgba(15, 23, 42, 0.08);
      --accent: #f59f00;
      --text-primary: #0f172a;
      --text-muted: rgba(15, 23, 42, 0.6);
      --glass: rgba(15, 23, 42, 0.08);
      --panel-bg: rgba(255, 255, 255, 0.95);
      --map-bg: #e5e8f0;
      --toggle-bg: rgba(15, 23, 42, 0.05);
      --toggle-color: #0f172a;
      --surface-1: rgba(255, 255, 255, 0.96);
      --surface-2: rgba(255, 255, 255, 0.9);
      --border-strong: rgba(15, 23, 42, 0.12);
      --shadow-strong: 0 24px 40px rgba(5, 10, 25, 0.12);
      --chart-axis-color: #0f172a;
      --chart-grid-color: rgba(15, 23, 42, 0.12);
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-app);
      color: var(--text-primary);
      display: flex;
      transition: background 0.3s ease;
    }

    body.theme-dark {
      --bg-app: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      --sidebar-bg: rgba(15, 23, 42, 0.92);
      --sidebar-border: rgba(255, 255, 255, 0.08);
      --text-primary: #f9fafb;
      --text-muted: rgba(248, 250, 252, 0.7);
      --glass: rgba(255, 255, 255, 0.12);
      --panel-bg: rgba(15, 23, 42, 0.85);
      --map-bg: #111827;
      --toggle-bg: rgba(255, 255, 255, 0.08);
      --toggle-color: #f9fafb;
      --surface-1: rgba(15, 23, 42, 0.9);
      --surface-2: rgba(15, 23, 42, 0.82);
      --border-strong: rgba(255, 255, 255, 0.12);
      --shadow-strong: 0 24px 50px rgba(0, 0, 0, 0.32);
      --chart-axis-color: #f9fafb;
      --chart-grid-color: rgba(255, 255, 255, 0.18);
    }

    @media (prefers-color-scheme: dark) {
      body.theme-auto {
        --bg-app: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
        --sidebar-bg: rgba(15, 23, 42, 0.92);
        --sidebar-border: rgba(255, 255, 255, 0.08);
        --text-primary: #f9fafb;
        --text-muted: rgba(248, 250, 252, 0.7);
        --glass: rgba(255, 255, 255, 0.12);
        --panel-bg: rgba(15, 23, 42, 0.85);
        --map-bg: #111827;
        --toggle-bg: rgba(255, 255, 255, 0.08);
        --toggle-color: #f9fafb;
        --surface-1: rgb(30, 41, 59);
        --surface-2: rgb(15, 23, 42);
        --border-strong: rgba(255, 255, 255, 0.12);
        --shadow-strong: 0 24px 50px rgba(0, 0, 0, 0.32);
        --chart-axis-color: #f9fafb;
        --chart-grid-color: rgba(255, 255, 255, 0.18);
      }
    }

    #app-shell {
      position: relative;
      width: 100%;
      min-height: 100vh;
      background: var(--map-bg);
      overflow: hidden;
    }

    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      min-width: 280px;
      max-width: 280px;
      padding: 24px 26px 30px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      box-shadow: 24px 0 48px rgba(3, 7, 18, 0.2);
      display: flex;
      flex-direction: column;
      gap: 22px;
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      z-index: 4500;
      transition: transform 0.25s ease, opacity 0.25s ease;
      backdrop-filter: blur(20px);
    }

    .sidebar-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

	    .sidebar-header > div {
	      padding-left: 56px;
	    }

    .sidebar-header h1 {
      font-size: 1.5rem;
      margin: 0;
    }
    .sidebar-footer {
      margin-top: auto;
      border-top: 1px solid var(--glass);
      padding-top: 16px;
      display: flex;
      justify-content: center;
    }
      .sidebar-author-link {
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.95rem;
        position: relative;
        padding-bottom: 4px;
        display: inline-flex;
        gap: 6px;
      }
      .sidebar-author-label {
        color: inherit;
      }
      .sidebar-author-handle {
        color: var(--accent);
      }
      .sidebar-author-link::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 2px;
        background: var(--accent);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.2s ease;
      }
    .sidebar-author-link:hover::after,
    .sidebar-author-link:focus-visible::after {
      transform: scaleX(1);
    }

    #sidebar-close,
    #sidebar-toggle {
      border: 1px solid var(--border-strong);
      border-radius: 50%;
      background: var(--surface-1);
      color: var(--text-primary);
      width: 45px;
      height: 45px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

	    #sidebar-close {
	      position: absolute;
	      top: 20px;
	      left: 25px;
		      z-index: 1601;
	    }

    #sidebar-close:hover,
    #sidebar-toggle:hover {
      transform: scale(1.08);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.32);
      opacity: 0.94;
    }

    #sidebar p {
      margin: 6px 0 0;
      font-size: 0.92rem;
      color: var(--text-muted);
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-section label {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }
    #variant-filter-group {
      margin-top: var(--variant-gap, 20px);
    }
    #variant-filter-group label {
      color: var(--text-muted);
    }

    .sidebar-section select,
    .sidebar-section input[type="text"] {
      border-radius: 12px;
      border: 1px solid var(--glass);
      padding: 12px 14px;
      font-size: 0.96rem;
      font-weight: 500;
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.95);
      appearance: none;
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    #route-filter {
      font-size: 16px;
      line-height: 1.35;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      font-weight: 500;
    }

    body.theme-dark .sidebar-section select,
    body.theme-dark .sidebar-section input[type="text"] {
      background: rgba(10, 15, 28, 0.8);
      color: #f8fafc;
    }
    @media (prefers-color-scheme: dark) {
      body.theme-auto .sidebar-section select,
      body.theme-auto .sidebar-section input[type="text"] {
        background: rgba(10, 15, 28, 0.8);
        color: #f8fafc;
      }
    }

    .sidebar-section select:focus,
    .sidebar-section input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(244, 159, 0, 0.3);
    }

    .sidebar-route-hint {
      margin-top: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .sidebar-route-hint.hidden {
      display: none;
    }

    .sidebar-note {
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.4;
      border-top: 1px solid var(--glass);
      padding-top: 16px;
    }

    .kpi-floating-context {
      --floating-base-top: 75px;
      --floating-base-left: 25px;
      --floating-scroll-offset: 0px;
      --floating-width: clamp(210px, 23vw, 270px);
      position: absolute;
      top: calc(var(--floating-base-top) + env(safe-area-inset-top, 0px) - var(--floating-scroll-offset));
      left: calc(var(--floating-base-left) + env(safe-area-inset-left, 0px));
      transform: none;
      padding: 5px 12px;
      border-radius: 16px;
      background: var(--surface-1);
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-strong);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      z-index: 4600;
      backdrop-filter: blur(12px);
      width: var(--floating-width);
      max-width: var(--floating-width);
      min-width: var(--floating-width);
      height: auto;
    }

    @media (min-width: 901px) {
      body.sidebar-collapsed .kpi-floating-context.kpi-floating-context--icon-only {
        top: calc(24px + 45px + 12px);
        left: 24px;
        width: 45px;
        min-width: 45px;
        max-width: 45px;
        height: 45px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      body.sidebar-collapsed .kpi-floating-context.kpi-floating-context--icon-only .kpi-floating-chip {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      body.sidebar-collapsed .kpi-floating-context.kpi-floating-context--icon-only #kpi-floating-text,
      body.sidebar-collapsed .kpi-floating-context.kpi-floating-context--icon-only .kpi-floating-clear {
        display: none;
      }
      body.sidebar-collapsed .kpi-floating-context.kpi-floating-context--icon-only .kpi-floating-icon {
        width: auto;
        height: auto;
        font-size: 1.2rem;
        background: transparent;
        box-shadow: none;
      }
    }

    .floating-search {
      display: none;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
      z-index: 10050;
      backdrop-filter: blur(10px);
    }
    .floating-search.visible {
      display: flex;
    }

    .floating-search--map {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      transform: none;
      width: 100%;
      max-width: none;
      min-width: 100%;
      background: var(--sidebar-bg);
      border: 1px solid var(--sidebar-border);
      box-shadow: 0 18px 36px rgba(5, 10, 25, 0.2);
      border-radius: 14px;
      padding: 12px 15px;
      height: auto !important;
      overflow: visible !important;
    }
    body.sidebar-collapsed .floating-search--map {
      width: clamp(240px, 20vw, 320px);
      min-width: clamp(240px, 20vw, 320px);
      max-width: clamp(240px, 20vw, 320px);
    }

    .floating-search--sidebar {
      position: fixed;
      top: var(--mobile-safe-top);
      left: var(--mobile-safe-start);
      right: var(--mobile-safe-end);
      width: auto;
      max-width: min(360px, 92vw);
      margin: 0 auto;
      background: var(--surface-1);
      border: 1px solid var(--sidebar-border);
      box-shadow: var(--shadow-strong);
      border-radius: 14px;
      padding: 12px 15px;
      height: auto !important;
      overflow: visible !important;
      pointer-events: auto;
      transform: none;
      z-index: 100060;
    }

    @media (max-width: 900px) {
      .floating-search--map {
        position: fixed !important;
        top: clamp(64px, 8vh, 110px) !important;
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        width: min(90vw, 420px) !important;
        max-width: 420px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        z-index: 100050 !important;
        max-height: 70vh;
      }

      .floating-search.visible {
        display: flex !important;
      }

      .floating-route-input {
        width: 100% !important;
        box-sizing: border-box;
      }

      .floating-route-preview {
        position: static !important;
        width: 100%;
        max-height: 260px;
        margin-top: 8px;
        z-index: 100100;
      }

    }
    .floating-route-input {
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid var(--border-strong);
      padding: 10px 12px;
      font-size: 16px;
      line-height: 1.4;
      font-weight: 600;
      color: var(--text-primary);
      background: var(--surface-1);
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body.theme-dark .floating-route-input {
      background: rgba(10, 15, 28, 0.82);
      color: #f8fafc;
    }
    .floating-route-preview {
      margin-top: 2px;
      max-height: 260px;
      overflow-y: auto;
      overflow-x: hidden;
      display: grid;
      gap: 1px;
      width: 100%;
      padding: 6px 0;
      box-sizing: border-box;
    }
    .floating-route-preview .preview-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0px;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-strong);
      background: var(--surface-2);
      cursor: pointer;
      transition: background 120ms ease, transform 120ms ease;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }
    .floating-route-preview .preview-item.preview-stop,
    .route-preview .preview-item.preview-stop {
      justify-content: flex-start;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .floating-route-preview .preview-item.preview-stop .preview-stop-icon,
    .route-preview .preview-item.preview-stop .preview-stop-icon {
      font-size: 1rem;
      width: 20px;
      text-align: center;
      color: var(--accent);
    }
    .floating-route-preview .preview-item.preview-stop .preview-stop-labels,
    .route-preview .preview-item.preview-stop .preview-stop-labels {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1 1 0;
      width: 100%;
    }
    .floating-route-preview .preview-stop-number,
    .route-preview .preview-stop-number {
      font-weight: 700;
      text-transform: none;
      white-space: nowrap;
    }
    .floating-route-preview .preview-stop-name,
    .route-preview .preview-stop-name {
      font-size: 0.8rem;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
      color: var(--text-primary);
      width: 100%;
      max-width: 100%;
    }
    .floating-route-preview .preview-stop-route-pills,
    .route-preview .preview-stop-route-pills {
      display: grid;
      grid-auto-flow: row;
      grid-template-columns: repeat(3, minmax(24px, max-content));
      grid-auto-columns: minmax(24px, max-content);
      grid-template-rows: repeat(2, minmax(20px, max-content));
      grid-auto-rows: minmax(20px, max-content);
      gap: 2px;
      width: auto;
      justify-content: flex-end;
      justify-items: flex-end;
      align-items: flex-start;
      align-content: flex-start;
      flex: 0 0 auto;
      white-space: normal;
      max-width: min(45%, 220px);
      margin-left: auto;
      direction: rtl;
    }
    .floating-route-preview .preview-stop-route-pills.preview-stop-route-pills--three-lines,
    .route-preview .preview-stop-route-pills.preview-stop-route-pills--three-lines {
      grid-template-rows: repeat(3, minmax(20px, max-content));
    }
    .floating-route-preview .preview-stop-route-pills.preview-stop-route-pills--two-lines,
    .route-preview .preview-stop-route-pills.preview-stop-route-pills--two-lines {
      grid-template-columns: repeat(2, minmax(24px, max-content));
      grid-template-rows: repeat(2, minmax(20px, max-content));
    }
    .floating-route-preview .preview-stop-route-pill,
    .route-preview .preview-stop-route-pill {
      font-size: 0.65rem;
      text-transform: none;
      letter-spacing: 0.01em;
      padding: 1px 4px;
      border-radius: 4px;
      border: 1px solid var(--pill-border, transparent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      background: var(--pill-bg, var(--accent));
      color: var(--pill-fg, #fff);
      font-weight: 700;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      min-width: 24px;
      text-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.3);
      direction: ltr;
    }
    .floating-route-preview .preview-stop-route-pills.preview-stop-route-pills--bigger .preview-stop-route-pill,
    .route-preview .preview-stop-route-pills.preview-stop-route-pills--bigger .preview-stop-route-pill {
      font-size: 0.8rem;
      padding: 3px 7px;
      min-width: 36px;
    }
    .floating-route-preview .preview-stop-route-pills.preview-stop-route-pills--single .preview-stop-route-pill,
    .route-preview .preview-stop-route-pills.preview-stop-route-pills--single .preview-stop-route-pill {
      font-size: 0.9rem;
      padding: 4px 10px;
      min-width: 46px;
      border-radius: 6px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35);
    }
    .floating-route-preview .preview-item:hover { background: rgba(255, 255, 255, 0.14); transform: translateY(-1px); }
    .floating-route-preview .preview-item.preview-stop.preview-stop-live {
      border-color: rgba(16, 185, 129, 0.55);
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.35), 0 0 18px rgba(16, 185, 129, 0.25);
      animation: preview-live-glow 2.4s ease-in-out infinite alternate;
      overflow: visible;
    }
    @keyframes preview-live-glow {
      from {
        box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.3), 0 0 12px rgba(16, 185, 129, 0.2);
      }
      to {
        box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.6), 0 0 20px rgba(16, 185, 129, 0.3);
      }
    }
    .floating-route-preview .preview-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.85rem;
      white-space: normal;
      word-break: break-word;
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 2px;
    }
    .floating-route-preview .preview-label .route-pill {
      flex: 0 0 auto;
    }
    .floating-route-preview .preview-item .preview-meta {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-left: auto;
      white-space: nowrap;
    }
    .floating-route-preview .preview-item.preview-category .preview-meta {
      color: var(--accent);
    }
    body.theme-dark .floating-route-preview .preview-item {
      border-color: rgba(255, 255, 255, 0.12);
      background: rgba(15, 23, 42, 0.7);
    }
    body.theme-dark .floating-route-preview .preview-item:hover { background: rgba(255, 255, 255, 0.06); }
    @media (prefers-color-scheme: dark) {
      body.theme-auto .floating-route-input {
        background: rgba(10, 15, 28, 0.82);
        color: #f8fafc;
      }
      body.theme-auto .floating-search {
        background: var(--sidebar-bg);
      }
      body.theme-auto .floating-search .floating-route-input {
        background: var(--surface-1);
      }
    }
    @media (min-width: 901px) {
      .floating-search.visible {
        display: none !important;
      }
      body.floating-search-open .floating-search.visible {
        display: flex !important;
      }
    }
    body.theme-dark .floating-search {
      background: var(--sidebar-bg);
    }
    body.theme-dark .floating-search .floating-route-input {
      background: var(--surface-1);
    }
    @media (max-width: 1200px) {
      .kpi-panel {
        width: clamp(220px, 42vw, 360px);
        padding: 10px;
        border-radius: 14px;
      }
      .kpi-panel .kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 3px;
      }
      .kpi-card {
        padding: 2px 4px;
        min-height: 44px;
      }
      .kpi-card strong {
        font-size: 1.05rem;
      }
      .kpi-panel-trigger {
        height: 26px;
      }
    }

    @media (max-width: 900px) {
      .kpi-floating-context {
        top: calc(12px + env(safe-area-inset-top));
        left: calc(12px + 45px + 12px + env(safe-area-inset-left));
        right: calc(12px + env(safe-area-inset-right));
        width: auto;
        max-width: min(var(--floating-width), 98vw, 560px);
        padding: 10px 14px;
      }
      .kpi-floating-chip {
        width: 100%;
        gap: 12px;
      }
      #kpi-floating-text { flex: 1; text-align: left; }
      #kpi-panel {
        background: var(--surface-1);
        border: 1px solid var(--border-strong);
        box-shadow: var(--shadow-strong);
        padding: 8px;
        width: min(300px, calc(100% - 16px));
        max-width: 300px;
        margin: 0 auto;
      }
      #kpi-panel .kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 4px;
      }
      #kpi-panel .kpi-card {
        background: var(--surface-2);
        border: 1px solid var(--border-strong);
        align-items: center;
        padding: 5px;
        min-height: 50px;
      }
      #kpi-panel .kpi-card strong {
        font-size: 1.08rem;
      }
      #kpi-panel .kpi-card .kpi-meta {
        font-size: 0.6rem;
      }
      #kpi-panel .kpi-value {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    @media (max-width: 640px) {
      #kpi-panel {
      width: min(280px, calc(100% - 16px));
      }
      #kpi-panel .kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 4px;
      }
      #kpi-extra-row {
        grid-template-columns: repeat(2, minmax(120px, 1fr));
      }
      #kpi-extra-row.kpi-extra-row--three .kpi-card:nth-child(1) {
        grid-column: 1 / -1;
      }
    }

    .kpi-floating-chip {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: flex-start;
      gap: 8px;
      min-width: 0;
      border: none;
      background: transparent;
      color: inherit;
      font: inherit;
      padding: 4px 0;
      cursor: pointer;
      width: 100%;
    }
    .kpi-floating-chip:focus-visible { outline: 2px solid var(--accent); outline-offset: 3px; }
    .kpi-floating-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.04);
      color: inherit;
      font-size: 0.85rem;
      justify-self: start;
    }
    body.theme-dark .kpi-floating-icon,
    body.theme-auto .kpi-floating-icon {
      background: rgba(255, 255, 255, 0.08);
    }
    #kpi-floating-text {
      min-width: 0;
      flex: 1 1 120px;
      max-width: 100%;
      line-height: 1.6;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-word;
      max-height: calc(1.6em * 5);
      transition: color 120ms ease;
      align-self: flex-start;
    }
    #kpi-floating-text.kpi-floating-text--placeholder {
      color: var(--text-muted);
      font-size: 0.85rem;
      white-space: nowrap;
      max-height: calc(1.6em * 3);
      text-transform: none;
    }
    .kpi-floating-clear {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(15, 23, 42, 0.04);
      color: inherit;
      font-weight: 800;
      line-height: 1;
      padding: 0;
      appearance: none;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease, opacity 120ms ease;
      justify-self: end;
    }
    .kpi-floating-clear:hover { background: rgba(15, 23, 42, 0.12); transform: translateY(-1px); }
    .kpi-floating-clear:active { transform: translateY(0); }
    body.theme-dark .kpi-floating-clear,
    body.theme-auto .kpi-floating-clear {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.18);
    }

    .kpi-panel {
      position: absolute;
      top: clamp(8px, 2vh, 22px);
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      width: clamp(220px, 36vw, 400px);
      background: var(--surface-1);
      border-radius: 12px;
      border: 1px solid var(--border-strong);
      padding: 10px;
      box-shadow: var(--shadow-strong);
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 1002;
      overflow: visible;
    }
    .kpi-panel.kpi-panel--loading .kpi-card,
    .kpi-panel.kpi-panel--loading .kpi-panel-trigger {
      opacity: 0.6;
      transition: opacity 0.25s ease;
    }
    .kpi-panel::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid var(--surface-1);
      width: 0;
      z-index: 1001;
    }
    .kpi-panel.kpi-panel--expanded::after {
      display: none;
    }

    .kpi-panel {
      position: absolute;
      top: clamp(8px, 2vh, 22px);
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      width: clamp(200px, 34vw, 380px);
      background: var(--surface-1);
      border-radius: 12px;
      border: 1px solid var(--border-strong);
      padding: 8px;
      box-shadow: var(--shadow-strong);
      display: flex;
      flex-direction: column;
      gap: 3px;
      z-index: 1002;
      overflow: visible;
    }

    .kpi-panel-trigger {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 3px;
      width: 86%;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 999px;
      pointer-events: auto;
      user-select: none;
    }

    .kpi-panel-trigger::before,
    .kpi-panel-trigger::after {
      content: "";
      position: absolute;
      height: 3px;
      top: 92%;
      transform: translateY(-50%) scaleX(0.75);
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.35);
      opacity: 0.55;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    .kpi-panel-trigger::before {
      left: 6%;
      width: 40%;
    }
    .kpi-panel-trigger::after {
      right: 6%;
      width: 40%;
    }
    .kpi-panel--expanded .kpi-panel-trigger::before,
    .kpi-panel--expanded .kpi-panel-trigger::after {
      transform: translateY(-50%) scaleX(0.95);
      opacity: 0;
    }
    .kpi-panel-trigger:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
    }

    .kpi-panel-trigger-icon {
      font-size: 1.5rem;
      color: var(--text-muted);
      transition: transform 0.2s ease;
      margin-top: 10px;
      position: relative;
      z-index: 2;
    }
    .kpi-panel--expanded .kpi-panel-trigger-icon {
      margin-top: 12px;
    }

    .kpi-extra-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap: 10px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.35s ease;
    }
    .kpi-extra-row.kpi-extra-row--two {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .kpi-panel--expanded .kpi-extra-row {
      max-height: 180px;
    }

    @media (max-width: 900px) {
      .kpi-extra-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 640px) {
      .kpi-extra-row.kpi-extra-row--three .kpi-card:nth-child(1) {
        grid-column: 1 / -1;
      }
    }

    .kpi-card--extra {
      padding: 10px 12px;
    }

    .kpi-panel .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 2px;
      justify-items: stretch;
    }

    .kpi-card {
      background: var(--surface-2);
      border-radius: 10px;
      padding: 1px 2px;
      min-height: 36px;
      display: flex;
      flex-direction: column;
      gap: 0;
      border: 1px solid rgba(15, 23, 42, 0.05);
      align-items: center;
      text-align: center;
      justify-content: center;
    }

	    .kpi-card strong {
	      font-size: 1.25rem;
	      line-height: 1.1;
	      width: 100%;
	    }
	    .kpi-card .kpi-value {
	      font-weight: 800;
	      font-variant-numeric: tabular-nums;
	    }
    .kpi-card .kpi-speed {
      display: inline-flex;
      justify-content: center;
      align-items: baseline;
      gap: 4px;
      white-space: nowrap;
    }
    .kpi-card .kpi-speed.has-unit::after {
      content: "km/h";
      font-size: 0.72em;
      font-weight: 700;
      color: var(--text-muted);
      opacity: 0.75;
    }
    .kpi-card .kpi-value[data-unit]:not(.kpi-speed)::after {
      content: attr(data-unit);
      font-size: 0.72em;
      font-weight: 700;
      color: var(--text-muted);
      opacity: 0.75;
      margin-left: 0.25rem;
    }
    body.theme-dark .chart-card-header span {
      color: #f9fafb;
    }
    body.theme-dark .chart-card .chart-card-help {
      color: #f9fafb;
    }
    .kpi-card .kpi-label,
    .kpi-card .kpi-delta,
    .kpi-card .kpi-meta {
      width: 100%;
    }
    .kpi-card .kpi-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

	    .kpi-delta {
	      font-size: 0.9rem;
	      letter-spacing: 0;
	      text-transform: none;
	      font-weight: 700;
	      color: var(--text-muted);
	    }
    .kpi-delta.positive {
      color: #10b981;
    }
    .kpi-delta.negative {
      color: #ef4444;
    }
    .kpi-delta.zero {
      color: var(--text-muted);
    }

	    .kpi-label {
	      font-size: 0.7rem;
	      text-transform: lowercase;
	      letter-spacing: 0.02em;
	      color: var(--text-muted);
	    }

    .kpi-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    body.theme-dark .kpi-panel {
      background: rgba(15, 23, 42, 0.88);
    }

    .kpi-card.kpi-card--hidden {
      display: none;
    }

    body.theme-dark .kpi-card {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .charts-section {
      margin-top: 16px;
      position: relative;
      border-top: 1px solid rgba(15, 23, 42, 0.1);
      padding-top: 14px;
    }
    #variant-filter-group.hidden + .charts-section {
      margin-top: calc(var(--variant-gap, 24px) + 4px);
    }
    .charts-section__header {
      margin-bottom: 12px;
      position: relative;
    }
    .charts-section__title {
      margin: 0;
    }
    .sr-only {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    #chart-section-toggle {
      border: 1px solid var(--border-strong);
      background: var(--surface-1);
      color: var(--text-primary);
      border-radius: 999px;
      padding: 10px 16px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      font-size: 1rem;
      text-transform: none;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    body.theme-dark #chart-section-toggle {
      background: var(--surface-2);
      color: var(--text-primary);
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
    }
    #chart-section-toggle:hover {
      transform: translateY(-1px);
      border-color: rgba(15, 23, 42, 0.3);
    }
    .chart-toggle-label {
      margin-right: 8px;
    }
    .chart-toggle-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: transform 0.25s ease;
    }
    #chart-section-toggle[aria-expanded="false"] .chart-toggle-arrow {
      transform: rotate(180deg);
    }
    .charts-section h2 {
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    .chart-grid-wrapper {
      overflow: hidden;
      max-height: 1000px;
      transition: max-height 0.4s ease, opacity 0.4s ease;
    }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      width: var(--floating-width);
      max-width: var(--floating-width);
      min-width: var(--floating-width);
      margin: 0 auto;
      transition: opacity 0.4s ease;
    }
    .chart-card {
      border-radius: 12px;
      border: 1px solid var(--border-strong);
      background: var(--surface-1);
      padding: 12px;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      max-width: 100%;
      min-height: 180px;
    }
    .chart-card:hover {
      box-shadow: var(--shadow-strong);
      transform: translateY(-2px);
    }
    .chart-card-header {
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    body.theme-dark .chart-card {
      background: rgba(15, 23, 42, 0.82);
      border-color: rgba(255, 255, 255, 0.12);
    }
    body.theme-dark .chart-card-header {
      color: #f9fafb;
    }
    @media (prefers-color-scheme: dark) {
      body.theme-auto .chart-card {
        background: rgba(15, 23, 42, 0.82);
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-auto .chart-card-header {
        color: #f9fafb;
      }
      body.theme-auto .chart-card-header span {
        color: #f9fafb;
      }
      body.theme-auto .chart-card .chart-card-help {
        color: #f9fafb;
      }
    }
    .chart-card canvas {
      width: 100% !important;
      height: 104px !important;
      display: block;
    }
    .charts-section--collapsed .chart-grid {
      opacity: 0;
    }
    .charts-section--collapsed .chart-grid-wrapper {
      max-height: 0;
      opacity: 0;
      pointer-events: none;
    }
	    .chart-card-help {
	      font-size: 1.05rem;
	      font-weight: 700;
	      letter-spacing: 0;
	      text-transform: none;
	      color: var(--text-muted);
	      align-self: flex-end;
	      line-height: 1;
	    }
    .chart-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 5500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .chart-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .chart-overlay-content {
      --overlay-tint: #f59f00;
      --overlay-tint-soft: rgba(245, 159, 0, 0.12);
      --overlay-tint-ultra: rgba(15, 23, 42, 0.02);
      background: var(--surface-1);
      border-radius: 18px;
      padding: 28px;
      width: min(1040px, 96vw);
      max-width: 1040px;
      max-height: 92vh;
      overflow: auto;
      box-shadow: var(--shadow-strong);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .chart-overlay h3 {
      margin: 0;
      margin-bottom: 16px;
      font-size: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chart-overlay-title-main { font-size: 1.2rem; line-height: 1.2; }
    .chart-overlay-context {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chart-overlay-body {
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-height: 0;
    }
    .chart-overlay-visual {
      background: radial-gradient(120% 120% at 20% 18%, var(--overlay-tint-soft), var(--overlay-tint-ultra));
      border: 1px solid var(--border-strong);
      border-radius: 16px;
      padding: 12px 12px 10px;
      box-shadow: var(--shadow-strong);
    }
    .chart-overlay canvas {
      width: 100%;
      max-width: none;
      height: clamp(300px, 42vh, 400px) !important;
      min-height: 300px;
      flex: 0 0 auto;
      display: block;
      margin: 0 auto;
    }
    @media (min-height: 900px) {
      .chart-overlay canvas {
        height: clamp(320px, 46vh, 460px) !important;
        min-height: 320px;
      }
    }
    .chart-overlay-content.volume-layout {
      gap: 18px;
    }
    .chart-overlay-content.volume-layout .chart-overlay-body {
      display: grid;
      grid-template-columns: minmax(380px, 1.15fr) minmax(320px, 1fr);
      align-items: stretch;
      gap: 18px;
      min-height: 0;
    }
    .overlay-tabs {
      display: none;
      gap: 8px;
      align-items: center;
    }
    .overlay-tab {
      border: 1px solid var(--border-strong);
      background: var(--surface-2);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1 1 0;
      text-align: center;
    }
    .overlay-tab.active {
      background: var(--overlay-tab-active-bg, rgba(245, 159, 0, 0.16));
      border-color: var(--overlay-tab-border, rgba(245, 159, 0, 0.4));
      color: var(--overlay-tab-fg, #8d5a00);
      box-shadow: inset 0 0 0 1px var(--overlay-tab-border, rgba(245, 159, 0, 0.3));
    }
    .chart-overlay-content.volume-layout .chart-overlay-visual {
      height: 100%;
      background: radial-gradient(120% 120% at 18% 16%, var(--overlay-tint-soft), var(--overlay-tint-ultra));
      border-color: rgba(245, 159, 0, 0.26);
    }
    .chart-overlay-content.volume-layout.volume-tight .chart-overlay-body {
      display: flex;
      flex-direction: column;
    }
    .chart-overlay-extra {
      margin-top: 4px;
      max-height: 40vh;
      overflow: auto;
      border: 1px solid var(--border-strong);
      border-radius: 12px;
      padding: 10px 10px 8px;
      background: var(--surface-1);
    }
    .chart-overlay-content.volume-layout .chart-overlay-extra {
      margin: 0;
      max-height: none;
      height: 100%;
      box-shadow: var(--shadow-strong);
      border-radius: 16px;
      background: linear-gradient(160deg, var(--overlay-tint-soft), transparent 46%),
        var(--surface-1);
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px;
    }
    .chart-overlay-content.volume-layout.volume-tight .chart-overlay-extra {
      height: auto;
      max-height: 38vh;
    }
    .chart-overlay-content.volume-layout.mobile-tabs {
      gap: 12px;
    }
    .chart-overlay-content.volume-layout.mobile-tabs .overlay-tabs {
      display: flex;
    }
    .chart-overlay-content.volume-layout.mobile-tabs .chart-overlay-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chart-overlay-content.volume-layout.mobile-tabs .chart-overlay-visual,
    .chart-overlay-content.volume-layout.mobile-tabs .chart-overlay-extra {
      display: none;
    }
    .chart-overlay-content.volume-layout.mobile-tabs.show-chart .chart-overlay-visual {
      display: block;
    }
    .chart-overlay-content.volume-layout.mobile-tabs.show-chart .chart-overlay-extra {
      display: none;
    }
    .chart-overlay-content.volume-layout.mobile-tabs.show-table .chart-overlay-visual {
      display: none;
    }
    .chart-overlay-content.volume-layout.mobile-tabs.show-table .chart-overlay-extra {
      display: flex;
      max-height: calc(70vh - 40px);
    }
    .overlay-extra-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .chart-overlay-content.volume-layout .overlay-extra-heading {
      position: sticky;
      top: 0;
      padding-bottom: 6px;
      background: var(--surface-1);
      z-index: 2;
    }
    .overlay-pill {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--text-primary);
      background: var(--overlay-pill-bg, rgba(245, 159, 0, 0.16));
      border: 1px solid var(--overlay-pill-border, rgba(245, 159, 0, 0.35));
    }
    .overlay-subtitle { margin: 0; font-size: 1rem; }
    .overlay-table-wrapper {
      overflow: auto;
      border: 1px solid var(--border-strong);
      border-radius: 10px;
      background: var(--surface-1);
      max-height: 260px;
    }
    .chart-overlay-content.volume-layout .overlay-table-wrapper {
      max-height: none;
      flex: 1;
      min-height: 0;
      border: none;
      background: transparent;
    }
    .chart-overlay-content.volume-layout.volume-tight .overlay-extra-heading {
      position: static;
      padding-bottom: 4px;
    }
    .overlay-table { width: 100%; border-collapse: collapse; font-size: 0.92rem; }
    .overlay-table th, .overlay-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border-strong); }
    .overlay-table th { background: var(--surface-2); position: sticky; top: 0; z-index: 1; }
    .overlay-table tr:last-child td { border-bottom: none; }
    .overlay-empty { text-align: center; color: var(--text-muted); font-style: italic; }
    .overlay-status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .overlay-status-dot.active { background: #2ecc71; box-shadow: 0 0 8px rgba(46, 204, 113, 0.6); }
    .overlay-status-dot.inactive { background: #e74c3c; box-shadow: 0 0 8px rgba(231, 76, 60, 0.6); }
    .overlay-sort {
      border: none;
      background: none;
      padding: 0;
      margin: 0;
      font: inherit;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: inherit;
      justify-content: flex-start;
      width: 100%;
      text-align: left;
    }
    .overlay-sort .sort-icon {
      font-size: 0.8rem;
      opacity: 0.55;
    }
    .overlay-sort.active .sort-icon {
      opacity: 1;
    }
    .overlay-sort:focus-visible {
      outline: 2px solid var(--overlay-tint, var(--accent));
      outline-offset: 3px;
      border-radius: 6px;
    }
    @media (max-width: 1024px) {
      .chart-overlay-content {
        max-height: 90vh;
      }
      .chart-overlay-content.volume-layout .chart-overlay-body {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .chart-overlay-content {
        width: 100vw;
        max-width: 100vw;
        padding: 16px;
        border-radius: 14px;
      }
      .chart-overlay-visual {
        margin-inline: -2px;
      }
      .chart-overlay canvas {
        height: clamp(280px, 50vh, 380px) !important;
        min-height: 260px;
      }
    }
    .chart-overlay-close {
      position: absolute;
      top: 12px;
      right: 12px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      color: var(--text-primary);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
    }

    #map-container {
      position: relative;
      height: 100vh;
      width: 100%;
      background: var(--map-bg);
      overflow: hidden;
    }

    #map {
      position: absolute;
      inset: 0;
      height: 100%;
      width: 100%;
      background: var(--map-bg);
    }

    .user-location-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: var(--surface-1);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      z-index: 4500;
    }
    .user-location-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.26);
    }
    .user-location-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 3px;
    }
    .user-location-btn .fa {
      font-size: 1.2rem;
      color: var(--text-primary);
      transition: transform 0.3s ease;
    }
    .user-location-btn.is-active .fa {
      color: var(--accent);
    }
    .user-location-btn.is-loading {
      opacity: 0.9;
    }
    .user-location-btn.is-loading .fa {
      animation: location-spin 1.2s linear infinite;
    }
    @keyframes location-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .app-alert {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 16px;
      border-radius: 10px;
      background: var(--surface-1);
      color: var(--text-primary);
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-strong);
      z-index: 2300;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      max-width: min(92vw, 680px);
      text-align: center;
    }

    .app-alert.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
      transition: background 0.3s;
      flex: 0 0 auto;
    }

    .status-dot.online { background: #2ecc71; box-shadow: 0 0 8px rgba(46, 204, 113, 0.8); }
    .status-dot.fetching { background: #f1c40f; animation: pulse 1s infinite; }
    .status-dot.offline { background: #e74c3c; box-shadow: 0 0 8px rgba(231, 76, 60, 0.7); }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.45; } 100% { opacity: 1; } }

    .kpi-active-value {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    /* Estilos do Popup */
    .custom-popup .leaflet-popup-content-wrapper {
      background: transparent;
      padding: 0;
      overflow: hidden;
      border-radius: 6px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3); /* Add a stronger shadow */
    }
    .custom-popup .leaflet-popup-tip {
      background: var(--surface-2); /* Matches the popup body color */
    }
    .custom-popup .leaflet-popup-content { margin: 0; min-width: 320px; max-width: min(720px, 96vw); width: min(720px, 96vw); }
    
    .pop-header { 
      padding: 10px 12px; 
      font-weight: bold; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      gap: 10px;
      background: var(--surface-1);
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-strong);
      position: relative;
      padding-right: 60px;
    }
    .pop-header__left { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .pop-title { font-size: 0.96rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pop-header__actions { display: inline-flex; align-items: center; gap: 8px; }
    .pop-body {
      padding: 12px;
      font-size: 13px;
      line-height: 1.5;
      background: var(--surface-2);
      color: var(--text-primary);
    }
    .pop-body__info {
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* MapLibre popup parity */
    .custom-popup .maplibregl-popup-content {
      background: transparent;
      padding: 0;
      margin: 0;
      min-width: 320px;
      width: fit-content;
      max-width: min(460px, 96vw);
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 3px 14px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    .custom-popup .maplibregl-popup-tip { display: none; }

    /* Stop popup pills */
    .stop-popup {
      padding: 12px 12px 14px;
      background: var(--surface-1);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      --stop-popup-pill-count: 6;
      --stop-popup-pill-gap: 6px;
      --stop-popup-pill-base: 52px;
      --stop-popup-inner-padding: 20px;
      --stop-popup-width-target: calc(
        var(--stop-popup-pill-count) * var(--stop-popup-pill-base) +
        (var(--stop-popup-pill-count) - 1) * var(--stop-popup-pill-gap) +
        var(--stop-popup-inner-padding)
      );
      width: clamp(320px, var(--stop-popup-width-target), min(460px, 96vw));
      min-width: 320px;
      max-width: min(460px, 96vw);
      box-sizing: border-box;
    }
    .stop-popup__title {
      font-weight: 800;
      font-size: 0.98rem;
      color: #0f172a;
      line-height: 1.15;
    }
    .stop-popup__meta {
      margin-top: 2px;
      font-size: 0.78rem;
      color: rgba(15, 23, 42, 0.6);
      font-variant-numeric: tabular-nums;
    }
    .stop-popup__section {
      margin-top: 10px;
      font-size: 0.72rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: rgba(15, 23, 42, 0.6);
      text-transform: uppercase;
    }
    .pill-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: var(--stop-popup-pill-gap, 6px);
    }
    .stop-schedule {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .stop-schedule__row {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-start;
      padding: 2px 4px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid var(--glass);
      font-size: 0.74rem;
      font-weight: 700;
      color: var(--text-primary);
      width: 100%;
      min-width: 0;
      line-height: 1.1;
      box-sizing: border-box;
    }
    .stop-schedule__info {
      display: flex;
      align-items: center;
      gap: 3px;
      flex-wrap: wrap;
      flex: 1 1 auto;
      min-width: 0;
      max-width: calc(100% - 56px);
    }
    @media (min-width: 900px) {
      .stop-popup {
        width: clamp(340px, var(--stop-popup-width-target), 460px);
        max-width: 460px;
      }
      .stop-schedule__info {
        max-width: calc(100% - 64px);
      }
    }
    .stop-schedule__list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 2px;
      width: 100%;
      box-sizing: border-box;
    }
    .stop-schedule__time {
      font-variant-numeric: tabular-nums;
      min-width: 44px;
      margin-left: auto;
      text-align: right;
      padding-right: 0;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .stop-schedule__eta {
      font-size: 0.76rem;
      color: var(--text-muted);
      font-weight: 600;
    }
    .pill--tiny {
      padding: 1px 3px;
      font-size: 0.68rem;
      border-radius: 999px;
      line-height: 1;
      letter-spacing: -0.03em;
    }
    .route-pill--active {
      box-shadow: 0 0 0 2px rgba(245, 159, 0, 0.3);
      border-color: var(--accent);
    }
    .stop-schedule__meta {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      flex-wrap: wrap;
    }
    .stop-schedule__dir {
      font-size: 0.76rem;
      color: var(--text-muted);
      font-weight: 600;
      flex: 1 1 auto;
      min-width: 0;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .stop-schedule__empty,
    .stop-schedule__loading {
      font-size: 0.86rem;
      color: var(--text-muted);
      padding: 6px 2px;
    }
    /* This rule was moved into the media query below to fix a theme bug */
    .mobile-stop-card {
      position: absolute;
      left: 12px;
      right: 12px;
      top: 28px;
      z-index: 1600;
      background: var(--surface-1);
      border: 1px solid var(--border-strong);
      border-radius: 16px;
      box-shadow: var(--shadow-strong);
      padding: 12px 14px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .mobile-stop-card.visible { display: flex; }
    .mobile-stop-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .mobile-stop-card__title {
      font-weight: 800;
      font-size: 1rem;
      line-height: 1.2;
    }
    .mobile-stop-card__meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }
    .mobile-stop-card__pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .mobile-stop-card__close {
      border: 1px solid var(--border-strong);
      background: var(--surface-2);
      color: var(--text-primary);
      width: 32px;
      height: 32px;
      border-radius: 10px;
      font-size: 0.96rem;
      cursor: pointer;
      box-shadow: var(--shadow-strong);
    }
    body.mobile-stop-open .kpi-panel {
      display: none !important;
    }

    @media (max-width: 900px) {
      body:not(.sidebar-collapsed) .maplibregl-popup,
      body:not(.sidebar-collapsed) .leaflet-popup,
      body:not(.sidebar-collapsed) .custom-popup,
      body:not(.sidebar-collapsed) .mobile-stop-card {
        display: none !important;
      }
    }
    @media (max-width: 900px) {
      .mobile-stop-card {
        top: 60px;
        bottom: auto;
      }
    }
    @media (max-width: 900px) {
      body.floating-search-open .kpi-floating-context {
        display: flex !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
    }
    .route-preview {
      position: absolute;
      display: grid;
      gap: 6px;
      max-height: 240px;
      overflow-y: auto;
      padding: 8px 10px;
      background: var(--surface-1);
      border-radius: 12px;
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-strong);
      z-index: 2200;
      top: calc(100% + 8px);
      left: 0;
      width: 100%;
      box-sizing: border-box;
    }
    .route-preview.hidden { display: none; }
    .route-preview .preview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-strong);
      background: var(--surface-2);
      cursor: pointer;
      transition: background 120ms ease, transform 120ms ease;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }
    .route-preview .preview-item:hover { background: rgba(255, 255, 255, 0.12); transform: translateY(-1px); }
    .route-preview .preview-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    body.theme-dark .route-preview .preview-item {
      border-color: rgba(255, 255, 255, 0.12);
      background: rgba(15, 23, 42, 0.7);
    }
    body.theme-dark .route-preview .preview-item:hover { background: rgba(255, 255, 255, 0.06); }
    .route-input-wrapper { position: relative; width: 100%; overflow: visible; }
    .route-input-wrapper input {
      width: 100%;
      box-sizing: border-box;
      min-height: 42px;
    }
    /* Ensure sidebar overlays tooltips/popups from the map */
    .leaflet-pane.leaflet-tooltip-pane { z-index: 900 !important; }
    .maplibregl-popup {
      z-index: 900 !important;
      width: auto !important;
    }
    .route-selected-pill {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--surface-1);
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-strong);
      cursor: text;
      z-index: 1501;
    }
    .route-selected-pill.hidden { display: none; }
    .route-input-wrapper.pill-visible input {
      opacity: 0;
      pointer-events: none;
    }
    .route-input-wrapper.input-focused .route-selected-pill { display: none; }
    .route-selected-pill #route-selected-text {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
      font-weight: 800;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .route-clear {
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 1rem;
      padding: 4px 6px;
      cursor: pointer;
      border-radius: 8px;
      flex-shrink: 0;
      transition: background 120ms ease, transform 120ms ease;
    }
    .route-clear:hover { background: rgba(15, 23, 42, 0.08); transform: translateY(-1px); }
    .route-clear:active { transform: translateY(0px); }
    body.theme-dark .route-clear { color: #f8fafc; }
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      line-height: 1.15;
      font-weight: 800;
      letter-spacing: 0.01em;
      border: 1px solid var(--pill-border, rgba(15, 23, 42, 0.12));
      color: var(--pill-fg, #0b1220);
      background: var(--pill-bg, #e2e8f0);
      white-space: nowrap;
    }
    .pill.pill--clickable {
      cursor: pointer;
      user-select: none;
    }
    .pill--loading {
      background: rgba(148, 163, 184, 0.22);
      border-color: rgba(148, 163, 184, 0.3);
      color: rgba(15, 23, 42, 0.55);
      box-shadow: none;
    }

    @media (prefers-color-scheme: dark) {
      body.theme-auto .stop-popup,
      body.theme-dark .stop-popup {
        background: var(--surface-1);
        color: #f8fafc;
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
      }
      body.theme-auto .stop-popup__title,
      body.theme-dark .stop-popup__title {
        color: #f8fafc;
      }
      body.theme-auto .stop-popup__meta,
      body.theme-dark .stop-popup__meta,
      body.theme-auto .stop-popup__section,
      body.theme-dark .stop-popup__section {
        color: rgba(248, 250, 252, 0.7);
      }
      body.theme-auto .pill,
      body.theme-dark .pill {
        border-color: var(--pill-border, rgba(255, 255, 255, 0.16));
        box-shadow: none;
      }
      body.theme-auto .stop-schedule__row,
      body.theme-dark .stop-schedule__row {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.12);
        color: #f8fafc;
      }
      body.theme-dark .pop-header,
      body.theme-auto .pop-header {
        background: var(--surface-1);
        color: var(--text-primary);
      }
      body.theme-dark .pop-body,
      body.theme-auto .pop-body {
        background: var(--surface-2);
        color: var(--text-primary);
      }
    }

    /* Route/global stops */
    :root {
      --map-zoom-size: 24px;
    }

    @keyframes stopFadeIn {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }

    .stop-marker {
      --stop-border: #f1c40f; /* strong yellow */
      --stop-fill: rgba(255, 255, 255, 0.98);
      --stop-arrow: var(--stop-border);
      --stop-ang: 0deg;
      --stop-size: var(--map-zoom-size, 24px);
      --stop-border-w: clamp(3px, calc(var(--stop-size) * 0.16), 6px);
      --stop-arrow-l: clamp(8px, calc(var(--stop-size) * 0.42), 13px);
      --stop-arrow-h: clamp(3px, calc(var(--stop-size) * 0.16), 6px);
      width: var(--stop-size);
      height: var(--stop-size);
      border-radius: 50%;
      background: var(--stop-fill);
      border: var(--stop-border-w) solid var(--stop-border);
      box-shadow: 0 10px 24px rgba(0,0,0,0.28);
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.35));
      position: relative;
      opacity: 1;
      transform: scale(1);
      transform-origin: center;
      will-change: transform, opacity, filter;
      animation: none;
      transition: opacity 320ms ease, transform 360ms cubic-bezier(0.2, 0.9, 0.2, 1), filter 220ms ease;
    }
    .stop-marker.stop--hidden {
      opacity: 0;
      transform: scale(0.78);
      animation: none;
    }
    .stop-marker.stop--shown {
      opacity: 1;
      transform: scale(1);
      animation: none;
    }

    /* Contentores das mini-pills sobre as paragens */
    .stop-label-container {
      pointer-events: none; /* Permite clicar na paragem por baixo */
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0;
      transform: translateY(6px) scale(0.94);
      transition: opacity 260ms ease, transform 320ms cubic-bezier(0.22, 1, 0.36, 1);
    }
    .stop-label-container.stop-label--shown {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    .stop-label-container.stop-label--hidden {
      opacity: 0;
      transform: translateY(10px) scale(0.92);
    }

    .stop-label-pills {
      display: flex;
      gap: 2px;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 60px; /* Mantm as pills compactas */
      opacity: 0;
      transform: translateY(6px) scale(0.94);
      transition: opacity 240ms ease, transform 280ms cubic-bezier(0.2, 0.9, 0.2, 1);
      will-change: opacity, transform;
    }
    .stop-label-pills.stop-label-pills--visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .stop-label-pill-mini {
      padding: 1px 3px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 900;
      line-height: 1;
      color: #0f172a;
      border: 1px solid rgba(0,0,0,0.15);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      white-space: nowrap;
      text-shadow: 0 0.5px 1px rgba(0,0,0,0.3);
    }
    body.theme-dark .stop-label-pill,
    body.theme-auto .stop-label-pill {
      background: rgba(15, 23, 42, 0.92);
      color: #f8fafc;
      border-color: rgba(248, 250, 252, 0.12);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.32);
    }
    body.theme-dark .stop-label-pill__pill,
    body.theme-auto .stop-label-pill__pill {
      border-color: var(--pill-border, rgba(248, 250, 252, 0.16));
      box-shadow: none;
    }
    body.stop-labels-visible .stop-label-pill {
      opacity: 1;
      transform: translate(-50%, -2px) scale(1);
    }
    .stop-marker .stop-arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      transform: translate(-50%, -50%) rotate(var(--stop-ang)) translateX(calc(var(--stop-arrow-l) + 1px));
      border-left: var(--stop-arrow-l) solid var(--stop-arrow);
      border-top: var(--stop-arrow-h) solid transparent;
      border-bottom: var(--stop-arrow-h) solid transparent;
      opacity: 0.95;
    }

    /* Leaflet wrapper class so marker appearance changes don't animate map pan/zoom transforms */
    .leaflet-marker-icon.stop-fade {
      will-change: opacity, transform;
    }
    .leaflet-marker-icon.stop-fade {
      width: var(--map-zoom-size, 24px) !important;
      height: var(--map-zoom-size, 24px) !important;
      margin-left: calc(var(--map-zoom-size, 24px) / -2) !important;
      margin-top: calc(var(--map-zoom-size, 24px) / -2) !important;
    }

    /* Modern route pills for stop popups */
    .route-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.8rem;
      line-height: 1.15;
      font-weight: 900;
      letter-spacing: 0.01em;
      border: 1px solid var(--pill-border, rgba(15, 23, 42, 0.12));
      color: var(--pill-fg, #0b1220);
      background: var(--pill-bg, #e2e8f0);
      white-space: nowrap;
      user-select: none;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
      transition: transform 160ms ease, filter 160ms ease;
    }
    .route-pill.route-pill--clickable { cursor: pointer; }
    .route-pill.route-pill--clickable:hover { filter: brightness(0.98); transform: translateY(-1px); }
    .route-pill.route-pill--clickable:active { transform: translateY(0px); filter: brightness(0.96); }
    .route-pill.route-pill--loading {
      background: rgba(148, 163, 184, 0.22);
      border-color: rgba(148, 163, 184, 0.3);
      color: rgba(15, 23, 42, 0.55);
      box-shadow: none;
    }
    .route-pill.route-pill--inline {
      box-shadow: none;
      padding: 4px 10px;
      font-size: 0.92rem;
      vertical-align: middle;
    }
    .route-title-rest {
      font-weight: 700;
      color: var(--text-primary);
      vertical-align: middle;
    }
    body.theme-dark .route-pill {
      border-color: var(--pill-border, rgba(255, 255, 255, 0.16));
      color: var(--pill-fg, #0b1220);
      box-shadow: none;
    }
    body.theme-dark .stop-schedule__row {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.12);
      color: #f8fafc;
    }
    .custom-popup .maplibregl-popup-close-button {
      position: absolute;
      top: 8px;
      right: 10px;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.25);
      background: rgba(255, 255, 255, 0.85);
      color: #0f172a;
      font-size: 18px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
      cursor: pointer;
      z-index: 20;
      transition: transform 120ms ease, background 120ms ease, box-shadow 120ms ease;
    }
    .custom-popup .maplibregl-popup-close-button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    body.theme-dark .custom-popup .maplibregl-popup-close-button {
      border-color: rgba(255, 255, 255, 0.35);
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }
    body.theme-dark .custom-popup .maplibregl-popup-close-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    body.theme-auto .custom-popup .maplibregl-popup-close-button {
      border-color: rgba(15, 23, 42, 0.25);
      background: rgba(255, 255, 255, 0.85);
      color: #0f172a;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    body.theme-auto .custom-popup .maplibregl-popup-close-button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    @media (prefers-color-scheme: dark) {
      body.theme-auto .custom-popup .maplibregl-popup-close-button {
        border-color: rgba(255, 255, 255, 0.35);
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      }
      body.theme-auto .custom-popup .maplibregl-popup-close-button:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      }
    }

    /* Leaflet Tooltips (cones) */
    .veh-label {
      background: transparent;
      border: none;
      box-shadow: none;
      color: #333;
      font-size: 16px;
      font-weight: 700;
      transform: translate(-50%, -50%);
      pointer-events: none !important;
    }

    .veh-wrapper {
      width: 34px;
      height: 42px;
    }

    .veh-marker {
      position: relative;
      width: 34px;
      height: 42px;
      transform: translate3d(0, 0, 0);
      --c: #2ecc71;
    }

    /* Smooth marker slide on new pings (only when we opt-in via JS). */
    .leaflet-marker-icon.veh-animating,
    .maplibregl-marker.veh-animating,
    .veh-wrapper.veh-animating {
      will-change: transform;
      transition: transform var(--veh-move-ms, 1000ms) linear;
    }

    /* Never animate marker transforms while the user is interacting with the map (pan/zoom),
       otherwise markers can "drift" a few pixels due to the map engine updating transforms. */
    .map-interacting .leaflet-marker-icon,
    .map-interacting .maplibregl-marker,
    .map-interacting .veh-wrapper,
    .map-interacting .stop-marker,
    .map-interacting .veh-marker {
      transition: none !important;
    }
    .map-interacting .stop-marker {
      animation: none !important;
    }

    @media (prefers-reduced-motion: reduce) {
      .leaflet-marker-icon.veh-animating,
      .maplibregl-marker.veh-animating {
        transition: none !important;
      }
    }

    .veh-pin {
      position: absolute;
      left: 50%;
      top: 2px;
      width: 28px;
      height: 28px;
      background: var(--c);
      border-radius: 50% 50% 50% 0;
      transform: translateX(-50%) rotate(-45deg);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.9);
    }

    .veh-pin::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 5px;
      left: 5px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.12);
    }

    .veh-icon {
      position: absolute;
      left: 50%;
      top: 8px;
      transform: translateX(-50%);
      font-size: 14px;
      color: rgba(26, 26, 26, 0.92);
      text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
      pointer-events: none;
    }

    .veh--stale {
      filter: grayscale(1) saturate(0.2);
      opacity: 0.55;
    }

    .veh--inactive {
      opacity: 0;
    }

    .veh--faded {
      opacity: 0.25;
      filter: grayscale(1) saturate(0.1);
    }

    .veh--hl {
      opacity: 1;
    }

	    #sidebar-toggle {
	      position: absolute;
	      top: 24px;
	      left: 24px;
      z-index: 1600;
      opacity: 0;
      pointer-events: none;
    }

    body.sidebar-collapsed #sidebar {
      transform: translateX(-105%);
      opacity: 0;
      pointer-events: none;
    }

    body.sidebar-collapsed #sidebar-toggle {
      opacity: 1;
      pointer-events: auto;
    }

    .hidden {
      display: none !important;
    }

    /* Keep popups above everything */
    .leaflet-pane.leaflet-popup-pane { z-index: 4000 !important; }
    .maplibregl-popup { z-index: 4000 !important; }

	    @media (max-width: 900px) {

      #sidebar {
        width: min(360px, 92vw);
        min-width: min(360px, 92vw);
        max-width: min(360px, 92vw);
      }

      .sidebar-header {
        margin-top: 60px;
        margin-bottom: -100px;
      }

      .chart-grid {
        grid-template-columns: 1fr;
        width: 100%;
        max-width: none;
        min-width: auto;
      }

      .sidebar-header h1 {
	        font-size: 1.3rem;
	      }

	      .charts-section h2 {
	        font-size: 0.95rem;
	      }

	      .chart-card {
	        max-width: none;
	        min-height: 170px;
	        touch-action: manipulation;
	      }

	      #map-container {
	        height: 100dvh;
	      }

	      .kpi-floating-context {
	        font-size: 0.9rem;
	        top: var(--mobile-safe-top);
	        left: calc(var(--mobile-safe-start) + var(--mobile-action-diameter) + var(--mobile-context-gap));
	        right: var(--mobile-safe-end);
	        width: auto;
	        min-width: 0;
	        max-width: calc(100% - (var(--mobile-safe-start) + var(--mobile-safe-end) + var(--mobile-action-diameter) + var(--mobile-context-gap)));
	        padding: 0 14px;
	        display: flex;
	        align-items: center;
	        gap: 0;
	      }
      .kpi-floating-chip {
        min-height: var(--mobile-action-diameter);
        padding: 0 clamp(4px, 2vw, 8px);
        display: grid;
        grid-template-columns: 20px minmax(0, 1fr) 18px;
        align-items: center;
        gap: clamp(6px, 1vw, 10px);
        width: 100%;
      }
	      .kpi-floating-icon,
	      #kpi-floating-text,
	      .kpi-floating-clear {
	        align-self: center;
	      }

	      #kpi-panel {
	        top: calc(var(--mobile-safe-top) + var(--mobile-action-diameter) + 12px);
	        left: var(--mobile-safe-start);
	        right: var(--mobile-safe-end);
	        transform: none;
	        width: auto;
	        max-width: min(420px, calc(100% - (var(--mobile-safe-start) + var(--mobile-safe-end))));
	        padding: 8px 10px;
	        gap: 8px;
	        border-radius: 14px;
	      }

	      #kpi-panel .kpi-grid {
	        grid-template-columns: repeat(3, minmax(0, 1fr));
	        gap: 6px;
	      }

	      #kpi-panel .kpi-card {
	        min-height: 52px;
	        padding: 6px 8px;
	      }

	      #kpi-panel .kpi-card strong {
	        font-size: 1.08rem;
	      }

	      #kpi-panel .kpi-label {
	        font-size: 0.64rem;
	      }

	      #kpi-panel .status-dot {
	        width: 10px;
	        height: 10px;
	      }

		      #sidebar-toggle,
		      #sidebar-close {
		        top: var(--mobile-safe-top);
		        left: var(--mobile-safe-start);
		        width: var(--mobile-action-diameter);
		        height: var(--mobile-action-diameter);
		      }

      body:not(.sidebar-collapsed) .kpi-panel {
        opacity: 0;
        pointer-events: none;
      }
	    }

    @media (max-width: 1024px) {
      .charts-section {
        margin-top: 12px;
      }
      .chart-grid {
        gap: 10px;
      }
    }

    @media (max-width: 768px) {
      #map-container {
        height: 100dvh;
      }
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .chart-card {
        min-height: 150px;
        padding: 12px 10px;
      }
      #kpi-panel {
        width: min(96vw, 340px);
        max-width: min(96vw, 340px);
        padding: 10px;
      }
      #kpi-panel .kpi-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 6px;
      }
      .kpi-panel-trigger {
        width: 92%;
      }
      .kpi-floating-context {
        --floating-width: min(280px, 90vw);
      }
    }

    @media (max-width: 540px) {
      .chart-card {
        min-height: 140px;
      }
      #kpi-panel {
        width: min(92vw, 320px);
        padding: 8px;
      }
      .kpi-floating-context {
        --floating-width: min(280px, 90vw);
      }
    }

</style>
</head>
<body class="theme-auto">
  <div id="app-shell">
    <aside id="sidebar">
      <button id="sidebar-close" type="button" aria-label="Fechar filtros"></button>
      <div class="sidebar-header">
        <div>
          <h1> Dashboard</h1>
        </div>
      </div>
      <div class="sidebar-section hidden" id="variant-filter-group">
        <label for="variant-filter"> Variante</label>
        <select id="variant-filter"></select>
      </div>
      <section class="charts-section" aria-label="Tendncias da frota">
        <div class="charts-section__header">
          <h2 class="charts-section__title sr-only">Tendncias rpidas</h2>
          <button id="chart-section-toggle" type="button" aria-label="Ocultar ou mostrar tendncias rpidas" aria-expanded="true">
            <span class="chart-toggle-label"> Tendncias rpidas</span>
            <span class="chart-toggle-arrow" aria-hidden="true"></span>
          </button>
        </div>
        <div class="chart-grid-wrapper">
          <div class="chart-grid" id="chart-grid">
	            <button class="chart-card" id="chart-speed-card" type="button">
	              <div class="chart-card-header">
	                <span>Velocidade Comercial</span>
	              </div>
	              <canvas id="chart-speed-preview"></canvas>
	              <span class="chart-card-help" aria-hidden="true"></span>
	            </button>
	            <button class="chart-card" id="chart-volume-card" type="button">
	              <div class="chart-card-header">
	                <span>Volume da Frota</span>
	              </div>
	              <canvas id="chart-volume-preview"></canvas>
	              <span class="chart-card-help" aria-hidden="true"></span>
	            </button>
          </div>
        </div>
      </section>
      <p id="route-chart-hint" class="sidebar-route-hint hidden">
        Expanda o grfico para ver detalhes da frota.
      </p>
      <p class="sidebar-note">
      </p>
      <div class="sidebar-footer">
        <a
          class="sidebar-author-link"
          href="https://discord.com/users/666907356789080066"
          target="_blank"
          rel="noopener noreferrer"
        >
          <span class="sidebar-author-label">Feito por</span>
          <span class="sidebar-author-handle">@Abelhato</span>
        </a>
      </div>
    </aside>
    <div id="map-container">
      <div class="kpi-floating-context" id="kpi-floating-context">
        <div id="kpi-floating-chip" class="kpi-floating-chip" role="button" tabindex="0" aria-label="Pesquisar carreira">
          <span class="kpi-floating-icon" aria-hidden="true"><i class="fa fa-search"></i></span>
          <span id="kpi-floating-text" class="kpi-floating-text--placeholder">pesquise carreira, paragem...</span>
          <button id="kpi-floating-clear" class="kpi-floating-clear hidden" type="button" aria-label="Voltar  Rede Global" title="Voltar  Rede Global"></button>
        </div>
      </div>
      <div class="kpi-panel" id="kpi-panel">
        <div class="kpi-grid">
          <article class="kpi-card">
            <span class="kpi-label">Veculos ativos</span>
            <strong class="kpi-value kpi-active-value">
              <span id="status-dot" class="status-dot" aria-hidden="true"></span>
              <span id="kpi-active-vehicles"></span>
            </strong>
            <span class="kpi-meta" id="kpi-last-update"></span>
          </article>
          <article class="kpi-card">
            <span class="kpi-label">Vel. comercial</span>
            <strong class="kpi-value kpi-speed" id="kpi-vel-day"></strong>
          </article>
          <article class="kpi-card">
            <span class="kpi-label">Vel. comercial (1 hora)</span>
            <strong class="kpi-value kpi-speed" id="kpi-vel-hour"></strong>
            <span class="kpi-delta" id="kpi-vel-hour-delta"></span>
          </article>
        </div>
        <div
          id="kpi-panel-trigger"
          class="kpi-panel-trigger"
          role="button"
          tabindex="0"
          aria-expanded="false"
          aria-label="Alternar KPIs adicionais"
        >
          <span class="kpi-panel-trigger-icon" aria-hidden="true"></span>
        </div>
        <div class="kpi-extra-row" id="kpi-extra-row" aria-hidden="true">
          <article class="kpi-card kpi-card--extra">
            <span class="kpi-label">Viagens efetuadas</span>
            <strong class="kpi-value" id="kpi-trips-percent"></strong>
            <span class="kpi-meta" id="kpi-trips-meta"></span>
          </article>
          <article class="kpi-card kpi-card--extra" data-kpi-frequency-card>
            <span class="kpi-label">Frequncia</span>
            <strong class="kpi-value" id="kpi-frequency"></strong>
            <span class="kpi-meta" id="kpi-frequency-meta">intervalo mdio</span>
          </article>
          <article class="kpi-card kpi-card--extra">
            <span class="kpi-label">Distncia</span>
            <strong class="kpi-value" id="kpi-distance"></strong>
            <span class="kpi-meta" id="kpi-distance-meta">percorridos hoje</span>
          </article>
        </div>
      </div>
      <div class="mobile-stop-card" id="mobile-stop-card" aria-live="polite">
        <div class="mobile-stop-card__header">
          <div>
            <div class="mobile-stop-card__title" id="mobile-stop-title">Paragem</div>
            <div class="mobile-stop-card__meta" id="mobile-stop-meta"></div>
          </div>
          <button class="mobile-stop-card__close" id="mobile-stop-close" type="button" aria-label="Fechar paragem"></button>
        </div>
        <div class="mobile-stop-card__pills" id="mobile-stop-pills"></div>
        <div class="stop-schedule" id="mobile-stop-schedule"></div>
      </div>
      <button id="sidebar-toggle" type="button" aria-controls="sidebar" aria-expanded="false" aria-label="Mostrar filtros"></button>
      <div id="map"></div>
      <div class="app-alert" id="app-alert" role="status" aria-live="polite"></div>
      <div class="chart-overlay" id="chart-overlay" role="dialog" aria-modal="true" aria-label="Grfico ampliado">
        <div class="chart-overlay-content">
          <button class="chart-overlay-close" id="chart-overlay-close" type="button" aria-label="Fechar grfico ampliado"></button>
          <h3 id="chart-overlay-title">Velocidade Comercial</h3>
          <div class="chart-overlay-body">
            <div class="overlay-tabs" id="overlay-tabs" aria-label="Alternar entre grfico e tabela">
              <button class="overlay-tab active" id="overlay-tab-chart" type="button">Grfico</button>
              <button class="overlay-tab" id="overlay-tab-table" type="button">Veculos</button>
            </div>
            <div class="chart-overlay-visual">
              <canvas id="chart-overlay-canvas"></canvas>
            </div>
            <div class="chart-overlay-extra" id="chart-overlay-extra" hidden>
              <div class="overlay-extra-heading">
                <h4 class="overlay-subtitle">Veculos detetados</h4>
                <span class="overlay-pill">Hoje</span>
              </div>
              <div class="overlay-table-wrapper">
                <table class="overlay-table">
                  <thead>
                    <tr>
                    <th><button class="overlay-sort" data-sort="id" type="button">Veculo <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort" data-sort="chapa" type="button">Chapa <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort" data-sort="model" type="button">Modelo <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort" data-sort="first" type="button">Primeiro ping <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort active" data-sort="last" type="button">ltimo ping <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort" data-sort="dist" type="button">Distncia (km) <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort" data-sort="trips" type="button">Viagens <span class="sort-icon"></span></button></th>
                    <th><button class="overlay-sort" data-sort="active" type="button">Estado <span class="sort-icon"></span></button></th>
                  </tr>
                </thead>
                  <tbody id="overlay-vehicle-rows">
                    <tr><td colspan="8" class="overlay-empty">A carregar</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button id="user-location-btn" class="user-location-btn" type="button" aria-label="Mostrar a minha localizao">
        <i class="fa fa-location-arrow" aria-hidden="true"></i>
      </button>
      <div id="floating-search" class="floating-search floating-search--map hidden" aria-label="Pesquisar carreira (mobile)">
        <input id="floating-route-input" class="floating-route-input" type="text" placeholder="Pesquise carreira, paragem..." autocomplete="off">
        <div id="floating-route-preview" class="floating-route-preview"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = "https://4belhato.trade/";
	    const urlParams = new URLSearchParams(window.location.search);
	    const ACTIVE_WINDOW_MIN = (() => {
	      const raw = (urlParams.get("active_window_min") || urlParams.get("activeWindowMin") || "").trim();
	      if (!raw) return 10;
	      const parsed = Number.parseInt(raw, 10);
	      if (!Number.isFinite(parsed)) return 10;
	      return Math.max(1, Math.min(180, parsed));
	    })();

    const MAP_CENTER = [38.736946, -9.142685];
    const MAP_ZOOM = 13;
    const REFRESH_RATE_MS = 5000;
    const VEHICLE_STALE_FORCE_MS = 12_000; // Force a refresh if we haven't applied new vehicles within this window.
    const VEHICLE_MAX_STALE_MS = 15_000; // If newest ping is older than this, try the next endpoint.
    const VEHICLE_CACHE_TTL_MS = 0; // disable vehicle cache to force fresh pulls each poll
    // Mimic Streamlit dashboard: on each poll, vehicles with a new ping slide for ~1s, otherwise stay still.
    const ANIMATION_MS = 1000;
    const ACTIVE_SECONDS = 300;
    const INACTIVE_SECONDS = 600;
    const MOBILE_POPUP_BREAKPOINT = 900;
const FLOATING_SEARCH_MULTILINE_THRESHOLD = 56;

    const SHAPES_MOCK = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": {"linha": "727"},
          "geometry": {
            "type": "LineString",
            "coordinates": [[-9.142, 38.736], [-9.145, 38.740], [-9.150, 38.735]]
          }
        }
      ]
    };

    const VEHICLES_MOCK = [
      { id: "2401", lat: 38.7369, lon: -9.1426, linha: "727", bearing: 45, speed: 22, category: "Bus", ts: Date.now() },
      { id: "305",  lat: 38.7100, lon: -9.1300, linha: "28E", bearing: 180, speed: 12, category: "Eltricos", ts: Date.now() },
      { id: "1001", lat: 38.7600, lon: -9.1600, linha: "201", bearing: 90, speed: 30, category: "Madrugada", ts: Date.now() }
    ];

    const OFFLINE_VEHICLES_URL = new URL("static/veiculos.json", location.href).href;
    let offlineVehiclesCache = null;

    const ROUTE_TRANSLATOR_URL = new URL("tradutor_rotas.csv", location.href).href;
    const ROUTES_DATA_URL = new URL("routes.txt", location.href).href;
    const STOP_CATALOG_URL = new URL("stops.txt", location.href).href;
    const STOP_CATALOG_CSV = String.raw`stop_id,stop_code,stop_name,stop_desc,stop_lat,stop_lon,zone_id,stop_url,location_type,parent_station,stop_timezone,wheelchair_boarding
50101,50101,R. F. Lopes Graa / R. Prof. A. Sousa,,38.76968170,-9.17041900,,,0,,,
50102,50102,Hosp. Foras Armadas,,38.76901720,-9.17502060,,,0,,,
14723,14723,Av. Dr. Arlindo Vicente,,38.75362870,-9.12593280,,,0,,,
14722,14722,Av. Dr. Arlindo Vicente,,38.75255370,-9.12624960,,,0,,,
14721,14721,Av. Dr. Arlindo Vicente,,38.75290270,-9.12626780,,,0,,,
14720,14720,Colgio Valsassina,,38.75537970,-9.12637480,,,0,,,
14727,14727,B. Flamenga,,38.75228070,-9.12320380,,,0,,,
14726,14726,Pq. Bela Vista,,38.75106770,-9.12454880,,,0,,,
14725,14725,Pq. Bela Vista,,38.75104470,-9.12479880,,,0,,,
14724,14724,Av. Dr. Arlindo Vicente,,38.75370370,-9.12602580,,,0,,,
14729,14729,Av. Avelino Teixeira Mota (CERCI),,38.75209670,-9.12130680,,,0,,,
14728,14728,B. Flamenga,,38.75266270,-9.12299580,,,0,,,
2008,2008,Campo Grande,,38.75212670,-9.15124280,,,0,,,
6503,6503,Jardim Constantino,,38.73084570,-9.13770380,,,0,,,
7409,7409,Lg. Frei Heitor Pinto,,38.75462770,-9.13852980,,,0,,,
3008,3008,R. Gen. Fernando Tamagnini,,38.74531670,-9.22199280,,,0,,,
3018,3018,Estao Damaia,,38.74813190,-9.21517120,,,0,,,
7503,7503,Av. Mar. Gomes Costa (Qta. Teresinhas),,38.76118070,-9.12176580,,,0,,,
7513,7513,Av. Brasil (Rot. Relgio),,38.76225070,-9.13025080,,,0,,,
14125,14125,R. Rio Cvado (C. Cultural),,38.76979470,-9.19105580,,,0,,,
14120,14120,B. Padre Cruz,,38.76925120,-9.18922280,,,0,,,
1409,1409,Av. Marqus Tomar,,38.73655070,-9.15058080,,,0,,,
4509,4509,Sul e Sueste,,38.70719510,-9.13344810,,,0,,,
1503,1503,P. Espanha / Av. Berna,,38.73873970,-9.15403380,,,0,,,
1513,1513,R. Tenente Espanca,,38.73915470,-9.15524680,,,0,,,
2409,2409,Parque Naes Sul,,38.75531120,-9.09685090,,,0,,,
5519,5519,P. Comrcio,,38.70890130,-9.13600740,,,0,,,
21304,21304,Montes Claros,,38.71784170,-9.19930180,,,0,,,
21305,21305,Pq. Infantil Alvito,,38.72022030,-9.18541340,,,0,,,
21306,21306,Pq. Infantil Alvito,,38.71998460,-9.18540140,,,0,,,
21307,21307,Estr. Alvito / Al. Keil Amaral,,38.72273800,-9.18659650,,,0,,,
21301,21301,Alto Moinhos,,38.72173570,-9.19710780,,,0,,,
21302,21302,Alto Moinhos,,38.72208270,-9.19677780,,,0,,,
21303,21303,Montes Claros,,38.71774270,-9.19955680,,,0,,,
21308,21308,Estr. Alvito / Al. Keil Amaral,,38.72261270,-9.18667140,,,0,,,
13630,13630,Hosp. Lusadas,,38.75025220,-9.18060210,,,0,,,
5607,5607,R. Prata,,38.71107820,-9.13690460,,,0,,,
4218,4218,Algs - P. D. Manuel I,,38.69950670,-9.22848980,,,0,,,
4208,4208,R. Damio Gis,,38.69836270,-9.22504780,,,0,,,
6607,6607,Gomes Freire - R. Joaquim Bonifcio,,38.72809970,-9.14277180,,,0,,,
7509,7509,Av. Mar. Gomes Costa (Qta. Teresinhas),,38.76123070,-9.12193780,,,0,,,
7519,7519,R. Cidade Quelimane,,38.76576970,-9.12490180,,,0,,,
8018,8018,Igreja Sto. Condestvel (C. Ourique),,38.71497570,-9.16642580,,,0,,,
8008,8008,R. Francisco Metrass,,38.71839770,-9.16623980,,,0,,,
8028,8028,Campo Ourique (Prazeres),,38.71469870,-9.17005580,,,0,,,
7607,7607,Geofsica,,38.77595770,-9.12636280,,,0,,,
9008,9008,Casal Vistoso,,38.74142070,-9.12941280,,,0,,,
1509,1509,R. Filipe Mata,,38.74126970,-9.15939680,,,0,,,
7208,7208,Qta. Lavadeiras,,38.78383670,-9.16418980,,,0,,,
7218,7218,Olival Basto,,38.78965970,-9.16849480,,,0,,,
1607,1607,Sete Rios,,38.74159220,-9.16924280,,,0,,,
1627,1627,Estao Sete Rios,,38.74026970,-9.16719780,,,0,,,
12838,12838,Est. Pao Lumiar (Plo Tec. Lisboa),,38.76426460,-9.18229240,,,0,,,
12839,12839,Lg. Luz,,38.76199150,-9.18365840,,,0,,,
12834,12834,Qta. Inglesinhos,,38.76331670,-9.18060680,,,0,,,
12835,12835,R. Padre Amrico,,38.76155570,-9.17982180,,,0,,,
12836,12836,R. Padre Amrico,,38.76174070,-9.17962380,,,0,,,
12837,12837,Av. Naes Unidas (C. Comercial),,38.76432350,-9.17749820,,,0,,,
12830,12830,R. Eugnio Salvador,,38.76771170,-9.18026980,,,0,,,
12831,12831,Az. Serrado,,38.76743470,-9.18556680,,,0,,,
12832,12832,Az. Serrado,,38.76764470,-9.18538680,,,0,,,
12833,12833,R. Virgilio Martinho,,38.76516870,-9.17852580,,,0,,,
8419,8419,C. Comercial Olivais - R. Cidade Bissau,,38.76303370,-9.11406180,,,0,,,
8409,8409,Cabo Ruivo - Av. Mar. Gomes Costa,,38.75876370,-9.11343180,,,0,,,
8439,8439,R. Mocimboa Praia,,38.75870270,-9.11053580,,,0,,,
1208,1208,Mq. Pombal - R. Braamcamp,,38.72402070,-9.15089580,,,0,,,
5707,5707,Campo Grande - Av. Brasil,,38.75579940,-9.15152580,,,0,,,
1218,1218,R. Sta. Marta,,38.72529670,-9.14602080,,,0,,,
8513,8513,R. D. Joo V,,38.72102570,-9.16136480,,,0,,,
9409,9409,R. Maria Pia / Estr. Loureiro,,38.71099870,-9.17241280,,,0,,,
6609,6609,R. Conde Redondo,,38.72654670,-9.14497380,,,0,,,
9419,9419,Lg. Necessidades,,38.70716060,-9.17156710,,,0,,,
9429,9429,R. Cruz,,38.70725870,-9.17415780,,,0,,,
3607,3607,B. Armador,,38.74625270,-9.11976080,,,0,,,
3617,3617,Av. Ucrnia,,38.74774270,-9.11748580,,,0,,,
2218,2218,Av. Paulo VI,,38.74826070,-9.10877780,,,0,,,
9503,9503,R. Junqueira (Centro Congressos),,38.70003970,-9.18364980,,,0,,,
2208,2208,Estao Brao Prata,,38.74718370,-9.10472580,,,0,,,
6707,6707,R. Borges Carneiro / C. Estrela,,38.71226870,-9.15661980,,,0,,,
9513,9513,Centro Congressos,,38.69967270,-9.18373380,,,0,,,
7609,7609,Gasolineiras,,38.78099170,-9.12483480,,,0,,,
7699,7699,Aeroporto,,38.76922410,-9.12808090,,,0,,,
12931,12931,B. 2 Maio,,38.71218000,-9.19910280,,,0,,,
7727,7727,R. Mercado,,38.77096270,-9.11713380,,,0,,,
12930,12930,Restelo,,38.71273250,-9.21078100,,,0,,,
12933,12933,Ajuda (Associao Desportiva),,38.71194880,-9.20385070,,,0,,,
7707,7707,Piscina Olivais,,38.76860970,-9.11489780,,,0,,,
12932,12932,Ajuda (Associao Desportiva),,38.71143340,-9.20406400,,,0,,,
7717,7717,Esc. Olivais,,38.76528870,-9.10960980,,,0,,,
1609,1609,Sete Rios,,38.74145420,-9.16949060,,,0,,,
1619,1619,Sete Rios,,38.74131920,-9.17024380,,,0,,,
1629,1629,Sete Rios,,38.74179910,-9.16882580,,,0,,,
1707,1707,Picoas,,38.73012870,-9.14543280,,,0,,,
19001,19001,Centro Sul,,38.66789220,-9.16413980,,,0,,,
4003,4003,Alcntara Mar,,38.70287570,-9.17323480,,,0,,,
8519,8519,R. D. Joo V,,38.72106170,-9.16097380,,,0,,,
8509,8509,Av. Cons. Fernando Sousa,,38.72522470,-9.15996680,,,0,,,
2707,2707,R. B (B. Liberdade),,38.73488790,-9.17037740,,,0,,,
3609,3609,Av. Verglio Ferreira (Fundao Oriente),,38.74353070,-9.11885680,,,0,,,
8607,8607,Viaduto Duarte Pacheco,,38.72331240,-9.16642860,,,0,,,
9509,9509,Tv. Artur Lamas,,38.69973270,-9.19268080,,,0,,,
3727,3727,Centro Sade Marvila,,38.74202570,-9.10968850,,,0,,,
3707,3707,Av. Joo Paulo II,,38.74742370,-9.11026580,,,0,,,
3717,3717,Av. Paulo VI (Igreja),,38.74307570,-9.11179280,,,0,,,
6033,6033,R. Joo Amaral,,38.78696070,-9.14993980,,,0,,,
6023,6023,B. Sete Cus,,38.78605170,-9.14992780,,,0,,,
6013,6013,R. Melo Antunes,,38.77920330,-9.14467540,,,0,,,
9607,9607,R. Jernimos,,38.69979770,-9.20590680,,,0,,,
6003,6003,Qta. Pailepa,,38.78789800,-9.14549260,,,0,,,
7709,7709,Av. Berlim / Av. Cidade Luanda,,38.76824970,-9.11117880,,,0,,,
7003,7003,P. Paiva Couceiro,,38.73041670,-9.12779480,,,0,,,
7013,7013,R. Morais Soares (Cemitrio),,38.73062070,-9.12533480,,,0,,,
9208,9208,Campo Mrtires Ptria,,38.72224570,-9.13988780,,,0,,,
1709,1709,P. Jos Fontana,,38.73074470,-9.14376180,,,0,,,
4009,4009,Alcntara Mar,,38.70584670,-9.17435780,,,0,,,
1003,1003,Restauradores,,38.71598870,-9.14158680,,,0,,,
1013,1013,Lavra - R. Cmara Pestana,,38.71866200,-9.14012490,,,0,,,
2709,2709,Serafina,,38.73251670,-9.17179480,,,0,,,
4113,4113,Belm (Museu Coches),,38.69738270,-9.19881480,,,0,,,
4103,4103,Belm - C. Ajuda,,38.69783170,-9.19948480,,,0,,,
2053,2053,Entrecampos - Av. EUA,,38.74837270,-9.14701080,,,0,,,
8609,8609,Arco Carvalho,,38.72420770,-9.16526080,,,0,,,
2023,2023,Av. 5 Outubro / Av. lvaro Pais,,38.74421550,-9.14959910,,,0,,,
2013,2013,Entrecampos,,38.74881570,-9.14783780,,,0,,,
2003,2003,Entrecampos Norte,,38.74980270,-9.14824380,,,0,,,
3709,3709,Esc. Marvila,,38.74031870,-9.10982880,,,0,,,
3719,3719,Av. Paulo VI / R. Jos Patrocnio,,38.74434070,-9.11076480,,,0,,,
7410,7410,Lg. Frei Heitor Pinto,,38.75522970,-9.13918180,,,0,,,
8717,8717,B. Monsanto,,38.73279470,-9.19371680,,,0,,,
8707,8707,Luneta Quartis,,38.73147370,-9.19765380,,,0,,,
6029,6029,P. D. Antnio Ribeiro,,38.78049370,-9.15151480,,,0,,,
6019,6019,Av. Nuno Krus Abecassis,,38.77962850,-9.15118170,,,0,,,
9609,9609,Mosteiro Jernimos,,38.69733770,-9.20341580,,,0,,,
6009,6009,Campo Amoreiras,,38.78550720,-9.14280290,,,0,,,
3023,3023,Reboleira (Metro),,38.75038470,-9.22186280,,,0,,,
3003,3003,Damaia - R. D. Francisco Almeida,,38.74983350,-9.21288590,,,0,,,
3013,3013,Damaia - Av. D. Joo V,,38.74550410,-9.21783150,,,0,,,
50010,50010,R. Prof. Joo Barreira,,38.76254470,-9.17081180,,,0,,,
50011,50011,Telheiras,,38.76058270,-9.16972180,,,0,,,
50012,50012,Telheiras,,38.76043300,-9.16950960,,,0,,,
50013,50013,R. Prof. Fernando Fonseca,,38.76172070,-9.16518480,,,0,,,
50014,50014,R. Prof. Fernando Fonseca,,38.76157770,-9.16507280,,,0,,,
50015,50015,Esc. Telheiras,,38.76015170,-9.17440080,,,0,,,
50016,50016,Esc. Telheiras,,38.76001340,-9.17408200,,,0,,,
50017,50017,Qta. Barros,,38.75572570,-9.16828780,,,0,,,
50018,50018,R. Fernando Namora,,38.76005570,-9.17770980,,,0,,,
50019,50019,R. Fernando Namora,,38.76013570,-9.17762480,,,0,,,
6133,6133,R. Gen. Taborda,,38.72873200,-9.16321750,,,0,,,
6123,6123,R. Campolide (Escola),,38.73226870,-9.16243080,,,0,,,
6113,6113,Campolide,,38.72676220,-9.16236800,,,0,,,
9707,9707,Av. Restelo,,38.69933620,-9.21415640,,,0,,,
6103,6103,R. Artilharia Um / R. Francisco M. Melo,,38.72756820,-9.15900500,,,0,,,
9717,9717,R. S. Francisco Xavier,,38.69911970,-9.21758280,,,0,,,
7009,7009,Esc. Nuno Gonalves,,38.72761470,-9.12820380,,,0,,,
7019,7019,R. Baro Sabrosa / R. Baldaques,,38.73383970,-9.12840980,,,0,,,
1410,1410,Av. Marqus Tomar,,38.73493770,-9.14956380,,,0,,,
7103,7103,Conde Baro - Av. D. Carlos I,,38.70890370,-9.15293380,,,0,,,
4502,4502,Sul e Sueste,,38.70830770,-9.13335180,,,0,,,
2410,2410,Parque Naes Sul,,38.75502870,-9.09660280,,,0,,,
5502,5502,P. Comrcio,,38.70900570,-9.13532180,,,0,,,
5512,5512,P. Comrcio,,38.70828460,-9.13632240,,,0,,,
4109,4109,Belm,,38.69713820,-9.20071710,,,0,,,
1103,1103,Av. Liberdade,,38.71973770,-9.14500980,,,0,,,
2019,2019,Estao Entrecampos,,38.74502170,-9.14770680,,,0,,,
2009,2009,Av. Foras Armadas / R. Sanches Coelho,,38.74773970,-9.15257180,,,0,,,
6502,6502,Estefnia,,38.73255770,-9.14098980,,,0,,,
7406,7406,Av. Sta. Joana Princesa,,38.75468570,-9.13654880,,,0,,,
2133,2133,Estao Sta. Apolnia,,38.71401110,-9.12228380,,,0,,,
2123,2123,Campo Sta. Clara,,38.71539170,-9.12307780,,,0,,,
2113,2113,Estao Sta. Apolnia,,38.71432320,-9.12156080,,,0,,,
2103,2103,R. Bica Sapato,,38.71637770,-9.12062080,,,0,,,
4305,4305,Estr. Costa,,38.70337070,-9.25142980,,,0,,,
3009,3009,R. Gen. Fernando Tamagnini,,38.74632350,-9.22260400,,,0,,,
3019,3019,R. Bernardino Machado,,38.74321970,-9.21875780,,,0,,,
7502,7502,Av. Brasil (Rot. Relgio),,38.76236570,-9.13049280,,,0,,,
7512,7512,Qta. Narigo,,38.75825570,-9.13018180,,,0,,,
8013,8013,Esc. Manuel Maia,,38.71699370,-9.16962380,,,0,,,
8003,8003,R. 4 Infantaria,,38.71827270,-9.16477880,,,0,,,
8023,8023,R. C. Teles / R. Ten. Ferreira Duro,,38.71922070,-9.16677580,,,0,,,
6129,6129,Campolide (Av. Cons. Fernando Sousa),,38.72739790,-9.16143260,,,0,,,
6119,6119,Campolide,,38.72773070,-9.16204780,,,0,,,
9709,9709,R. Alto Duque,,38.70101970,-9.22145880,,,0,,,
6109,6109,B. Campolide,,38.72896570,-9.16608980,,,0,,,
9003,9003,R. Joo Silva,,38.74257520,-9.12934880,,,0,,,
1406,1406,B. Azul,,38.73341470,-9.15451580,,,0,,,
1502,1502,B. Azul (Gulbenkian),,38.73653270,-9.15593080,,,0,,,
1512,1512,R. Filipe Mata,,38.74131670,-9.16028580,,,0,,,
2406,2406,Hosp. Descobertas,,38.75741270,-9.09816480,,,0,,,
7305,7305,Av. Alm. Gago Coutinho / Av. EUA,,38.74960270,-9.13074480,,,0,,,
5804,5804,Campo Grande Norte,,38.75786970,-9.15540280,,,0,,,
5814,5814,Hosp. Pulido Valente,,38.76527070,-9.15734480,,,0,,,
5824,5824,R. Francisco Stromp,,38.76343870,-9.15944180,,,0,,,
5508,5508,P. Comrcio,,38.70837970,-9.13773580,,,0,,,
2512,2512,R. Caribe,,38.76622370,-9.09779980,,,0,,,
13622,13622,R. Antnio Albino Machado,,38.75461070,-9.16813980,,,0,,,
13623,13623,R. Soeiros,,38.75587470,-9.17730280,,,0,,,
8440,8440,R. Manhia,,38.75829870,-9.10824480,,,0,,,
13620,13620,R. S. Toms Aquino,,38.75147370,-9.16766680,,,0,,,
13621,13621,R. Antnio Albino Machado,,38.75419730,-9.16912190,,,0,,,
13626,13626,R. Mateus Vicente / R. Anjos Teixeira,,38.75627870,-9.18100980,,,0,,,
13627,13627,R. Natrcia Freire,,38.75469070,-9.18233580,,,0,,,
13624,13624,R. Virglio Correia,,38.75485070,-9.17374080,,,0,,,
8430,8430,Esc. Vitorino Nemsio,,38.75664970,-9.11461980,,,0,,,
13625,13625,R. Virglio Correia (Loja Cidado),,38.75126870,-9.17212880,,,0,,,
8420,8420,Av. Pdua,,38.76298670,-9.10685580,,,0,,,
6824,6824,Jardim Amoreiras,,38.72147370,-9.15638080,,,0,,,
13628,13628,R. Antnio Alada Baptista,,38.75392270,-9.18191280,,,0,,,
6814,6814,R. Rodrigo Fonseca,,38.72120070,-9.15178680,,,0,,,
13629,13629,Estr. Luz,,38.75494670,-9.17595780,,,0,,,
6804,6804,Rato,,38.72009070,-9.15483780,,,0,,,
4219,4219,Algs - P. D. Manuel I,,38.69941270,-9.22856780,,,0,,,
4209,4209,R. Damio Gis,,38.69822970,-9.22503580,,,0,,,
2129,2129,Mercado Sta. Clara,,38.71538570,-9.12541780,,,0,,,
6610,6610,R. Conde Redondo,,38.72662270,-9.14508580,,,0,,,
9410,9410,R. Maria Pia / Estr. Loureiro,,38.71108170,-9.17234280,,,0,,,
9420,9420,Lg. Necessidades,,38.70711770,-9.17141980,,,0,,,
9430,9430,R. Feliciano Sousa,,38.70918970,-9.17537080,,,0,,,
7824,7824,Av. Boa Esperana,,38.77440030,-9.09749780,,,0,,,
2199,2199,Campo Sta. Clara,,38.71543870,-9.12321780,,,0,,,
7804,7804,P. Jos Queirs,,38.77424270,-9.10623680,,,0,,,
7814,7814,Estao Oriente (Interface),,38.76818070,-9.09992580,,,0,,,
7518,7518,R. Cidade Beira,,38.76782770,-9.12337180,,,0,,,
8019,8019,Igreja Sto. Condestvel (C. Ourique),,38.71484370,-9.16650080,,,0,,,
8009,8009,R. Sampaio Bruno,,38.71833770,-9.16936180,,,0,,,
8029,8029,Campo Ourique (Prazeres),,38.71440070,-9.17001980,,,0,,,
7610,7610,Gasolineiras,,38.78046770,-9.12542880,,,0,,,
8113,8113,R. Joo Deus,,38.71268370,-9.16021880,,,0,,,
8103,8103,Jardim Estrela,,38.71556570,-9.16000580,,,0,,,
2335,2335,R. Vila Fontes,,38.75834970,-9.10563780,,,0,,,
2315,2315,Av. Inf. D. Henrique / Av. Berlim,,38.76683770,-9.10399780,,,0,,,
9009,9009,Casal Vistoso,,38.74135070,-9.12817180,,,0,,,
9103,9103,R. Penha Frana,,38.72436970,-9.12961480,,,0,,,
9113,9113,R. Bartolomeu Costa,,38.72056870,-9.12376680,,,0,,,
9123,9123,R. Gen. Themudo Barata,,38.72694370,-9.12420980,,,0,,,
9133,9133,Sapadores,,38.72197070,-9.12874080,,,0,,,
3305,3305,B. Santos,,38.74484770,-9.15657680,,,0,,,
1814,1814,Av. Repblica,,38.73826870,-9.14605280,,,0,,,
1508,1508,P. Espanha,,38.73821120,-9.15890780,,,0,,,
7209,7209,Qta. Lavadeiras,,38.78378270,-9.16406180,,,0,,,
7219,7219,C. Carriche,,38.78152870,-9.16425450,,,0,,,
1610,1610,Sete Rios,,38.74083030,-9.16812230,,,0,,,
1620,1620,Av. Columb. B. Pinheiro (Est. Sete Rios),,38.73946570,-9.16756380,,,0,,,
5802,5802,Hipdromo,,38.75786970,-9.16287280,,,0,,,
5812,5812,Hosp. Pulido Valente,,38.76519170,-9.15687980,,,0,,,
5832,5832,Qta. Lambert - R. Agostinho Neto,,38.76323670,-9.15345280,,,0,,,
2814,2814,R. Vasco Botelho Amaral,,38.74275630,-9.20188970,,,0,,,
2804,2804,R. Gen. Morais Sarmento,,38.74778270,-9.19781580,,,0,,,
5906,5906,Lumiar,,38.77287670,-9.16131580,,,0,,,
5916,5916,R. Rainha D. Lusa Gusmo,,38.76746370,-9.15960980,,,0,,,
13125,13125,R. Mem Rodrigues,,38.70813270,-9.20902580,,,0,,,
5926,5926,Ameixoeira,,38.78188470,-9.15866180,,,0,,,
13124,13124,Estdio Restelo,,38.70419070,-9.20785080,,,0,,,
13126,13126,R. Mem Rodrigues,,38.70807970,-9.20889780,,,0,,,
13121,13121,R. Pero Alenquer,,38.70315770,-9.21119280,,,0,,,
8416,8416,Cabo Ruivo - Av. Dr. Augusto Castro,,38.75716870,-9.11255680,,,0,,,
13120,13120,Restelo (EPUL),,38.70558170,-9.21248460,,,0,,,
8406,8406,Cabo Ruivo - Av. Mar. Gomes Costa,,38.75904070,-9.11340080,,,0,,,
13123,13123,R. Cons. Martins Carvalho,,38.70658270,-9.20402080,,,0,,,
13122,13122,R. Pero Alenquer,,38.70338290,-9.21146670,,,0,,,
8426,8426,R. Cons. Emdio Navarro,,38.75687370,-9.11850580,,,0,,,
6822,6822,Rato,,38.72029270,-9.15565580,,,0,,,
6812,6812,Rato,,38.72025070,-9.15488480,,,0,,,
6802,6802,Av. lvares Cabral,,38.71834570,-9.15694280,,,0,,,
3824,3824,Corpo Santo,,38.70723650,-9.14116990,,,0,,,
3804,3804,Cais Sodr,,38.70592170,-9.14396180,,,0,,,
1209,1209,Mq. Pombal - R. Joaquim A. Aguiar,,38.72538350,-9.15204210,,,0,,,
5706,5706,Campo Grande - Av. Brasil,,38.75469270,-9.15190280,,,0,,,
1229,1229,Marqus Pombal,,38.72566570,-9.14903980,,,0,,,
8512,8512,Amoreiras,,38.72382670,-9.16091280,,,0,,,
8502,8502,Amoreiras,,38.72409370,-9.16071880,,,0,,,
6906,6906,Hosp. D. Estefnia,,38.72754270,-9.14079880,,,0,,,
9406,9406,R. Maria Pia,,38.71283970,-9.17362780,,,0,,,
9416,9416,Qta. Jacinto,,38.70818870,-9.17661240,,,0,,,
9426,9426,R. Necessidades,,38.70574570,-9.16975480,,,0,,,
4309,4309,Cruz Quebrada (Clube Tnis Jamor),,38.70774870,-9.25151180,,,0,,,
3610,3610,Av. Verglio Ferreira (Fundao Oriente),,38.74414070,-9.11844580,,,0,,,
7822,7822,Av. D. Joo II,,38.77133070,-9.09776180,,,0,,,
7802,7802,R. Sarg. Armando Monteiro Ferreira,,38.77171370,-9.10998280,,,0,,,
7812,7812,P. Jos Queirs,,38.77379670,-9.10475380,,,0,,,
2219,2219,Av. Paulo VI,,38.74790770,-9.10894980,,,0,,,
2209,2209,B. Prodac,,38.74660570,-9.10710980,,,0,,,
6716,6716,R. Palmeira,,38.71484170,-9.15014980,,,0,,,
9502,9502,Hosp. Egas Moniz - Av. India,,38.69776570,-9.18697380,,,0,,,
6706,6706,R. S. Bento,,38.71528570,-9.15437880,,,0,,,
9512,9512,R. Pinto Ferreira,,38.69822970,-9.19135180,,,0,,,
7906,7906,R. Laureano Oliveira,,38.77664730,-9.10284960,,,0,,,
7916,7916,Moscavide (Qta. Laranjeiras),,38.77191570,-9.10148080,,,0,,,
8109,8109,Estrela - R. Domingos Sequeira,,38.71409170,-9.16170980,,,0,,,
7726,7726,R. Mercado,,38.77052970,-9.11693580,,,0,,,
7706,7706,Piscina Olivais,,38.76961950,-9.11247160,,,0,,,
7716,7716,Av. Berlim,,38.76715570,-9.11021280,,,0,,,
9109,9109,Sapadores,,38.72219670,-9.12871880,,,0,,,
9119,9119,R. Sra. Glria,,38.71822270,-9.12766380,,,0,,,
9129,9129,Sapadores,,38.72098070,-9.13019680,,,0,,,
1802,1802,Saldanha,,38.73390070,-9.14506380,,,0,,,
1812,1812,Saldanha,,38.73362670,-9.14508480,,,0,,,
8305,8305,C. Grilo,,38.73025070,-9.10788780,,,0,,,
1906,1906,Campo Pequeno - Av. Repblica,,38.74171270,-9.14688980,,,0,,,
7309,7309,R. Eduardo Noronha,,38.75168570,-9.13201780,,,0,,,
2812,2812,Estao Benfica,,38.74488670,-9.19981780,,,0,,,
9305,9305,R. Arco Carvalho (Ajuda de Me),,38.71994370,-9.17254880,,,0,,,
2802,2802,Estao Benfica - Av. Gomes Pereira,,38.74544870,-9.19803380,,,0,,,
2906,2906,R. Prof. Jorge Silva Horta,,38.74596420,-9.20471180,,,0,,,
13824,13824,Lg. Terreirinho,,38.71606920,-9.13307060,,,0,,,
13822,13822,R. Lagares,,38.71546670,-9.13208380,,,0,,,
3802,3802,Cais Sodr,,38.70634080,-9.14539260,,,0,,,
3812,3812,Cais Sodr,,38.70568670,-9.14396780,,,0,,,
8844,8844,Alto Zambujal,,38.73633870,-9.21259480,,,0,,,
8814,8814,Buraca,,38.74378470,-9.20576380,,,0,,,
8804,8804,Qta. Torres,,38.73362470,-9.20765980,,,0,,,
5708,5708,Campo Grande - Av. Brasil,,38.75514270,-9.15034380,,,0,,,
8824,8824,R. Creche,,38.74407770,-9.21087380,,,0,,,
8518,8518,Amoreiras (C. Comercial),,38.72272370,-9.16111280,,,0,,,
8508,8508,Cruz Almas,,38.72534670,-9.16333090,,,0,,,
2716,2716,Estao Campolide,,38.73138330,-9.16837600,,,0,,,
2706,2706,B. Liberdade,,38.73308570,-9.16911580,,,0,,,
4114,4114,Altinho (MAAT),,38.69751470,-9.19600880,,,0,,,
4104,4104,Belm - C. Ajuda,,38.69798970,-9.19938280,,,0,,,
3926,3926,Santos,,38.70648270,-9.15447680,,,0,,,
3906,3906,Cais Rocha (Museu Nac. Arte Antiga),,38.70378140,-9.16235200,,,0,,,
8610,8610,Arco Carvalho,,38.72402570,-9.16537180,,,0,,,
9804,9804,R. D. Fuas Roupinho,,38.72461770,-9.11637980,,,0,,,
9814,9814,C. Cruz Pedra,,38.72036070,-9.11710780,,,0,,,
9824,9824,C. Cruz Pedra,,38.72046370,-9.11780480,,,0,,,
6718,6718,C. Estrela / R. Dr. Tefilo Braga,,38.71276370,-9.15743080,,,0,,,
9508,9508,R. Pinto Ferreira,,38.69783270,-9.19175680,,,0,,,
6708,6708,R. Borges Carneiro / C. Estrela,,38.71229270,-9.15633480,,,0,,,
3726,3726,Az. Vale Fundo,,38.74360530,-9.10527020,,,0,,,
3706,3706,P. Eduardo Mondlane,,38.74413770,-9.11367980,,,0,,,
3716,3716,Av. Paulo VI (Igreja),,38.74246570,-9.11292880,,,0,,,
6030,6030,P. D. Antnio Ribeiro,,38.78018830,-9.15147040,,,0,,,
6020,6020,Av. Nuno Krus Abecassis,,38.77940120,-9.15120130,,,0,,,
2319,2319,Az. Baptista,,38.75306120,-9.10326980,,,0,,,
6010,6010,Qta. Pailepa,,38.78809170,-9.14565180,,,0,,,
9610,9610,Mosteiro Jernimos,,38.69722870,-9.20505980,,,0,,,
7728,7728,Av. Berlim (P. Baden Powell),,38.76811770,-9.10906080,,,0,,,
7708,7708,Piscina Olivais,,38.76870270,-9.11438580,,,0,,,
7718,7718,Esc. Olivais,,38.76490170,-9.10977480,,,0,,,
6124,6124,R. Campolide (Escola),,38.73221470,-9.16273780,,,0,,,
6104,6104,Campolide,,38.72649970,-9.16226800,,,0,,,
3309,3309,Qta. Freiras,,38.74394770,-9.15477080,,,0,,,
7010,7010,P. Paiva Couceiro,,38.73136770,-9.12708780,,,0,,,
9209,9209,Desterro,,38.72079320,-9.13815080,,,0,,,
7104,7104,Conde Baro - Av. D. Carlos I,,38.70941510,-9.15325790,,,0,,,
1010,1010,Restauradores,,38.71619980,-9.14175690,,,0,,,
8842,8842,B. Zambujal,,38.73868270,-9.21036280,,,0,,,
8802,8802,B. Boavista,,38.73514520,-9.20459880,,,0,,,
8822,8822,Estr. Alfragide (Buraca),,38.74276920,-9.20594350,,,0,,,
2718,2718,R. Campolide / Av. Jos Malhoa,,38.73670740,-9.16780070,,,0,,,
2708,2708,R. B (B. Liberdade),,38.73465270,-9.17022180,,,0,,,
6401,6401,Av. Joo XXI,,38.74220870,-9.14034880,,,0,,,
4112,4112,Belm (Museu Coches),,38.69746170,-9.19858380,,,0,,,
4102,4102,Estao Fluvial Belm,,38.69671870,-9.19912980,,,0,,,
1104,1104,R. Telhal,,38.71962570,-9.14224980,,,0,,,
8916,8916,R. Joo Nascimento Costa,,38.73416070,-9.12082980,,,0,,,
8906,8906,R. Capito Roby,,38.73797370,-9.12243080,,,0,,,
2020,2020,Estao Entrecampos,,38.74457470,-9.14762080,,,0,,,
2010,2010,Av. Foras Armadas / R. Sanches Coelho,,38.74771370,-9.15167480,,,0,,,
4206,4206,Algs,,38.69863360,-9.22739590,,,0,,,
9802,9802,C. Lajes,,38.72555870,-9.11871780,,,0,,,
9812,9812,Av. Inf. D. Henrique (Tipografia),,38.72281440,-9.11355820,,,0,,,
9822,9822,Av. Inf. D. Henrique (Ponte Xabregas),,38.72553990,-9.11239080,,,0,,,
3708,3708,P. Dr. Fernando Amado,,38.74634270,-9.11297280,,,0,,,
3718,3718,Av. Paulo VI (Igreja),,38.74319870,-9.11194580,,,0,,,
7401,7401,Av. Gago Coutinho / Av. D. Rodrigo Cunha,,38.75509570,-9.13020180,,,0,,,
7411,7411,Lg. Frei Heitor Pinto,,38.75429670,-9.13888580,,,0,,,
8716,8716,Tribunal Monsanto,,38.73296270,-9.19192180,,,0,,,
8706,8706,Monsanto,,38.73256770,-9.18975780,,,0,,,
2124,2124,Campo Sta. Clara,,38.71578640,-9.12386410,,,0,,,
2114,2114,Estao Sta. Apolnia,,38.71353560,-9.12280570,,,0,,,
2104,2104,R. Bica Sapato,,38.71689510,-9.12071630,,,0,,,
9906,9906,Sta. Catarina,,38.71101590,-9.14692770,,,0,,,
3020,3020,R. Bernardino Machado,,38.74361470,-9.21966280,,,0,,,
3010,3010,P. Marqus Minas,,38.74412570,-9.21990180,,,0,,,
6132,6132,B. C. Mestres - Rua 12,,38.72799070,-9.17039280,,,0,,,
6122,6122,R. Campolide,,38.72932270,-9.16243680,,,0,,,
6112,6112,B. C. Mestres - Rua 5,,38.72627270,-9.16754480,,,0,,,
9706,9706,R. D. Constantino Bragana,,38.70637170,-9.21605780,,,0,,,
6102,6102,Campolide,,38.72704460,-9.16237650,,,0,,,
9716,9716,R. S. Francisco Xavier,,38.69877870,-9.21783480,,,0,,,
8319,8319,Xabregas,,38.72611270,-9.11348780,,,0,,,
8309,8309,Xabregas - R. Manuteno,,38.72671270,-9.10985250,,,0,,,
1401,1401,Igreja S. Sebastio Pedreira,,38.73181070,-9.15161080,,,0,,,
7102,7102,Conde Baro - Av. 24 Julho,,38.70639890,-9.14909280,,,0,,,
7112,7112,R. Instituto Industrial,,38.70835450,-9.15052050,,,0,,,
4501,4501,Sul e Sueste,,38.70852170,-9.13355480,,,0,,,
7226,7226,R. Jaime Lopes Dias,,38.77911290,-9.16570100,,,0,,,
7206,7206,Qta. Lavadeiras,,38.78433570,-9.16620680,,,0,,,
7216,7216,Qta. Moleirinha,,38.78432670,-9.16131880,,,0,,,
2411,2411,Passeio Adamastor,,38.75793970,-9.09630780,,,0,,,
2401,2401,Av. Mediterrneo,,38.76241170,-9.09846280,,,0,,,
5501,5501,P. Comrcio,,38.70838020,-9.13636430,,,0,,,
33103,33103,Hosp. Curry Cabral,,38.74062720,-9.15439380,,,0,,,
33102,33102,Av. Berna (Rego),,38.73981270,-9.15165080,,,0,,,
33101,33101,Av. Berna (Rego),,38.73976070,-9.15121180,,,0,,,
1102,1102,Av. Liberdade,,38.72024970,-9.14571480,,,0,,,
6501,6501,Estefnia,,38.73212470,-9.14105080,,,0,,,
4210,4210,Algs,,38.69846150,-9.22747910,,,0,,,
1206,1206,Mq. Pombal - Av. Fontes P. Melo,,38.72625940,-9.14975700,,,0,,,
4220,4220,Algs,,38.69948970,-9.22778980,,,0,,,
1216,1216,Mq. Pombal - R. Alexandre Herculano,,38.72267570,-9.14938080,,,0,,,
7407,7407,Av. Sta. Joana Princesa,,38.75459470,-9.13637880,,,0,,,
8718,8718,B. Monsanto,,38.73271270,-9.19360280,,,0,,,
8708,8708,Luneta Quartis,,38.73145770,-9.19745780,,,0,,,
2132,2132,Estao Sta. Apolnia,,38.71420250,-9.12210060,,,0,,,
2122,2122,R. Paraso,,38.71386470,-9.12470580,,,0,,,
4304,4304,Cruz Quebrada,,38.70186570,-9.25134280,,,0,,,
7521,7521,R. Cidade Nampula,,38.76430970,-9.12045480,,,0,,,
7501,7501,Av. Brasil (Rot. Relgio),,38.76241070,-9.13008280,,,0,,,
8010,8010,Terramotos,,38.72155970,-9.16719580,,,0,,,
8030,8030,Campo Ourique (Prazeres),,38.71400570,-9.16926370,,,0,,,
2216,2216,R. Fernando Palha,,38.74721470,-9.09930480,,,0,,,
8020,8020,Campo Ourique (Igreja),,38.71537470,-9.16790880,,,0,,,
2206,2206,Vale Formoso Cima,,38.74944970,-9.10481080,,,0,,,
6128,6128,R. Artilharia Um,,38.72669370,-9.15857080,,,0,,,
6118,6118,Palcio Justia,,38.73114370,-9.15608080,,,0,,,
6108,6108,C. Mestres,,38.72692570,-9.16497780,,,0,,,
3102,3102,Estao Damaia,,38.74828530,-9.21654840,,,0,,,
8114,8114,Estrela (Baslica),,38.71386870,-9.16059680,,,0,,,
8104,8104,Jardim Estrela,,38.71577570,-9.15957580,,,0,,,
1407,1407,Av. Visconde Valmor,,38.73752270,-9.14951280,,,0,,,
9104,9104,R. Penha Frana,,38.72388070,-9.12937580,,,0,,,
9114,9114,R. Afonso Domingues,,38.72064970,-9.12455580,,,0,,,
9124,9124,R. Leite Vasconcelos,,38.71762640,-9.12506770,,,0,,,
9134,9134,R. Castelo Branco Saraiva,,38.72607370,-9.12551980,,,0,,,
4507,4507,Sul e Sueste,,38.70738550,-9.13305900,,,0,,,
1501,1501,B. Azul (Gulbenkian),,38.73671170,-9.15579880,,,0,,,
7220,7220,Sr. Roubado (Metro),,38.78583470,-9.17211180,,,0,,,
1511,1511,Av. Calouste Gulbenkian (Viaduto),,38.73616870,-9.16020780,,,0,,,
7210,7210,Qta. Alcoutins,,38.77949810,-9.17224220,,,0,,,
2407,2407,Hosp. Descobertas,,38.75716570,-9.09811470,,,0,,,
7304,7304,Qta. Sto. Antnio,,38.75190270,-9.13081280,,,0,,,
5805,5805,Campo Grande Norte,,38.75808670,-9.15344470,,,0,,,
5815,5815,Inst. Ricardo Jorge,,38.76705970,-9.16407880,,,0,,,
5825,5825,Campo Grande (Metro),,38.76049970,-9.15598180,,,0,,,
5835,5835,R. Manuel Marques,,38.76631470,-9.15417380,,,0,,,
2511,2511,R. Caribe,,38.76597770,-9.09817280,,,0,,,
8441,8441,Sport Lisboa Olivais,,38.76152170,-9.10828580,,,0,,,
5601,5601,Igreja Sta. Maria Madalena,,38.71005070,-9.13526480,,,0,,,
8401,8401,Av. Cidade L. Marques S,,38.76267670,-9.11938080,,,0,,,
8421,8421,C. Comercial Olivais,,38.76160720,-9.11366390,,,0,,,
6825,6825,Rato,,38.72035370,-9.15365980,,,0,,,
6815,6815,R. Custdio Vieira,,38.72032970,-9.15904580,,,0,,,
6805,6805,Rato,,38.71983670,-9.15506380,,,0,,,
1220,1220,Marqus Pombal,,38.72616070,-9.15024350,,,0,,,
2128,2128,Estao Sta. Apolnia (Mercadorias),,38.71679970,-9.11915180,,,0,,,
2118,2118,Estao Sta. Apolnia,,38.71379880,-9.12253640,,,0,,,
2108,2108,R. Washington,,38.71823570,-9.12123080,,,0,,,
6611,6611,Gomes Freire - R. Joaquim Bonifcio,,38.72734470,-9.14203880,,,0,,,
9401,9401,Alcntara,,38.70685570,-9.17360680,,,0,,,
6601,6601,Av. Duque Loul,,38.72792870,-9.14515080,,,0,,,
9411,9411,Qta. Cabrinha - Av. Ceuta,,38.71292900,-9.17535240,,,0,,,
9421,9421,R. Possidnio Silva,,38.71042770,-9.17132280,,,0,,,
9431,9431,Alcntara (R. Costa),,38.70689970,-9.17266880,,,0,,,
7825,7825,Estao Oriente,,38.76717840,-9.09909230,,,0,,,
7805,7805,Estao Oriente,,38.76847770,-9.09882980,,,0,,,
7507,7507,Qta. Narigo,,38.75791670,-9.12992480,,,0,,,
7517,7517,P. Aeroporto,,38.76322270,-9.12859780,,,0,,,
2220,2220,Vale Formoso Cima,,38.75043970,-9.10439080,,,0,,,
2210,2210,B. Prodac,,38.74674370,-9.10686980,,,0,,,
7601,7601,Aeroporto,,38.76783370,-9.12870780,,,0,,,
7611,7611,Externato Champagnat,,38.77785570,-9.12683880,,,0,,,
8112,8112,Estrela (Baslica),,38.71372170,-9.16022880,,,0,,,
8102,8102,Estrela,,38.71328070,-9.16216980,,,0,,,
2324,2324,Av. Inf. D. Henrique / Av. Berlim,,38.76657570,-9.10436980,,,0,,,
2314,2314,Rot. Cabo Ruivo,,38.75598610,-9.10426970,,,0,,,
2304,2304,Rot. Cabo Ruivo,,38.75634730,-9.10454250,,,0,,,
8206,8206,Chafariz Dentro (Museu Fado),,38.71109870,-9.12797980,,,0,,,
9102,9102,P. Antnio Sardinha,,38.72597470,-9.12993780,,,0,,,
9112,9112,R. Sapadores,,38.72108270,-9.12703680,,,0,,,
9122,9122,R. Sra. Glria,,38.71804570,-9.12740480,,,0,,,
9132,9132,Sapadores,,38.72180170,-9.12875480,,,0,,,
3304,3304,R. Beneficncia,,38.74397170,-9.15808680,,,0,,,
3314,3314,Qta. Freiras,,38.74381740,-9.15451410,,,0,,,
1805,1805,Av. Repblica,,38.73834520,-9.14581550,,,0,,,
1507,1507,Av. Madame Curie,,38.73833770,-9.16195680,,,0,,,
1517,1517,P. Espanha (Pq. Urbano),,38.73718620,-9.15783080,,,0,,,
9206,9206,Hosp. Sto. Antnio Capuchos,,38.72257270,-9.14154380,,,0,,,
1601,1601,R. Dr. Antnio Granjo,,38.73883870,-9.16460680,,,0,,,
1621,1621,Estao Sete Rios,,38.74056770,-9.16740380,,,0,,,
1631,1631,R. Baslio Teles,,38.73817320,-9.16383080,,,0,,,
5803,5803,Campo Grande Norte,,38.75911470,-9.15567680,,,0,,,
5813,5813,Av. Rainha D. Amlia,,38.76677460,-9.16065580,,,0,,,
5823,5823,Inst. Ricardo Jorge,,38.76256270,-9.16360980,,,0,,,
5833,5833,Qta. Lambert - R. Agostinho Neto,,38.76295170,-9.15349480,,,0,,,
2815,2815,Trav. Sargento Ablio,,38.74241370,-9.20076280,,,0,,,
2805,2805,Estao Benfica,,38.74471070,-9.19884580,,,0,,,
5905,5905,Lumiar (Estr. Torre),,38.77379470,-9.16139080,,,0,,,
5915,5915,Lumiar - Av. Padre Cruz,,38.77450070,-9.16378280,,,0,,,
5925,5925,R. Prof. M. Valadares,,38.77560710,-9.16072840,,,0,,,
5935,5935,INETI,,38.76904670,-9.17924580,,,0,,,
5945,5945,Hosp. Foras Armadas,,38.76891770,-9.17424580,,,0,,,
8407,8407,Av. Mar. Gomes Costa (Poo Cortes),,38.75976470,-9.11676680,,,0,,,
8437,8437,Olivais (Centro Cvico),,38.76325270,-9.11735480,,,0,,,
8427,8427,R. Cons. Emdio Navarro (ISEL),,38.75710370,-9.11660280,,,0,,,
6823,6823,Jardim Amoreiras,,38.72151870,-9.15653580,,,0,,,
6813,6813,Rato - R. D. Joo V,,38.72077070,-9.15631480,,,0,,,
3825,3825,R. Alecrim,,38.70759470,-9.14334080,,,0,,,
6803,6803,Av. lvares Cabral,,38.71769370,-9.15716380,,,0,,,
3805,3805,Cais Sodr,,38.70532470,-9.14390980,,,0,,,
5701,5701,Cidade Universitria,,38.75385470,-9.15651380,,,0,,,
8511,8511,Amoreiras,,38.72386970,-9.16057480,,,0,,,
8501,8501,Amoreiras,,38.72438590,-9.16103790,,,0,,,
6905,6905,Hosp. D. Estefnia,,38.72761670,-9.13977480,,,0,,,
9407,9407,R. Capito Afonso Pala,,38.70894350,-9.17147510,,,0,,,
9417,9417,Alcntara,,38.70627970,-9.17337980,,,0,,,
9427,9427,R. Alvito,,38.70750770,-9.17518180,,,0,,,
3601,3601,Lg. Chelas,,38.73983170,-9.11783280,,,0,,,
3611,3611,B. Armador,,38.74708790,-9.11875400,,,0,,,
7823,7823,Av. Boa Esperana,,38.77450270,-9.09708880,,,0,,,
7803,7803,Olivais Velho - Av. Inf. D. Henrique,,38.77004370,-9.10431780,,,0,,,
7813,7813,Estao Oriente (Interface),,38.76757570,-9.09998080,,,0,,,
6721,6721,C. Estrela,,38.71222370,-9.15513480,,,0,,,
9501,9501,Hosp. Egas Moniz - Av. India,,38.69742770,-9.18814480,,,0,,,
9511,9511,R. Junqueira (Centro Congressos),,38.70000670,-9.18342580,,,0,,,
6701,6701,Assembleia Repblica,,38.71100870,-9.15349980,,,0,,,
7905,7905,R. Laureano Oliveira,,38.77697570,-9.10174140,,,0,,,
7915,7915,R. Pe. Joaquim Alves Correia,,38.77271850,-9.10279810,,,0,,,
8108,8108,R. Domingos Sequeira,,38.71510770,-9.16302880,,,0,,,
7721,7721,P. Casas Novas,,38.77291970,-9.11312980,,,0,,,
7731,7731,Av. Cidade L. Marques N,,38.76816370,-9.11978380,,,0,,,
7701,7701,Av. Cidade L. Marques N,,38.76740970,-9.11931180,,,0,,,
7711,7711,Av. Berlim / Tv. Courelas,,38.76769270,-9.10583480,,,0,,,
9108,9108,Av. General Roadas,,38.72488670,-9.12861480,,,0,,,
9118,9118,Sapadores,,38.72128870,-9.12918980,,,0,,,
9128,9128,Sapadores,,38.72134370,-9.12989480,,,0,,,
1803,1803,Saldanha,,38.73392820,-9.14534480,,,0,,,
8314,8314,Av. Inf. D. Henrique (Beato ID),,38.73130350,-9.10552200,,,0,,,
8304,8304,Xabregas,,38.72825870,-9.10964080,,,0,,,
9210,9210,Campo Mrtires Ptria,,38.72239770,-9.13960880,,,0,,,
1905,1905,Campo Pequeno,,38.74356170,-9.14485580,,,0,,,
1915,1915,Campo Pequeno - Av. Berna,,38.74113070,-9.14725780,,,0,,,
2813,2813,R. Jos Augusto Seabra,,38.74417870,-9.20023680,,,0,,,
9304,9304,R. Correia Teles,,38.71875770,-9.17128180,,,0,,,
2803,2803,R. Gen. Morais Sarmento,,38.74731770,-9.19774480,,,0,,,
1701,1701,Av. Fontes P. Melo,,38.72878270,-9.14775780,,,0,,,
1711,1711,P. Jos Fontana,,38.73041670,-9.14364280,,,0,,,
5903,5903,Qta. Conchas,,38.77034370,-9.15970480,,,0,,,
5913,5913,Castanheira Moura,,38.77418470,-9.15686180,,,0,,,
5923,5923,C. Carriche / Estr. Militar,,38.77810470,-9.16423580,,,0,,,
5933,5933,Az. S. Gonalo,,38.78186870,-9.15696180,,,0,,,
5943,5943,R. Prof. Orlando Ribeiro,,38.77032470,-9.17076680,,,0,,,
5953,5953,R. F. Lopes Graa / R. Csar Oliveira,,38.76920050,-9.17149080,,,0,,,
2905,2905,B. Sta. Cruz,,38.74770870,-9.20702480,,,0,,,
4001,4001,Alcntara - Av. 24 Julho,,38.70414820,-9.17381780,,,0,,,
3823,3823,Corpo Santo,,38.70695280,-9.14158490,,,0,,,
3803,3803,Cais Sodr,,38.70624670,-9.14501880,,,0,,,
8845,8845,Alto Zambujal,,38.73646670,-9.21275780,,,0,,,
8815,8815,Estr. Alfragide,,38.74075870,-9.20889280,,,0,,,
8835,8835,Estr. Buraca,,38.74163770,-9.20281580,,,0,,,
8517,8517,R. Amoreiras,,38.72321870,-9.16011580,,,0,,,
8507,8507,Cruz Almas,,38.72534770,-9.16362580,,,0,,,
2711,2711,Tarujo,,38.73496000,-9.16508340,,,0,,,
2701,2701,Estao Campolide,,38.73136370,-9.16853310,,,0,,,
6903,6903,Hosp. D. Estefnia,,38.72947470,-9.14048780,,,0,,,
3905,3905,Cais Rocha (Museu Nac. Arte Antiga),,38.70350970,-9.16272480,,,0,,,
3915,3915,Santos-o-Velho,,38.70694820,-9.15817080,,,0,,,
8611,8611,R. Arco Carvalho,,38.72282470,-9.16680880,,,0,,,
8601,8601,Av. Ceuta (Viveiros),,38.72297670,-9.17484580,,,0,,,
9805,9805,R. Madre Deus,,38.72285770,-9.11509180,,,0,,,
9825,9825,C. Cruz Pedra,,38.72038770,-9.11810180,,,0,,,
9507,9507,R. Pinto Ferreira,,38.69801970,-9.19053380,,,0,,,
3721,3721,R. A. Jos Pessoa,,38.74160470,-9.10787680,,,0,,,
3701,3701,R. Dinah Silveira Queiroz,,38.74073970,-9.11191080,,,0,,,
3711,3711,B. Salgadas,,38.73840870,-9.11315080,,,0,,,
7903,7903,Moscavide Centro - R. Franc. M. Beato,,38.77963770,-9.10249880,,,0,,,
6031,6031,Vale Castanheira,,38.78059070,-9.14819580,,,0,,,
6021,6021,Av. Dr. Jos Salvado Sampaio,,38.78029470,-9.15321780,,,0,,,
6011,6011,Igreja Charneca,,38.78341270,-9.14262380,,,0,,,
9601,9601,C. Galvo,,38.70068670,-9.20299580,,,0,,,
6001,6001,R. Joo Amaral,,38.78730070,-9.14916180,,,0,,,
9611,9611,Mosteiro Jernimos,,38.69795270,-9.20451380,,,0,,,
7001,7001,R. Baro Sabrosa,,38.73520570,-9.12896380,,,0,,,
7011,7011,P. Paiva Couceiro / R. Morais Soares,,38.73211770,-9.12829080,,,0,,,
1903,1903,Campo Pequeno - Av. Repblica,,38.74278270,-9.14669080,,,0,,,
2903,2903,Benfica (Mercado),,38.75026070,-9.20742980,,,0,,,
1001,1001,Restauradores,,38.71569530,-9.14132250,,,0,,,
1011,1011,Restauradores,,38.71584110,-9.14145060,,,0,,,
8843,8843,B. Zambujal,,38.73873950,-9.21058110,,,0,,,
8813,8813,R. Venezuela,,38.74511270,-9.20273780,,,0,,,
8803,8803,Qta. Torres,,38.73322170,-9.20779780,,,0,,,
8823,8823,R. Creche,,38.74398970,-9.21106080,,,0,,,
4111,4111,Belm,,38.69712370,-9.20083280,,,0,,,
4101,4101,Estao Fluvial Belm,,38.69622470,-9.19833480,,,0,,,
3913,3913,Santos,,38.70665070,-9.15574780,,,0,,,
8915,8915,R. Frederico Perry Vidal,,38.73599770,-9.12227280,,,0,,,
8905,8905,R. Aquiles Machado,,38.73830070,-9.12470980,,,0,,,
2051,2051,Estao Entrecampos,,38.74537470,-9.14779880,,,0,,,
2021,2021,Estao Entrecampos,,38.74550870,-9.14739480,,,0,,,
2011,2011,Entrecampos,,38.74758390,-9.14785680,,,0,,,
2001,2001,Entrecampos,,38.74726350,-9.14779650,,,0,,,
4207,4207,Algs,,38.69928990,-9.22707790,,,0,,,
9803,9803,R. D. Fuas Roupinho,,38.72440870,-9.11738880,,,0,,,
9813,9813,C. Cruz Pedra,,38.72051570,-9.11686680,,,0,,,
9823,9823,Esc. Patricio Prazeres,,38.72129370,-9.11983180,,,0,,,
8711,8711,Estr. Oliveiras Baixo (Bombeiros),,38.72618270,-9.19628080,,,0,,,
8701,8701,Cruz Oliveiras,,38.72660070,-9.19374780,,,0,,,
9905,9905,Bica - R. S. Paulo,,38.70855140,-9.14680080,,,0,,,
3021,3021,Alto Damaia,,38.74349670,-9.21751380,,,0,,,
3001,3001,Av. Padre Himalaia,,38.74494870,-9.22171880,,,0,,,
3011,3011,P. Marqus Minas,,38.74380070,-9.22020380,,,0,,,
6131,6131,Alto Carvalho,,38.72592520,-9.16482880,,,0,,,
6121,6121,R. Campolide,,38.73060810,-9.16230310,,,0,,,
6111,6111,B. C. Mestres - Rua 10,,38.72944370,-9.16706980,,,0,,,
6101,6101,Campolide,,38.72759970,-9.16177780,,,0,,,
9711,9711,Av. D. Vasco Gama,,38.70140470,-9.21677880,,,0,,,
7101,7101,Conde Baro - Av. 24 Julho,,38.70631240,-9.14852790,,,0,,,
7111,7111,R. Poo Negros,,38.70980570,-9.15172280,,,0,,,
7227,7227,R. Jaime Lopes Dias,,38.77887360,-9.16542210,,,0,,,
7207,7207,C. Carriche / Estr. Desvio,,38.78295940,-9.16472130,,,0,,,
7217,7217,Estr. Desvio / R. Prof. J. Pinto Correia,,38.78198370,-9.16281780,,,0,,,
5510,5510,R. Ouro,,38.71046770,-9.13855680,,,0,,,
8913,8913,Olaias (Piscina),,38.73989070,-9.12368980,,,0,,,
8903,8903,R. Prof. Mira Fernandes,,38.73807170,-9.12340080,,,0,,,
8923,8923,R. Eng. Maciel Chaves,,38.73632970,-9.12377380,,,0,,,
4211,4211,Algs,,38.69896470,-9.22717280,,,0,,,
4201,4201,Algs,,38.69860580,-9.22725170,,,0,,,
4221,4221,R. Ferno Mendes Pinto,,38.69819770,-9.22552280,,,0,,,
1207,1207,Mq. Pombal - R. Braamcamp,,38.72413270,-9.15064080,,,0,,,
1217,1217,R. Sta. Marta,,38.72515770,-9.14619180,,,0,,,
10521,10521,Lg. Academia Nacional Belas Artes,,38.70803970,-9.13989480,,,0,,,
10522,10522,Lg. Carmo - Sta. Justa,,38.71192520,-9.14094610,,,0,,,
2131,2131,C. Sta. Apolnia,,38.71777870,-9.11901280,,,0,,,
2111,2111,Estao Sta. Apolnia,,38.71399420,-9.12191920,,,0,,,
2101,2101,Estao Sta. Apolnia,,38.71427750,-9.12283010,,,0,,,
9903,9903,C. Combro,,38.71097470,-9.14948080,,,0,,,
4307,4307,Cruz Quebrada,,38.70197140,-9.25147600,,,0,,,
7520,7520,R. Cidade Joo Belo,,38.76348470,-9.12280380,,,0,,,
8011,8011,Terramotos,,38.72152740,-9.16713130,,,0,,,
8001,8001,R. Saraiva Carvalho,,38.71532370,-9.16459680,,,0,,,
8021,8021,R. Almeida Sousa,,38.71757270,-9.16636580,,,0,,,
2217,2217,Av. Paulo VI,,38.74805370,-9.10807180,,,0,,,
2207,2207,Estao Brao Prata,,38.74709670,-9.10496580,,,0,,,
3101,3101,Damaia - R. D. Francisco Almeida,,38.75051070,-9.21304480,,,0,,,
9001,9001,Alto Pina,,38.73756170,-9.12772180,,,0,,,
10723,10723,B. Calhau,,38.73927670,-9.17761780,,,0,,,
10722,10722,Palcio Marqus Fronteira,,38.74053400,-9.17999700,,,0,,,
10721,10721,Palcio Marqus Fronteira,,38.74038250,-9.18018920,,,0,,,
10720,10720,Mercado S. Domingos Benfica,,38.74399170,-9.18029020,,,0,,,
10726,10726,Pq. Recreativo Alto Serafina,,38.73586070,-9.17964780,,,0,,,
10724,10724,Hosp. Lusadas,,38.74962130,-9.17882930,,,0,,,
7221,7221,Alto Chapeleiro,,38.78767470,-9.16358180,,,0,,,
1510,1510,Av. Madame Curie,,38.73815870,-9.16183880,,,0,,,
7201,7201,Qta. Alcoutins,,38.78035410,-9.17232420,,,0,,,
7211,7211,Sr. Roubado,,38.78695170,-9.17041180,,,0,,,
7307,7307,Qta. Sto. Antnio,,38.75260270,-9.13045480,,,0,,,
1201,1201,Mq. Pombal - Av. Duque Loul,,38.72605220,-9.14762980,,,0,,,
1211,1211,Mq. Pombal - R. Alexandre Herculano,,38.72292470,-9.14925980,,,0,,,
1221,1221,Marqus Pombal,,38.72542540,-9.15151450,,,0,,,
6612,6612,P. Jos Fontana,,38.72865900,-9.14459800,,,0,,,
6602,6602,Av. Duque Loul,,38.72783590,-9.14564310,,,0,,,
4301,4301,Cruz Quebrada (Fac. Motricidade Humana),,38.70517070,-9.25252180,,,0,,,
14730,14730,Av. Avelino Teixeira Mota (CERCI),,38.75212570,-9.12085080,,,0,,,
2211,2211,Av. Paulo VI,,38.74828170,-9.10792780,,,0,,,
2201,2201,Fbrica Gs,,38.75031170,-9.09632080,,,0,,,
10321,10321,Palcio Nacional Ajuda,,38.70746570,-9.19897680,,,0,,,
10320,10320,R. Cruzeiro,,38.70921170,-9.19462080,,,0,,,
7602,7602,Aeroporto,,38.76896370,-9.12797180,,,0,,,
7612,7612,Externato Champagnat,,38.77780270,-9.12706680,,,0,,,
8111,8111,Estrela (Baslica),,38.71364170,-9.16005480,,,0,,,
8101,8101,Estrela,,38.71316570,-9.16201780,,,0,,,
2307,2307,Gs Portugal,,38.75349970,-9.09613680,,,0,,,
9101,9101,P. Antnio Sardinha,,38.72589270,-9.13005580,,,0,,,
9111,9111,R. Sapadores,,38.72122870,-9.12717980,,,0,,,
9121,9121,R. Leite Vasconcelos,,38.71771570,-9.12500980,,,0,,,
9131,9131,R. Graa,,38.71922270,-9.12987380,,,0,,,
3307,3307,R. Cardeal Mercier,,38.74154570,-9.15971580,,,0,,,
9207,9207,Campo Santana,,38.72291370,-9.14032880,,,0,,,
1602,1602,R. Dr. Antnio Granjo,,38.73864170,-9.16458580,,,0,,,
1612,1612,Sete Rios,,38.74233870,-9.16787160,,,0,,,
7301,7301,Av. Estados Unidos Amrica,,38.74898570,-9.13288480,,,0,,,
10828,10828,R. Augusto Pina,,38.74964770,-9.18619280,,,0,,,
10829,10829,Pupilos Exrcito,,38.74669770,-9.18458880,,,0,,,
5904,5904,Qta. Conchas,,38.77024370,-9.15989380,,,0,,,
5914,5914,Az. Poo Baixo,,38.77263070,-9.17041980,,,0,,,
10824,10824,R. Prof. Reinaldo Santos,,38.74781570,-9.18848980,,,0,,,
5924,5924,R. Prof. M. Valadares,,38.77558700,-9.16055460,,,0,,,
10825,10825,R. Augusto Pina,,38.74950470,-9.18561480,,,0,,,
5934,5934,Az. Torre Fato,,38.77010870,-9.17759380,,,0,,,
10826,10826,R. Prof. Reinaldo Santos,,38.74735720,-9.18897380,,,0,,,
5944,5944,R. Prof. Orlando Ribeiro,,38.77055470,-9.17052880,,,0,,,
10827,10827,Colgio Militar (Metro),,38.75173370,-9.18759380,,,0,,,
5954,5954,Pao Lumiar,,38.76940770,-9.17361380,,,0,,,
10820,10820,Colgio Militar (Metro),,38.75253470,-9.18944180,,,0,,,
10821,10821,R. Prof. Reinaldo Santos,,38.74703370,-9.18870980,,,0,,,
10822,10822,Calhariz - R. Ten. Coronel Ribeiro Reis,,38.74627570,-9.18981780,,,0,,,
10823,10823,Colgio Militar (Metro),,38.75273170,-9.18934680,,,0,,,
8510,8510,Amoreiras,,38.72400370,-9.15978180,,,0,,,
8520,8520,Amoreiras (C. Comercial),,38.72242660,-9.16114870,,,0,,,
6904,6904,Hosp. D. Estefnia,,38.72953270,-9.14035480,,,0,,,
3602,3602,Lg. Chelas,,38.74002170,-9.11749780,,,0,,,
3612,3612,Bela Vista,,38.74897770,-9.11617980,,,0,,,
1301,1301,Av. Antnio Augusto Aguiar,,38.72913270,-9.14931580,,,0,,,
6720,6720,C. Estrela / R. Borges Carneiro,,38.71238270,-9.15534620,,,0,,,
9510,9510,Tv. Artur Lamas,,38.70012470,-9.19182380,,,0,,,
7904,7904,Moscavide Centro - R. Franc. M. Beato,,38.77963450,-9.10443000,,,0,,,
2311,2311,Av. Inf. D. Henrique (Centieira),,38.75950270,-9.10331380,,,0,,,
2301,2301,Av. Mar. Gomes Costa (Universidade),,38.75731870,-9.10866080,,,0,,,
7720,7720,P. Casas Novas,,38.77255970,-9.11368480,,,0,,,
7710,7710,Av. Berlim / Av. Cidade Luanda,,38.76839270,-9.11160780,,,0,,,
8201,8201,Alfndega (Terminal Cruzeiros),,38.71060080,-9.12730580,,,0,,,
10927,10927,R. Pedralvas,,38.75393270,-9.20617480,,,0,,,
10926,10926,R. Pedralvas,,38.75397550,-9.20609130,,,0,,,
10921,10921,Benfica - Av. Gro Vasco,,38.75013970,-9.20322780,,,0,,,
10920,10920,Benfica - Av. Gro Vasco,,38.74993770,-9.20304280,,,0,,,
10922,10922,Benfica - Al. Pe. lv. Proena,,38.74893730,-9.20293950,,,0,,,
3301,3301,R. Beneficncia (Rego),,38.74168670,-9.15616480,,,0,,,
3311,3311,Av. lvaro Pais,,38.74533670,-9.15241180,,,0,,,
8317,8317,C. Grilo,,38.73000670,-9.10869780,,,0,,,
8307,8307,Al. Beato,,38.73310070,-9.10553380,,,0,,,
9201,9201,Pao Rainha,,38.72362670,-9.13774080,,,0,,,
9211,9211,Campo Santana,,38.72365970,-9.13984180,,,0,,,
1904,1904,Campo Pequeno - Av. Defensores Chaves,,38.74179570,-9.14423780,,,0,,,
1914,1914,Campo Pequeno - Av. Berna,,38.74128620,-9.14769100,,,0,,,
9307,9307,R. Guilherme Anjos,,38.71854370,-9.17163380,,,0,,,
1710,1710,P. Jos Fontana,,38.72953670,-9.14356180,,,0,,,
2904,2904,Benfica (Mercado),,38.74985690,-9.20662380,,,0,,,
2720,2720,R. C (B. Liberdade),,38.73535270,-9.17172080,,,0,,,
2710,2710,Tarujo,,38.73479680,-9.16515870,,,0,,,
8612,8612,R. Garcia,,38.72382270,-9.16654180,,,0,,,
8602,8602,Av. Ceuta (Viveiros),,38.72347170,-9.17489380,,,0,,,
3720,3720,Av. Paulo VI / R. Jos Patrocnio,,38.74437170,-9.11092280,,,0,,,
3710,3710,Av. Joo Paulo II,,38.74737670,-9.11044780,,,0,,,
9602,9602,C. Galvo,,38.70030170,-9.20304480,,,0,,,
94904,94904,Linda-a-Velha,,38.71603170,-9.23566280,,,0,,,
8311,8311,Av. Inf. D. Henrique (Doca Xabregas),,38.72898670,-9.10701580,,,0,,,
8301,8301,Ponte Xabregas,,38.72641660,-9.11165910,,,0,,,
94901,94901,Av. Jos Gomes Ferreira,,38.71507520,-9.23167880,,,0,,,
8321,8321,Mercado Xabregas,,38.72778670,-9.11467480,,,0,,,
94903,94903,Linda-a-Velha,,38.71583570,-9.23564980,,,0,,,
94902,94902,Av. Jos Gomes Ferreira,,38.71490320,-9.23165880,,,0,,,
9301,9301,Meia Laranja,,38.71581870,-9.17277580,,,0,,,
8914,8914,P. Scrates Costa,,38.73504770,-9.12181980,,,0,,,
8904,8904,C. Picheleira,,38.73741270,-9.12421080,,,0,,,
9904,9904,C. Combro,,38.71103170,-9.14983480,,,0,,,
9710,9710,R. Alto Duque,,38.70088470,-9.22129880,,,0,,,
14602,14602,Portagem (Cristo-Rei),,38.67428370,-9.17331780,,,0,,,
14601,14601,Portagem (Cristo-Rei),,38.67381670,-9.17399880,,,0,,,
7306,7306,R. Guilhermina Suggia,,38.74798370,-9.13246780,,,0,,,
14005,14005,Pq. Campismo,,38.72773070,-9.20903080,,,0,,,
14006,14006,Pq. Campismo,,38.72792770,-9.20929380,,,0,,,
14007,14007,Pq. Campismo (Receo),,38.72455670,-9.20801080,,,0,,,
14008,14008,Pq. Campismo,,38.72804570,-9.20935380,,,0,,,
14703,14703,R. Luis Cristino Silva,,38.75811970,-9.12292280,,,0,,,
14702,14702,R. Ades Bermudes,,38.75620770,-9.12070980,,,0,,,
14701,14701,R. Ades Bermudes,,38.75676340,-9.12164920,,,0,,,
14707,14707,Esc. Damio Gis,,38.75739770,-9.12653980,,,0,,,
14706,14706,B. Loios,,38.75912470,-9.12479680,,,0,,,
14705,14705,B. Loios,,38.75925870,-9.12470880,,,0,,,
14704,14704,R. Luis Cristino Silva,,38.75790570,-9.12317880,,,0,,,
14708,14708,Esc. Damio Gis,,38.75762470,-9.12636980,,,0,,,
2336,2336,R. Almada Negreiros,,38.76056170,-9.10597480,,,0,,,
2316,2316,Gs Portugal,,38.75389970,-9.09599480,,,0,,,
14105,14105,R. Rio Tejo,,38.77097870,-9.18896780,,,0,,,
14104,14104,Serra Luz,,38.77197870,-9.19019880,,,0,,,
14107,14107,B. Padre Cruz,,38.76954370,-9.18970880,,,0,,,
3306,3306,B. Santos,,38.74534370,-9.15702850,,,0,,,
14106,14106,R. Rio Tejo,,38.77107770,-9.18923480,,,0,,,
14101,14101,Estr. Militar (Escorpies),,38.77099970,-9.19357680,,,0,,,
14103,14103,Serra Luz,,38.77222770,-9.19073280,,,0,,,
14102,14102,Estr. Militar (Escorpies),,38.77095870,-9.19339780,,,0,,,
14109,14109,Qta. Olival (C. Triagem),,38.77704270,-9.17449280,,,0,,,
14108,14108,B. Padre Cruz,,38.76954560,-9.18931450,,,0,,,
521,521,P. Chile,,38.73453270,-9.13501880,,,0,,,
522,522,P. Chile,,38.73314970,-9.13249080,,,0,,,
10838,10838,R. Carolina M. Vasc./ R. Jos P. Chaves,,38.74446760,-9.19225070,,,0,,,
10834,10834,Colgio Militar (Metro),,38.75261500,-9.18983230,,,0,,,
10835,10835,Esc. Pedro Santarm,,38.74979070,-9.19425480,,,0,,,
10830,10830,Pupilos Exrcito,,38.74681070,-9.18461180,,,0,,,
10831,10831,R. Carolina Michaelis Vasconcelos,,38.74446670,-9.19416980,,,0,,,
10832,10832,Colgio Militar (Metro),,38.75261270,-9.18956480,,,0,,,
10833,10833,Colgio Militar (Metro),,38.75279870,-9.18972180,,,0,,,
14307,14307,Miraflores Norte,,38.71418320,-9.22734080,,,0,,,
14306,14306,Al. Ferno Lopes (Estao Miraflores),,38.71500770,-9.22943180,,,0,,,
14305,14305,Al. Ferno Lopes (Estao Miraflores),,38.71463870,-9.22921980,,,0,,,
14301,14301,Miraflores,,38.71401980,-9.22545630,,,0,,,
14309,14309,Miraflores,,38.71326520,-9.22528880,,,0,,,
14308,14308,Miraflores Norte,,38.71446020,-9.22695180,,,0,,,
14804,14804,Graa,,38.71727570,-9.12989280,,,0,,,
8316,8316,C. Grilo,,38.72979070,-9.10860280,,,0,,,
14805,14805,Lg. Graa,,38.71601770,-9.13060080,,,0,,,
8306,8306,C. Grilo,,38.73018070,-9.10804880,,,0,,,
14806,14806,R. D. Monteiro / Lg. Graa,,38.71806070,-9.13041580,,,0,,,
14801,14801,Voz Operrio,,38.71507670,-9.12872380,,,0,,,
14802,14802,Voz Operrio,,38.71503870,-9.12882480,,,0,,,
14803,14803,Graa,,38.71722970,-9.12976380,,,0,,,
9306,9306,R. Costa Pimenta (Centro Social),,38.71705870,-9.17344380,,,0,,,
322,322,Estao Roma-Areeiro,,38.74556370,-9.13555280,,,0,,,
323,323,Av. Pe. Manuel Nbrega,,38.74298670,-9.13353380,,,0,,,
320,320,Estao Roma-Areeiro,,38.74557870,-9.13520280,,,0,,,
321,321,Estao Roma-Areeiro,,38.74558070,-9.13538880,,,0,,,
14908,14908,Aqurio Vasco Gama,,38.69927070,-9.23751080,,,0,,,
14905,14905,Dafundo,,38.70017930,-9.24077690,,,0,,,
14904,14904,Dafundo - R. 1. Maio,,38.70073670,-9.24473780,,,0,,,
16004,16004,Fonte Pipa,,38.79600170,-9.14936180,,,0,,,
14907,14907,Aqurio Vasco Gama,,38.69921130,-9.23753540,,,0,,,
16005,16005,Fonte Pipa,,38.79595170,-9.14951180,,,0,,,
14906,14906,Dafundo,,38.70024670,-9.24064480,,,0,,,
16006,16006,Az. Reguengo,,38.78841170,-9.14535780,,,0,,,
14901,14901,R. Bombeiros Voluntrios Dafundo,,38.70023970,-9.24649680,,,0,,,
16007,16007,Az. Reguengo,,38.78842770,-9.14524880,,,0,,,
14903,14903,Dafundo - R. 1. Maio,,38.70066770,-9.24430580,,,0,,,
16001,16001,Fetais,,38.79809690,-9.14541990,,,0,,,
14902,14902,R. Bombeiros Voluntrios Dafundo,,38.70035410,-9.24715700,,,0,,,
16002,16002,Az. Fetais,,38.79859200,-9.14757610,,,0,,,
16003,16003,Az. Fetais,,38.79870170,-9.14764480,,,0,,,
16008,16008,R. Cidade Luanda,,38.79048670,-9.14475580,,,0,,,
16009,16009,R. Cidade Luanda,,38.79085170,-9.14431180,,,0,,,
4308,4308,Cruz Quebrada (Fac. Motricidade Humana),,38.70536270,-9.25233880,,,0,,,
7308,7308,Av. Alm. Gago Coutinho / Av. EUA,,38.74800270,-9.13118880,,,0,,,
920,920,P. Figueira,,38.71310230,-9.13769880,,,0,,,
16307,16307,Qta. Francelha Baixo,,38.78823180,-9.12369140,,,0,,,
16306,16306,Qta. Francelha Cima,,38.78520980,-9.12431500,,,0,,,
16305,16305,Qta. Francelha Cima,,38.78586570,-9.12382880,,,0,,,
16304,16304,Rot. Encarnao,,38.78392570,-9.12478580,,,0,,,
16303,16303,Rot. Encarnao,,38.78356470,-9.12452980,,,0,,,
16302,16302,Rot. Encarnao,,38.78265170,-9.12520780,,,0,,,
16301,16301,Rot. Encarnao,,38.78236970,-9.12599780,,,0,,,
16309,16309,Prior Velho,,38.79011570,-9.12388180,,,0,,,
16308,16308,Qta. Francelha Baixo,,38.78830770,-9.12388180,,,0,,,
18125,18125,Av. Laranjeiras,,38.73735850,-9.22393000,,,0,,,
18124,18124,Av. Laranjeiras,,38.73744250,-9.22385760,,,0,,,
18127,18127,Av. Qta. Grande,,38.73963370,-9.22388380,,,0,,,
10401,10401,Caselas,,38.71695570,-9.21316080,,,0,,,
18126,18126,Av. Qta. Grande,,38.73951670,-9.22400480,,,0,,,
10402,10402,Fonte Caselas,,38.71579970,-9.21469780,,,0,,,
18121,18121,Av. Laranjeiras / Av. Qta. Grande,,38.73718770,-9.22133480,,,0,,,
10403,10403,Fonte Caselas,,38.71571770,-9.21479580,,,0,,,
18120,18120,Av. Laranjeiras / Av. Qta. Grande,,38.73735700,-9.22128740,,,0,,,
10404,10404,Caselas,,38.71699930,-9.21288750,,,0,,,
18123,18123,Av. Moinhos,,38.73680770,-9.22267180,,,0,,,
2328,2328,Rot. Cabo Ruivo,,38.75647840,-9.10297220,,,0,,,
10405,10405,Estr. Queluz,,38.71752350,-9.20987390,,,0,,,
18122,18122,Av. Moinhos,,38.73694770,-9.22257280,,,0,,,
10406,10406,Estr. Queluz,,38.71746370,-9.20952980,,,0,,,
18129,18129,Alfragide (Qta. Grande),,38.73550060,-9.21896490,,,0,,,
18128,18128,Alfragide Norte,,38.73946270,-9.22150480,,,0,,,
3308,3308,R. S. Pereira Gomes (Mercado),,38.74281070,-9.15850680,,,0,,,
10602,10602,Ascensor Glria,,38.71450470,-9.14434980,,,0,,,
10603,10603,R. Rosa / Trav. S. Pedro,,38.71490670,-9.14589180,,,0,,,
10601,10601,Ascensor Glria,,38.71491370,-9.14447380,,,0,,,
10606,10606,Prncipe Real,,38.71665970,-9.14851080,,,0,,,
10607,10607,R. Escola Politcnica,,38.71805160,-9.15182360,,,0,,,
10604,10604,S. Pedro Alcntara,,38.71545970,-9.14508880,,,0,,,
10605,10605,Prncipe Real,,38.71657470,-9.14810880,,,0,,,
10608,10608,R. Escola Politcnica,,38.71753970,-9.15104180,,,0,,,
10609,10609,Prncipe Real,,38.71652230,-9.14818010,,,0,,,
10501,10501,P. Luis Cames (B. Alto),,38.71115050,-9.14288140,,,0,,,
10503,10503,Lg. Trindade Coelho,,38.71318370,-9.14332880,,,0,,,
10502,10502,P. Luis Cames (B. Alto),,38.70994470,-9.14315080,,,0,,,
10505,10505,R. Rosa,,38.71270970,-9.14530980,,,0,,,
10504,10504,Lg. Trindade Coelho,,38.71255270,-9.14320780,,,0,,,
10507,10507,Bica - Lg. Calhariz,,38.71076760,-9.14579680,,,0,,,
10508,10508,P. Luis Cames (B. Alto),,38.71049250,-9.14386520,,,0,,,
10004,10004,Lapa,,38.71098670,-9.15847080,,,0,,,
10005,10005,R. Prior,,38.70674170,-9.16248380,,,0,,,
10006,10006,R. S. Domingos  Lapa,,38.70930770,-9.16170780,,,0,,,
10007,10007,R. Garcia Orta,,38.70727170,-9.16139980,,,0,,,
10001,10001,R. Santana  Lapa / R. Buenos Aires,,38.71033470,-9.16140780,,,0,,,
10003,10003,Lapa,,38.71120770,-9.15832380,,,0,,,
10008,10008,R. Garcia Orta,,38.70755470,-9.16135780,,,0,,,
10009,10009,R. S. Joo Mata,,38.70789070,-9.15908580,,,0,,,
10703,10703,B. Novo,,38.74433970,-9.17873680,,,0,,,
10702,10702,S. Domingos Benfica,,38.74570470,-9.18171980,,,0,,,
10701,10701,S. Domingos Benfica,,38.74556070,-9.18175480,,,0,,,
10707,10707,Esc. Delfim Santos,,38.74816270,-9.18095280,,,0,,,
10706,10706,R. Duarte Galvo,,38.74361570,-9.17551880,,,0,,,
10705,10705,R. Duarte Galvo,,38.74359770,-9.17613280,,,0,,,
10704,10704,B. Novo,,38.74459680,-9.17926640,,,0,,,
10709,10709,Alto Moinhos (Metro),,38.74935670,-9.18023180,,,0,,,
10708,10708,Esc. Delfim Santos,,38.74848670,-9.18165080,,,0,,,
10206,10206,Cova Moura,,38.70702670,-9.16762580,,,0,,,
10207,10207,P. Armada,,38.70497770,-9.17029180,,,0,,,
10204,10204,Av. Infante Santo,,38.70380670,-9.16823380,,,0,,,
10205,10205,Cova Moura,,38.70714770,-9.16739780,,,0,,,
10202,10202,Av. Infante Santo,,38.70350560,-9.16772470,,,0,,,
10203,10203,Av. Infante Santo,,38.70419270,-9.16795280,,,0,,,
10201,10201,Av. Infante Santo,,38.70340870,-9.16701780,,,0,,,
8308,8308,Al. Beato,,38.73275970,-9.10591980,,,0,,,
10208,10208,P. Armada,,38.70529600,-9.17066730,,,0,,,
10209,10209,Av. Infante Santo,,38.70458870,-9.16736080,,,0,,,
10105,10105,Fonte Santa,,38.71166550,-9.16933760,,,0,,,
10104,10104,Av. Inf. Santo / R. Santana  Lapa,,38.71139970,-9.16436580,,,0,,,
10107,10107,Esc. Josefa bidos,,38.71273270,-9.16694580,,,0,,,
10106,10106,Fonte Santa,,38.71199570,-9.16862380,,,0,,,
10101,10101,Av. Inf. Santo (Gasmetro),,38.70986970,-9.16585480,,,0,,,
10103,10103,Av. Inf. Santo / R. Santana  Lapa,,38.71202670,-9.16333780,,,0,,,
10102,10102,Av. Inf. Santo (Gasmetro),,38.70943370,-9.16667180,,,0,,,
9308,9308,R. Maria Pia,,38.71632970,-9.17263780,,,0,,,
10109,10109,Av. Inf. Santo / R. Santana  Lapa,,38.71185220,-9.16384960,,,0,,,
10108,10108,Esc. Josefa bidos,,38.71268470,-9.16646580,,,0,,,
11622,11622,Lg. Castelo,,38.79173570,-9.14732480,,,0,,,
11623,11623,R. Maluda,,38.79225670,-9.15325980,,,0,,,
11620,11620,Torrinha,,38.78812170,-9.15860880,,,0,,,
11621,11621,Lg. Castelo,,38.79161770,-9.14740780,,,0,,,
11624,11624,R. Maluda,,38.79201070,-9.15313380,,,0,,,
14713,14713,R. Ferreira Castro,,38.75416670,-9.12487880,,,0,,,
14712,14712,R. Ferreira Castro,,38.75448170,-9.12495980,,,0,,,
14711,14711,B. Flamenga,,38.75286070,-9.12342780,,,0,,,
14710,14710,Colgio Valsassina,,38.75545870,-9.12635880,,,0,,,
14717,14717,Pq. Bela Vista,,38.75027570,-9.12388380,,,0,,,
11521,11521,R. Luis Piarra,,38.77589270,-9.15083480,,,0,,,
14716,14716,R. Pedro Cruz,,38.75002200,-9.11985820,,,0,,,
11520,11520,R. Luis Piarra,,38.77590370,-9.15129480,,,0,,,
14715,14715,B. Flamenga,,38.75276270,-9.12359180,,,0,,,
11523,11523,Lumiar (Esc. Alto Lumiar),,38.77454360,-9.15537960,,,0,,,
14714,14714,Pq. Bela Vista,,38.75058670,-9.12391080,,,0,,,
11522,11522,Estao Alta Lisboa,,38.77485970,-9.14736380,,,0,,,
6404,6404,R. Augusto Gil,,38.74316170,-9.14048680,,,0,,,
10307,10307,R. Stio,,38.71089570,-9.19339780,,,0,,,
10306,10306,R. Cruzeiro,,38.70950870,-9.19470880,,,0,,,
10305,10305,R. Cruzeiro,,38.70966470,-9.19494380,,,0,,,
10304,10304,Lg. Ajuda (Palcio),,38.70756370,-9.19615680,,,0,,,
10303,10303,Lg. Ajuda (Palcio),,38.70775970,-9.19641480,,,0,,,
10302,10302,C. Ajuda (GNR),,38.70644770,-9.19905280,,,0,,,
10301,10301,C. Ajuda (GNR),,38.70638270,-9.19918880,,,0,,,
10309,10309,Casalinho Ajuda,,38.70919870,-9.19199580,,,0,,,
10308,10308,R. Stio,,38.71055870,-9.19344080,,,0,,,
7404,7404,Av. D. Rodrigo Cunha,,38.75485670,-9.13421580,,,0,,,
7414,7414,R. Conde Arnoso,,38.75549370,-9.13627680,,,0,,,
14115,14115,Cemitrio Carnide,,38.77325870,-9.18292180,,,0,,,
14114,14114,R. Rio Minho,,38.77134670,-9.18644380,,,0,,,
14117,14117,Qta. Olival (C. Triagem),,38.77679390,-9.17481000,,,0,,,
14116,14116,Cemitrio Carnide,,38.77305670,-9.18361980,,,0,,,
14111,14111,Mal Penteada,,38.76880270,-9.19580480,,,0,,,
14110,14110,Mal Penteada,,38.76893250,-9.19549100,,,0,,,
14113,14113,Serra Luz,,38.77243970,-9.19019280,,,0,,,
14112,14112,B. Padre Cruz,,38.76959470,-9.18962880,,,0,,,
14119,14119,Vale Forno,,38.77570070,-9.17810180,,,0,,,
14118,14118,Vale Forno,,38.77569270,-9.17834580,,,0,,,
12401,12401,R. Gregrio Lopes,,38.71157270,-9.21485780,,,0,,,
12402,12402,R. Gregrio Lopes,,38.71187870,-9.21416180,,,0,,,
12403,12403,Restelo - R. Anto Gonalves,,38.70893270,-9.21434480,,,0,,,
12404,12404,Restelo - Av. Descobertas,,38.70982370,-9.21497880,,,0,,,
12405,12405,Restelo (Torres) - R. Anto Gonalves,,38.70919970,-9.21145280,,,0,,,
12406,12406,Restelo (Torres) - R. Anto Gonalves,,38.70935070,-9.21156480,,,0,,,
12407,12407,Restelo - Av. Descobertas,,38.70970370,-9.21545280,,,0,,,
12408,12408,Restelo,,38.71132570,-9.21036780,,,0,,,
12409,12409,Restelo - Av. Descobertas,,38.70898660,-9.21339940,,,0,,,
1404,1404,S. Sebastio,,38.73351870,-9.15338380,,,0,,,
1414,1414,S. Sebastio,,38.73479170,-9.15235880,,,0,,,
10808,10808,Colgio Militar (Metro),,38.75246080,-9.18902550,,,0,,,
10809,10809,Estdio Luz,,38.75440070,-9.18512080,,,0,,,
10804,10804,Calhariz,,38.74959870,-9.19131180,,,0,,,
10805,10805,R. Prof. Reinaldo Santos,,38.74769670,-9.18836180,,,0,,,
10806,10806,Calhariz,,38.74911620,-9.19024000,,,0,,,
10807,10807,Calhariz,,38.74865210,-9.19116560,,,0,,,
10801,10801,Esc. Pedro Santarm,,38.74981470,-9.19436080,,,0,,,
4506,4506,Sul e Sueste,,38.70812470,-9.13327580,,,0,,,
10802,10802,Esc. Pedro Santarm,,38.75013990,-9.19558380,,,0,,,
10803,10803,Calhariz (Escola),,38.74827270,-9.19264980,,,0,,,
14312,14312,Esc. Miraflores,,38.71139310,-9.22572500,,,0,,,
14311,14311,Esc. Miraflores,,38.71108470,-9.22618480,,,0,,,
14310,14310,Miraflores,,38.71324620,-9.22508280,,,0,,,
2404,2404,Oceanrio Lisboa,,38.76127270,-9.09612180,,,0,,,
12602,12602,RALIS,,38.78091070,-9.12008880,,,0,,,
12603,12603,Qta. Morgado,,38.77937870,-9.12012580,,,0,,,
12601,12601,RALIS,,38.78165270,-9.11940980,,,0,,,
12607,12607,Portela - Av. Repblica,,38.78354570,-9.11561580,,,0,,,
12604,12604,Qta. Morgado,,38.77913370,-9.12016580,,,0,,,
12605,12605,RALIS,,38.78309240,-9.11738260,,,0,,,
12608,12608,Portela - Av. Repblica,,38.78361970,-9.11626480,,,0,,,
12501,12501,Fbrica Brao Prata,,38.74462570,-9.10101580,,,0,,,
12502,12502,Poo Bispo,,38.74246910,-9.10118500,,,0,,,
12505,12505,Beato,,38.73491070,-9.10469780,,,0,,,
12504,12504,Fbrica Brao Prata,,38.74494870,-9.10113780,,,0,,,
6506,6506,Estefnia - Av. Casal Ribeiro,,38.73190770,-9.14200080,,,0,,,
12506,12506,Beato,,38.73468570,-9.10511480,,,0,,,
12509,12509,Palcio Mitra,,38.73968270,-9.10286280,,,0,,,
11321,11321,Hosp. Jlio Matos,,38.75635570,-9.14694380,,,0,,,
10909,10909,Estr. Arneiros,,38.75420670,-9.19776580,,,0,,,
10908,10908,Estr. Benfica / Av. Gomes Pereira,,38.74930070,-9.19766680,,,0,,,
10905,10905,Estr. Benfica / Av. Gomes Pereira,,38.75065290,-9.19846750,,,0,,,
10904,10904,Igreja Benfica,,38.75083670,-9.20173080,,,0,,,
12004,12004,R. Luis Cames,,38.70453170,-9.18304280,,,0,,,
10907,10907,Estr. Benfica / Av. Gomes Pereira,,38.75013980,-9.19746580,,,0,,,
12005,12005,R. Luis Cames,,38.70410770,-9.18276580,,,0,,,
10906,10906,Estr. Benfica / Av. Gomes Pereira,,38.75078970,-9.19861280,,,0,,,
12006,12006,Alto Sto. Amaro,,38.70512270,-9.18765180,,,0,,,
10901,10901,Estr. Benfica (Mercado),,38.75202270,-9.20550980,,,0,,,
12007,12007,Alto Sto. Amaro,,38.70490070,-9.18742280,,,0,,,
10903,10903,Igreja Benfica,,38.75061670,-9.20144980,,,0,,,
7506,7506,Av. Mar. Gomes Costa (Qta. Teresinhas),,38.76171270,-9.12208580,,,0,,,
12001,12001,Alto Sto. Amaro,,38.70237070,-9.18807880,,,0,,,
10902,10902,Estr. Benfica (Mercado),,38.75199700,-9.20523760,,,0,,,
7516,7516,P. Aeroporto,,38.76278370,-9.12900180,,,0,,,
12002,12002,Jardim Alto Sto. Amaro,,38.70404360,-9.18573760,,,0,,,
12003,12003,Jardim Alto Sto. Amaro,,38.70448270,-9.18480880,,,0,,,
12008,12008,R. Aliana Operria,,38.70441170,-9.18958680,,,0,,,
12009,12009,Alto Sto. Amaro,,38.70252070,-9.18775280,,,0,,,
12703,12703,C. Palma Baixo,,38.74629470,-9.16788880,,,0,,,
12702,12702,C. Palma Baixo / Estr. Laranjeiras,,38.74507870,-9.16862280,,,0,,,
12707,12707,Estr. Laranjeiras,,38.74556270,-9.16933980,,,0,,,
12706,12706,Universidade Catlica,,38.74820770,-9.16541380,,,0,,,
12705,12705,Universidade Catlica,,38.74804700,-9.16517510,,,0,,,
12704,12704,C. Palma Baixo,,38.74689270,-9.16788080,,,0,,,
12709,12709,Laranjeiras (Metro),,38.74756570,-9.17091780,,,0,,,
12708,12708,Estr. Laranjeiras,,38.74526770,-9.16930780,,,0,,,
12206,12206,Igreja Encarnao,,38.77357670,-9.11866480,,,0,,,
12207,12207,R. Lojistas,,38.77294070,-9.11535480,,,0,,,
12204,12204,Encarnao,,38.77108670,-9.12187180,,,0,,,
12205,12205,Igreja Encarnao,,38.77270270,-9.11837380,,,0,,,
12202,12202,Encarnao (Bombeiros),,38.76961870,-9.12313280,,,0,,,
12203,12203,Encarnao,,38.77081470,-9.12155080,,,0,,,
1506,1506,P. Espanha,,38.73839120,-9.15848480,,,0,,,
12201,12201,Encarnao (Bombeiros),,38.77020070,-9.12313580,,,0,,,
1516,1516,R. Ramalho Ortigo,,38.73599770,-9.15791880,,,0,,,
12208,12208,R. Lojistas,,38.77406970,-9.11677580,,,0,,,
12209,12209,Encarnao (Bombeiros),,38.76945870,-9.12316580,,,0,,,
5810,5810,Campo Grande Norte,,38.75973270,-9.15582380,,,0,,,
12105,12105,Calvrio,,38.70539670,-9.17630480,,,0,,,
12104,12104,R. Leo Oliveira,,38.70464740,-9.17847710,,,0,,,
5830,5830,Qta. Conchas (Metro),,38.76670790,-9.15584510,,,0,,,
12107,12107,Estao Sto. Amaro,,38.70303170,-9.17977780,,,0,,,
5840,5840,R. Agostinho Neto,,38.76175170,-9.15411180,,,0,,,
12106,12106,Estao Sto. Amaro,,38.70242470,-9.18031880,,,0,,,
12101,12101,Calvrio,,38.70455770,-9.17649580,,,0,,,
12103,12103,R. Lusadas / R. Leo Oliveira,,38.70575070,-9.17818580,,,0,,,
12102,12102,Calvrio,,38.70466170,-9.17656480,,,0,,,
12108,12108,Estao Sto. Amaro,,38.70199370,-9.18103580,,,0,,,
5604,5604,R. Conceio,,38.70956800,-9.13747760,,,0,,,
8414,8414,R. Cidade Bissau (Metro),,38.76035770,-9.11166780,,,0,,,
8404,8404,Olivais Sul,,38.76404870,-9.11902580,,,0,,,
8424,8424,Cemitrio Olivais,,38.76243470,-9.10979580,,,0,,,
6820,6820,R. Braamcamp,,38.72169070,-9.15156580,,,0,,,
6810,6810,Rato,,38.72003570,-9.15511680,,,0,,,
9404,9404,Tv. Horta Navia,,38.70892470,-9.17201780,,,0,,,
6604,6604,R. Bernardim Ribeiro,,38.72499170,-9.14417880,,,0,,,
9414,9414,Alcntara,,38.70688470,-9.17313980,,,0,,,
9424,9424,Travessa Sebeiro,,38.70850970,-9.17592080,,,0,,,
9434,9434,R. Cruz / R. Feliciano Sousa,,38.70816820,-9.17410590,,,0,,,
12307,12307,R. Capito-Ten. Oliveira Carmo,,38.77605170,-9.11353680,,,0,,,
12306,12306,R. Alf. Barrilaro Ruas,,38.77707270,-9.11589380,,,0,,,
7810,7810,P. Jos Queirs,,38.77442770,-9.10602980,,,0,,,
12305,12305,R. Alf. Barrilaro Ruas,,38.77716870,-9.11616180,,,0,,,
12304,12304,B. Encarnao,,38.77475770,-9.11418880,,,0,,,
12303,12303,B. Encarnao,,38.77534770,-9.11337780,,,0,,,
12302,12302,Olivais Norte,,38.77507970,-9.11140680,,,0,,,
12301,12301,Olivais Norte,,38.77538070,-9.11076280,,,0,,,
12309,12309,Olivais Norte,,38.77442970,-9.11116580,,,0,,,
12308,12308,R. Capito-Ten. Oliveira Carmo,,38.77609470,-9.11382680,,,0,,,
7604,7604,Av. Berlim (Aeroporto),,38.77015770,-9.12734880,,,0,,,
61102,61102,R. Leandro Braga,,38.72990070,-9.16439280,,,0,,,
61103,61103,C. Quintinha,,38.72595350,-9.16940940,,,0,,,
61101,61101,C. Quintinha,,38.72584150,-9.16893290,,,0,,,
1810,1810,Av. Repblica,,38.73847170,-9.14610680,,,0,,,
1604,1604,Sete Rios,,38.74165610,-9.16780830,,,0,,,
1614,1614,Sete Rios,,38.74201710,-9.16846940,,,0,,,
1624,1624,R. Fernando Sylan,,38.74020870,-9.17334980,,,0,,,
12808,12808,Qta. Inglesinhos,,38.76317670,-9.18057880,,,0,,,
2810,2810,B. Calhariz Benfica,,38.74210070,-9.20009480,,,0,,,
12809,12809,Av. Cidade Praga (Lispolis),,38.76567070,-9.18228580,,,0,,,
12804,12804,Lg. Luz,,38.76030470,-9.18287580,,,0,,,
12805,12805,Av. Norton Matos (Torres Lisboa),,38.75783200,-9.17536790,,,0,,,
12806,12806,Av. Norton Matos (Torres Lisboa),,38.75748230,-9.17519370,,,0,,,
12807,12807,Av. Cidade Praga (Lispolis),,38.76548170,-9.18264280,,,0,,,
12801,12801,Qta. Luz,,38.75727470,-9.18540580,,,0,,,
12802,12802,Qta. Luz,,38.75717170,-9.18567880,,,0,,,
12803,12803,Lg. Luz,,38.76002170,-9.18274880,,,0,,,
16315,16315,Prior Velho,,38.79019670,-9.12311980,,,0,,,
5902,5902,Av. Rainha D. Leonor,,38.76767570,-9.15837780,,,0,,,
16314,16314,R. Diu,,38.79149070,-9.12332880,,,0,,,
5912,5912,Lumiar - Av. Padre Cruz,,38.77471670,-9.16313580,,,0,,,
16313,16313,Prior Velho - R. Maestro Lopes Graa,,38.79274670,-9.12159680,,,0,,,
5922,5922,Ameixoeira (Metro),,38.77963370,-9.15978880,,,0,,,
16312,16312,R. Cabo Verde,,38.79122970,-9.12090780,,,0,,,
5932,5932,INETI,,38.76917770,-9.17923180,,,0,,,
5942,5942,R. Prof. Fernando Mello Moser,,38.77094970,-9.16871780,,,0,,,
16310,16310,Prior Velho,,38.79021470,-9.12434780,,,0,,,
5952,5952,R. Fernando Lopes Graa,,38.77015470,-9.16901380,,,0,,,
3820,3820,Corpo Santo,,38.70727570,-9.14133490,,,0,,,
3810,3810,Cais Sodr,,38.70578970,-9.14311580,,,0,,,
8516,8516,R. Amoreiras,,38.72334970,-9.15941080,,,0,,,
6902,6902,Gomes Freire,,38.72592870,-9.14062680,,,0,,,
3604,3604,Lg. Broma,,38.74234670,-9.11677680,,,0,,,
9506,9506,Hosp. Egas Moniz,,38.69844070,-9.18835780,,,0,,,
7902,7902,Moscavide Centro,,38.77990870,-9.10247680,,,0,,,
7912,7912,Estr. Moscavide,,38.77278370,-9.09996480,,,0,,,
18135,18135,Estr. Seminrio,,38.73445670,-9.22050280,,,0,,,
18134,18134,Alfragide (NATO),,38.73720570,-9.21609780,,,0,,,
18136,18136,Estr. Seminrio,,38.73432670,-9.22040980,,,0,,,
18131,18131,Alfragide (Qta. Grande),,38.73576750,-9.21877690,,,0,,,
18130,18130,Estr. Alfragide / R. Encosta,,38.73476170,-9.22135980,,,0,,,
18133,18133,Av. Almeida Garrett,,38.73826470,-9.21793380,,,0,,,
18132,18132,Av. Almeida Garrett,,38.73836870,-9.21776080,,,0,,,
6036,6036,R. Raul Rego (Escola),,38.78296070,-9.14955180,,,0,,,
6026,6026,Esc. S. Gonalo,,38.78382670,-9.14933680,,,0,,,
6016,6016,R. Melo Antunes,,38.77904670,-9.14478480,,,0,,,
6006,6006,Campo Amoreiras,,38.78545170,-9.14319480,,,0,,,
12909,12909,Cemitrio Ajuda,,38.70937670,-9.20335180,,,0,,,
12908,12908,Plo Universitrio Ajuda - Estr. Marcos,,38.71333270,-9.20086880,,,0,,,
12905,12905,Caramo (Ajuda),,38.71445470,-9.20455680,,,0,,,
12904,12904,B. Ajuda (Escola),,38.71172970,-9.20110980,,,0,,,
12907,12907,Estr. Marcos,,38.71341370,-9.20265580,,,0,,,
12906,12906,Caramo (Ajuda),,38.71458370,-9.20451780,,,0,,,
12901,12901,Ajuda,,38.70913670,-9.19998080,,,0,,,
12903,12903,B. Ajuda (Escola),,38.71165570,-9.20123280,,,0,,,
12902,12902,Ajuda,,38.70941070,-9.19992780,,,0,,,
7006,7006,Esc. Nuno Gonalves,,38.72719770,-9.12838880,,,0,,,
7016,7016,R. Cesrio Verde,,38.73004370,-9.13034480,,,0,,,
1902,1902,Campo Pequeno - Av. Repblica,,38.74190680,-9.14697750,,,0,,,
10612,10612,R. Nova S. Mamede,,38.71965670,-9.15113680,,,0,,,
10613,10613,R. Taipas,,38.71667670,-9.14528280,,,0,,,
10610,10610,Prncipe Real,,38.71589780,-9.14827920,,,0,,,
10614,10614,P. Alegria,,38.71793520,-9.14472980,,,0,,,
10615,10615,R. Taipas - Glria,,38.71508220,-9.14372340,,,0,,,
2902,2902,R. Prof. Jorge Silva Horta,,38.74585250,-9.20476190,,,0,,,
10511,10511,Calhariz (Bica),,38.71081870,-9.14599980,,,0,,,
10510,10510,Calhariz (Bica),,38.71080370,-9.14531880,,,0,,,
10513,10513,P. Luis Cames (B. Alto),,38.71054260,-9.14382280,,,0,,,
10512,10512,P. Luis Cames (B. Alto),,38.71079070,-9.14358980,,,0,,,
10515,10515,Chiado,,38.70983870,-9.14248420,,,0,,,
10514,10514,Chiado,,38.71042670,-9.14207180,,,0,,,
10517,10517,R. Vitor Cordon,,38.70794530,-9.14257220,,,0,,,
10516,10516,R. Vitor Cordon / R. Serpa Pinto,,38.70826770,-9.14197580,,,0,,,
10519,10519,R. Vitor Cordon / R. Serpa Pinto,,38.70796470,-9.14141580,,,0,,,
10518,10518,Lg. Academia Nacional Belas Artes,,38.70807470,-9.14045880,,,0,,,
1006,1006,Restauradores,,38.71580370,-9.14201480,,,0,,,
1016,1016,Av. Liberdade - Lavra,,38.71777930,-9.14339730,,,0,,,
8840,8840,Lisboa Clube Tnis,,38.73054970,-9.20375080,,,0,,,
8820,8820,Buraca (B. Tacha),,38.74235970,-9.21152380,,,0,,,
3922,3922,Lg. Vitorino Damsio,,38.70733570,-9.15446280,,,0,,,
3902,3902,Santos,,38.70623760,-9.15597810,,,0,,,
3912,3912,Santos,,38.70672470,-9.15586980,,,0,,,
10014,10014,R. Santana  Lapa,,38.71083670,-9.16136580,,,0,,,
10015,10015,R. S. Domingos  Lapa,,38.70892570,-9.16191580,,,0,,,
10016,10016,R. S. Domingos  Lapa,,38.70971370,-9.16243380,,,0,,,
10010,10010,R. S. Joo Mata,,38.70770670,-9.15966580,,,0,,,
10011,10011,R. Buenos Aires,,38.71144220,-9.16079170,,,0,,,
10012,10012,R. Buenos Aires,,38.71212270,-9.16035680,,,0,,,
10013,10013,R. Santana  Lapa,,38.71005670,-9.16245680,,,0,,,
8614,8614,R. D. Antnio Luis Sousa,,38.72511770,-9.16766180,,,0,,,
8604,8604,B. Bela Flor,,38.72444370,-9.16918480,,,0,,,
2016,2016,Entrecampos - Av. EUA,,38.74871870,-9.14664780,,,0,,,
2006,2006,Entrecampos Norte,,38.74931060,-9.14936640,,,0,,,
9810,9810,Av. Inf. D. Henrique (Ponte Xabregas),,38.72439870,-9.11213380,,,0,,,
9820,9820,Qta. Peixinhos,,38.72274470,-9.12146280,,,0,,,
10711,10711,R. Conde Almoster / Tv. S. Domingos,,38.74341570,-9.18050380,,,0,,,
10710,10710,Alto Moinhos (Metro),,38.74915850,-9.18005590,,,0,,,
10717,10717,R. Sousa Loureiro,,38.74472370,-9.18381880,,,0,,,
10714,10714,B. Furnas,,38.74123370,-9.17619280,,,0,,,
9604,9604,Mosteiro Jernimos,,38.69778470,-9.20442980,,,0,,,
9614,9614,Av. Restelo (Estdio),,38.70052970,-9.20978980,,,0,,,
10719,10719,Tv. S. Domingos Benfica,,38.74232270,-9.18189180,,,0,,,
10718,10718,R. Francisco Gentil Martins,,38.74009670,-9.17399080,,,0,,,
3006,3006,R. Carvalho Arajo,,38.74762960,-9.22152270,,,0,,,
3016,3016,Buraca - Av. Repblica,,38.74608870,-9.21226780,,,0,,,
6130,6130,Campolide,,38.72676670,-9.16199180,,,0,,,
6120,6120,Campolide (Av. Cons. Fernando Sousa),,38.72629920,-9.16119880,,,0,,,
6110,6110,B. Campolide,,38.72851470,-9.16598480,,,0,,,
10214,10214,R. Prior / R. Ribeiro Sanches,,38.70625570,-9.16575080,,,0,,,
10212,10212,R. Presidente Arriaga,,38.70461570,-9.16359080,,,0,,,
10213,10213,R. Olival,,38.70479870,-9.16657580,,,0,,,
10210,10210,Av. Infante Santo,,38.70476570,-9.16775580,,,0,,,
10211,10211,R. Presidente Arriaga,,38.70448270,-9.16418180,,,0,,,
10114,10114,R. Borja / R. Possidnio Silva,,38.71020470,-9.17059280,,,0,,,
10111,10111,R. Santana  Lapa / R. Possolo,,38.71280510,-9.16524300,,,0,,,
10113,10113,R. Borja,,38.71118870,-9.16724680,,,0,,,
10112,10112,R. Santana  Lapa / R. Possolo,,38.71258270,-9.16544980,,,0,,,
11612,11612,Grafanil,,38.79311870,-9.15523380,,,0,,,
11613,11613,Galinheiras,,38.79208470,-9.15029480,,,0,,,
11610,11610,Qta. Balsares,,38.79408470,-9.15199480,,,0,,,
11611,11611,Qta. Balsares,,38.79338470,-9.15313180,,,0,,,
11616,11616,Qta. Balsares,,38.79314370,-9.15311080,,,0,,,
11617,11617,Rampa Mercado,,38.79276270,-9.14817480,,,0,,,
11614,11614,Qta. Torrinha,,38.79060970,-9.15734180,,,0,,,
11615,11615,Rampa Mercado,,38.79238870,-9.14811080,,,0,,,
11618,11618,Torrinha,,38.78777670,-9.15907080,,,0,,,
11619,11619,Piscina Municipal Ameixoeira,,38.78581680,-9.15980740,,,0,,,
11511,11511,Esc. Pintor Almada Negreiros,,38.77713470,-9.14646180,,,0,,,
11510,11510,Av. Carlos Paredes,,38.77441570,-9.15214390,,,0,,,
11513,11513,R. Helena Vaz Silva,,38.77311270,-9.15321480,,,0,,,
11512,11512,R. Helena Vaz Silva,,38.77318940,-9.15294360,,,0,,,
11515,11515,Av. David Mouro Ferreira (C. Social),,38.77724480,-9.15573670,,,0,,,
11514,11514,Av. David Mouro Ferreira (C. Social),,38.77727370,-9.15553450,,,0,,,
6405,6405,P. Londres,,38.74138470,-9.13744580,,,0,,,
11517,11517,Av. David Mouro Ferreira,,38.77747270,-9.15201880,,,0,,,
11516,11516,Av. David Mouro Ferreira,,38.77736670,-9.15232380,,,0,,,
11519,11519,Av. Maria Helena Vieira Silva,,38.76686870,-9.15167780,,,0,,,
11518,11518,Av. Maria Helena Vieira Silva,,38.76688170,-9.15102980,,,0,,,
10317,10317,Plo Univ. Ajuda - Av. Univ. Tcnica,,38.71114660,-9.19576190,,,0,,,
10316,10316,Plo Univ. Ajuda - Av. Univ. Tcnica,,38.71175700,-9.19541170,,,0,,,
10315,10315,Plo Universitrio Ajuda,,38.71394170,-9.19697380,,,0,,,
10314,10314,R. Cruzeiro,,38.71006470,-9.19495780,,,0,,,
10313,10313,Plo Universitrio Ajuda,,38.71283570,-9.19588480,,,0,,,
8912,8912,Olaias (Piscina),,38.73991070,-9.12406780,,,0,,,
10312,10312,R. Fonseca Benevides,,38.71019670,-9.19133580,,,0,,,
8902,8902,R. Frei Fortunato S. Boaventura,,38.73601770,-9.12293280,,,0,,,
10311,10311,R. Armando Lucena,,38.71073420,-9.19641170,,,0,,,
8922,8922,R. Joo Nascimento Costa,,38.73730070,-9.12547280,,,0,,,
10310,10310,Palcio Nacional Ajuda,,38.70716970,-9.19909780,,,0,,,
10319,10319,R. Cruzeiro / Tv. Jos Fernandes,,38.70803970,-9.19272380,,,0,,,
10318,10318,R. Cruzeiro / Tv. Pardal,,38.70686970,-9.19110280,,,0,,,
4202,4202,Algs (Mercado),,38.70138220,-9.22705480,,,0,,,
11010,11010,Estr. Benfica (Mercado),,38.75253070,-9.20646280,,,0,,,
7405,7405,Av. D. Rodrigo Cunha,,38.75471170,-9.13410980,,,0,,,
2130,2130,Mercado Sta. Clara,,38.71566770,-9.12581480,,,0,,,
2110,2110,Cais Lingueta (Museu Fado),,38.71114170,-9.12736950,,,0,,,
9902,9902,R. S. Paulo (Bica),,38.70845070,-9.14703940,,,0,,,
8016,8016,Campo Ourique (Prazeres),,38.71425870,-9.16997680,,,0,,,
8006,8006,R. 4 Infantaria,,38.72023670,-9.16544180,,,0,,,
8026,8026,R. Coelho Rocha,,38.71658270,-9.16505280,,,0,,,
9006,9006,Olaias - Av. Afonso Costa,,38.73861750,-9.12733230,,,0,,,
11210,11210,Av. Frei Miguel Contreiras,,38.74614170,-9.13651680,,,0,,,
1405,1405,B. Azul,,38.73333670,-9.15473780,,,0,,,
11211,11211,Av. Frei Miguel Contreiras,,38.74580570,-9.13711480,,,0,,,
10818,10818,R. Carolina Michaelis Vasconcelos,,38.74449570,-9.19303980,,,0,,,
10819,10819,Colgio Militar (Metro),,38.75267570,-9.18951080,,,0,,,
10814,10814,Calhariz,,38.74895070,-9.19126780,,,0,,,
10815,10815,Calhariz - R. Ten. Coronel Ribeiro Reis,,38.74634270,-9.18965080,,,0,,,
10816,10816,Colgio Militar (Metro),,38.75201270,-9.18791380,,,0,,,
10817,10817,R. Carolina Michaelis Vasconcelos,,38.74426170,-9.19429480,,,0,,,
10810,10810,Estdio Luz,,38.75405170,-9.18603080,,,0,,,
10811,10811,Colgio Militar (Metro),,38.75290870,-9.18963280,,,0,,,
4505,4505,Sul e Sueste,,38.70828070,-9.13346780,,,0,,,
10812,10812,Colgio Militar (Metro),,38.75247270,-9.18953380,,,0,,,
10813,10813,Colgio Militar (Metro),,38.75288790,-9.18815920,,,0,,,
7222,7222,Chapeleiro 1,,38.79043970,-9.15971080,,,0,,,
7202,7202,C. Carriche / Estr. Desvio,,38.78217300,-9.16472750,,,0,,,
7212,7212,R. Formosinho Sanchez,,38.78021560,-9.16930520,,,0,,,
11115,11115,Lg. Leo,,38.73457370,-9.13732480,,,0,,,
11114,11114,Av. Manuel Maia,,38.73714070,-9.13637280,,,0,,,
11117,11117,Av. Defensores Chaves,,38.73880170,-9.14438980,,,0,,,
11116,11116,Lg. Leo,,38.73473170,-9.13721380,,,0,,,
11111,11111,Alameda D. A. Henriques,,38.73693270,-9.13634580,,,0,,,
11110,11110,R. Visconde Santarm,,38.73496870,-9.13994380,,,0,,,
2405,2405,Av. Fernando Pessoa,,38.75854970,-9.09729480,,,0,,,
11118,11118,Arco Cego - Av. Miguel Bombarda,,38.73770370,-9.14283080,,,0,,,
5515,5515,P. Comrcio,,38.70817270,-9.13710780,,,0,,,
5603,5603,R. Madalena,,38.70988670,-9.13503180,,,0,,,
6505,6505,R. Ponta Delgada,,38.73281070,-9.13863480,,,0,,,
1202,1202,Mq. Pombal - Av. Duque Loul,,38.72557370,-9.14861380,,,0,,,
1212,1212,Marqus Pombal,,38.72466670,-9.15085280,,,0,,,
11317,11317,Esc. Padre Antnio Vieira,,38.75776370,-9.13620980,,,0,,,
11316,11316,Pote gua,,38.75912070,-9.13713680,,,0,,,
11315,11315,Bombeiros Alvalade,,38.75679670,-9.13968880,,,0,,,
11314,11314,Bombeiros Alvalade,,38.75634570,-9.13999180,,,0,,,
11312,11312,LNEC,,38.75779540,-9.14074110,,,0,,,
11310,11310,R. Murtas / Av. Brasil,,38.75599170,-9.14875280,,,0,,,
11319,11319,Pote gua,,38.75943570,-9.13582580,,,0,,,
6603,6603,R. Bernardim Ribeiro,,38.72502870,-9.14401180,,,0,,,
11318,11318,R. Reinaldo Ferreira,,38.75757170,-9.13797680,,,0,,,
10919,10919,Al. Padre lvaro Proena,,38.74855770,-9.20146980,,,0,,,
10918,10918,Al. Padre lvaro Proena,,38.74889870,-9.20124380,,,0,,,
10915,10915,Benfica - Al. Pe. lvaro Proena,,38.74924850,-9.20272300,,,0,,,
10914,10914,Av. Uruguai,,38.75150470,-9.19726280,,,0,,,
10917,10917,Qta. Granja,,38.75446620,-9.19547880,,,0,,,
10916,10916,Qta. Granja,,38.75471420,-9.19608080,,,0,,,
10911,10911,Qta. Granja - Av. Uruguai,,38.75287370,-9.19681080,,,0,,,
10910,10910,Estr. Arneiros,,38.75448370,-9.19781480,,,0,,,
10913,10913,Av. Uruguai,,38.75144270,-9.19748680,,,0,,,
7505,7505,Av. Alm. Gago Coutinho (Rot. Relgio),,38.76237270,-9.12944780,,,0,,,
10912,10912,Qta. Granja - Av. Uruguai,,38.75322570,-9.19634080,,,0,,,
7515,7515,Av. Brasil (Rot. Relgio),,38.76248370,-9.13036680,,,0,,,
2212,2212,Av. Paulo VI,,38.74798670,-9.10780080,,,0,,,
2202,2202,Fbrica Gs,,38.75101070,-9.09588780,,,0,,,
7603,7603,Av. Berlim (Aeroporto),,38.76983070,-9.12658980,,,0,,,
8110,8110,Estrela - R. Domingos Sequeira,,38.71451170,-9.16210780,,,0,,,
15105,15105,Odivelas (B. Dr. Lima Pimentel),,38.78666490,-9.18297850,,,0,,,
15104,15104,Av. D. Dinis,,38.78946970,-9.17719780,,,0,,,
15107,15107,R. Bomb. Voluntrio / Al. I. D. Henrique,,38.78881670,-9.17581380,,,0,,,
15106,15106,R. Bombeiros Voluntrios,,38.78699670,-9.17814380,,,0,,,
15101,15101,Odivelas (B. Dr. Lima Pimentel),,38.78610170,-9.18320480,,,0,,,
15103,15103,Av. D. Dinis (Bombeiros Odivelas),,38.78679720,-9.18047880,,,0,,,
15102,15102,Av. D. Dinis (Bombeiros Odivelas),,38.78732570,-9.17991880,,,0,,,
78103,78103,Cais Olival,,38.77720370,-9.09426580,,,0,,,
78102,78102,Cais Olival,,38.77604210,-9.09515060,,,0,,,
78101,78101,Cais Olival,,38.77614270,-9.09496480,,,0,,,
9110,9110,Sapadores,,38.72128870,-9.12918980,,,0,,,
9120,9120,Tv. Sto. Antnio,,38.71917970,-9.12797680,,,0,,,
9130,9130,R. Graa,,38.71903870,-9.12983380,,,0,,,
78104,78104,Cais Olival - Al. Oceanos,,38.77592670,-9.09475380,,,0,,,
1505,1505,P. Espanha,,38.73810720,-9.15995280,,,0,,,
1515,1515,Av. Jos Malhoa (Policia Municipal),,38.73642070,-9.16095080,,,0,,,
1603,1603,Sete Rios,,38.74176640,-9.16760370,,,0,,,
1613,1613,Av. Jos Malhoa,,38.73757070,-9.16449880,,,0,,,
1623,1623,R. Raul Carapinha,,38.74140670,-9.17363280,,,0,,,
5801,5801,Hipdromo,,38.75761970,-9.16249880,,,0,,,
5811,5811,Hosp. Pulido Valente,,38.76456870,-9.15699480,,,0,,,
5841,5841,Campo Grande (Metro),,38.76041180,-9.15652930,,,0,,,
5605,5605,R. Conceio,,38.70931870,-9.13817380,,,0,,,
8435,8435,C. Comercial Olivais,,38.76151270,-9.11398280,,,0,,,
8425,8425,R. Cons. Emdio Navarro,,38.75660170,-9.11829180,,,0,,,
6821,6821,Rato,,38.72087990,-9.15583130,,,0,,,
6811,6811,Rato,,38.72028770,-9.15378580,,,0,,,
6801,6801,Av. lvares Cabral,,38.71748770,-9.15732380,,,0,,,
5703,5703,Campo Grande - Av. Brasil,,38.75481570,-9.15209680,,,0,,,
9405,9405,R. Maria Pia,,38.71244030,-9.17360210,,,0,,,
6605,6605,R. Luciano Cordeiro,,38.72688670,-9.14568080,,,0,,,
9415,9415,Alcntara - Av. Ceuta,,38.70725770,-9.17352980,,,0,,,
9425,9425,Alcntara - Av. Ceuta,,38.70813070,-9.17385280,,,0,,,
3603,3603,Lg. Broma,,38.74233270,-9.11693980,,,0,,,
7821,7821,Av. D. Joo II,,38.77155970,-9.09733980,,,0,,,
7801,7801,R. Sarg. Armando Monteiro Ferreira,,38.77190370,-9.10986380,,,0,,,
7811,7811,P. Jos Queirs,,38.77301970,-9.10509080,,,0,,,
6723,6723,R. S. Bento / C. Estrela,,38.71097470,-9.15263480,,,0,,,
6713,6713,P. Flores,,38.71483290,-9.15158340,,,0,,,
6703,6703,Palcio S. Bento (Jardim),,38.71339270,-9.15315280,,,0,,,
7605,7605,R. C (Aeroporto),,38.77412870,-9.12587180,,,0,,,
2320,2320,Av. Inf. D. Henrique (Centieira),,38.75993170,-9.10366680,,,0,,,
2310,2310,Rot. Cabo Ruivo,,38.75483280,-9.10318260,,,0,,,
7723,7723,R. Cidade Benguela,,38.76578770,-9.11334580,,,0,,,
7703,7703,Av. Berlim (Viveiros),,38.76892070,-9.11783980,,,0,,,
7713,7713,Piscina Olivais,,38.77003670,-9.10898980,,,0,,,
8202,8202,Alfndega (Terminal Cruzeiros),,38.70964430,-9.12901180,,,0,,,
3310,3310,R. Soeiro Pereira Gomes,,38.74513570,-9.15935780,,,0,,,
1801,1801,Saldanha,,38.73367770,-9.14463080,,,0,,,
1811,1811,Av. Miguel Bombarda (ISCAL),,38.73716270,-9.14670180,,,0,,,
79123,79123,R. Chen He,,38.78875870,-9.09953280,,,0,,,
79122,79122,Parque Naes Norte,,38.79377570,-9.09753880,,,0,,,
79121,79121,Via Oriente,,38.79164770,-9.09919980,,,0,,,
79120,79120,Via Oriente,,38.79208070,-9.09936480,,,0,,,
9202,9202,Pao Rainha,,38.72339370,-9.13769880,,,0,,,
79127,79127,Estao Sacavm,,38.79609070,-9.09962080,,,0,,,
9212,9212,Campo Santana,,38.72417670,-9.13986880,,,0,,,
79126,79126,P. Repblica,,38.79671360,-9.10340270,,,0,,,
79125,79125,Sacavm (Urb. Real Forte),,38.79417470,-9.10369280,,,0,,,
79124,79124,Estao Sacavm,,38.79569970,-9.10019180,,,0,,,
1605,1605,Esc. D. Pedro V,,38.74122570,-9.16324280,,,0,,,
1615,1615,Estr. Benfica (Furnas),,38.74242070,-9.17240280,,,0,,,
1625,1625,R. Alcina Bastos,,38.74126670,-9.17596280,,,0,,,
2811,2811,Estao Benfica,,38.74472570,-9.19912170,,,0,,,
2801,2801,Estao Benfica - Av. Gomes Pereira,,38.74528770,-9.19794680,,,0,,,
1703,1703,Picoas,,38.73140570,-9.14611280,,,0,,,
1713,1713,Picoas,,38.73104070,-9.14632480,,,0,,,
5901,5901,Av. Rainha D. Leonor,,38.76719070,-9.15791680,,,0,,,
5911,5911,Ameixoeira - Estr. Desvio,,38.77883270,-9.16338680,,,0,,,
5921,5921,R. Prof. M. Valadares,,38.77578820,-9.16007610,,,0,,,
5931,5931,Ameixoeira,,38.78208470,-9.15874480,,,0,,,
5941,5941,R. Prof. Fernando Mello Moser,,38.77089970,-9.16882680,,,0,,,
5951,5951,R. Fernando Lopes Graa,,38.77026770,-9.16909480,,,0,,,
3821,3821,Corpo Santo,,38.70730390,-9.14195050,,,0,,,
3801,3801,Cais Sodr,,38.70590570,-9.14311080,,,0,,,
3811,3811,Cais Sodr,,38.70566470,-9.14312480,,,0,,,
5705,5705,Campo Grande - Av. Brasil,,38.75563370,-9.15143580,,,0,,,
8515,8515,R. Amoreiras,,38.72387270,-9.15961980,,,0,,,
2723,2723,B. Liberdade,,38.73089470,-9.17307980,,,0,,,
2713,2713,Av. Jos Malhoa,,38.73773470,-9.16762780,,,0,,,
2703,2703,R. C (B. Liberdade),,38.73513670,-9.17182780,,,0,,,
6901,6901,Gomes Freire,,38.72557770,-9.14075080,,,0,,,
3605,3605,Bela Vista (Centro Comercial),,38.74823770,-9.11870980,,,0,,,
3615,3615,Av. Cidade Bratislava,,38.75027070,-9.11705380,,,0,,,
8613,8613,R. Particular Arco Carvalho,,38.72444170,-9.16688180,,,0,,,
8603,8603,R. Bela Flor,,38.72353070,-9.17093480,,,0,,,
6725,6725,C. Estrela / R. Dr. Tefilo Braga,,38.71268210,-9.15719350,,,0,,,
6715,6715,R. Palmeira,,38.71468270,-9.15000480,,,0,,,
9505,9505,Hosp. Egas Moniz,,38.69859570,-9.18739480,,,0,,,
6705,6705,R. S. Bento,,38.71544910,-9.15432380,,,0,,,
3703,3703,P. Eduardo Mondlane,,38.74446270,-9.11322580,,,0,,,
3713,3713,R. Salgueiro Maia,,38.74817070,-9.11293980,,,0,,,
7911,7911,Moscavide (Metro),,38.77464070,-9.10091480,,,0,,,
6037,6037,R. Raul Rego (Escola),,38.78250370,-9.14945680,,,0,,,
6027,6027,Esc. S. Gonalo,,38.78479270,-9.14949580,,,0,,,
6017,6017,Av. Dr. Jos Salvado Sampaio,,38.78052470,-9.15302280,,,0,,,
9603,9603,Mosteiro Jernimos,,38.69734770,-9.20364980,,,0,,,
6007,6007,Charneca,,38.78715170,-9.14211180,,,0,,,
9613,9613,Av. Restelo (Estdio),,38.70037170,-9.20998180,,,0,,,
7725,7725,R. Cidade Benguela (Mercado),,38.76548370,-9.11088880,,,0,,,
7705,7705,Piscina Olivais,,38.76974390,-9.11170010,,,0,,,
7715,7715,Av. Berlim,,38.76744770,-9.11003280,,,0,,,
7007,7007,R. Cesrio Verde,,38.72917070,-9.12988580,,,0,,,
7017,7017,Igreja Penha Frana,,38.72990170,-9.13093680,,,0,,,
8310,8310,Xabregas - R. Manuteno,,38.72631170,-9.11047380,,,0,,,
8320,8320,Xabregas,,38.72594090,-9.11353000,,,0,,,
1901,1901,Campo Pequeno - Av. Repblica,,38.74298570,-9.14674080,,,0,,,
1705,1705,P. Jos Fontana,,38.73064170,-9.14434880,,,0,,,
8841,8841,Alfragide,,38.73813470,-9.21283080,,,0,,,
8811,8811,Buraca,,38.74386970,-9.20551380,,,0,,,
8801,8801,R. Azevinho,,38.73302520,-9.20600480,,,0,,,
8821,8821,Estr. Alfragide (Buraca),,38.74172770,-9.20660180,,,0,,,
2715,2715,Estao Campolide,,38.72996370,-9.16608780,,,0,,,
2705,2705,B. Liberdade,,38.73334120,-9.16896880,,,0,,,
3921,3921,Santos-o-Velho,,38.70706820,-9.15814080,,,0,,,
3901,3901,Santos,,38.70617370,-9.15572680,,,0,,,
3911,3911,Santos-o-Velho,,38.70652570,-9.15793380,,,0,,,
8615,8615,B. Bela Flor,,38.72460170,-9.16964680,,,0,,,
8605,8605,R. D. Antnio Luis Sousa,,38.72532070,-9.16775380,,,0,,,
2017,2017,Campo Grande,,38.75313160,-9.15001720,,,0,,,
2007,2007,Av. Foras Armadas,,38.74805170,-9.15090380,,,0,,,
9801,9801,C. Lajes,,38.72566670,-9.11889280,,,0,,,
9811,9811,Av. Inf. D. Henrique (Tipografia),,38.72305770,-9.11304480,,,0,,,
9821,9821,Qta. Peixinhos,,38.72354430,-9.12165270,,,0,,,
3725,3725,Az. Vale Fundo,,38.74364060,-9.10535040,,,0,,,
3705,3705,P. Dr. Fernando Amado,,38.74655670,-9.11280380,,,0,,,
3715,3715,Av. Paulo VI (Igreja),,38.74241070,-9.11274580,,,0,,,
8713,8713,Cruz Oliveiras,,38.72553270,-9.19402580,,,0,,,
8703,8703,Av. Tenente Martins,,38.72882570,-9.19051480,,,0,,,
9605,9605,B. Terras Forno,,38.70235880,-9.20664440,,,0,,,
3007,3007,Estao Damaia,,38.74833870,-9.21527280,,,0,,,
3017,3017,Buraca - Av. Repblica,,38.74597270,-9.21237880,,,0,,,
6127,6127,R. Artilharia Um,,38.72591270,-9.15743380,,,0,,,
6117,6117,Palcio Justia,,38.73064970,-9.15700780,,,0,,,
6107,6107,C. Mestres,,38.72651970,-9.16502980,,,0,,,
9713,9713,Av. Restelo,,38.69961770,-9.21365880,,,0,,,
6402,6402,Av. Joo XXI,,38.74243470,-9.14045380,,,0,,,
8911,8911,R. Eng. Santos Simes,,38.73584970,-9.12562580,,,0,,,
8901,8901,Picheleira (Qta. Lavrado),,38.73265770,-9.12147280,,,0,,,
8921,8921,Olaias,,38.73900170,-9.12326380,,,0,,,
4213,4213,Algs (Mercado),,38.70086910,-9.22796380,,,0,,,
7402,7402,Av. D. Rodrigo Cunha / R. Ed. Noronha,,38.75458370,-9.13161480,,,0,,,
7412,7412,R. Eduardo Noronha / Av. D. Rodr. Cunha,,38.75385670,-9.13175680,,,0,,,
8715,8715,Tribunal Monsanto,,38.73291470,-9.19222680,,,0,,,
8705,8705,Monsanto,,38.73276570,-9.18962180,,,0,,,
2127,2127,Estao Sta. Apolnia (Mercadorias),,38.71644090,-9.11928940,,,0,,,
2117,2117,Panteo Nacional,,38.71458470,-9.12525380,,,0,,,
2107,2107,R. Washington,,38.71784270,-9.12078380,,,0,,,
9901,9901,R. S. Paulo (Bica),,38.70850670,-9.14668280,,,0,,,
8017,8017,Campo Ourique (Prazeres),,38.71428470,-9.16951380,,,0,,,
8007,8007,R. Freitas Gazul,,38.71714770,-9.16981980,,,0,,,
8027,8027,R. Campo Ourique,,38.72067870,-9.16400280,,,0,,,
9705,9705,R. D. Constantino Bragana,,38.70606070,-9.21637980,,,0,,,
9007,9007,Casal Vistoso,,38.74153970,-9.12840580,,,0,,,
1402,1402,Igreja S. Sebastio Pedreira,,38.73159870,-9.15177680,,,0,,,
1412,1412,Av. Marqus Tomar,,38.73631080,-9.14952100,,,0,,,
4504,4504,Campo Cebolas,,38.70880470,-9.13324880,,,0,,,
7223,7223,Chapeleiro 2,,38.79227770,-9.15755980,,,0,,,
7203,7203,Estr. Desvio / R. Prof. J. Pinto Correia,,38.78122070,-9.16295880,,,0,,,
7213,7213,R. Formosinho Sanchez,,38.78048980,-9.16913460,,,0,,,
2412,2412,Passeio Adamastor,,38.75773770,-9.09660180,,,0,,,
2402,2402,Av. Mediterrneo,,38.76250670,-9.09810180,,,0,,,
5808,5808,Campo Grande (Metro),,38.76133660,-9.15750860,,,0,,,
5818,5818,Inst. Ricardo Jorge,,38.76685970,-9.16404680,,,0,,,
5838,5838,Alto Lumiar (Parque Europa),,38.76645270,-9.15274180,,,0,,,
5504,5504,P. Comrcio,,38.70795270,-9.13859480,,,0,,,
6818,6818,R. S. Bento / R. Arco,,38.71808770,-9.15550980,,,0,,,
6808,6808,Rato,,38.71974640,-9.15412780,,,0,,,
6504,6504,Jardim Constantino,,38.73082270,-9.13685280,,,0,,,
1203,1203,Marqus Pombal,,38.72587970,-9.14923780,,,0,,,
1213,1213,Marqus Pombal,,38.72609920,-9.15046710,,,0,,,
1223,1223,R. Joaquim Antnio Aguiar,,38.72510770,-9.15529980,,,0,,,
89924,89924,R. Manuel Teixeira Gomes,,38.75164770,-9.10935780,,,0,,,
89925,89925,R. Manuel Teixeira Gomes (Esc. D. Dinis),,38.75205470,-9.11205480,,,0,,,
89926,89926,R. Manuel Teixeira Gomes (Esc. D. Dinis),,38.75153270,-9.11186650,,,0,,,
89927,89927,ISEL,,38.75571110,-9.11376990,,,0,,,
89920,89920,ISEL,,38.75667870,-9.11323380,,,0,,,
89921,89921,R. Toms Alcaide,,38.75281570,-9.11031980,,,0,,,
89922,89922,R. Toms Alcaide,,38.75300570,-9.11030680,,,0,,,
89923,89923,R. Manuel Teixeira Gomes,,38.75175070,-9.10948380,,,0,,,
83118,83118,Qta. Ourives,,38.73534970,-9.11543980,,,0,,,
83119,83119,R. Faustino Jos Rodrigues,,38.73421670,-9.11548180,,,0,,,
83114,83114,R. Gualdim Pais,,38.73113670,-9.11683780,,,0,,,
83115,83115,Az. Salgada,,38.73638940,-9.11312850,,,0,,,
4303,4303,Igreja Cruz Quebrada,,38.70100970,-9.24969580,,,0,,,
83116,83116,Az. Salgada,,38.73609770,-9.11322580,,,0,,,
83117,83117,R. Dr. Manuel Esprito Santo,,38.73506270,-9.11401880,,,0,,,
83110,83110,B. Madre Deus (Escola),,38.73386970,-9.11253380,,,0,,,
83111,83111,Estr. Chelas,,38.73436620,-9.11717770,,,0,,,
7808,7808,Estao Oriente (Interface),,38.76799270,-9.10000280,,,0,,,
83112,83112,Estr. Chelas,,38.73463670,-9.11728980,,,0,,,
83113,83113,R. Gualdim Pais,,38.73125670,-9.11680280,,,0,,,
7504,7504,Av. Mar. Gomes Costa (Qta. Teresinhas),,38.76162870,-9.12181380,,,0,,,
7514,7514,Av. Alm. Gago Coutinho (Rot. Relgio),,38.76211170,-9.12979580,,,0,,,
2223,2223,Estao Brao Prata,,38.74697000,-9.10335000,,,0,,,
2213,2213,Estao Brao Prata,,38.74578970,-9.10471780,,,0,,,
2203,2203,Matinha,,38.74812970,-9.09695080,,,0,,,
8107,8107,R. Domingos Sequeira,,38.71496470,-9.16303480,,,0,,,
9107,9107,Av. General Roadas,,38.72489070,-9.12848180,,,0,,,
9117,9117,R. Cardal Graa,,38.72020670,-9.12728680,,,0,,,
88104,88104,Alfragide (DGA),,38.73778680,-9.20848880,,,0,,,
9127,9127,R. Angelina Vidal,,38.72231270,-9.13106280,,,0,,,
88105,88105,R. Galegas,,38.73597830,-9.20944730,,,0,,,
88101,88101,R. Galegas,,38.73590140,-9.20918930,,,0,,,
88102,88102,Alfragide (DGA),,38.73767670,-9.20802680,,,0,,,
1504,1504,P. Espanha / Av. Berna,,38.73779070,-9.15554280,,,0,,,
1514,1514,Av. Calouste Gulbenkian (Viaduto),,38.73618670,-9.16063780,,,0,,,
7303,7303,R. Francisco L. Fonseca,,38.74945570,-9.13203880,,,0,,,
5806,5806,Campo Grande Norte,,38.75764900,-9.15523230,,,0,,,
5816,5816,Av. Rainha D. Amlia,,38.76660270,-9.15976380,,,0,,,
5826,5826,Campo Grande (Metro),,38.76125550,-9.15719340,,,0,,,
5836,5836,R. M. Marques / R. Agostinho Neto,,38.76458090,-9.15389460,,,0,,,
2808,2808,R. Garridas,,38.74573270,-9.20046980,,,0,,,
21310,21310,Estr. Pimenteira (Casa dos Animais),,38.72313270,-9.18200880,,,0,,,
87101,87101,Espao Monsanto,,38.74068170,-9.18654980,,,0,,,
8442,8442,R. Chibuto,,38.76092970,-9.11032780,,,0,,,
8402,8402,Av. Cidade L. Marques S,,38.76269770,-9.11973380,,,0,,,
8422,8422,Av. Pdua,,38.76288270,-9.10705680,,,0,,,
6826,6826,Igreja Sta. Isabel,,38.71815470,-9.15817880,,,0,,,
6816,6816,R. Custdio Vieira,,38.72047270,-9.15915080,,,0,,,
6806,6806,R. Braamcamp,,38.72223870,-9.15198180,,,0,,,
3818,3818,R. S. Paulo,,38.70778170,-9.14458580,,,0,,,
5702,5702,Cidade Universitria,,38.75284970,-9.15591580,,,0,,,
5712,5712,Campo Grande - Av. Brasil,,38.75511270,-9.15042080,,,0,,,
30001,30001,Hosp. Luz,,38.75543070,-9.19237580,,,0,,,
9402,9402,Alcntara,,38.70697270,-9.17298680,,,0,,,
6606,6606,R. Luciano Cordeiro,,38.72673870,-9.14576080,,,0,,,
9412,9412,Qta. Cabrinha - Av. Ceuta,,38.71241670,-9.17545780,,,0,,,
9422,9422,R. Possidnio Silva,,38.71049570,-9.17105880,,,0,,,
9432,9432,Qta. Cabrinha - Av. Ceuta,,38.71146100,-9.17452920,,,0,,,
7806,7806,Olivais Velho - Av. Inf. D. Henrique,,38.77036670,-9.10479280,,,0,,,
7816,7816,Estao Oriente (Interface),,38.76776170,-9.10002580,,,0,,,
6722,6722,R. S. Bento / C. Estrela,,38.71148570,-9.15318780,,,0,,,
6712,6712,Palcio S. Bento,,38.71226510,-9.15279080,,,0,,,
6702,6702,Assembleia Repblica,,38.71118270,-9.15370380,,,0,,,
7606,7606,R. C (Aeroporto),,38.77451570,-9.12614480,,,0,,,
2313,2313,Av. Inf. D. Henrique / Av. Pdua,,38.76367670,-9.10366480,,,0,,,
7722,7722,R. Cidade Benguela,,38.76594670,-9.11301480,,,0,,,
7702,7702,Av. Cidade L. Marques N,,38.76690570,-9.11988180,,,0,,,
7712,7712,Av. Berlim / Tv. Courelas,,38.76781570,-9.10606380,,,0,,,
8203,8203,Chafariz d'El Rei,,38.70964270,-9.12947380,,,0,,,
3303,3303,R. Beneficncia,,38.74314570,-9.15669580,,,0,,,
3313,3313,R. Diogo Macedo (Escola),,38.74567470,-9.15589380,,,0,,,
1806,1806,Av. Duque D'vila,,38.73501570,-9.14628480,,,0,,,
79113,79113,Esc. Vasco Gama,,38.77785170,-9.09267680,,,0,,,
79117,79117,Passeio Tejo,,38.78597270,-9.09647380,,,0,,,
30102,30102,R. Guiomar Torreso,,38.75774070,-9.19156080,,,0,,,
9203,9203,Campo Mrtires Ptria,,38.72241870,-9.13983680,,,0,,,
79116,79116,Passeio Tejo,,38.78585170,-9.09679280,,,0,,,
30101,30101,Carnide (C. Comercial),,38.75625970,-9.18814480,,,0,,,
9213,9213,Campo Mrtires Ptria,,38.72167770,-9.13904880,,,0,,,
79115,79115,Passeio Garas,,38.78190470,-9.09456680,,,0,,,
79114,79114,R. Ilha Amores,,38.78064570,-9.09385480,,,0,,,
79118,79118,R. Chen He,,38.78877270,-9.09844080,,,0,,,
1616,1616,Estr. Benfica (Furnas),,38.74258470,-9.17265680,,,0,,,
1626,1626,Centro Sade Tlias,,38.74033970,-9.17190680,,,0,,,
2816,2816,Centro Sade Benfica,,38.74807520,-9.20028880,,,0,,,
2806,2806,Estao Benfica,,38.74503120,-9.19988180,,,0,,,
1702,1702,Av. Fontes P. Melo,,38.72861170,-9.14814080,,,0,,,
1712,1712,P. Jos Fontana,,38.72988370,-9.14349380,,,0,,,
5910,5910,C. Carriche / Estr. Militar,,38.77836870,-9.16429280,,,0,,,
5920,5920,R. Prof. M. Valadares,,38.77565900,-9.16009170,,,0,,,
5930,5930,Castanheira Moura,,38.77446410,-9.15689870,,,0,,,
5940,5940,Lumiar,,38.77308470,-9.16142680,,,0,,,
5950,5950,Lumiar (Estr. Torre),,38.77394670,-9.16148180,,,0,,,
4004,4004,Alcntara - Av. 24 Julho,,38.70430670,-9.17394580,,,0,,,
3826,3826,R. Alecrim,,38.70806570,-9.14340080,,,0,,,
3806,3806,Cais Sodr,,38.70633440,-9.14517890,,,0,,,
3816,3816,Mercado Ribeira,,38.70708840,-9.14460440,,,0,,,
8848,8848,Estr. Outeiro,,38.73234370,-9.20317480,,,0,,,
8818,8818,Estr. Alfragide,,38.74084370,-9.20889480,,,0,,,
8808,8808,B. Boavista,,38.73647470,-9.20591480,,,0,,,
8838,8838,Estdio Pina Manique,,38.73649470,-9.20166780,,,0,,,
8828,8828,B. Boavista,,38.73616570,-9.20545480,,,0,,,
5704,5704,Campo Grande - Av. Brasil,,38.75392070,-9.15255980,,,0,,,
8514,8514,R. D. Joo V,,38.72071370,-9.16071980,,,0,,,
2722,2722,B. Liberdade,,38.73075070,-9.17332080,,,0,,,
2712,2712,Estao Sete Rios,,38.73891850,-9.16845540,,,0,,,
2702,2702,Estao Campolide,,38.73124470,-9.16846680,,,0,,,
3606,3606,Bela Vista (Centro Comercial),,38.74842670,-9.11847980,,,0,,,
9808,9808,Igreja Madre Deus (Museu Azulejo),,38.72447970,-9.11382380,,,0,,,
6724,6724,R. Poiais S. Bento,,38.71077170,-9.15186380,,,0,,,
6714,6714,P. Flores,,38.71490970,-9.15155680,,,0,,,
9504,9504,R. Junqueira (Centro Congressos),,38.69979070,-9.18434480,,,0,,,
3722,3722,B. Alfinetes,,38.74186070,-9.10844580,,,0,,,
6704,6704,Palcio S. Bento (Jardim),,38.71348670,-9.15332280,,,0,,,
3702,3702,R. Dinah Silveira Queiroz,,38.74065170,-9.11205280,,,0,,,
3712,3712,B. Salgadas,,38.73843870,-9.11335280,,,0,,,
7910,7910,Moscavide (Metro),,38.77472340,-9.10249160,,,0,,,
6034,6034,R. Raul Rego,,38.78414270,-9.15131280,,,0,,,
6024,6024,B. Sete Cus,,38.78590170,-9.14994480,,,0,,,
6014,6014,Igreja Charneca,,38.78362670,-9.14255180,,,0,,,
7724,7724,R. Cidade Benguela (Mercado),,38.76519070,-9.11091280,,,0,,,
7704,7704,Av. Berlim (Viveiros),,38.76908670,-9.11731380,,,0,,,
7714,7714,Piscina Olivais,,38.76914570,-9.10989380,,,0,,,
7004,7004,P. Paiva Couceiro,,38.73120470,-9.12795880,,,0,,,
7014,7014,P. Paiva Couceiro,,38.73054870,-9.12748280,,,0,,,
8313,8313,Av. Inf. D. Henrique (Beato ID),,38.73300870,-9.10433480,,,0,,,
8303,8303,Xabregas,,38.72744170,-9.11028780,,,0,,,
8323,8323,Av. Inf. D. Henrique (Ponte Xabregas),,38.72539390,-9.11213900,,,0,,,
1910,1910,Av. 5 Outubro / Av. lvaro Pais,,38.74345430,-9.14908220,,,0,,,
9303,9303,R. Correia Teles,,38.71889570,-9.17134380,,,0,,,
1704,1704,Picoas,,38.73143570,-9.14632680,,,0,,,
1714,1714,Picoas,,38.73107970,-9.14656780,,,0,,,
2910,2910,B. Sta. Cruz,,38.74783770,-9.20737480,,,0,,,
4002,4002,Alcntara Mar,,38.70295270,-9.17341580,,,0,,,
1004,1004,Restauradores,,38.71563370,-9.14191280,,,0,,,
8846,8846,B. Boavista - Estr. Outeiro,,38.73479870,-9.20193680,,,0,,,
8816,8816,R. Venezuela,,38.74526170,-9.20296680,,,0,,,
8836,8836,Estr. Buraca,,38.74162170,-9.20288980,,,0,,,
8826,8826,Estdio Pina Manique,,38.73562720,-9.20303180,,,0,,,
2724,2724,Serafina,,38.73237470,-9.17268870,,,0,,,
2714,2714,Estao Campolide,,38.72999470,-9.16823880,,,0,,,
2704,2704,Estao Campolide,,38.73084570,-9.16859980,,,0,,,
4106,4106,C. Ajuda / R. Gen. Joo Almeida,,38.70120670,-9.19985180,,,0,,,
3920,3920,R. Esperana (Museu Marioneta),,38.70788520,-9.15584380,,,0,,,
3910,3910,Santos-o-Velho,,38.70643470,-9.15862780,,,0,,,
8606,8606,C. Sete Moinhos,,38.72620170,-9.17041880,,,0,,,
2004,2004,Entrecampos,,38.74742370,-9.14843980,,,0,,,
9806,9806,R. Madre Deus,,38.72342170,-9.11529780,,,0,,,
9816,9816,R. Madre Deus,,38.72264070,-9.11565780,,,0,,,
9826,9826,C. Lajes (Escola),,38.72165660,-9.11636360,,,0,,,
3724,3724,R. Eduarda Lapa,,38.74114920,-9.10919480,,,0,,,
3704,3704,Esc. Marvila,,38.73991870,-9.11060680,,,0,,,
3714,3714,R. Salgueiro Maia,,38.74804270,-9.11294380,,,0,,,
8712,8712,Estr. Oliveiras Baixo (Bombeiros),,38.72625770,-9.19621880,,,0,,,
8702,8702,Cruz Oliveiras,,38.72534370,-9.19407180,,,0,,,
6032,6032,R. Joo Amaral,,38.78685670,-9.14968480,,,0,,,
6022,6022,R. Tito Morais,,38.78253470,-9.14741180,,,0,,,
9606,9606,B. Terras Forno,,38.70183320,-9.20635110,,,0,,,
6002,6002,R. Joo Amaral,,38.78758270,-9.14837400,,,0,,,
3024,3024,R. Bartolomeu Dias,,38.74883970,-9.21846980,,,0,,,
3004,3004,Damaia Cima,,38.74675170,-9.22020580,,,0,,,
3014,3014,P. guas Livres,,38.74708610,-9.21645420,,,0,,,
6126,6126,Av. Calouste Gulbenkian,,38.73225970,-9.16487380,,,0,,,
6116,6116,R. Marqus Fronteira,,38.72953370,-9.15834680,,,0,,,
9712,9712,Av. D. Vasco Gama,,38.70097370,-9.21633480,,,0,,,
6106,6106,Campolide,,38.72765570,-9.16071380,,,0,,,
7002,7002,R. Baro Sabrosa,,38.73535270,-9.12885780,,,0,,,
7012,7012,R. Morais Soares (Cemitrio),,38.73026570,-9.12492680,,,0,,,
7106,7106,Conde Baro,,38.70862270,-9.15175680,,,0,,,
1012,1012,Restauradores,,38.71543970,-9.14189880,,,0,,,
6403,6403,P. Londres,,38.74059570,-9.13755080,,,0,,,
8910,8910,Rot. Olaias,,38.73924070,-9.12623980,,,0,,,
8920,8920,Qta. Lavrado,,38.73386670,-9.12514880,,,0,,,
2022,2022,Estao Entrecampos,,38.74592970,-9.14747680,,,0,,,
2012,2012,R. Afonso Lopes Vieira,,38.74988370,-9.14734880,,,0,,,
2002,2002,Entrecampos,,38.74760670,-9.14847280,,,0,,,
4204,4204,R. D. Jernimo Osrio,,38.69936570,-9.22493480,,,0,,,
4224,4224,R. Latino Coelho,,38.70317370,-9.22711680,,,0,,,
7403,7403,Av. D. Rodrigo Cunha / R. Ed. Noronha,,38.75440370,-9.13156580,,,0,,,
7413,7413,Av. Gago Coutinho / Av. D. Rodrigo Cunha,,38.75380270,-9.13061380,,,0,,,
8714,8714,Cruz Oliveiras,,38.72397470,-9.19361980,,,0,,,
8704,8704,Av. Tenente Martins,,38.72869470,-9.19076080,,,0,,,
2126,2126,R. Vale Sto. Antnio,,38.71788170,-9.12291280,,,0,,,
2116,2116,Campo Sta. Clara,,38.71507870,-9.12622980,,,0,,,
2106,2106,R. Vale Sto. Antnio,,38.71804670,-9.12217880,,,0,,,
3022,3022,Estao Damaia,,38.74764670,-9.21499980,,,0,,,
3002,3002,R. Bartolomeu Dias,,38.74804570,-9.21707580,,,0,,,
3012,3012,Damaia - Av. D. Joo V,,38.74548770,-9.21806080,,,0,,,
8014,8014,R. Sampaio Bruno,,38.71896770,-9.16955580,,,0,,,
8004,8004,Campo Ourique (Prazeres),,38.71479040,-9.16929110,,,0,,,
8024,8024,R. Saraiva Carvalho / R. Estrela,,38.71682470,-9.16114880,,,0,,,
9714,9714,Av. Restelo,,38.69983370,-9.21432180,,,0,,,
9004,9004,P. Bernardo Santareno,,38.74451520,-9.12824880,,,0,,,
1403,1403,S. Sebastio,,38.73459770,-9.15400080,,,0,,,
1413,1413,S. Sebastio,,38.73485270,-9.15265580,,,0,,,
7224,7224,Chapeleiro 2,,38.79241770,-9.15737080,,,0,,,
7204,7204,Sr. Roubado,,38.78580170,-9.16991180,,,0,,,
7214,7214,Estr. Desvio / R. Prof. J. Pinto Correia,,38.78201240,-9.16297020,,,0,,,
2403,2403,Oceanrio Lisboa,,38.76109170,-9.09643480,,,0,,,
5809,5809,Campo Grande (Metro),,38.75938470,-9.15753880,,,0,,,
5829,5829,Campo Grande (Metro),,38.76045620,-9.15624560,,,0,,,
5839,5839,R. Agostinho Neto,,38.76176570,-9.15382980,,,0,,,
6819,6819,Rato,,38.72045670,-9.15539080,,,0,,,
6809,6809,R. Braamcamp,,38.72213170,-9.15179580,,,0,,,
1214,1214,Mq. Pombal - R. Braamcamp,,38.72390120,-9.15097780,,,0,,,
1224,1224,R. Joaquim Antnio Aguiar,,38.72490470,-9.15484180,,,0,,,
89914,89914,R. Eng. Ferreira Dias,,38.75219290,-9.11685630,,,0,,,
89915,89915,R. Eng. Ferreira Dias,,38.75219070,-9.11651880,,,0,,,
89916,89916,R. Eng. Rodrigues Carvalho,,38.75492770,-9.11812480,,,0,,,
89917,89917,R. Eng. Rodrigues Carvalho,,38.75494770,-9.11794680,,,0,,,
89910,89910,Esc. D. Dinis,,38.75195970,-9.11403480,,,0,,,
89911,89911,Esc. D. Dinis,,38.75213970,-9.11404180,,,0,,,
89912,89912,Esc. D. Dinis,,38.75175470,-9.11358580,,,0,,,
89913,89913,Esc. D. Dinis,,38.75204970,-9.11349980,,,0,,,
83108,83108,B. Madre Deus (Escola),,38.73384570,-9.11275480,,,0,,,
83109,83109,C. Teixeira,,38.73567740,-9.11702100,,,0,,,
89918,89918,Esc. D. Dinis,,38.75253970,-9.11472780,,,0,,,
89919,89919,ISEL,,38.75651270,-9.11334480,,,0,,,
83104,83104,R. Marqus Olho,,38.73144920,-9.11245120,,,0,,,
83105,83105,B. Madre Deus,,38.73204770,-9.11439380,,,0,,,
4302,4302,Igreja Cruz Quebrada,,38.70098810,-9.24945440,,,0,,,
83106,83106,B. Madre Deus,,38.73193370,-9.11496980,,,0,,,
83107,83107,B. Madre Deus (Escola),,38.73402770,-9.11264080,,,0,,,
7809,7809,Qta. Conde Arcos,,38.77054070,-9.10866280,,,0,,,
83102,83102,R. Nicolau Tolentino,,38.73102170,-9.10964880,,,0,,,
83103,83103,R. Marqus Olho,,38.73139110,-9.11100490,,,0,,,
8012,8012,Esc. Manuel Maia,,38.71711770,-9.16949280,,,0,,,
8002,8002,R. Saraiva Carvalho,,38.71546370,-9.16452680,,,0,,,
8022,8022,R. Arco Carvalho II,,38.72110470,-9.16914880,,,0,,,
2214,2214,Vale Formoso Cima,,38.74979070,-9.10308480,,,0,,,
2204,2204,Matinha,,38.74777070,-9.09684080,,,0,,,
8106,8106,Estrela (Baslica),,38.71383370,-9.16042080,,,0,,,
9002,9002,Alto Pina,,38.73750770,-9.12744580,,,0,,,
401,401,Alameda D. A. Henriques,,38.73651170,-9.13113280,,,0,,,
403,403,Alameda D. A. Henriques,,38.73655670,-9.13352180,,,0,,,
402,402,Alameda D. A. Henriques,,38.73694570,-9.13398880,,,0,,,
405,405,Alameda D. A. Henriques,,38.73667670,-9.13245380,,,0,,,
404,404,P. Joo Rio,,38.74051670,-9.13363180,,,0,,,
407,407,Av. Guerra Junqueiro,,38.73751570,-9.13475880,,,0,,,
406,406,Av. Manuel Maia,,38.73644470,-9.13593280,,,0,,,
409,409,Alameda D. A. Henriques,,38.73659770,-9.13324380,,,0,,,
408,408,Alameda D. A. Henriques,,38.73602270,-9.13407180,,,0,,,
50020,50020,Qta. Barros,,38.75574070,-9.16859380,,,0,,,
50021,50021,Av. Naes Unidas,,38.76462470,-9.17705180,,,0,,,
50022,50022,Av. Naes Unidas,,38.76408270,-9.17660780,,,0,,,
9106,9106,Sapadores,,38.72230070,-9.12908280,,,0,,,
50023,50023,Alto Faia Sul,,38.76523020,-9.17161160,,,0,,,
9116,9116,R. Mato Grosso,,38.71952670,-9.12285880,,,0,,,
50024,50024,Alto Faia Sul,,38.76523850,-9.17180300,,,0,,,
9126,9126,R. Angelina Vidal,,38.72285270,-9.13131380,,,0,,,
50025,50025,R. Prof. Prado Coelho,,38.76700970,-9.17066480,,,0,,,
9136,9136,Sapadores,,38.72140770,-9.12922580,,,0,,,
50026,50026,R. Prof. Prado Coelho,,38.76694870,-9.17097680,,,0,,,
50027,50027,R. F. George / R. Alexandre Cabral,,38.76799670,-9.16978080,,,0,,,
1809,1809,Av. Repblica,,38.73852570,-9.14586980,,,0,,,
50028,50028,R. F. George / R. Alexandre Cabral,,38.76809970,-9.16935780,,,0,,,
50029,50029,Alto Faia,,38.76765270,-9.16857580,,,0,,,
79201,79201,Sacavm - Az. Cabeo,,38.78918650,-9.11056200,,,0,,,
79202,79202,Sacavm - R. Estado ndia,,38.79037030,-9.10909530,,,0,,,
79203,79203,R. Estado ndia,,38.79064930,-9.10847010,,,0,,,
501,501,R. Morais Soares,,38.73273770,-9.13040480,,,0,,,
502,502,R. Morais Soares,,38.73265570,-9.13055180,,,0,,,
503,503,P. Chile,,38.73326470,-9.13247480,,,0,,,
504,504,P. Chile,,38.73322870,-9.13279280,,,0,,,
505,505,P. Chile / Av. Almirante Reis,,38.73257270,-9.13424480,,,0,,,
506,506,P. Chile / Av. Almirante Reis,,38.73246870,-9.13439780,,,0,,,
12410,12410,Restelo - Av. Descobertas,,38.70916810,-9.21429690,,,0,,,
507,507,P. Chile,,38.73443370,-9.13507580,,,0,,,
12411,12411,Restelo,,38.71101370,-9.21081180,,,0,,,
508,508,R. Morais Soares,,38.73244470,-9.13084280,,,0,,,
509,509,P. Chile,,38.73334670,-9.13278780,,,0,,,
12415,12415,Restelo (Torres),,38.71192700,-9.21170090,,,0,,,
12416,12416,Estr. Pedro Teixeira,,38.71361970,-9.20365580,,,0,,,
7302,7302,Av. Estados Unidos Amrica,,38.74865070,-9.13204580,,,0,,,
5807,5807,Campo Grande (Metro),,38.76095220,-9.15712780,,,0,,,
5827,5827,Campo Grande (Metro),,38.76157800,-9.15755170,,,0,,,
5837,5837,R. Amilcar Cabral,,38.76483270,-9.15282280,,,0,,,
2809,2809,B. Calhariz Benfica,,38.74312470,-9.19826680,,,0,,,
603,603,P. Novas Naes,,38.72634970,-9.13269880,,,0,,,
602,602,R. Forno Tijolo,,38.72342270,-9.13178780,,,0,,,
601,601,R. Forno Tijolo,,38.72390970,-9.13202980,,,0,,,
5909,5909,R. Alexandre Ferreira,,38.77638570,-9.16273980,,,0,,,
5919,5919,Estr. Lumiar,,38.77372420,-9.16995380,,,0,,,
607,607,Av. Almirante Reis / R. Angola,,38.72525770,-9.13495280,,,0,,,
606,606,R. Jos Estvo,,38.72727470,-9.13794180,,,0,,,
605,605,Av. Almirante Reis / R. Febo Moniz,,38.72643070,-9.13556880,,,0,,,
5949,5949,Pao Lumiar,,38.77117070,-9.17372280,,,0,,,
604,604,Av. Almirante Reis / R. Angola,,38.72601370,-9.13432180,,,0,,,
8443,8443,R. Cidade Novo Redondo,,38.76494270,-9.11605480,,,0,,,
5959,5959,Estr. Torre,,38.77430660,-9.15947010,,,0,,,
609,609,Av. Almirante Reis / R. Marques Silva,,38.72906670,-9.13456580,,,0,,,
8413,8413,R. Cidade Bissau (Metro),,38.76047970,-9.11199380,,,0,,,
608,608,Av. Almirante Reis / R. Angola,,38.72558070,-9.13508680,,,0,,,
8403,8403,Olivais Sul,,38.76427970,-9.11879680,,,0,,,
8433,8433,Olivais (Centro Cvico),,38.76217170,-9.11660880,,,0,,,
8423,8423,Cemitrio Olivais,,38.76236170,-9.10954280,,,0,,,
6817,6817,R. S. Bento / R. Arco,,38.71736570,-9.15514680,,,0,,,
6807,6807,Rato,,38.71991770,-9.15468980,,,0,,,
3819,3819,R. S. Paulo,,38.70772570,-9.14414280,,,0,,,
703,703,R. Damasceno Monteiro,,38.72103970,-9.13177780,,,0,,,
701,701,Igreja Anjos,,38.72215470,-9.13525780,,,0,,,
706,706,R. Maria Andrade,,38.72356270,-9.13446580,,,0,,,
707,707,R. Maria Andrade,,38.72343570,-9.13382880,,,0,,,
6909,6909,Gomes Freire,,38.72620770,-9.14072180,,,0,,,
704,704,Igreja Anjos,,38.72212370,-9.13543980,,,0,,,
12612,12612,Portela - R. Mouzinho Albuquerque,,38.78548370,-9.11149180,,,0,,,
12613,12613,Portela - Av. Descobrimentos,,38.78194470,-9.11398780,,,0,,,
12610,12610,C. Comercial Portela,,38.78381170,-9.11249880,,,0,,,
12611,12611,Portela - R. Mouzinho Albuquerque,,38.78549470,-9.11138880,,,0,,,
708,708,R. Maria,,38.72381970,-9.13324580,,,0,,,
9403,9403,Tv. Horta Navia,,38.70958870,-9.17198380,,,0,,,
709,709,R. Maria Fonte,,38.72311770,-9.13199780,,,0,,,
12617,12617,Portela - R. Escritores,,38.78244270,-9.10837480,,,0,,,
9413,9413,C. Livramento,,38.70581770,-9.17174380,,,0,,,
9423,9423,R. Cruz Alcntara,,38.70906070,-9.17435980,,,0,,,
12615,12615,C. Comercial Portela,,38.78101570,-9.11182580,,,0,,,
9433,9433,R. Qta. Jacinto,,38.70720170,-9.17589280,,,0,,,
1302,1302,Av. Antnio Augusto Aguiar,,38.72898670,-9.14956480,,,0,,,
12618,12618,Portela (Seminrio),,38.78133770,-9.10716780,,,0,,,
7807,7807,P. Jos Queirs,,38.77396770,-9.10477280,,,0,,,
12619,12619,Portela (Seminrio),,38.78122370,-9.10748280,,,0,,,
7817,7817,Estao Oriente (Interface),,38.76818070,-9.09998380,,,0,,,
7909,7909,Moscavide (Metro),,38.77473730,-9.10214500,,,0,,,
12511,12511,Poo Bispo,,38.74304200,-9.10176120,,,0,,,
12510,12510,Palcio Mitra,,38.73918470,-9.10312080,,,0,,,
12513,12513,Beato,,38.73554040,-9.10363430,,,0,,,
12512,12512,Poo Bispo,,38.74245770,-9.10243880,,,0,,,
12515,12515,Estr. Marvila,,38.73522870,-9.10845980,,,0,,,
12514,12514,Beato,,38.73527870,-9.10394280,,,0,,,
12517,12517,Estr. Marvila / Az. Alfinetes,,38.73805770,-9.10720980,,,0,,,
12516,12516,Estr. Marvila,,38.73514480,-9.10872080,,,0,,,
12519,12519,R. Marvila,,38.73961270,-9.10649280,,,0,,,
12518,12518,Az. Veigas,,38.73633620,-9.10807300,,,0,,,
2322,2322,Av. Inf. D. Henrique / Av. Pdua,,38.76344670,-9.10408180,,,0,,,
2312,2312,Az. Baptista,,38.75288870,-9.10362980,,,0,,,
2302,2302,Av. Mar. Gomes Costa (Universidade),,38.75758770,-9.10879330,,,0,,,
104,104,P. Alvalade (Esc. Eugnio Santos),,38.75405270,-9.14463480,,,0,,,
105,105,P. Alvalade,,38.75347970,-9.14257180,,,0,,,
106,106,P. Alvalade (Esc. Eugnio Santos),,38.75474070,-9.14465380,,,0,,,
8204,8204,Cais Lingueta,,38.71101770,-9.12684580,,,0,,,
107,107,Av. Igreja,,38.75205570,-9.14739980,,,0,,,
101,101,Esc. Rainha D. Leonor,,38.75183870,-9.14321580,,,0,,,
102,102,Esc. Rainha D. Leonor,,38.75208670,-9.14361180,,,0,,,
12014,12014,Pavilho Desportivo Ajuda,,38.70609170,-9.18288780,,,0,,,
103,103,P. Alvalade (Esc. Eugnio Santos),,38.75422070,-9.14441680,,,0,,,
12015,12015,Tv. Fornos / R. Cruzeiro,,38.70625170,-9.18976480,,,0,,,
12016,12016,R. Joo Barros,,38.70575370,-9.18489580,,,0,,,
12017,12017,R. Cruzeiro / R. Eng. Antnio M. Avelar,,38.70588770,-9.18815280,,,0,,,
12010,12010,Alto Sto. Amaro,,38.70256770,-9.18792880,,,0,,,
12011,12011,R. Joo Barros,,38.70528370,-9.18540980,,,0,,,
108,108,P. Alvalade,,38.75341970,-9.14327080,,,0,,,
12012,12012,R. Joo Barros,,38.70553140,-9.18527990,,,0,,,
12013,12013,Pavilho Desportivo Ajuda,,38.70602670,-9.18224080,,,0,,,
3302,3302,R. Beneficncia (Rego),,38.74168070,-9.15733880,,,0,,,
3312,3312,R. Alberto Sousa,,38.74605470,-9.15776380,,,0,,,
1807,1807,Saldanha,,38.73391970,-9.14464080,,,0,,,
79103,79103,Rot. Oliveiras,,38.78068910,-9.09641870,,,0,,,
79102,79102,Jardim Jacarands,,38.77871260,-9.09541000,,,0,,,
79101,79101,Jardim Jacarands,,38.77876170,-9.09524180,,,0,,,
207,207,R. Joo Vilarett,,38.74516870,-9.14104180,,,0,,,
206,206,Lg. Machado Assis,,38.74690570,-9.13973380,,,0,,,
9204,9204,Campo Mrtires Ptria,,38.72223570,-9.13971780,,,0,,,
79107,79107,Rossio do Levante,,38.78318170,-9.09407780,,,0,,,
205,205,Av. Roma / Av. EUA,,38.74934670,-9.14279080,,,0,,,
9214,9214,Campo Mrtires Ptria,,38.72196370,-9.13920480,,,0,,,
79106,79106,Av. Peregrinao,,38.78222670,-9.09573980,,,0,,,
204,204,Av. Roma / Av. EUA,,38.75000570,-9.14250780,,,0,,,
79105,79105,Av. Peregrinao,,38.78218870,-9.09538680,,,0,,,
203,203,Av. Roma / Av. EUA,,38.75008870,-9.14214580,,,0,,,
79104,79104,Rot. Oliveiras,,38.78060840,-9.09648490,,,0,,,
202,202,B. S. Miguel - Av. Roma,,38.74743270,-9.14108080,,,0,,,
201,201,B. S. Miguel - Av. Roma,,38.74757270,-9.14082480,,,0,,,
12713,12713,R. Direita Palma,,38.74829930,-9.16821570,,,0,,,
1909,1909,Campo Pequeno - Av. Antnio Serpa,,38.74332620,-9.14766740,,,0,,,
12712,12712,Estr. Luz (Loja Cidado),,38.74966570,-9.17259780,,,0,,,
79109,79109,Parque Naes Norte,,38.79348270,-9.09776380,,,0,,,
12711,12711,Estr. Luz (Loja Cidado),,38.75086870,-9.17312980,,,0,,,
79108,79108,Rossio do Levante,,38.78321370,-9.09512380,,,0,,,
12710,12710,Laranjeiras (Metro),,38.74774670,-9.17125480,,,0,,,
12715,12715,Laranjeiras (Loja Cidado),,38.75019610,-9.17184940,,,0,,,
12714,12714,R. Afonso Botelho,,38.74882490,-9.16941090,,,0,,,
208,208,Av. Roma / Av. EUA,,38.74900470,-9.14261580,,,0,,,
2817,2817,R. Garridas,,38.74558670,-9.20062880,,,0,,,
13410,13410,Boa Hora,,38.70375670,-9.19498520,,,0,,,
13411,13411,R. D. Joo Castro,,38.70504970,-9.18989580,,,0,,,
13412,13412,Centro Sade Ajuda,,38.70552570,-9.19430680,,,0,,,
13413,13413,Travessa Giestal,,38.70311270,-9.19099980,,,0,,,
13414,13414,Travessa Giestal,,38.70172770,-9.19082580,,,0,,,
13415,13415,R. Giestal,,38.70030570,-9.19083080,,,0,,,
306,306,Av. Roma (Piscina),,38.74454870,-9.13950580,,,0,,,
13416,13416,C. Boa Hora,,38.69952120,-9.19010720,,,0,,,
307,307,Av. Roma (Piscina),,38.74429170,-9.13911780,,,0,,,
13417,13417,Boa Hora,,38.70294060,-9.19476080,,,0,,,
304,304,Av. Joo XXI / P. Londres,,38.74237170,-9.13756380,,,0,,,
305,305,Av. Joo XXI / P. Londres,,38.74251470,-9.13633780,,,0,,,
302,302,Areeiro,,38.74214370,-9.13444920,,,0,,,
5907,5907,Lumiar,,38.77325420,-9.16134680,,,0,,,
5917,5917,Igreja Lumiar,,38.77435520,-9.16618780,,,0,,,
5927,5927,Ameixoeira (Metro),,38.77950570,-9.15944780,,,0,,,
301,301,Areeiro - Av. Afonso Costa,,38.74229270,-9.13189980,,,0,,,
5937,5937,Az. Torre Fato,,38.77026970,-9.17713280,,,0,,,
12214,12214,R. Escolas,,38.77436900,-9.11944460,,,0,,,
2909,2909,B. Sta. Cruz,,38.74788070,-9.20724780,,,0,,,
12212,12212,Av. Dr. Alfredo Bensade,,38.77902870,-9.11735780,,,0,,,
12213,12213,Mercado Encarnao,,38.77668470,-9.12003880,,,0,,,
12210,12210,Centro Sade Olivais,,38.77254470,-9.11778680,,,0,,,
12211,12211,Centro Sade Olivais,,38.77245170,-9.11793880,,,0,,,
308,308,Areeiro - Av. Alm. Gago Coutinho,,38.74329470,-9.13282780,,,0,,,
309,309,Areeiro,,38.74237570,-9.13450680,,,0,,,
4005,4005,Alcntara Mar,,38.70326540,-9.17477530,,,0,,,
3807,3807,Cais Sodr,,38.70554570,-9.14312580,,,0,,,
3817,3817,Cais Sodr,,38.70666070,-9.14327380,,,0,,,
8849,8849,Estr. Outeiro,,38.73218470,-9.20334880,,,0,,,
8819,8819,Buraca (B. Tacha),,38.74180070,-9.21169880,,,0,,,
8839,8839,Lisboa Clube Tnis,,38.73048470,-9.20387280,,,0,,,
8829,8829,B. Boavista,,38.73638390,-9.20542030,,,0,,,
12115,12115,Calvrio,,38.70477960,-9.17738630,,,0,,,
12114,12114,R. Lusadas,,38.70518270,-9.18094980,,,0,,,
6907,6907,Gomes Freire,,38.72620870,-9.14088780,,,0,,,
12117,12117,Alcntara - C. Tapada,,38.70724770,-9.17892880,,,0,,,
3909,3909,Santos-o-Velho,,38.70669770,-9.15801480,,,0,,,
12116,12116,Calvrio,,38.70481770,-9.17737380,,,0,,,
12111,12111,Estao Sto. Amaro,,38.70221770,-9.18067180,,,0,,,
12110,12110,R. Alcntara,,38.70624570,-9.17560180,,,0,,,
12113,12113,R. Lusadas,,38.70536140,-9.18018800,,,0,,,
12112,12112,Estao Sto. Amaro,,38.70259070,-9.18093380,,,0,,,
12119,12119,C. Tapada,,38.70627070,-9.17938080,,,0,,,
12118,12118,Alcntara - C. Tapada,,38.70661280,-9.17875410,,,0,,,
9809,9809,Av. Inf. D. Henrique (Ponte Xabregas),,38.72475370,-9.11157480,,,0,,,
13612,13612,R. Soeiros,,38.75472970,-9.17948280,,,0,,,
9819,9819,Esc. Patricio Prazeres,,38.72181370,-9.11995980,,,0,,,
13613,13613,R. Joo Freitas Branco,,38.75248970,-9.18014780,,,0,,,
13610,13610,R. Toms Fonseca / R. A. A. Machado,,38.75598570,-9.17085580,,,0,,,
13611,13611,R. Soeiros,,38.75440050,-9.18031090,,,0,,,
13616,13616,R. A. A. Machado / R. S. Toms Aquino,,38.75281470,-9.16790980,,,0,,,
13617,13617,B. S. Joo,,38.75357070,-9.17450380,,,0,,,
18401,18401,Av. Bombeiros V. Algs,,38.70788830,-9.22563120,,,0,,,
13614,13614,R. Joo Freitas Branco,,38.75234170,-9.17997680,,,0,,,
18402,18402,Av. Bombeiros V. Algs,,38.70733970,-9.22559080,,,0,,,
13615,13615,R. Mateus Vicente,,38.75597870,-9.17885780,,,0,,,
18403,18403,Av. Bombeiros V. Algs (Cinema),,38.70572770,-9.22681880,,,0,,,
18404,18404,Av. Bombeiros V. Algs (Cinema),,38.70529770,-9.22675080,,,0,,,
13618,13618,B. S. Joo,,38.75452370,-9.17559880,,,0,,,
13619,13619,R. S. Toms Aquino,,38.75163270,-9.16750280,,,0,,,
7917,7917,Moscavide - P. Jos Queirs,,38.77362270,-9.10474680,,,0,,,
6035,6035,R. Raul Rego,,38.78391070,-9.15165980,,,0,,,
6025,6025,R. Tito Morais,,38.78306970,-9.14760580,,,0,,,
6015,6015,Vale Castanheira,,38.77974300,-9.14856800,,,0,,,
6005,6005,Charneca,,38.78718470,-9.14251180,,,0,,,
13511,13511,Cidade Universitria,,38.75059970,-9.15877480,,,0,,,
13510,13510,Cantina Universidade,,38.75140270,-9.15876080,,,0,,,
13513,13513,Hosp. Sta. Maria,,38.75021070,-9.16021180,,,0,,,
13512,13512,Hosp. Sta. Maria,,38.74999170,-9.15905080,,,0,,,
13515,13515,Hosp. Sta. Maria - Av. Prof. Gama Pinto,,38.74798280,-9.15740730,,,0,,,
13514,13514,Cantina Universidade,,38.75020370,-9.15890780,,,0,,,
12317,12317,Lab. Qumica Militar,,38.77753770,-9.11317880,,,0,,,
12316,12316,Olivais Norte,,38.77585170,-9.11107480,,,0,,,
12315,12315,Olivais Norte,,38.77627370,-9.11101380,,,0,,,
12312,12312,P. Norte (Mercado),,38.77630270,-9.11800380,,,0,,,
12311,12311,P. Norte (Mercado),,38.77673670,-9.11788680,,,0,,,
12310,12310,Olivais Norte,,38.77424470,-9.11125480,,,0,,,
7005,7005,Penha Frana,,38.72852070,-9.13082980,,,0,,,
7015,7015,P. Paiva Couceiro,,38.73055970,-9.12709780,,,0,,,
12319,12319,Av. Dr. Alfredo Bensade,,38.77931370,-9.11621680,,,0,,,
12318,12318,Lab. Qumica Militar,,38.77758170,-9.11370280,,,0,,,
8312,8312,Av. Inf. D. Henrique (Doca Xabregas),,38.72900510,-9.10734460,,,0,,,
8302,8302,Ponte Xabregas,,38.72593780,-9.11258930,,,0,,,
8322,8322,Mercado Xabregas,,38.72811270,-9.11492180,,,0,,,
18602,18602,Outurela,,38.72483370,-9.22799780,,,0,,,
18603,18603,Outurela (B. 18 Maio),,38.72484070,-9.22692480,,,0,,,
18601,18601,Outurela,,38.72406370,-9.22752580,,,0,,,
18604,18604,Outurela (Pav. Carlos Queiroz),,38.72378010,-9.22597880,,,0,,,
18605,18605,Outurela (Pav. Carlos Queiroz),,38.72365770,-9.22599980,,,0,,,
9302,9302,Meia Laranja,,38.71639670,-9.17242380,,,0,,,
13712,13712,R. Joo Ortigo Ramos,,38.75630570,-9.20394680,,,0,,,
13711,13711,Calia,,38.75739960,-9.20444020,,,0,,,
13710,13710,Calia,,38.75769390,-9.20515930,,,0,,,
809,809,R. S. Lzaro,,38.71860270,-9.13670480,,,0,,,
805,805,Martim Moniz,,38.71488750,-9.13642290,,,0,,,
804,804,R. Palma,,38.71916270,-9.13573080,,,0,,,
807,807,Martim Moniz,,38.71577770,-9.13693180,,,0,,,
2907,2907,R. Casquilha,,38.74595670,-9.20650880,,,0,,,
803,803,R. Palma,,38.71914290,-9.13556090,,,0,,,
802,802,Escadas do Monte,,38.71892370,-9.13335780,,,0,,,
1005,1005,Restauradores,,38.71545370,-9.14175580,,,0,,,
1015,1015,Glria - Restauradores,,38.71604020,-9.14225190,,,0,,,
8847,8847,B. Boavista - Estr. Outeiro,,38.73448470,-9.20218980,,,0,,,
8807,8807,B. Boavista,,38.73593280,-9.20602320,,,0,,,
8837,8837,Estdio Pina Manique,,38.73700070,-9.20187780,,,0,,,
8827,8827,Estdio Pina Manique,,38.73583570,-9.20347180,,,0,,,
13212,13212,Inst. Altos Estudos Militares,,38.69689070,-9.22012080,,,0,,,
13213,13213,Av. Torre Belm,,38.69687010,-9.21457240,,,0,,,
13210,13210,Centro Cultural Belm,,38.69629570,-9.20934080,,,0,,,
13211,13211,Inst. Altos Estudos Militares,,38.69660670,-9.22048980,,,0,,,
908,908,Rossio,,38.71330970,-9.13962280,,,0,,,
909,909,Rossio,,38.71356070,-9.13883280,,,0,,,
4115,4115,Altinho (MAAT),,38.69736970,-9.19416280,,,0,,,
4105,4105,C. Ajuda / R. Gen. Joo Almeida,,38.70067570,-9.19978780,,,0,,,
904,904,Sta. Justa - Lg. Carmo,,38.71205670,-9.13958320,,,0,,,
3927,3927,Santos,,38.70638870,-9.15424180,,,0,,,
905,905,P. Figueira,,38.71374430,-9.13652860,,,0,,,
906,906,P. Figueira,,38.71383150,-9.13735030,,,0,,,
12818,12818,Av. Cidade Praga (Lispolis),,38.76643290,-9.18396990,,,0,,,
3907,3907,R. Janelas Verdes (Museu Arte Antiga),,38.70539070,-9.16048080,,,0,,,
12819,12819,Carnide,,38.75943070,-9.18683380,,,0,,,
901,901,Rossio,,38.71427170,-9.13911380,,,0,,,
902,902,Rossio,,38.71384850,-9.13980540,,,0,,,
12814,12814,Carnide (Metro),,38.75980030,-9.19088740,,,0,,,
8919,8919,Picheleira (Qta. Lavrado),,38.73270370,-9.12220980,,,0,,,
903,903,Sta. Justa - R. Ouro,,38.71213350,-9.13923010,,,0,,,
12815,12815,Av. Cidade Praga (Lispolis),,38.76628330,-9.18322590,,,0,,,
8909,8909,Olaias,,38.73898770,-9.12339080,,,0,,,
12816,12816,Carnide,,38.75930170,-9.18737980,,,0,,,
12817,12817,Carnide (Metro),,38.75945070,-9.19017380,,,0,,,
12810,12810,B. Horta Nova,,38.76705270,-9.18170180,,,0,,,
12811,12811,B. Horta Nova,,38.76728370,-9.18129280,,,0,,,
12812,12812,Estao Pontinha,,38.76063920,-9.19462580,,,0,,,
12813,12813,Estao Pontinha,,38.76032970,-9.19413480,,,0,,,
2015,2015,Entrecampos Norte,,38.74999770,-9.14834480,,,0,,,
2005,2005,Entrecampos - Av. EUA,,38.74841370,-9.14673580,,,0,,,
13115,13115,R. Tristo Vaz,,38.70758070,-9.20595380,,,0,,,
9807,9807,Igreja Madre Deus (Museu Azulejo),,38.72469070,-9.11338180,,,0,,,
13114,13114,Esc. Paula Vicente,,38.70573670,-9.20229480,,,0,,,
9817,9817,Cruz da Pedra,,38.72308470,-9.11554180,,,0,,,
13117,13117,R. Gonalves Zarco,,38.70564970,-9.20516380,,,0,,,
13116,13116,R. Tristo Vaz,,38.70771570,-9.20584680,,,0,,,
13111,13111,C. Galvo (GNR),,38.70755600,-9.20259780,,,0,,,
18703,18703,Portela,,38.72124570,-9.22151480,,,0,,,
13110,13110,Esc. Paula Vicente,,38.70559070,-9.20384880,,,0,,,
18702,18702,Portela,,38.72124510,-9.22133730,,,0,,,
13113,13113,Esc. Paula Vicente,,38.70563870,-9.20243880,,,0,,,
13112,13112,C. Galvo (GNR),,38.70730670,-9.20251080,,,0,,,
18707,18707,Portas Queluz,,38.72451970,-9.21404680,,,0,,,
18706,18706,Portas Queluz,,38.72362970,-9.21547480,,,0,,,
18705,18705,Outurela (Escola),,38.72231070,-9.22461880,,,0,,,
18704,18704,Outurela (Escola),,38.72237070,-9.22457280,,,0,,,
13119,13119,Restelo (EPUL),,38.70621270,-9.21275780,,,0,,,
13118,13118,R. Gonalves Zarco,,38.70593670,-9.20510680,,,0,,,
18709,18709,R. Proletariado,,38.72217230,-9.21765490,,,0,,,
18708,18708,R. Proletariado,,38.72227670,-9.21779880,,,0,,,
3005,3005,Estao Damaia,,38.74811370,-9.21450680,,,0,,,
3015,3015,P. guas Livres,,38.74684370,-9.21621480,,,0,,,
6125,6125,Av. Calouste Gulbenkian,,38.73225170,-9.16450880,,,0,,,
6115,6115,R. Marqus Fronteira,,38.72909070,-9.15920280,,,0,,,
6105,6105,Campolide,,38.72749870,-9.16291980,,,0,,,
13315,13315,Tv. Memria,,38.70257170,-9.20084780,,,0,,,
18105,18105,Alfragide (Qta. Grande),,38.73532370,-9.21870680,,,0,,,
13312,13312,R. D. Vasco,,38.70530270,-9.19603150,,,0,,,
18104,18104,Av. D. Luis I,,38.73138330,-9.21834560,,,0,,,
13311,13311,C. Ajuda / Tv. Boa Hora,,38.70298170,-9.19945980,,,0,,,
18107,18107,Alfragide (NATO),,38.73665170,-9.21584980,,,0,,,
13310,13310,Igreja Memria,,38.70236150,-9.20242100,,,0,,,
18106,18106,Av. Ivens,,38.73326100,-9.21978380,,,0,,,
18101,18101,Alfragide Sul,,38.73332270,-9.21712780,,,0,,,
18103,18103,Av. Ivens,,38.73351690,-9.21963880,,,0,,,
18102,18102,B. Alto Moinho,,38.72785250,-9.21234510,,,0,,,
7105,7105,Conde Baro,,38.70881670,-9.15130280,,,0,,,
12919,12919,R. Aucenas,,38.70881070,-9.20001780,,,0,,,
12918,12918,R. Jos Pinto Bastos,,38.71402370,-9.20603280,,,0,,,
18109,18109,Alfragide (F. Area),,38.73877370,-9.21402950,,,0,,,
18108,18108,Alfragide (Qta. Grande),,38.73537970,-9.21883780,,,0,,,
12915,12915,Cemitrio Ajuda,,38.70904470,-9.20321280,,,0,,,
12914,12914,B. Caramo,,38.71101240,-9.20558120,,,0,,,
12917,12917,Cemitrio Ajuda,,38.70978100,-9.20311930,,,0,,,
12916,12916,Cemitrio Ajuda,,38.70961270,-9.20332780,,,0,,,
12911,12911,Av. Dr. Mrio Moutinho,,38.71140070,-9.20853180,,,0,,,
12910,12910,B. Ajuda (Escola),,38.71210070,-9.20177780,,,0,,,
12913,12913,B. Caramo,,38.71081530,-9.20500430,,,0,,,
12912,12912,Av. Dr. Mrio Moutinho,,38.71153070,-9.20843480,,,0,,,
8917,8917,Esc. Eng. Duarte Pacheco,,38.73528270,-9.12123080,,,0,,,
8907,8907,Picheleira - R. Dr. Faria Vasconcelos,,38.73885470,-9.12034380,,,0,,,
4215,4215,Algs (Jardim),,38.69926670,-9.23145780,,,0,,,
4205,4205,R. D. Jernimo Osrio,,38.69996300,-9.22399670,,,0,,,
4225,4225,R. Latino Coelho,,38.70320870,-9.22735080,,,0,,,
13814,13814,R. Escolas Gerais,,38.71308770,-9.12970180,,,0,,,
13815,13815,S. Tom,,38.71438670,-9.13070390,,,0,,,
13816,13816,Miradouro Sta. Luzia,,38.71131670,-9.13070780,,,0,,,
13817,13817,C. S. Vicente,,38.71350040,-9.12868220,,,0,,,
13810,13810,Castelo,,38.71229470,-9.13248380,,,0,,,
13811,13811,Lg. Portas Sol,,38.71243070,-9.13051510,,,0,,,
13812,13812,Lg. Portas Sol,,38.71218470,-9.13040180,,,0,,,
13813,13813,R. Escolas Gerais,,38.71288970,-9.12948680,,,0,,,
2125,2125,R. Paraso,,38.71342670,-9.12526880,,,0,,,
2115,2115,Estao Sta. Apolnia,,38.71434280,-9.12272230,,,0,,,
2105,2105,R. Vale Sto. Antnio,,38.71774070,-9.12205480,,,0,,,
8015,8015,R. Sampaio Bruno,,38.71862570,-9.16965680,,,0,,,
8005,8005,R. Francisco Metrass,,38.71736170,-9.16669780,,,0,,,
8025,8025,R. Campo Ourique,,38.72085570,-9.16415380,,,0,,,
9005,9005,R. Sarmento Beires,,38.74260520,-9.12756880,,,0,,,
91105,91105,R. Vale Sto. Antnio / Tv. Olival,,38.71992570,-9.12429480,,,0,,,
91106,91106,R. Vale Sto. Antnio / R. Sta. Engrcia,,38.71841310,-9.12299910,,,0,,,
11401,11401,R. Murtas Poente,,38.75880170,-9.15003480,,,0,,,
7225,7225,Chapeleiro 1,,38.79051570,-9.15977780,,,0,,,
7205,7205,Estr. Desvio / Qta. Lavadeiras,,38.78370370,-9.16351480,,,0,,,
7215,7215,Qta. Moleirinha,,38.78441770,-9.16106080,,,0,,,
13911,13911,Pontinha (Metro),,38.76169280,-9.19702470,,,0,,,
13910,13910,Pontinha,,38.76596770,-9.19887780,,,0,,,
13913,13913,Pontinha (Metro),,38.76149870,-9.19718380,,,0,,,
13912,13912,Pontinha (Metro),,38.76172480,-9.19663550,,,0,,,
11602,11602,Estr. Forte (Escola),,38.79040070,-9.15064080,,,0,,,
11603,11603,Galinheiras,,38.79226870,-9.15076180,,,0,,,
11601,11601,Estr. Forte (Escola),,38.79075570,-9.15075580,,,0,,,
11606,11606,Az. Galinheiras,,38.79388470,-9.14991180,,,0,,,
11607,11607,Grafanil,,38.79315570,-9.15540180,,,0,,,
11604,11604,Az. Galinheiras,,38.79377470,-9.14986680,,,0,,,
11605,11605,Qta. Balsares,,38.79350170,-9.15204480,,,0,,,
1205,1205,Mq. Pombal - Av. Fontes P. Melo,,38.72669150,-9.14902890,,,0,,,
1215,1215,Mq. Pombal - R. Joaquim A. Aguiar,,38.72499870,-9.15266680,,,0,,,
11608,11608,Galinheiras,,38.79243470,-9.15024480,,,0,,,
89904,89904,ISEL,,38.75560070,-9.11282180,,,0,,,
1225,1225,Mq. Pombal - Av. Fontes P. Melo,,38.72654220,-9.14909380,,,0,,,
11609,11609,Qta. Torrinha,,38.79088870,-9.15729980,,,0,,,
89905,89905,Av. Dr. Augusto Castro,,38.75372970,-9.11422580,,,0,,,
89906,89906,ISEL,,38.75509670,-9.11354080,,,0,,,
89907,89907,R. Dr. Jos Espirito Santo,,38.75300770,-9.10566680,,,0,,,
89901,89901,R. Capito-Mor Lopes Sequeira,,38.75443070,-9.10934980,,,0,,,
89902,89902,R. Capito-Mor Lopes Sequeira,,38.75439470,-9.10875380,,,0,,,
89903,89903,ISEL,,38.75576270,-9.11372280,,,0,,,
89908,89908,R. Dr. Jos Espirito Santo,,38.75303270,-9.10550980,,,0,,,
89909,89909,ISEL,,38.75462870,-9.11370680,,,0,,,
11501,11501,Estao Alta Lisboa,,38.77461870,-9.14739480,,,0,,,
11503,11503,Alta de Lisboa (Qta. Conchas),,38.76987170,-9.14854780,,,0,,,
11502,11502,Esc. Alto Lumiar,,38.77467770,-9.15582580,,,0,,,
11505,11505,Estao Alta Lisboa,,38.77465770,-9.14895590,,,0,,,
11504,11504,Alta de Lisboa (Qta. Conchas),,38.76880970,-9.14906480,,,0,,,
11507,11507,Av. Carlos Paredes,,38.77423670,-9.15196110,,,0,,,
11506,11506,Alta Lisboa (C. Sade),,38.77664420,-9.14558850,,,0,,,
11509,11509,Esc. Pintor Almada Negreiros,,38.77728230,-9.14642440,,,0,,,
11508,11508,Esc. Alto Lumiar,,38.77491070,-9.15533280,,,0,,,
2215,2215,R. Fernando Palha,,38.74696970,-9.09973080,,,0,,,
2205,2205,Vale Formoso Cima,,38.75088670,-9.10459180,,,0,,,
8105,8105,Estrela - R. Domingos Sequeira,,38.71441170,-9.16067580,,,0,,,
11006,11006,Portas Benfica,,38.75341570,-9.20849380,,,0,,,
11007,11007,Portas Benfica,,38.75262970,-9.20949380,,,0,,,
11001,11001,Portas Benfica,,38.75270970,-9.20877480,,,0,,,
11008,11008,Estr. Benfica (Mercado),,38.75287870,-9.20618180,,,0,,,
11009,11009,Estr. Benfica (Mercado),,38.75199870,-9.20582880,,,0,,,
411,411,P. Joo Rio,,38.74019870,-9.13342780,,,0,,,
410,410,Alameda D. A. Henriques,,38.73718570,-9.13398680,,,0,,,
413,413,Alameda D. A. Henriques,,38.73694970,-9.13371480,,,0,,,
414,414,Alameda D. A. Henriques,,38.73729870,-9.13366780,,,0,,,
417,417,R. Baro Sabrosa,,38.73724930,-9.12912080,,,0,,,
416,416,Av. Guerra Junqueiro,,38.73871840,-9.13549990,,,0,,,
50031,50031,R. Armindo Rodrigues,,38.76811370,-9.16723680,,,0,,,
50032,50032,R. Armindo Rodrigues,,38.76880370,-9.16744980,,,0,,,
9105,9105,Sapadores,,38.72155470,-9.12971580,,,0,,,
50033,50033,R. Frederico George,,38.76945020,-9.16665780,,,0,,,
9115,9115,R. Mato Grosso,,38.71982270,-9.12315980,,,0,,,
50034,50034,R. F. George (R. Daniel Santa Rita),,38.76973220,-9.16518480,,,0,,,
9125,9125,Sapadores,,38.72142770,-9.12938180,,,0,,,
9135,9135,R. Francisco Pedro Curado,,38.72724170,-9.12569280,,,0,,,
11703,11703,Av. Afonso III,,38.72770570,-9.11964180,,,0,,,
11702,11702,Cemitrio Alto S. Joo,,38.72886370,-9.12218680,,,0,,,
11701,11701,Cemitrio Alto S. Joo,,38.72947890,-9.12308410,,,0,,,
11707,11707,Az. Alto Varejo,,38.72576970,-9.12241980,,,0,,,
11706,11706,Vale Escuro,,38.72836770,-9.12466680,,,0,,,
11705,11705,Vale Escuro,,38.72854220,-9.12457380,,,0,,,
11704,11704,Av. Afonso III,,38.72748770,-9.11960280,,,0,,,
11709,11709,R. Sousa Viterbo,,38.72732940,-9.12109610,,,0,,,
11708,11708,Az. Alto Varejo,,38.72503970,-9.12239180,,,0,,,
510,510,R. Pascoal Melo,,38.73138870,-9.13614680,,,0,,,
511,511,R. Pascoal Melo,,38.73122570,-9.13570580,,,0,,,
512,512,Lg. Leo,,38.73491770,-9.13696580,,,0,,,
517,517,R. Pereira Carrilho,,38.73401670,-9.13574380,,,0,,,
518,518,R. Pereira Carrilho,,38.73413970,-9.13575380,,,0,,,
11206,11206,Av. EUA / R. Moura Giro,,38.74874170,-9.13464480,,,0,,,
11204,11204,Av. Rio Janeiro / Av. EUA,,38.74890270,-9.13673480,,,0,,,
11205,11205,Av. Rio Janeiro / Av. EUA,,38.75024370,-9.13728380,,,0,,,
11202,11202,Estdio 1. Maio,,38.75246970,-9.13790780,,,0,,,
11203,11203,Av. EUA / R. Moura Giro,,38.74911170,-9.13642080,,,0,,,
11201,11201,Estdio 1. Maio,,38.75309570,-9.13800480,,,0,,,
11208,11208,R. Dr. Gama Barros,,38.74794470,-9.13640480,,,0,,,
11209,11209,Av. Rio Janeiro / Av. EUA,,38.74924470,-9.13828380,,,0,,,
613,613,R. Jos Estvo,,38.72789020,-9.13762620,,,0,,,
611,611,R. Passos Manuel,,38.72801870,-9.13677480,,,0,,,
5908,5908,R. Lumiar,,38.77596170,-9.16340480,,,0,,,
610,610,Av. Almirante Reis / R. Marques Silva,,38.72878270,-9.13477880,,,0,,,
5918,5918,Az. Poo Baixo,,38.77254770,-9.17018480,,,0,,,
5928,5928,Az. S. Gonalo,,38.78161870,-9.15656180,,,0,,,
616,616,R. Jos Estvo,,38.72733870,-9.13736780,,,0,,,
5938,5938,Lumiar,,38.77032270,-9.16122780,,,0,,,
615,615,R. Jos Estvo,,38.72743370,-9.13845180,,,0,,,
5948,5948,R. Tefilo Carvalho Santos,,38.77041770,-9.17308680,,,0,,,
5958,5958,Estr. Torre,,38.77416670,-9.15974880,,,0,,,
11105,11105,Arco Cego,,38.73458570,-9.14157280,,,0,,,
11104,11104,Av. Manuel Maia (INE),,38.73874570,-9.13671480,,,0,,,
11107,11107,R. Alves Redol,,38.73749270,-9.14062580,,,0,,,
11106,11106,R. Visconde Santarm,,38.73494130,-9.13962930,,,0,,,
11101,11101,Arco Cego,,38.73511170,-9.14241980,,,0,,,
11103,11103,Av. Manuel Maia (INE),,38.73827870,-9.13683480,,,0,,,
11102,11102,Arco Cego,,38.73489170,-9.14146680,,,0,,,
11109,11109,Av. Antnio Jos Almeida,,38.73825370,-9.13967740,,,0,,,
11108,11108,Av. Rovisco Pais,,38.73519370,-9.13957080,,,0,,,
12622,12622,R. Cons. Teles Vasconcelos,,38.77689170,-9.10997880,,,0,,,
12623,12623,Portela - Lg. Bombeiros Voluntrios,,38.77907870,-9.11108180,,,0,,,
12620,12620,RALIS,,38.78140470,-9.12034080,,,0,,,
12621,12621,R. Cons. Teles Vasconcelos,,38.77678370,-9.11019980,,,0,,,
12627,12627,Portela - Av. Repblica,,38.78394770,-9.10982480,,,0,,,
12624,12624,Portela - Lg. Bombeiros Voluntrios,,38.77942370,-9.11090480,,,0,,,
12625,12625,C. Comercial Portela,,38.78109170,-9.11035580,,,0,,,
6408,6408,P. Londres,,38.74033170,-9.13744480,,,0,,,
7908,7908,Moscavide (Metro),,38.77511370,-9.10256480,,,0,,,
12521,12521,Estr. Marvila / Az. Alfinetes,,38.73815270,-9.10730880,,,0,,,
12520,12520,R. Marvila,,38.73931370,-9.10665180,,,0,,,
12523,12523,Fbrica Brao Prata,,38.74461170,-9.10212980,,,0,,,
12522,12522,Marvila,,38.74087470,-9.10566280,,,0,,,
12525,12525,Az. Veigas,,38.73657970,-9.10778680,,,0,,,
12524,12524,Fbrica Brao Prata,,38.74436370,-9.10220580,,,0,,,
12527,12527,Poo Bispo,,38.74251970,-9.10027880,,,0,,,
12526,12526,Poo Bispo,,38.74175670,-9.10040980,,,0,,,
11307,11307,Bombeiros Alvalade,,38.75710270,-9.14015780,,,0,,,
11306,11306,LNEC,,38.75813870,-9.14164980,,,0,,,
11305,11305,Pote gua,,38.75964070,-9.13647380,,,0,,,
11304,11304,Hosp. Jlio Matos,,38.75704070,-9.14444580,,,0,,,
11303,11303,LNEC,,38.75840570,-9.14038380,,,0,,,
7408,7408,Lg. Frei Heitor Pinto,,38.75507870,-9.13883280,,,0,,,
11302,11302,Hosp. Jlio Matos,,38.75594370,-9.14562980,,,0,,,
11301,11301,Hosp. Jlio Matos,,38.75626570,-9.14719480,,,0,,,
11309,11309,USF Parque,,38.75946070,-9.14924780,,,0,,,
11308,11308,Pote gua,,38.75949870,-9.13714880,,,0,,,
8205,8205,R. Remdios,,38.71212070,-9.12704580,,,0,,,
9205,9205,Hosp. Sto. Antnio Capuchos,,38.72295270,-9.14185880,,,0,,,
9215,9215,Faculdade Medicina,,38.72028170,-9.13999280,,,0,,,
1908,1908,Campo Pequeno - Av. Defensores Chaves,,38.74154070,-9.14421080,,,0,,,
1408,1408,Av. Visconde Valmor,,38.73790370,-9.14988280,,,0,,,
13401,13401,Boa Hora,,38.70297580,-9.19461960,,,0,,,
13402,13402,Boa Hora - R. Guarda Jias,,38.70486570,-9.19380980,,,0,,,
13403,13403,R. Qta. Almargem,,38.70112670,-9.19242780,,,0,,,
13404,13404,C. Boa Hora,,38.70216670,-9.19267180,,,0,,,
13405,13405,Rio Seco,,38.70340970,-9.19158780,,,0,,,
316,316,Estao Roma-Areeiro,,38.74551470,-9.13626880,,,0,,,
13406,13406,Rio Seco,,38.70370770,-9.19087180,,,0,,,
317,317,Areeiro - Av. Alm. Gago Coutinho,,38.74341470,-9.13241080,,,0,,,
13407,13407,C. Boa Hora,,38.70307070,-9.19331380,,,0,,,
314,314,Estao Roma-Areeiro,,38.74610270,-9.13282280,,,0,,,
13408,13408,C. Boa Hora,,38.70313670,-9.19339080,,,0,,,
13409,13409,Boa Hora,,38.70369270,-9.19471480,,,0,,,
312,312,Areeiro - Av. Afonso Costa,,38.74195290,-9.13174540,,,0,,,
313,313,Av. Alm. Gago Coutinho,,38.74570270,-9.13112480,,,0,,,
310,310,Av. Alm. Gago Coutinho,,38.74520270,-9.13154580,,,0,,,
311,311,Areeiro - Av. Alm. Gago Coutinho,,38.74329670,-9.13249680,,,0,,,
2908,2908,R. Casquilha,,38.74589970,-9.20634980,,,0,,,
319,319,Areeiro,,38.74236970,-9.13436380,,,0,,,
11804,11804,B. Alvito,,38.71392170,-9.18148280,,,0,,,
11805,11805,Estr. Alvito (Clube Desportivo),,38.71699570,-9.18387480,,,0,,,
2408,2408,Av. Fernando Pessoa,,38.75848440,-9.09712760,,,0,,,
11806,11806,Estr. Alvito (Clube Desportivo),,38.71647470,-9.18373980,,,0,,,
11801,11801,Estdio Tapadinha,,38.70968370,-9.17945180,,,0,,,
11802,11802,Estdio Tapadinha,,38.70954070,-9.17957280,,,0,,,
11803,11803,B. Alvito,,38.71422770,-9.18179980,,,0,,,
3908,3908,R. Janelas Verdes (Museu Arte Antiga),,38.70510470,-9.16133680,,,0,,,
12121,12121,Calvrio,,38.70478170,-9.17766880,,,0,,,
12120,12120,C. Tapada,,38.70609170,-9.17900780,,,0,,,
12122,12122,Calvrio,,38.70538270,-9.17653880,,,0,,,
13602,13602,R. Toms Fonseca,,38.75612970,-9.17644280,,,0,,,
13603,13603,Viaduto Luz,,38.75733970,-9.17741780,,,0,,,
13601,13601,R. Toms Fonseca,,38.75596930,-9.17598650,,,0,,,
13606,13606,Estr. Luz / R. Soeiros,,38.75659570,-9.17738880,,,0,,,
13607,13607,Colgio Militar,,38.75826170,-9.17999280,,,0,,,
13605,13605,Estr. Luz / R. Soeiros,,38.75664070,-9.17781980,,,0,,,
13608,13608,Colgio Militar,,38.75889170,-9.18072180,,,0,,,
13609,13609,R. Toms Fonseca / R. A. A. Machado,,38.75576070,-9.17044980,,,0,,,
13501,13501,Faculdade Farmcia,,38.74738170,-9.15524680,,,0,,,
13503,13503,Hosp. Sta. Maria - Av. Prof. Gama Pinto,,38.74855870,-9.15739080,,,0,,,
13502,13502,Faculdade Farmcia,,38.74723770,-9.15461880,,,0,,,
13505,13505,Hosp. Sta. Maria - Av. Prof. Gama Pinto,,38.75008370,-9.15812880,,,0,,,
13504,13504,Cidade Universitria,,38.75265170,-9.15940180,,,0,,,
13507,13507,Cantina Universidade,,38.75075870,-9.15885980,,,0,,,
13506,13506,Hosp. Sta. Maria,,38.75000470,-9.15934680,,,0,,,
13509,13509,Hosp. Sta. Maria,,38.75000370,-9.15970280,,,0,,,
13508,13508,Hosp. Sta. Maria,,38.75019770,-9.16157780,,,0,,,
12320,12320,Av. Dr. Alfredo Bensade,,38.77906570,-9.11628780,,,0,,,
11905,11905,Esc. Vale Alcntara,,38.71737540,-9.17483060,,,0,,,
11904,11904,B. Loureiro - Av. Ceuta,,38.71592370,-9.17579980,,,0,,,
11906,11906,R. Qta. Loureiro,,38.71529470,-9.17550880,,,0,,,
11901,11901,Av. Ceuta / R. Arco Carvalho,,38.71937370,-9.17478480,,,0,,,
11903,11903,B. Loureiro - Av. Ceuta,,38.71587770,-9.17550580,,,0,,,
11902,11902,Av. Ceuta / R. Arco Carvalho,,38.71867070,-9.17504180,,,0,,,
13703,13703,Cemitrio Benfica,,38.75673870,-9.20113180,,,0,,,
13702,13702,R. Joo Ortigo Ramos,,38.75639110,-9.20419040,,,0,,,
13701,13701,R. Joo Ortigo Ramos,,38.75632070,-9.20376380,,,0,,,
13706,13706,Charquinho,,38.75571470,-9.19942680,,,0,,,
13705,13705,Charquinho,,38.75578970,-9.19981480,,,0,,,
13704,13704,Cemitrio Benfica,,38.75687270,-9.20140380,,,0,,,
819,819,Martim Moniz,,38.71549990,-9.13603550,,,0,,,
13709,13709,C. Tojal (Cemitrio Benfica),,38.75659970,-9.20478880,,,0,,,
818,818,Martim Moniz,,38.71604470,-9.13570680,,,0,,,
13708,13708,C. Tojal (Cemitrio Benfica),,38.75668430,-9.20461990,,,0,,,
815,815,Martim Moniz,,38.71475820,-9.13762480,,,0,,,
817,817,Socorro,,38.71671170,-9.13514680,,,0,,,
816,816,Martim Moniz,,38.71587770,-9.13576080,,,0,,,
811,811,Desterro,,38.71981470,-9.13809880,,,0,,,
810,810,R. S. Lzaro,,38.71821970,-9.13632880,,,0,,,
813,813,C. Desterro,,38.71966320,-9.13631660,,,0,,,
812,812,Desterro,,38.71971770,-9.13775780,,,0,,,
13206,13206,Lg. Princesa,,38.69505080,-9.21456760,,,0,,,
13207,13207,Lg. Princesa,,38.69578470,-9.21502780,,,0,,,
13204,13204,Pedrouos,,38.69592370,-9.21884180,,,0,,,
13205,13205,Lg. Princesa,,38.69495770,-9.21548480,,,0,,,
13203,13203,Pedrouos,,38.69603670,-9.21955680,,,0,,,
13201,13201,USF Descobertas,,38.69524730,-9.22032120,,,0,,,
919,919,Rossio,,38.71440370,-9.13921180,,,0,,,
12828,12828,Esc. Carnide,,38.75967170,-9.17972880,,,0,,,
13209,13209,Centro Cultural Belm,,38.69608070,-9.20971180,,,0,,,
12829,12829,R. Eugnio Salvador,,38.76709970,-9.17933380,,,0,,,
12824,12824,Igreja Carnide,,38.75959170,-9.18524280,,,0,,,
912,912,P. Figueira,,38.71391370,-9.13801380,,,0,,,
12825,12825,Av. Cidade Praga,,38.76463370,-9.18994880,,,0,,,
8918,8918,C. Carrascal,,38.73438770,-9.11851080,,,0,,,
913,913,Lg. Caldas,,38.71205330,-9.13590020,,,0,,,
12826,12826,Av. Cidade Praga,,38.76390270,-9.19005680,,,0,,,
8908,8908,Rot. Olaias,,38.73848970,-9.12534180,,,0,,,
12827,12827,Esc. Carnide,,38.75976470,-9.17963480,,,0,,,
12821,12821,Carnide (Metro),,38.75949270,-9.19263780,,,0,,,
12822,12822,Carnide (Metro),,38.75904570,-9.19262780,,,0,,,
12823,12823,Igreja Carnide,,38.75983470,-9.18503580,,,0,,,
13105,13105,Av. Ilha Madeira (Museu de Etnologia),,38.70534410,-9.20770350,,,0,,,
13104,13104,R. Mem Rodrigues,,38.70736470,-9.20860680,,,0,,,
13107,13107,Estdio Restelo,,38.70400670,-9.20635180,,,0,,,
13106,13106,Av. Ilha Madeira (Museu de Etnologia),,38.70557970,-9.20764780,,,0,,,
13101,13101,Restelo - R. Tristo Vaz,,38.70952170,-9.20845980,,,0,,,
18711,18711,Estr. Portela,,38.72036570,-9.21937260,,,0,,,
8408,8408,Av. Mar. Gomes Costa (Poo Cortes),,38.76015870,-9.11709880,,,0,,,
13103,13103,R. Mem Rodrigues,,38.70709570,-9.20860380,,,0,,,
18710,18710,Estr. Portela,,38.72026370,-9.21956480,,,0,,,
8438,8438,R. Cidade Novo Redondo,,38.76501270,-9.11621180,,,0,,,
13102,13102,Restelo - R. Tristo Vaz,,38.70969670,-9.20842780,,,0,,,
8428,8428,R. Cons. Emdio Navarro (ISEL),,38.75711170,-9.11617280,,,0,,,
13109,13109,Esc. Paula Vicente,,38.70529440,-9.20476970,,,0,,,
13108,13108,Estdio Restelo,,38.70387970,-9.20655780,,,0,,,
9408,9408,R. Capito Afonso Pala,,38.70905540,-9.17141430,,,0,,,
6608,6608,Gomes Freire - R. Joaquim Bonifcio,,38.72779850,-9.14324960,,,0,,,
9418,9418,Alcntara,,38.70589070,-9.17270580,,,0,,,
9428,9428,Av. Ceuta,,38.70723570,-9.17415680,,,0,,,
13307,13307,R. Bica Marqus,,38.70420770,-9.19948080,,,0,,,
13306,13306,R. D. Vasco,,38.70493470,-9.19672280,,,0,,,
13305,13305,R. D. Vasco,,38.70489270,-9.19624680,,,0,,,
13304,13304,R. Bica Marqus,,38.70477700,-9.19895960,,,0,,,
18115,18115,Estr. Alfragide / R. Encosta,,38.73488470,-9.22147280,,,0,,,
13303,13303,R. Bica Marqus,,38.70470170,-9.19865780,,,0,,,
18114,18114,Estr. Zambujal,,38.73457370,-9.21543880,,,0,,,
7608,7608,Geofsica,,38.77583970,-9.12649880,,,0,,,
13302,13302,R. Jardim Botnico,,38.70576370,-9.19986680,,,0,,,
13301,13301,R. Jardim Botnico,,38.70569520,-9.19989370,,,0,,,
18116,18116,Alfragide Sul,,38.73289370,-9.21695680,,,0,,,
18111,18111,B. Alto Moinho,,38.72752470,-9.21214580,,,0,,,
18110,18110,Alfragide (NATO),,38.73652570,-9.21637780,,,0,,,
18113,18113,Estr. Zambujal,,38.73485570,-9.21553380,,,0,,,
18112,18112,Alfragide (F. Area),,38.73826450,-9.21410350,,,0,,,
13309,13309,Igreja Memria,,38.70233900,-9.20253510,,,0,,,
13308,13308,R. Bica Marqus,,38.70432970,-9.19929580,,,0,,,
12929,12929,Cemitrio Ajuda,,38.70993770,-9.20307080,,,0,,,
18119,18119,Av. Qta. Grande / R. Encosta,,38.73576970,-9.22170280,,,0,,,
12928,12928,Plo Universitrio Ajuda (ISCSP),,38.71369220,-9.19731380,,,0,,,
18118,18118,Av. Qta. Grande / R. Encosta,,38.73565970,-9.22166680,,,0,,,
12925,12925,Clube Atltico Caramo,,38.71285270,-9.20684480,,,0,,,
12924,12924,B. 2 Maio,,38.71217170,-9.19879380,,,0,,,
12927,12927,Av. Universidade Tcnica (UTL),,38.71358970,-9.20048780,,,0,,,
12926,12926,Av. Helen Keller,,38.71170130,-9.20774890,,,0,,,
12921,12921,CIF,,38.71337590,-9.20995980,,,0,,,
12920,12920,R. Aucenas,,38.70899200,-9.20031710,,,0,,,
12923,12923,B. 2 Maio,,38.71209570,-9.19917880,,,0,,,
12922,12922,CIF,,38.71355470,-9.21006580,,,0,,,
1608,1608,Esc. D. Pedro V,,38.74127980,-9.16308600,,,0,,,
1618,1618,Centro Sade Sete Rios,,38.73994720,-9.16848280,,,0,,,
1628,1628,USF Sete Rios,,38.73963620,-9.16883880,,,0,,,
13808,13808,Costa Castelo,,38.71179270,-9.13287880,,,0,,,
13809,13809,S. Tom,,38.71343370,-9.13064680,,,0,,,
13804,13804,Limoeiro,,38.71016870,-9.13233380,,,0,,,
13805,13805,Miradouro Sta. Luzia,,38.71158370,-9.13056980,,,0,,,
13806,13806,C. S. Vicente,,38.71350870,-9.12871880,,,0,,,
13807,13807,Lg. Contador Mor,,38.71168370,-9.13096180,,,0,,,
13801,13801,S,,38.70976370,-9.13376280,,,0,,,
13802,13802,S,,38.71005470,-9.13426180,,,0,,,
13803,13803,Limoeiro,,38.71032970,-9.13162380,,,0,,,
3608,3608,B. Armador,,38.74659870,-9.11925480,,,0,,,
13909,13909,Pontinha,,38.76517510,-9.19893870,,,0,,,
13908,13908,Pontinha,,38.76512360,-9.19908080,,,0,,,
13905,13905,Pontinha,,38.76443070,-9.19980680,,,0,,,
13904,13904,Pontinha (Metro),,38.76185080,-9.19697070,,,0,,,
13907,13907,Pontinha (Metro),,38.76155690,-9.19671020,,,0,,,
13906,13906,Pontinha,,38.76604970,-9.19817680,,,0,,,
13901,13901,Pontinha Centro,,38.76673970,-9.20226580,,,0,,,
13903,13903,R. Ilha Terceira,,38.76589670,-9.20118380,,,0,,,
13902,13902,R. Sto. Eloy,,38.76684770,-9.20095780,,,0,,,
83124,83124,C. Duque Lafes / Trav. Olival,,38.73324620,-9.10674770,,,0,,,
83120,83120,Esc. Luis Antnio Verney,,38.73455170,-9.11353880,,,0,,,
83121,83121,Estr. Marvila,,38.73464970,-9.10856580,,,0,,,
83122,83122,C. Duque Lafes,,38.73376470,-9.10742080,,,0,,,
83123,83123,R. Luis Barbosa,,38.73569170,-9.11449080,,,0,,,
8608,8608,Viaduto Duarte Pacheco,,38.72321270,-9.16566980,,,0,,,
6038,6038,Av. Srgio Vieira Mello,,38.78099870,-9.14908080,,,0,,,
6028,6028,Av. Srgio Vieira Mello,,38.78155870,-9.14824480,,,0,,,
6018,6018,Vale Castanheira,,38.77986870,-9.14837780,,,0,,,
9608,9608,R. Jernimos,,38.69980270,-9.20579080,,,0,,,
6008,6008,Charneca,,38.78718470,-9.14459480,,,0,,,
50001,50001,Az. Galhardas,,38.75718770,-9.16677980,,,0,,,
50002,50002,Az. Galhardas,,38.75742170,-9.16735680,,,0,,,
50003,50003,R. Prof. Vieira Almeida,,38.76419420,-9.16695860,,,0,,,
50004,50004,R. Prof. Queirs Veloso,,38.76437760,-9.17122250,,,0,,,
50005,50005,R. Prof. Francisco Gentil (Metro),,38.76110410,-9.16685750,,,0,,,
50006,50006,R. Prof. Francisco Gentil (Metro),,38.76048200,-9.16755060,,,0,,,
50007,50007,R. Prof. Joo Barreira,,38.76246170,-9.17067780,,,0,,,
50008,50008,R. Prof. Vieira Almeida,,38.76455870,-9.16658780,,,0,,,
7008,7008,Penha Frana,,38.72852270,-9.13094780,,,0,,,
7018,7018,R. Baro Sabrosa / R. Baldaques,,38.73321870,-9.12834380,,,0,,,
      4503,4503,Sul e Sueste,,38.70726170,-9.13328830,,,0,,,
    `;
    const STOP_SEARCH_ICON = "";
    const MAX_STOP_SEARCH_RESULTS = 8;
    const NEAREST_STOP_RADIUS_METERS = 340; // meters
    let stopCatalogEntries = buildStopCatalogEntries(STOP_CATALOG_CSV);
    let stopCatalogPromise = null;
    const ROUTE_TRANSLATOR = { byId: {}, base: {} };
    const CATEGORY_FILTER_ALL = "__ALL_CATEGORIES__";
    const ROUTE_FILTER_ALL = "__ALL_ROUTES__";
    const VARIANT_FILTER_ALL = "__ALL_VARIANTS__";
    const ROUTE_GLOBAL_LABEL = " Rede Completa";
    const STANDARD_ROUTE_CATEGORIES = [
      "Autocarros Diurnos",
      "Carreiras de Bairro",
      "Eltricos",
      "Rede Madrugada"
    ];
    const observedCategories = new Set(STANDARD_ROUTE_CATEGORIES);
    // Zone mapping provided by Carris (for future zoning features).
    const ZONE_COLOR_BY_NAME = {
      Bairro: "#FFE113",
      Centro: "#FF7F00",
      Ocidental: "#FF0078",
      Madrugada: "#0060A9",
      Transversal: "#808080",
      Oriental: "#F70002",
      Noroeste: "#00A0EF",
      Norte: "#39BA2E"
    };
    const ZONE_ROUTE_BASES = {
      Centro: new Set([
        "12E", "24E", "25E", "28E", "51E", "52E", "53E", "54E", "55E",
        "702", "706", "709", "712", "713", "730", "734", "737", "740",
        "773", "774", "790", "797"
      ]),
      Ocidental: new Set([
        "15E", "18E", "714", "723", "732", "748", "751", "760", "776",
        "784", "786"
      ]),
      Madrugada: new Set([
        "201", "202", "203", "204", "205", "206", "207", "208", "209", "210"
      ]),
      Transversal: new Set([
        "701", "703", "720", "727", "728", "728F", "738", "742", "750", "752",
        "753", "756", "767"
      ]),
      Oriental: new Set([
        "16E", "705", "708", "718", "722", "725", "731", "744", "745", "749",
        "755", "759", "779", "781", "782", "783", "793", "794"
      ]),
      Noroeste: new Set([
        "711", "716", "724", "726", "729", "746", "754", "758", "763", "764",
        "765", "768", "770", "771", "780", "799"
      ]),
      Norte: new Set([
        "717", "735", "736", "747", "757", "777", "778", "796", "798"
      ])
    };

    function dedupeList(list) {
      const seen = new Set();
      return list
        .map(item => (item || "").trim())
        .filter(item => {
          if (!item) return false;
          const key = item.toLowerCase();
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
    }

    // Always add the ngrok bypass header to skip the warning page.
    const NGROK_SKIP_HEADER_VALUE = "true";
    function withNgrokBypass(options = {}) {
      const headers = new Headers(options.headers || {});
      headers.set("ngrok-skip-browser-warning", NGROK_SKIP_HEADER_VALUE);
      return { ...options, headers };
    }

	    function normalizeBaseUrl(raw) {
	      if (!raw) return null;
	      const value = raw.trim();
	      if (!value) return null;
	      const proto = (typeof location !== "undefined" && location.protocol && location.protocol !== "file:") ? location.protocol : "http:";
	      const host = (typeof location !== "undefined" && location.hostname) ? location.hostname : "127.0.0.1";
	      if (/^\d+$/.test(value)) return `${proto}//${host}:${value}`;
	      if (/^[\w.-]+:\d+$/i.test(value)) return `${proto}//${value}`;
	      if (/^https?:\/\//i.test(value)) return value;
	      return null;
	    }

	    function resolveBackendBases() {
	      const bases = ["https://4belhato.trade"];
	      const override = urlParams.get("backend") || urlParams.get("api_base");
	      const normalizedOverride = normalizeBaseUrl(override);
	      if (normalizedOverride) bases.push(normalizedOverride);
	      const originOk = typeof location !== "undefined" && location.origin && location.origin !== "null" && location.protocol !== "file:";
	      const hostname = originOk ? location.hostname : "";
	      const proto = originOk ? location.protocol : "http:";
	      const isLoopback = hostname === "localhost" || hostname === "127.0.0.1" || hostname === "::1";

	      // Prefer same-origin first (works when dashboard is served by the API itself,
	      // or when a reverse proxy exposes both dashboard+API on the same public port).
	      if (originOk && hostname) {
	        bases.push(location.origin);
	        // When the page is opened from a non-loopback host (e.g. mobile accessing http://192.168.x.x:8000),
	        // 127.0.0.1 would point to the phone itself. Try the same hostname with our known API ports.
	        bases.push(`${proto}//${hostname}:8002`, `${proto}//${hostname}:8001`);
	      }

	      // Local development fallback (only when the browser is actually on loopback).
	      if (isLoopback) {
	        bases.push("http://127.0.0.1:8002", "http://127.0.0.1:8001");
	      }

	      return dedupeList(bases);
	    }

    const BACKEND_BASES = resolveBackendBases();
    const KPI_BASE_URLS = BACKEND_BASES.length ? BACKEND_BASES : ["http://127.0.0.1:8001", "http://127.0.0.1:8002"];
    const KPI_CATEGORIES_PATH = "/api/kpis/categorias";
    const KPI_ENDPOINTS = {
      categories: KPI_BASE_URLS.map(base => `${base}${KPI_CATEGORIES_PATH}`),
      routeLegacy: KPI_BASE_URLS.map(base => `${base}/api/kpis`),
      route: KPI_BASE_URLS.map(base => `${base}/api/kpis/route`),
      routeVariant: KPI_BASE_URLS.map(base => `${base}/api/kpis/route_variant`),
      category: KPI_BASE_URLS.map(base => `${base}/api/kpis/category`)
    };
    const KPI_CACHE_TTL_MS = 25_000;
    const KPI_REFRESH_INTERVAL_MS = 15_000;
    const CHART_PATHS = ["/historico/metricas/resumo", "/historico/metricas"];
    const CHARTS_ENDPOINTS = KPI_BASE_URLS.flatMap(base => CHART_PATHS.map(path => `${base}${path}`));
    const LOCAL_BACKENDS = BACKEND_BASES.length ? BACKEND_BASES : ["http://127.0.0.1:8001", "http://127.0.0.1:8002"];
    // Realtime feed used for vehicle positions (only). KPIs/charts use backend APIs separately.
    const VEHICLE_ENDPOINT = "https://rt.jdcp.workers.dev/";
    const CHARTS_CACHE_TTL_MS = 60_000;
    const CHARTS_MIN_INTERVAL_MS = 35_000;
    const CHARTS_REFRESH_INTERVAL_MS = 45_000;
    const VEHICLE_DAY_ENDPOINTS = KPI_BASE_URLS.map(base => `${base}/frota/resumo-diario/veiculos`);
    const HEALTH_ENDPOINTS = KPI_BASE_URLS.map(base => `${base}/health`);
    const CHAPA_SNAPSHOTS_ENDPOINT = "https://carris.pt/umbraco/surface/Vehicles/GetSnapshots";
    const CHAPA_REFRESH_INTERVAL_MS = 5 * 60_000;
    const CHAPA_FETCH_TIMEOUT_MS = 6000;
    const FLEET_AGGREGATE_PATH = "/frota/resumo-diario/agrupado";
    const FLEET_AGGREGATE_ENDPOINTS = KPI_BASE_URLS.map(base => `${base}${FLEET_AGGREGATE_PATH}`);
    const FLEET_AGGREGATE_TTL_MS = 5 * 60_000;
    let fleetDistanceCache = { date: "", ts: 0, payload: null };
    let fleetDistanceFetchPromise = null;
    const FLEET_MODEL_CSV_URL = new URL("frota.csv", location.href);
    const FLEET_MODEL_CSV_FALLBACK = `ID_Inicio,ID_Fim,Modelo,Tipo,Categoria
501,510,Eltricos Articulados SIEMENS,Eltrico,Articulado
601,615,Eltricos Articulados CAF,Eltrico,Articulado
541,585,Eltricos Remodelados,Eltrico,Remodelado
201,240,Mini Mercedes Sprinter,Autocarro,Mini
251,278,Mini MAN,Autocarro,Mini
401,414,Mini Karsan,Autocarro,Mini
1700,1799,Standard Volvo,Autocarro,Standard
2201,2500,Standard MAN,Autocarro,Standard
2601,2820,Standard MAN GNC,Autocarro,Standard
2821,2844,Articulado MAN,Autocarro,Articulado
2941,2997,Mdio MAN,Autocarro,Mdio
4600,4699,Articulado Mercedes,Autocarro,Articulado
4800,4899,Articulado Mercedes GNC,Autocarro,Articulado
5000,5999,Standard Scania,Autocarro,Standard
6000,6999,Standard Caetano,Autocarro,Standard`;
    let fleetModelRanges = [];
    let fleetModelLoadPromise = null;

    function parseFleetModelCsv(text) {
      if (!text) return;
      const cleaned = text.replace(/\r/g, "\n");
      const lines = cleaned.split("\n").map(line => line.trim()).filter(Boolean);
      if (lines.length <= 1) return;
      const ranges = [];
      for (let i = 1; i < lines.length; i += 1) {
        const line = lines[i];
        if (!line) continue;
        const parts = line.split(",");
        if (parts.length < 3) continue;
        const start = Number.parseInt(parts[0], 10);
        const end = Number.parseInt(parts[1], 10);
        const model = (parts[2] || "").trim();
        if (!Number.isFinite(start) || !Number.isFinite(end) || !model) continue;
        ranges.push({ start, end, model });
      }
      if (ranges.length) {
        fleetModelRanges = ranges;
      }
    }

    function loadFleetModelRanges() {
      if (!fleetModelRanges.length) parseFleetModelCsv(FLEET_MODEL_CSV_FALLBACK);
      if (fleetModelLoadPromise) return fleetModelLoadPromise;
      fleetModelLoadPromise = fetch(FLEET_MODEL_CSV_URL, { cache: "no-store" })
        .then(resp => resp.ok ? resp.text() : "")
        .then(text => parseFleetModelCsv(text))
        .catch(err => {
          console.warn("Falha ao carregar frota.csv", err);
        });
      return fleetModelLoadPromise;
    }

    function fleetModelLabelForId(value) {
      if (!fleetModelRanges.length) return "";
      const candidate = value == null ? "" : String(value).trim().replace(/^#/, "");
      const numericId = Number.parseInt(candidate, 10);
      if (!Number.isFinite(numericId)) return "";
      for (const range of fleetModelRanges) {
        if (numericId >= range.start && numericId <= range.end) {
          return range.model;
        }
      }
      return "";
    }

    loadFleetModelRanges();

    let selectedCategory = CATEGORY_FILTER_ALL;
    let selectedRoute = ROUTE_FILTER_ALL;
    let selectedVariant = VARIANT_FILTER_ALL;
    let lastVehicles = [];
    let lastVehicleApplyTs = 0;
    let globalVehiclesCache = { timestamp: 0, list: [] };
    let vehiclesRequestSeq = 0;
    let vehiclesLatestAppliedId = 0;
    const routeOptions = new Map(); // baseId -> { label: string, variants: Map<variantId, label>, categories: Set<string> }
    const ROUTE_DETAILS = new Map(); // routeId -> { shortName, longName }
    const BASE_ROUTE_DETAILS = new Map(); // baseId -> { shortName, longName }
    let routesCatalogLoaded = false;
    let vehicleChapaMap = new Map();
    let lastChapaFetchTs = 0;
    let chapaRefreshTimerId = null;
    let chapaFetchAbortController = null;

    const categorySelect = document.getElementById("category-filter");
    const categorySearchInput = document.getElementById("category-search-input");
    const categoryPreview = document.getElementById("category-preview");
    const routeInput = document.getElementById("route-filter");
    const routeDatalist = document.getElementById("route-filter-options");
    const routePreview = document.getElementById("route-preview");
    const routeClear = document.getElementById("route-clear");
    const routeSelectedPill = document.getElementById("route-selected-pill");
    const routeSelectedText = document.getElementById("route-selected-text");
    const routeInputWrapper = document.querySelector(".route-input-wrapper");
    const variantSelect = document.getElementById("variant-filter");
    const variantGroup = document.getElementById("variant-filter-group");
    const statusDot = document.getElementById("status-dot");
    const sidebarToggle = document.getElementById("sidebar-toggle");
    const sidebarClose = document.getElementById("sidebar-close");
    const routeLabelById = new Map();
    const routeLabelLookup = new Map();
    const kpiPanel = document.getElementById("kpi-panel");
    const kpiLastUpdate = document.getElementById("kpi-last-update");
    const kpiActiveVehicles = document.getElementById("kpi-active-vehicles");
    const kpiVelDay = document.getElementById("kpi-vel-day");
    const kpiVelHour = document.getElementById("kpi-vel-hour");
    const kpiContext = document.getElementById("kpi-context");
    const kpiFloatingText = document.getElementById("kpi-floating-text");
    const kpiFloatingChip = document.getElementById("kpi-floating-chip");
    const kpiFloatingClear = document.getElementById("kpi-floating-clear");
    const kpiFloatingContext = document.getElementById("kpi-floating-context");
    const kpiVelHourDelta = document.getElementById("kpi-vel-hour-delta");
    const kpiTripsPercent = document.getElementById("kpi-trips-percent");
    const kpiTripsMeta = document.getElementById("kpi-trips-meta");
    const kpiFrequency = document.getElementById("kpi-frequency");
    const kpiFrequencyCard = document.querySelector("[data-kpi-frequency-card]");
    const kpiDistance = document.getElementById("kpi-distance");
    const kpiPanelTrigger = document.getElementById("kpi-panel-trigger");
    const kpiExtraRow = document.getElementById("kpi-extra-row");
    const kpiPanelTriggerIcon = kpiPanelTrigger ? kpiPanelTrigger.querySelector(".kpi-panel-trigger-icon") : null;
    const appAlert = document.getElementById("app-alert");
    const chartSpeedCard = document.getElementById("chart-speed-card");
    const chartVolumeCard = document.getElementById("chart-volume-card");
    const chartSpeedCanvas = document.getElementById("chart-speed-preview");
    const chartVolumeCanvas = document.getElementById("chart-volume-preview");
    const chartOverlay = document.getElementById("chart-overlay");
    const chartOverlayContent = document.querySelector(".chart-overlay-content");
    const chartOverlayTitle = document.getElementById("chart-overlay-title");
    const chartOverlayExtra = document.getElementById("chart-overlay-extra");
    const chartOverlayVisual = document.querySelector(".chart-overlay-visual");
    const overlayTabChart = document.getElementById("overlay-tab-chart");
    const overlayTabTable = document.getElementById("overlay-tab-table");
    const overlaySortButtons = document.querySelectorAll(".overlay-sort");
    const chartOverlayVehicleRows = document.getElementById("overlay-vehicle-rows");
    const chartOverlayCanvas = document.getElementById("chart-overlay-canvas");
    const floatingSearch = document.getElementById("floating-search");
    const floatingRouteInput = document.getElementById("floating-route-input");
    const floatingRoutePreview = document.getElementById("floating-route-preview");
    const userLocationButton = document.getElementById("user-location-btn");
    const chartOverlayClose = document.getElementById("chart-overlay-close");
    const chartSectionToggle = document.getElementById("chart-section-toggle");
    const chartsSection = document.querySelector(".charts-section");
    const mapContainer = document.getElementById("map-container");
    const bodyEl = document.body;
    const sidebar = document.getElementById("sidebar");
    const KPI_TRIGGER_DRAG_THRESHOLD = 12;
    const routeChartHint = document.getElementById("route-chart-hint");

    function syncFloatingSearchPlacement() {
      if (!floatingSearch) return;
      const isMobileSidebar = window.matchMedia("(max-width: 900px)").matches;
      const mobileTarget = bodyEl || document.body;
      const target = isMobileSidebar
        ? mobileTarget
        : (kpiFloatingContext || mapContainer);
      if (!target) return;
      if (floatingSearch.parentElement !== target) {
        target.appendChild(floatingSearch);
      }
      floatingSearch.classList.toggle("floating-search--map", !isMobileSidebar);
      floatingSearch.classList.toggle("floating-search--sidebar", isMobileSidebar);
    }

    window.addEventListener("resize", syncFloatingSearchPlacement, { passive: true });
    syncFloatingSearchPlacement();

    const setChartSectionExpanded = expanded => {
      if (!chartSectionToggle || !chartsSection) return;
      chartSectionToggle.setAttribute("aria-expanded", expanded ? "true" : "false");
      chartsSection.classList.toggle("charts-section--collapsed", !expanded);
    };
    if (chartSectionToggle) {
      const initialExpanded = chartSectionToggle.getAttribute("aria-expanded") !== "false";
      setChartSectionExpanded(initialExpanded);
      chartSectionToggle.addEventListener("click", () => {
        const currentlyExpanded = chartSectionToggle.getAttribute("aria-expanded") !== "false";
        setChartSectionExpanded(!currentlyExpanded);
      });
    }
    let kpiTriggerDragState = null;
    let sidebarCollapsed = false;
    let userLocationInFlight = false;
    let mobileLocationPrompted = false;
    let lastUserLocationCoords = null;
    let categoryKpisCache = { timestamp: 0, data: [] };
    let routeKpisCache = { timestamp: 0, key: "", row: null };
    let lastKpiTimestamp = null;
    let kpiAgeTimer = null;
    let chartRefreshIntervalId = null;
    let chartCache = { paramsKey: "", timestamp: 0, summary: null, lineCandidate: null };
    let lastChartFetchTs = 0;
    let trendTimeline = [];
    let previewCharts = { speed: null, volume: null };
    let overlayChartInstance = null;
    let overlayChartState = { type: null, labels: [], values: [] };
    let currentOverlayType = null;
    let lastTrendSummary = { timeline: [], kpi: null, rows: [], lineCandidate: null };
    let lastTrendLineCandidate = null;
    let volumeTableRows = [];
    let volumeTableSort = { key: "last", dir: "desc" };
    let volumeOverlayChapaCache = new Map();
    let kpiRefreshToken = 0;
    let kpiRefreshContextKey = "";
    const timeLabelFormatter = new Intl.DateTimeFormat("pt-PT", {
      hour: "2-digit",
      minute: "2-digit",
    });

    function showAppError(message) {
      console.error("[Dashboard]", message);
      if (!appAlert) return;
      appAlert.textContent = "";
      appAlert.classList.remove("visible");
    }

    function clearAppError() {
      if (!appAlert) return;
      appAlert.classList.remove("visible");
    }

    window.addEventListener("error", event => {
      showAppError(`Erro inesperado: ${event.message}`);
    });
    window.addEventListener("unhandledrejection", event => {
      showAppError(`Erro de promessa: ${event.reason}`);
    });

    function parseTranslatorCsv(text) {
      const byId = {};
      const base = {};
      if (!text) return { byId, base };
      const clean = text.replace(/\r/g, "\n");
      const lines = clean.split("\n");
      for (let i = 1; i < lines.length; i += 1) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(/,(.+)/);
        if (parts.length < 2) continue;
        const rawId = parts[0].replace(/^\ufeff/, "").trim();
        const name = parts[1].trim();
        if (!rawId || !name) continue;
        byId[rawId] = name;
        const baseKey = rawId.split("_")[0] || rawId;
        if (baseKey && !base[baseKey]) base[baseKey] = name;
      }
      return { byId, base };
    }

    async function loadRouteTranslator() {
      try {
        const resp = await fetch(ROUTE_TRANSLATOR_URL, withNgrokBypass({ cache: "no-store" }));
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();
        const parsed = parseTranslatorCsv(text);
        ROUTE_TRANSLATOR.byId = parsed.byId;
        ROUTE_TRANSLATOR.base = parsed.base;
        refreshRouteLabels();
        refreshRouteTaxonomy();
      } catch (err) {
        console.warn("Falha ao carregar tradutor de rotas:", err);
      }
    }

    async function loadRoutesCatalog() {
      if (routesCatalogLoaded) return;
      try {
        const resp = await fetch(ROUTES_DATA_URL, withNgrokBypass({ cache: "no-store" }));
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();
        const lines = text.replace(/\r/g, "\n").split("\n");
        if (!lines.length) return;
        const header = splitCsvLine(lines[0]).map(h => h.replace(/^\ufeff/, "").trim());
        const idxRouteId = header.indexOf("route_id");
        const idxShort = header.indexOf("route_short_name");
        const idxLong = header.indexOf("route_long_name");
        let dirty = false;
        const getPart = (parts, idx) => {
          if (idx < 0 || idx >= parts.length) return "";
          return parts[idx] || "";
        };
        for (let i = 1; i < lines.length; i += 1) {
          const rawLine = lines[i];
          if (!rawLine || !rawLine.trim()) continue;
          const parts = splitCsvLine(rawLine);
          const routeId = getPart(parts, idxRouteId).trim();
          if (!routeId) continue;
          const shortName = getPart(parts, idxShort).trim();
          const longName = getPart(parts, idxLong).trim();
          const baseId = getBaseRouteKey(routeId);
          if (!baseId) continue;
          if (registerRoute(baseId, routeId, { shortName, longName })) dirty = true;
        }
        routesCatalogLoaded = true;
        if (dirty) {
          rebuildRouteSuggestions();
          updateVariantOptions();
          refreshRouteTaxonomy();
        }
      } catch (err) {
        console.warn("Falha ao carregar routes.txt:", err);
      }
    }

    function splitCsvLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === '"' && line[i + 1] === '"') {
          current += '"';
          i += 1;
          continue;
        }
        if (char === '"') {
          inQuotes = !inQuotes;
          continue;
        }
        if (char === ',' && !inQuotes) {
          result.push(current);
          current = "";
          continue;
        }
        current += char;
      }
      result.push(current);
      return result;
    }

    function rememberRouteMeta(routeId, shortName, longName) {
      if (!routeId) return;
      const shortClean = (shortName || "").trim();
      const longClean = (longName || "").trim();
      if (!shortClean && !longClean) return;
      ROUTE_DETAILS.set(routeId, { shortName: shortClean, longName: longClean });
      const base = getBaseRouteKey(routeId);
      if (!base) return;
      const existing = BASE_ROUTE_DETAILS.get(base) || {};
      let updated = false;
      if (shortClean && !existing.shortName) {
        existing.shortName = shortClean;
        updated = true;
      }
      if (longClean && !existing.longName) {
        existing.longName = longClean;
        updated = true;
      }
      if (updated || !BASE_ROUTE_DETAILS.has(base)) {
        BASE_ROUTE_DETAILS.set(base, existing);
      }
    }

    function ensureRouteEntry(baseId) {
      if (!baseId) return null;
      let entry = routeOptions.get(baseId);
      let created = false;
      if (!entry) {
        entry = { label: "", variants: new Map(), categories: new Set(), zones: new Set() };
        routeOptions.set(baseId, entry);
        created = true;
      } else {
        if (!entry.variants) entry.variants = new Map();
        if (!entry.categories) entry.categories = new Set();
        if (!entry.zones) entry.zones = new Set();
      }
      return { entry, created };
    }

    function registerRoute(baseId, variantId, options = {}) {
      if (!baseId) return false;
      const { shortName, longName, label, category } = options;
      if (shortName || longName) {
        rememberRouteMeta(variantId || baseId, shortName, longName);
      }
      const fallbackLabel = label || shortName || longName || translateRoute(variantId) || translateRoute(baseId) || variantId || baseId;
      const ensured = ensureRouteEntry(baseId);
      if (!ensured) return false;
      const { entry, created } = ensured;
      let dirty = created;
      const baseLabel = formatRouteLabel(baseId, fallbackLabel);
      if (entry.label !== baseLabel) {
        entry.label = baseLabel;
        dirty = true;
      }
      if (variantId && variantId !== baseId) {
        const variantLabel = formatVariantLabel(variantId, fallbackLabel);
        const normalizedVariant = (variantLabel || "").trim();
        if (normalizedVariant && (!entry.variants.has(variantId) || entry.variants.get(variantId) !== normalizedVariant)) {
          entry.variants.set(variantId, normalizedVariant);
          dirty = true;
        }
      }
      const resolvedCategory = category || definirCategoria(shortName || fallbackLabel || baseId);
      const baseCategory = definirCategoria(baseId);
      const nextCategories = new Set([resolvedCategory, baseCategory].filter(Boolean));
      const categoriesChanged =
        !entry.categories ||
        entry.categories.size !== nextCategories.size ||
        Array.from(nextCategories).some(cat => !entry.categories.has(cat));
      if (categoriesChanged) {
        entry.categories = nextCategories;
        dirty = true;
      }
      let categoryAdded = false;
      nextCategories.forEach(cat => {
        if (cat && !observedCategories.has(cat)) {
          observedCategories.add(cat);
          categoryAdded = true;
        }
      });
      if (categoryAdded) rebuildCategoryOptions();
      const resolvedZone = definirZona(shortName || fallbackLabel || baseId);
      const nextZones = new Set(resolvedZone ? [resolvedZone] : []);
      const zonesChanged =
        !entry.zones ||
        entry.zones.size !== nextZones.size ||
        Array.from(nextZones).some(zone => !entry.zones.has(zone));
      if (zonesChanged) {
        entry.zones = nextZones;
        dirty = true;
      }
      return dirty;
    }

    function setSidebarCollapsed(collapsed) {
      sidebarCollapsed = Boolean(collapsed);
      document.body.classList.toggle("sidebar-collapsed", sidebarCollapsed);
      if (sidebarToggle) {
        sidebarToggle.setAttribute("aria-expanded", String(!sidebarCollapsed));
      }
      syncFloatingContextIconState();
      syncFloatingContextLayout();
    }

    if (sidebarToggle) {
      sidebarToggle.addEventListener("click", () => setSidebarCollapsed(false));
    }
    if (sidebarClose) {
      sidebarClose.addEventListener("click", () => setSidebarCollapsed(true));
    }

    function normalizeRouteKey(value) {
      if (value == null) return "";
      return String(value).trim();
    }

    function getBaseRouteKey(value) {
      const normalized = normalizeRouteKey(value);
      if (!normalized) return "";
      const [base] = normalized.split("_");
      return base || normalized;
    }

    function formatRouteLabel(routeId, fallback = "") {
      const base = getBaseRouteKey(routeId);
      // For the aggregated base route label, prefer the metadata for the `_0` variant when available.
      let metaVariantId = routeId;
      if (routeId && !routeId.includes("_") && base) {
        const preferred = `${base}_0`;
        if (ROUTE_DETAILS.has(preferred) || ROUTE_TRANSLATOR.byId[preferred]) {
          metaVariantId = preferred;
        }
      }
      const metaVariant = metaVariantId ? ROUTE_DETAILS.get(metaVariantId) : null;
      const metaBase = base ? BASE_ROUTE_DETAILS.get(base) : null;
      const shortName = (metaVariant?.shortName || metaBase?.shortName || translateRoute(metaVariantId) || translateRoute(routeId) || translateRoute(base) || "").trim();
      const longName = (metaVariant?.longName || metaBase?.longName || "").trim();
      const fallbackClean = (fallback || "").trim();
      const parts = [];
      if (shortName) parts.push(shortName);
      if (longName) parts.push(longName);
      if (!parts.length && fallbackClean) parts.push(fallbackClean);
      if (!parts.length && base) parts.push(base);
      return parts.join(" ").trim();
    }

    function resolvePublicRouteLabel(value) {
      const raw = normalizeRouteKey(value);
      const base = getBaseRouteKey(raw);
      // Prefer the label already loaded do routes.txt; fallback to formatted label, otherwise raw.
      return routeLabelById.get(base) || routeLabelById.get(raw) || formatRouteLabel(raw, raw);
    }

    function formatVariantLabel(routeId, fallback = "") {
      // Keep variant labels clean (no "(Var. X)" suffix); use the best known name for that variant id.
      return formatRouteLabel(routeId, fallback);
    }

    function refreshRouteLabels() {
      let dirty = false;
      routeOptions.forEach((entry, baseId) => {
        const updatedLabel = formatRouteLabel(baseId);
        if (entry.label !== updatedLabel) {
          entry.label = updatedLabel;
          dirty = true;
        }
        if (entry.variants) {
          entry.variants.forEach((label, variantId) => {
            const updatedVariantLabel = formatVariantLabel(variantId);
            if (label !== updatedVariantLabel) {
              entry.variants.set(variantId, updatedVariantLabel);
              dirty = true;
            }
          });
        }
      });
      if (dirty) {
        rebuildRouteSuggestions();
        updateVariantOptions();
      }
    }

    function refreshRouteTaxonomy() {
      let dirty = false;
      routeOptions.forEach((entry, baseId) => {
        const labels = [];
        const baseLabel = formatRouteLabel(baseId, entry.label || baseId);
        if (baseLabel) labels.push(baseLabel);
        labels.push(translateRoute(baseId), baseId);
        if (entry?.variants) {
          entry.variants.forEach((label, variantId) => {
            if (label) labels.push(label);
            labels.push(translateRoute(variantId), variantId);
          });
        }

        const nextCategories = new Set();
        const nextZones = new Set();
        labels.forEach(label => {
          const cat = definirCategoria(label);
          if (cat) nextCategories.add(cat);
          const zone = definirZona(label);
          if (zone) nextZones.add(zone);
        });

        const categoriesChanged =
          !entry.categories ||
          entry.categories.size !== nextCategories.size ||
          Array.from(nextCategories).some(cat => !entry.categories.has(cat));
        const zonesChanged =
          !entry.zones ||
          entry.zones.size !== nextZones.size ||
          Array.from(nextZones).some(zone => !entry.zones.has(zone));
        if (categoriesChanged) {
          entry.categories = nextCategories;
          dirty = true;
        }
        if (zonesChanged) {
          entry.zones = nextZones;
          dirty = true;
        }
      });
      if (dirty) {
        rebuildRouteSuggestions();
      }
    }

    const CATEGORY_PREVIEW_LIMIT = 7;
    const CATEGORY_LIST_COLLATOR = new Intl.Collator("pt-PT", { numeric: true, sensitivity: "base" });

    function previewCategoryEntries(query = "", options = {}) {
      const limit = Number.isFinite(options.limit) ? options.limit : CATEGORY_PREVIEW_LIMIT;
      const normalizedQuery = (query || "").trim().toLowerCase();
      let baseCategories = Array.from(observedCategories).filter(Boolean);
      if (!baseCategories.length) {
        baseCategories = STANDARD_ROUTE_CATEGORIES.filter(Boolean);
      }
      const matches = baseCategories
        .filter(cat => !normalizedQuery || cat.toLowerCase().includes(normalizedQuery))
        .sort((a, b) => CATEGORY_LIST_COLLATOR.compare(a, b));
      const entries = matches.slice(0, limit).map(cat => ({ label: cat, value: cat }));
      if (!entries.length && baseCategories.length) {
        baseCategories.slice(0, limit).forEach(cat => entries.push({ label: cat, value: cat }));
      }
      return entries;
    }

    function rebuildCategoryOptions() {
      if (!categorySelect) return;
      const previousSelection = categorySelect.value || selectedCategory || CATEGORY_FILTER_ALL;
      categorySelect.innerHTML = "";
      categorySelect.appendChild(new Option("Todas", CATEGORY_FILTER_ALL));
      const sortedCategories = Array.from(observedCategories)
        .filter(Boolean)
        .sort((a, b) => CATEGORY_LIST_COLLATOR.compare(a, b));
      sortedCategories.forEach(cat => categorySelect.appendChild(new Option(cat, cat)));
      const availableValues = new Set(sortedCategories);
      availableValues.add(CATEGORY_FILTER_ALL);
      const target = availableValues.has(previousSelection) ? previousSelection : CATEGORY_FILTER_ALL;
      categorySelect.value = target;
      if (categorySearchInput) {
        categorySearchInput.value = target === CATEGORY_FILTER_ALL ? "" : target;
      }
      if (categoryPreview?.classList.contains("visible")) {
        renderCategoryPreview(categorySearchInput?.value || "");
      }
    }

    let categoryChangeSuspended = false;

    function renderCategoryPreview(query = "") {
      if (!categoryPreview) return;
      const entries = previewCategoryEntries(query);
      if (!entries.length) {
        categoryPreview.innerHTML = `<div class="preview-item preview-empty" aria-hidden="true">Sem resultados</div>`;
      } else {
        categoryPreview.innerHTML = entries
          .map(entry => `<div class="preview-item" role="option" tabindex="0" data-category="${escapeHtml(entry.value)}">${escapeHtml(entry.label)}</div>`)
          .join("");
      }
      categoryPreview.classList.add("visible");
      categoryPreview.classList.remove("hidden");
    }

    function closeCategoryPreview() {
      if (!categoryPreview) return;
      categoryPreview.classList.remove("visible");
      categoryPreview.classList.add("hidden");
    }

    function clearCategoryFilter() {
      if (selectedCategory === CATEGORY_FILTER_ALL) return false;
      selectedCategory = CATEGORY_FILTER_ALL;
      syncCategoryInputs(CATEGORY_FILTER_ALL);
      closeCategoryPreview();
      setHashFilters({ category: selectedCategory, variant: selectedVariant });
      return true;
    }

    function syncCategoryInputs(value) {
      if (categorySelect) {
        categoryChangeSuspended = true;
        categorySelect.value = value;
        categoryChangeSuspended = false;
      }
      if (categorySearchInput) {
        categorySearchInput.value = value === CATEGORY_FILTER_ALL ? "" : value;
      }
    }

    function applyCategorySelection(categoryValue, { skipHash = false } = {}) {
      const normalized = categoryValue || CATEGORY_FILTER_ALL;
      if (normalized === selectedCategory) {
        closeCategoryPreview();
        return;
      }
      selectedCategory = normalized;
      syncCategoryInputs(normalized);
      rebuildRouteSuggestions();
      closeFloatingSearch();
      selectedRoute = ROUTE_FILTER_ALL;
      syncRouteInputValue();
      selectedVariant = VARIANT_FILTER_ALL;
      updateVariantOptions();
      renderVehicles();
      refreshRouteOverlay(true).catch(() => {});
      refreshGlobalStops(true).catch(() => {});
      refreshCharts(true).catch(() => {});
      refreshKpis(true);
      updateRouteClearVisibility();
      renderSelectedRoutePill();
      if (!skipHash) setHashFilters({ category: normalized, variant: selectedVariant });
    }

    function selectCategoryValue(category) {
      const normalized = category || CATEGORY_FILTER_ALL;
      syncCategoryInputs(normalized);
      applyCategorySelection(normalized);
    }

    function initCategorySearch() {
      if (!categorySearchInput || !categoryPreview) return;
      const openPreview = () => renderCategoryPreview(categorySearchInput.value || "");
      categorySearchInput.addEventListener("input", openPreview);
      categorySearchInput.addEventListener("focus", openPreview);
      categorySearchInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          const firstItem = categoryPreview.querySelector(".preview-item:not(.preview-empty)");
          if (firstItem) selectCategoryValue(firstItem.dataset.category);
        } else if (ev.key === "Escape") {
          ev.preventDefault();
          closeCategoryPreview();
        }
      });
      categorySearchInput.addEventListener("blur", () => {
        setTimeout(() => closeCategoryPreview(), 140);
      });
      categoryPreview.addEventListener("mousedown", (ev) => {
        const item = ev.target.closest(".preview-item");
        if (!item || item.classList.contains("preview-empty")) return;
        ev.preventDefault();
        selectCategoryValue(item.dataset.category);
      });
      categoryPreview.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" || ev.key === " ") {
          const item = ev.target.closest(".preview-item");
          if (!item || item.classList.contains("preview-empty")) return;
          ev.preventDefault();
          selectCategoryValue(item.dataset.category);
        }
      });
      document.addEventListener("click", (ev) => {
        if (!categoryPreview?.classList.contains("visible")) return;
        if (categoryPreview.contains(ev.target) || categorySearchInput.contains(ev.target)) return;
        closeCategoryPreview();
      });
    }

    function initCategoryFilter() {
      if (!categorySelect) return;
      rebuildCategoryOptions();
      selectedCategory = CATEGORY_FILTER_ALL;
      categorySelect.value = CATEGORY_FILTER_ALL;
      categorySelect.addEventListener("change", () => {
        if (categoryChangeSuspended) return;
        applyCategorySelection(categorySelect.value || CATEGORY_FILTER_ALL);
      });
    }

    function handleRouteInputFocus() {
      if (!routeInput) return;
      routeInput.dataset.previousRoute = selectedRoute || ROUTE_FILTER_ALL;
      routeInput.dataset.focusCleared = "true";
      routeInput.value = "";
    }

    function findBestRouteSuggestion(query) {
      if (!routeDatalist || !query) return null;
      const normalizedQuery = query.trim().toLowerCase();
      if (!normalizedQuery) return null;
      let bestOption = null;
      let bestScore = Number.POSITIVE_INFINITY;
      Array.from(routeDatalist.options).forEach(option => {
        const label = (option.value || option.textContent || "").trim();
        if (!label) return;
        const lowerLabel = label.toLowerCase();
        let score = 3;
        if (lowerLabel === normalizedQuery) {
          score = 0;
        } else if (lowerLabel.startsWith(normalizedQuery)) {
          score = 1;
        } else if (lowerLabel.includes(normalizedQuery)) {
          score = 2;
        }
        if (score < bestScore) {
          bestScore = score;
          bestOption = option;
        }
      });
      if (bestOption) {
        return (bestOption.value || bestOption.textContent || "").trim() || null;
      }
      const firstOption = routeDatalist.querySelector("option");
      return firstOption ? ((firstOption.value || firstOption.textContent || "").trim() || null) : null;
    }

    function handleRouteInputKeyDown(event) {
      if (!routeInput) return;
      if (event.key !== "Enter") return;
      if (routePreview && !routePreview.classList.contains("hidden")) {
        const firstItem = routePreview.querySelector(".preview-item:not(.preview-empty)");
        const previewId = firstItem?.dataset?.routeId || "";
        if (previewId && commitRoutePreviewSelection(previewId)) {
          event.preventDefault();
          return;
        }
      }
      const trimmed = routeInput.value?.trim();
      if (!trimmed) return;
      const suggestion = findBestRouteSuggestion(trimmed);
      if (!suggestion) return;
      event.preventDefault();
      routeInput.dataset.focusCleared = "false";
      routeInput.value = suggestion;
      handleRouteInputCommit();
    }

    function updateRoutePreviewPosition() {
      if (!routePreview || !routeInput) return;
      const rect = routeInput.getBoundingClientRect();
      routePreview.style.minWidth = `${rect.width}px`;
    }
    const updateRoutePreviewPositionDebounced = debounce(updateRoutePreviewPosition, 160);

    function updateRouteClearVisibility() {
      const isGlobal = !selectedRoute || selectedRoute === ROUTE_FILTER_ALL;
      if (routeClear) {
        routeClear.classList.toggle("hidden", isGlobal);
        routeClear.setAttribute("aria-hidden", isGlobal ? "true" : "false");
      }
      if (routeInputWrapper) {
        routeInputWrapper.classList.toggle("pill-visible", !isGlobal && !routeInputWrapper.classList.contains("input-focused"));
      }
    }

    function updateRouteChartHintVisibility() {
      if (!routeChartHint) return;
      const showHint = Boolean(selectedRoute && selectedRoute !== ROUTE_FILTER_ALL);
      routeChartHint.classList.toggle("hidden", !showHint);
    }

    function commitRoutePreviewSelection(routeId) {
      if (!routeInput || !routePreview) return false;
      const targetRouteId = (routeId || "").trim();
      if (!targetRouteId) return false;
      routeInput.value = routeLabelById.get(targetRouteId) || targetRouteId;
      routeInput.dataset.focusCleared = "false";
      handleRouteInputCommit();
      return true;
    }

    function previewEntries(query, { allowEmpty = false } = {}) {
      if (!routeOptions) return [];
      const normalized = (query || "").trim().toLowerCase();
      if (!allowEmpty && (!normalized || normalized === ROUTE_GLOBAL_LABEL.toLowerCase())) return [];
      const entries = [];
      routeOptions.forEach((data, baseId) => {
        const label = data.label || baseId;
        const translated = baseId.includes("_") ? translateRoute(baseId) : label;
        const { code, codeBase } = parseRouteCodeParts(translated || label);
        const haystacks = [
          (label || "").toLowerCase(),
          (translated || "").toLowerCase(),
          (code || "").toLowerCase(),
          (codeBase || "").toLowerCase()
        ].filter(Boolean);
        if (normalized) {
          const match = haystacks.some(h => h.includes(normalized));
          if (!match) return;
        }
        entries.push({ id: baseId, label: translated || label });
      });
      const collator = new Intl.Collator("pt-PT", { numeric: true, sensitivity: "base" });
      entries.sort((a, b) => collator.compare(a.label, b.label));
      return entries;
    }

    const STOP_PREVIEW_ROUTE_COLLATOR = new Intl.Collator("pt-PT", {
      numeric: true,
      sensitivity: "base"
    });

    const STOP_PREVIEW_PILLS_ROWS_BEFORE_COLUMN = 2;
    const STOP_PREVIEW_PILLS_COLUMNS_BEFORE_THIRD_LINE = 3;
    const STOP_PREVIEW_PILLS_COUNT_BEFORE_THIRD_LINE =
      STOP_PREVIEW_PILLS_ROWS_BEFORE_COLUMN * STOP_PREVIEW_PILLS_COLUMNS_BEFORE_THIRD_LINE;

    function stopPreviewRouteSortKey(routeLabel) {
      const label = (routeLabel ?? "").toString();
      const { code } = parseRouteCodeParts(label);
      return (code || label).toUpperCase().trim();
    }

    function updateStopPreviewRoutePillsLayout(el) {
      if (!el) return;
      const pills = el.querySelectorAll?.(".preview-stop-route-pill").length || 0;
      if (pills === 0) {
        el.classList.remove(
          "preview-stop-route-pills--three-lines",
          "preview-stop-route-pills--bigger",
          "preview-stop-route-pills--two-lines",
          "preview-stop-route-pills--single"
        );
        return;
      }
      const needsThirdLine = pills > STOP_PREVIEW_PILLS_COUNT_BEFORE_THIRD_LINE;
      el.classList.toggle("preview-stop-route-pills--three-lines", needsThirdLine);
      const hasFewPills = pills < 5;
      el.classList.toggle("preview-stop-route-pills--bigger", hasFewPills);
      const isSinglePill = pills === 1;
      el.classList.toggle("preview-stop-route-pills--single", isSinglePill);
      const needsTwoLines = pills >= 3 && pills <= 4;
      el.classList.toggle("preview-stop-route-pills--two-lines", needsTwoLines);
    }

    function refreshStopPreviewRoutePillsLayouts(root) {
      const scope = root || document;
      const pillsElements = scope?.querySelectorAll?.(".preview-stop-route-pills");
      if (!pillsElements?.length) return;
      pillsElements.forEach(updateStopPreviewRoutePillsLayout);
    }

    function stopPreviewRoutePills(stopId) {
      const routes = Array.isArray(stopRoutesCache.get(stopId)) ? stopRoutesCache.get(stopId) : [];
      if (routes.length) return buildStopPreviewPillsHtml(routes);
      requestStopPreviewPills(stopId);
      return "";
    }

    function buildStopPreviewPillsHtml(routes) {
      if (!Array.isArray(routes) || !routes.length) return "";
      const ordered = routes.slice().sort((a, b) => {
        const aKey = stopPreviewRouteSortKey(a);
        const bKey = stopPreviewRouteSortKey(b);
        return STOP_PREVIEW_ROUTE_COLLATOR.compare(aKey, bKey);
      });
      const limited = ordered.slice(0, 13);
      return limited.map(routeLabel => {
        const style = pillStyleForRoute(routeLabel);
        const code = parseRouteCodeParts(routeLabel).code || routeLabel;
        return `<span class="preview-stop-route-pill" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}">${escapeHtml(code)}</span>`;
      }).join("");
    }

    function requestStopPreviewPills(stopId) {
      const key = stopId == null ? "" : String(stopId);
      if (!key) return;
      ensureStopRoutes(key)
        .then(routes => {
          if (!routes || !routes.length) return;
          updateStopPreviewPillsElements(key, routes);
        })
        .catch(() => {});
    }

    function updateStopPreviewPillsElements(stopId, routes) {
      if (!stopId) return;
      const html = buildStopPreviewPillsHtml(routes);
      if (!html) return;
      const selector = `[data-stop-route-id="${cssEscapeValue(stopId)}"]`;
      const elements = document.querySelectorAll(selector);
      if (!elements.length) return;
      elements.forEach(el => {
        el.innerHTML = html;
        updateStopPreviewRoutePillsLayout(el);
      });
    }

    function cssEscapeValue(value) {
      if (typeof value !== "string") value = String(value ?? "");
      if (typeof CSS !== "undefined" && typeof CSS.escape === "function") {
        return CSS.escape(value);
      }
      // Basic fallback: escape quotes and backslashes.
      return value.replace(/["\\]/g, "\\$&");
    }

    function stopPreviewItemMarkup(entry) {
      if (!entry) return "";
      const rawId = entry.stopId || "";
      const safeId = escapeHtml(rawId);
      const safeName = escapeHtml(entry.stopName || "");
      const safeNumber = escapeHtml(entry.displayNumber || entry.stopCode || entry.stopId || "");
      const safeLat = Number.isFinite(entry.lat) ? entry.lat : "";
      const safeLon = Number.isFinite(entry.lon) ? entry.lon : "";
      const liveClass = entry?.isNearestStop ? " preview-stop-live" : "";
      return `<div class="preview-item preview-stop${liveClass}" role="option"
        data-stop-id="${safeId}"
        data-stop-name="${safeName}"
        data-stop-code="${safeNumber}"
        data-stop-lat="${safeLat}"
        data-stop-lon="${safeLon}">
          <span class="preview-stop-icon" aria-hidden="true">${STOP_SEARCH_ICON}</span>
          <span class="preview-stop-labels">
            <span class="preview-stop-number">${safeNumber}</span>
            <span class="preview-stop-name">${safeName}</span>
          </span>
          <span class="preview-stop-route-pills" data-stop-route-id="${safeId}">${stopPreviewRoutePills(rawId)}</span>
      </div>`;
    }

    function renderRoutePreview(query) {
      if (!routePreview) return;
      const hasFocus = routeInput && document.activeElement === routeInput;
      if (!hasFocus) {
        routePreview.classList.add("hidden");
        routePreview.innerHTML = "";
        return;
      }
      const isFocused = routeInput && document.activeElement === routeInput;
      const allowEmpty = isFocused && !((query || "").trim());
      const entries = previewEntries(query, { allowEmpty });
      const stopEntries = stopSearchEntries(query);
      if (!entries.length && !stopEntries.length) {
        routePreview.classList.add("hidden");
        routePreview.innerHTML = "";
        return;
      }
      const html = entries.map(({ id, label }) => {
        const displayLabel = label || id;
        const style = pillStyleForRoute(displayLabel);
        const { code } = parseRouteCodeParts(displayLabel);
        const pillText = code || displayLabel || id;
        const regex = code ? new RegExp(`^${escapeRegex(code)}\\s*`, "i") : null;
        const restLabel = regex ? (displayLabel.replace(regex, "").trim() || displayLabel) : displayLabel;
        const safeLabel = escapeHtml(restLabel);
        const safeId = escapeHtml(id);
        const pill = `<span class="route-pill" aria-hidden="true" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}">${escapeHtml(pillText)}</span>`;
        return `<div class="preview-item" role="option" data-route-id="${safeId}">
          <span class="preview-label">${pill} ${safeLabel}</span>
        </div>`;
      }).join("");
      const stopHtml = (stopEntries || []).map(stopPreviewItemMarkup).join("");
      routePreview.innerHTML = html + stopHtml;
      routePreview.classList.remove("hidden");
      updateRoutePreviewPositionDebounced();
      refreshStopPreviewRoutePillsLayouts(routePreview);
      Array.from(routePreview.querySelectorAll(".preview-item")).forEach(item => {
        if (item.dataset.bound === "1") return;
        item.dataset.bound = "1";
        item.addEventListener("mousedown", ev => {
          ev.preventDefault();
          const stopId = item.dataset.stopId;
          if (stopId) {
            const stopData = extractStopPreviewData(item);
            if (stopData) {
              openStopScheduleFromSearch(stopData);
              routePreview.classList.add("hidden");
              routePreview.innerHTML = "";
            }
            return;
          }
          commitRoutePreviewSelection(item.dataset.routeId || "");
        });
      });
    }

    function renderSelectedRoutePill() {
      if (!routeSelectedPill || !routeSelectedText || !routeInputWrapper) return;
      updateRouteClearVisibility();
      const isGlobal = !selectedRoute || selectedRoute === ROUTE_FILTER_ALL;
      if (isGlobal) {
      routeSelectedPill.classList.add("hidden");
      return;
    }
    const displayLabel = resolvePublicRouteLabel(selectedRoute);
    const { code } = parseRouteCodeParts(displayLabel);
    const pillText = code || displayLabel || selectedRoute;
    const style = pillStyleForRoute(displayLabel);
    const regex = code ? new RegExp(`^${escapeRegex(code)}\\s*`, "i") : null;
    const restLabel = regex ? (displayLabel.replace(regex, "").trim() || displayLabel) : displayLabel;
    const safeRest = escapeHtml(restLabel);
    routeSelectedText.innerHTML = `<span class="route-pill route-pill--inline" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}">${escapeHtml(pillText)}</span> <span class="route-title-rest" title="${safeRest}">${safeRest}</span>`;
    routeSelectedPill.classList.remove("hidden");
    routeInputWrapper.classList.add("pill-visible");
  }

    function initRouteFilter() {
      if (!routeInput || !routeDatalist) return;
      routeInput.value = ROUTE_GLOBAL_LABEL;
      // Prevent native datalist dropdown; we render our own preview list.
      routeInput.removeAttribute("list");
      routeInput.addEventListener("focus", handleRouteInputFocus);
      routeInput.addEventListener("keydown", handleRouteInputKeyDown);
      routeInput.addEventListener("change", handleRouteInputCommit, { passive: true });
      routeInput.addEventListener("blur", handleRouteInputCommit);
      routeInput.addEventListener("input", () => {
        renderRoutePreview(routeInput.value || "");
        updateRoutePreviewPositionDebounced();
      });
      routeInput.addEventListener("focus", () => {
        renderRoutePreview(routeInput.value || "");
        updateRoutePreviewPositionDebounced();
        routeInputWrapper?.classList.add("input-focused");
        routeInputWrapper?.classList.remove("pill-visible");
        updateRouteClearVisibility();
      });
      routeInput.addEventListener("blur", () => {
        setTimeout(() => routePreview?.classList.add("hidden"), 120);
        routeInputWrapper?.classList.remove("input-focused");
        updateRouteClearVisibility();
      });
      window.addEventListener("resize", updateRoutePreviewPositionDebounced, { passive: true });
      window.addEventListener("scroll", updateRoutePreviewPositionDebounced, { passive: true });
      if (routeClear) {
        routeClear.addEventListener("click", () => {
          clearRouteSelection();
        });
      }
      if (routeSelectedPill) {
        routeSelectedPill.addEventListener("click", () => {
          routeInputWrapper?.classList.remove("pill-visible");
          routeInputWrapper?.classList.add("input-focused");
          routeInput?.focus();
          routeInput?.select();
        });
        routeSelectedPill.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " ") {
            ev.preventDefault();
            routeInputWrapper?.classList.remove("pill-visible");
            routeInputWrapper?.classList.add("input-focused");
            routeInput?.focus();
            routeInput?.select();
          }
        });
      }
      updateRouteClearVisibility();
      renderSelectedRoutePill();
    }

    function initFloatingSearch() {
      if (!floatingRouteInput) return;
      floatingRouteInput.addEventListener("input", () => renderFloatingRoutePreview(floatingRouteInput.value || ""));
      floatingRouteInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          if (commitFloatingRoutePreviewSelection()) {
            ev.preventDefault();
            return;
          }
          ev.preventDefault();
          handleFloatingRouteCommit();
        } else if (ev.key === "Escape") {
          ev.preventDefault();
          closeFloatingSearch();
        }
      });
      floatingRouteInput.addEventListener("focus", () => {
        renderFloatingRoutePreview(floatingRouteInput.value || "");
      });
      floatingRouteInput.addEventListener("blur", () => {
        setTimeout(() => closeFloatingSearch(), 140);
      });
      if (floatingSearch) {
        floatingSearch.addEventListener("click", (ev) => ev.stopPropagation());
      }
      document.addEventListener("click", (ev) => {
        if (!floatingSearch || !floatingSearch.classList.contains("visible")) return;
        if (floatingSearch.contains(ev.target) || kpiFloatingChip?.contains?.(ev.target)) return;
        closeFloatingSearch();
      });
    }

    function applyVariantSelection(value, { skipHash = false } = {}) {
      const normalized = value || VARIANT_FILTER_ALL;
      selectedVariant = normalized;
      if (variantSelect) variantSelect.value = normalized;
      renderVehicles();
      refreshRouteOverlay(true).catch(() => {});
      refreshGlobalStops(true).catch(() => {});
      refreshKpis(true);
      refreshCharts(true).catch(() => {});
      if (!skipHash) setHashFilters({ category: selectedCategory, variant: selectedVariant });
    }

    function initVariantFilter() {
      if (!variantSelect) return;
      variantSelect.innerHTML = "";
      variantSelect.appendChild(new Option("Todas as variantes", VARIANT_FILTER_ALL));
      variantSelect.value = VARIANT_FILTER_ALL;
      variantSelect.addEventListener("change", () => {
        applyVariantSelection(variantSelect.value);
      });
    }

	    function formatUpdateAge(timestamp) {
	      if (!timestamp) return "";
	      const ms = Date.now() - new Date(timestamp).getTime();
	      if (!Number.isFinite(ms) || ms < 0) return "";
	      const seconds = Math.round(ms / 1000);
	      if (seconds < 60) return `${seconds}s`;
	      if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
	      return `${Math.round(seconds / 3600)}h`;
	    }

	    function formatSpeedValue(value) {
	      if (!Number.isFinite(Number(value))) return null;
	      const rounded = Math.round(Number(value) * 10) / 10;
	      return rounded.toFixed(1);
	    }

    const TRIPS_NUMBER_FORMATTER = new Intl.NumberFormat("pt-PT");
    function formatTripsNumber(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "";
      return TRIPS_NUMBER_FORMATTER.format(Math.round(num));
    }

    function formatFrequencyValue(value) {
      const num = Number(value);
      if (!Number.isFinite(num) || num <= 0) return null;
      const rounded = Math.round(num * 10) / 10;
      return rounded.toFixed(1);
    }

    function formatDistanceValue(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return null;
      const rounded = Math.round(num * 10) / 10;
      return rounded.toFixed(1);
    }

    function shouldShowFrequencyKpi() {
      const hasVariant = selectedVariant && selectedVariant !== VARIANT_FILTER_ALL;
      const hasRoute = selectedRoute && selectedRoute !== ROUTE_FILTER_ALL;
      return Boolean(hasVariant || hasRoute);
    }

    function syncFrequencyKpiVisibility() {
      if (!kpiFrequencyCard) return;
      const show = shouldShowFrequencyKpi();
      kpiFrequencyCard.classList.toggle("kpi-card--hidden", !show);
      if (kpiExtraRow) {
        const visibleExtras = Array.from(kpiExtraRow.children).filter(child => !child.classList.contains("kpi-card--hidden"));
        kpiExtraRow.classList.toggle("kpi-extra-row--three", visibleExtras.length >= 3);
        kpiExtraRow.classList.toggle("kpi-extra-row--two", visibleExtras.length === 2);
      }
    }

    syncFrequencyKpiVisibility();

    function setKpiExtrasExpanded(expanded) {
      if (!kpiPanel || !kpiPanelTrigger) return;
      const isExpanded = Boolean(expanded);
      kpiPanel.classList.toggle("kpi-panel--expanded", isExpanded);
      kpiPanelTrigger.setAttribute("aria-expanded", isExpanded ? "true" : "false");
      if (kpiExtraRow) {
        kpiExtraRow.setAttribute("aria-hidden", isExpanded ? "false" : "true");
      }
      if (kpiPanelTriggerIcon) {
        kpiPanelTriggerIcon.textContent = isExpanded ? "" : "";
      }
    }

    if (kpiPanelTrigger) {
      const toggleExtras = () => {
        const currentlyExpanded = kpiPanel?.classList.contains("kpi-panel--expanded") || false;
        setKpiExtrasExpanded(!currentlyExpanded);
      };
      const onPointerMove = (ev) => {
        if (!kpiTriggerDragState) return;
        const rect = mapContainer?.getBoundingClientRect?.();
        if (rect && (ev.clientX < rect.left || ev.clientX > rect.right || ev.clientY < rect.top || ev.clientY > rect.bottom)) {
          endDrag(ev);
          return;
        }
        const delta = ev.clientY - kpiTriggerDragState.startY;
        if (Math.abs(delta) < KPI_TRIGGER_DRAG_THRESHOLD) return;
        setKpiExtrasExpanded(delta > 0);
      };
      const endDrag = (ev) => {
        if (!kpiTriggerDragState) return;
        window.removeEventListener("pointermove", onPointerMove);
        window.removeEventListener("pointerup", endDrag);
        window.removeEventListener("pointercancel", endDrag);
        kpiPanelTrigger.releasePointerCapture?.(ev.pointerId);
        kpiTriggerDragState = null;
      };
      const startDrag = (ev) => {
        if (ev.pointerType === "mouse" && ev.button !== 0) return;
        kpiTriggerDragState = { startY: ev.clientY };
        kpiPanelTrigger.setPointerCapture?.(ev.pointerId);
        window.addEventListener("pointermove", onPointerMove);
        window.addEventListener("pointerup", endDrag);
        window.addEventListener("pointercancel", endDrag);
      };
      kpiPanelTrigger.addEventListener("click", toggleExtras);
      kpiPanelTrigger.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" || ev.key === " ") {
          ev.preventDefault();
          toggleExtras();
        }
      });
      kpiPanelTrigger.addEventListener("pointerdown", startDrag);
      setKpiExtrasExpanded(false);
    }

    function normalizeContext(context) {
      if (context && typeof context === "object") {
        return { text: context.text || "", html: context.html || null };
      }
      const text = context == null ? "" : String(context);
      return { text, html: null };
    }

    function isMobileViewport() {
      return window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
    }

    function updateUserLocationButtonState({ loading = false, message = "" } = {}) {
      if (!userLocationButton) return;
      userLocationButton.classList.toggle("is-loading", loading);
      userLocationButton.classList.toggle("is-active", Boolean(lastUserLocationCoords));
      if (message) {
        userLocationButton.setAttribute("title", message);
      } else {
        userLocationButton.setAttribute("title", "Mostrar a minha localizao");
      }
    }

    function applyUserLocation(coords, { center = false } = {}) {
      if (!coords) return;
      const lat = Number(coords.latitude ?? coords.lat);
      const lon = Number(coords.longitude ?? coords.lon);
      const accuracy = Number.isFinite(coords.accuracy) ? Number(coords.accuracy) : null;
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      lastUserLocationCoords = { lat, lon, accuracy };
      if (adapter?.setUserLocation) {
        adapter.setUserLocation([lat, lon], { center, accuracy });
      }
    }

    function handleUserLocationSuccess(position, { center = false } = {}) {
      userLocationInFlight = false;
      applyUserLocation(position.coords, { center });
      updateUserLocationButtonState({ loading: false });
    }

    function handleUserLocationError(err) {
      userLocationInFlight = false;
      const msg = err?.message || "No foi possvel obter a localizao.";
      console.warn("Geolocalizao falhou:", err);
      updateUserLocationButtonState({ loading: false, message: msg });
    }

    function requestUserLocation({ center = true, auto = false } = {}) {
      if (!navigator?.geolocation) {
        updateUserLocationButtonState({ message: "Localizao indisponvel neste navegador." });
        return;
      }
      if (userLocationInFlight) return;
      userLocationInFlight = true;
      updateUserLocationButtonState({ loading: true });
      navigator.geolocation.getCurrentPosition(
        (position) => handleUserLocationSuccess(position, { center }),
        handleUserLocationError,
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: auto ? 0 : 300000
        }
      );
    }

    function maybePromptMobileLocation() {
      if (mobileLocationPrompted) return;
      if (!isMobileViewport()) return;
      mobileLocationPrompted = true;
      requestUserLocation({ center: true, auto: true });
    }

    updateUserLocationButtonState();

    function buildCategoryContext(categoryName) {
      const cat = categoryName || selectedCategory;
      if (!cat || cat === CATEGORY_FILTER_ALL) return null;
      const bg = pillBgForCategory(cat);
      const fg = readableTextColor(bg, "#0b1220");
      const border = "rgba(15, 23, 42, 0.12)";
      const html = `<span class="route-pill route-pill--inline" style="--pill-bg:${bg};--pill-fg:${fg};--pill-border:${border}">${escapeHtml(cat)}</span>`;
      return { text: cat, html };
    }

    function buildFloatingContext(contextOverride) {
      if (contextOverride) return normalizeContext(contextOverride);
      if (selectedRoute && selectedRoute !== ROUTE_FILTER_ALL) {
        return buildRouteContext();
      }
      const catCtx = buildCategoryContext(selectedCategory);
      if (catCtx) return catCtx;
      return { text: "pesquise carreira, paragem", html: null };
    }

    function updateFloatingContext(context) {
      if (!kpiFloatingText) return;
      const ctx = buildFloatingContext(context);
      if (ctx.html) {
        kpiFloatingText.innerHTML = ctx.html;
      } else {
        kpiFloatingText.textContent = ctx.text || "pesquise carreira, paragem";
      }
      const aria = ctx.text || "pesquise carreira, paragem";
      const isGlobal =
        (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) &&
        (!selectedCategory || selectedCategory === CATEGORY_FILTER_ALL);
      if (kpiFloatingClear) {
        kpiFloatingClear.classList.toggle("hidden", isGlobal);
        kpiFloatingClear.setAttribute("aria-hidden", isGlobal ? "true" : "false");
      }
      if (kpiFloatingChip) {
        kpiFloatingChip.setAttribute("aria-label", isGlobal ? "Pesquisar carreira" : `${aria} (clique para pesquisar)`);
      }
      kpiFloatingText.setAttribute("aria-label", aria);
      const isPlaceholder = isGlobal && !ctx.html;
      kpiFloatingText.classList.toggle("kpi-floating-text--placeholder", isPlaceholder);
      syncFloatingContextIconState(isPlaceholder);
      requestAnimationFrame(() => refreshFloatingSpacing());
    }

    function syncFloatingContextIconState(isPlaceholderOverride) {
      if (!kpiFloatingContext || !kpiFloatingText) return;
      const isCollapsed = document.body.classList.contains("sidebar-collapsed");
      const isPlaceholder =
        typeof isPlaceholderOverride === "boolean"
          ? isPlaceholderOverride
          : kpiFloatingText.classList.contains("kpi-floating-text--placeholder");
      kpiFloatingContext.classList.toggle("kpi-floating-context--icon-only", isCollapsed && isPlaceholder);
    }

    function refreshFloatingSpacing() {
      if (!kpiFloatingChip) return;
      const height = kpiFloatingChip.offsetHeight;
      if (!height) return;
      const shouldStack = height > FLOATING_SEARCH_MULTILINE_THRESHOLD;
      document.body.classList.toggle("floating-search-multiline", shouldStack);
      const baseGap = height + 18;
      const clampedGap = Math.min(200, Math.max(24, baseGap));
      document.documentElement.style.setProperty("--variant-gap", `${clampedGap}px`);
    }

    const FLOATING_SIDEBAR_MIN_WIDTH = 210;
    const FLOATING_SIDEBAR_MAX_WIDTH = 360;

    function syncFloatingContextLayout() {
      if (!kpiFloatingContext || !sidebar) return;
      const isCollapsed = document.body.classList.contains("sidebar-collapsed");
      const scrollOffset = isCollapsed ? 0 : sidebar.scrollTop || 0;
      kpiFloatingContext.style.setProperty("--floating-scroll-offset", `${scrollOffset}px`);
      const sidebarRect = sidebar.getBoundingClientRect();
      const sidebarStyle = window.getComputedStyle(sidebar);
      const paddingLeft = parseFloat(sidebarStyle.paddingLeft) || 0;
      const paddingRight = parseFloat(sidebarStyle.paddingRight) || 0;
      const innerWidth = Math.max(0, sidebarRect.width - paddingLeft - paddingRight);
      const availableWidth = innerWidth || FLOATING_SIDEBAR_MIN_WIDTH;
      const targetWidth = Math.min(availableWidth, FLOATING_SIDEBAR_MAX_WIDTH);
      const widthValue = `${targetWidth}px`;
      kpiFloatingContext.style.setProperty("--floating-width", widthValue);
      document.documentElement.style.setProperty("--floating-width", widthValue);
    }
    if (sidebar) {
      sidebar.addEventListener("scroll", syncFloatingContextLayout, { passive: true });
    }
    window.addEventListener("resize", syncFloatingContextLayout);
    window.addEventListener("resize", syncFloatingContextLayout);
    syncFloatingContextLayout();

    function focusRouteSearchFromFloating() {
      if (floatingSearch && floatingRouteInput) {
        openFloatingSearch();
        return;
      }
      setSidebarCollapsed(false);
      if (!routeInput) return;
      try { routeInput.focus({ preventScroll: true }); } catch (e) { routeInput.focus(); }
      routeInput.select();
      if (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) {
        routeInput.value = "";
      }
      renderRoutePreview(routeInput.value || "");
      updateRoutePreviewPositionDebounced();
    }

    function resetFiltersToGlobal() {
      if (categorySelect) {
        const categoryNeedsReset = categorySelect.value !== CATEGORY_FILTER_ALL;
        if (categoryNeedsReset) {
          categorySelect.value = CATEGORY_FILTER_ALL;
          categorySelect.dispatchEvent(new Event("change", { bubbles: true }));
        }
      }
      clearRouteSelection();
      closeFloatingSearch();
      updateFloatingContext(buildFloatingContext());
    }

    function startKpiAgeTicker() {
      if (kpiAgeTimer) return;
      kpiAgeTimer = setInterval(() => {
        if (!lastKpiTimestamp) return;
        if (kpiLastUpdate) {
          const age = formatUpdateAge(lastKpiTimestamp);
          kpiLastUpdate.textContent = age && age !== "" ? `Atualizado h ${age}` : "Sem dados recentes";
        }
      }, 1000);
    }

	    function formatDeltaValue(value) {
	      if (!Number.isFinite(Number(value))) return null;
	      const delta = Number(value);
	      if (delta === 0) return { text: "", className: "kpi-delta zero" };
	      const arrow = delta > 0 ? "" : "";
	      return { text: `${arrow} ${Math.abs(delta).toFixed(1)} km/h`, className: delta > 0 ? "kpi-delta positive" : "kpi-delta negative" };
	    }

    function updateKpiDelta(value) {
      if (!kpiVelHourDelta) return;
      const formatted = formatDeltaValue(value);
      if (!formatted) {
        kpiVelHourDelta.textContent = "";
        kpiVelHourDelta.className = "kpi-delta";
        return;
      }
      kpiVelHourDelta.textContent = formatted.text;
      kpiVelHourDelta.className = formatted.className;
    }

    function updateKpiDisplay(row, contextText) {
      if (!kpiPanel) return;
      lastKpiTimestamp = row && row.timestamp ? row.timestamp : null;
      if (kpiLastUpdate) {
        const age = lastKpiTimestamp ? formatUpdateAge(lastKpiTimestamp) : null;
        kpiLastUpdate.textContent = age && age !== "" ? `Atualizado h ${age}` : "Sem dados recentes";
      }
      startKpiAgeTicker();
      kpiActiveVehicles.textContent = row ? String(Math.round(row.veiculos_ativos ?? 0)) : "";
	      const velDayText = row ? formatSpeedValue(row.vel_comercial ?? NaN) : null;
	      if (kpiVelDay) {
	        kpiVelDay.textContent = velDayText ?? "";
	        kpiVelDay.classList.toggle("has-unit", Boolean(velDayText));
	      }
	      const velHourText = row ? formatSpeedValue(row.vel_comercial_1h ?? NaN) : null;
      if (kpiVelHour) {
        kpiVelHour.textContent = velHourText ?? "";
        kpiVelHour.classList.toggle("has-unit", Boolean(velHourText));
      }
      if (kpiTripsPercent) {
        const percentVal = Number(row?.viagens_realizadas_pct);
        kpiTripsPercent.textContent = Number.isFinite(percentVal)
          ? `${percentVal.toFixed(1)}%`
          : "";
      }
      if (kpiTripsMeta) {
        const actual = Number(row?.viagens_realizadas);
        const scheduled = Number(row?.viagens_previstas);
        let metaText = "";
        const hasActual = Number.isFinite(actual) && actual > 0;
        const hasScheduled = Number.isFinite(scheduled) && scheduled > 0;
        if (hasActual && hasScheduled) {
          metaText = `${formatTripsNumber(actual)} de ${formatTripsNumber(scheduled)} previstas`;
        } else if (hasActual) {
          metaText = `${formatTripsNumber(actual)} viagens detetadas`;
        } else if (hasScheduled) {
          metaText = `${formatTripsNumber(scheduled)} viagens previstas`;
        }
        kpiTripsMeta.textContent = metaText;
      }
      if (kpiFrequency) {
        const frequencyValue = formatFrequencyValue(row?.frequencia);
        kpiFrequency.textContent = frequencyValue ?? "";
        if (frequencyValue) {
          kpiFrequency.dataset.unit = "min";
        } else {
          kpiFrequency.removeAttribute("data-unit");
        }
      }
      syncFrequencyKpiVisibility();
      if (kpiDistance) {
        const distanceValue = formatDistanceValue(row?.distancia_total);
        kpiDistance.textContent = distanceValue ?? "";
        if (distanceValue) {
          kpiDistance.dataset.unit = "km";
        } else {
          kpiDistance.removeAttribute("data-unit");
        }
      }
      const ctx = normalizeContext(contextText);
      if (kpiContext) kpiContext.textContent = ctx.text || "";
      updateFloatingContext(ctx);
      updateKpiDelta(row?.delta_vel_comercial);
    }

    function safeNumber(value) {
      const num = Number(value);
      return Number.isFinite(num) ? num : 0;
    }

    function getRouteLineCandidates() {
      const candidates = [];
      const pushCandidate = value => {
        if (!value || value === VARIANT_FILTER_ALL || value === ROUTE_FILTER_ALL) return;
        if (!candidates.includes(value)) candidates.push(value);
      };
      // If a specific variant is selected, use it; otherwise prefer the aggregated base route id
      // so "Todas as variantes" aggregates KPI/chart data (like the Python dashboard).
      if (selectedVariant && selectedVariant !== VARIANT_FILTER_ALL) {
        pushCandidate(selectedVariant);
      } else if (selectedRoute && selectedRoute !== ROUTE_FILTER_ALL) {
        pushCandidate(getBaseRouteKey(selectedRoute));
      }
      // Keep some fallbacks for more tolerant backends.
      pushCandidate(selectedRoute);
      pushCandidate(getBaseRouteKey(selectedRoute));
      return candidates;
    }

    function buildTrendQueryParams(lineCandidate) {
      const today = new Date().toISOString().split("T")[0];
      const params = {
        date: today,
        hora_inicio: "00:00:00",
        hora_fim: "23:59:59",
      };
      if (lineCandidate) {
        params.line_id = lineCandidate;
        params.linha = lineCandidate;
      } else if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) {
        params.categoria = selectedCategory;
      }
      return params;
    }

    async function fetchTrendSummary(lineCandidate) {
      const params = buildTrendQueryParams(lineCandidate);
      const payload = await fetchFromEndpoints(CHARTS_ENDPOINTS, params).catch(err => {
        console.warn("Falha ao buscar grficos:", err);
        return null;
      });
      return normalizeTrendPayload(payload);
    }

    function parseRowTimestamp(row) {
      const raw = row?.timestamp_intervalo ?? row?.timestamp_bloco ?? row?.ts_ref ?? row?.timestamp;
      if (!raw) return null;
      const dt = new Date(raw);
      return Number.isFinite(dt.getTime()) ? dt : null;
    }

    function computeRouteKpiFromRows(rows) {
      if (!Array.isArray(rows) || rows.length === 0) return null;
      const enriched = rows.map(row => ({ row, ts: parseRowTimestamp(row) })).filter(item => item.ts);
      if (!enriched.length) return null;
      enriched.sort((a, b) => a.ts - b.ts);
      const totalDistance = enriched.reduce((sum, item) => sum + safeNumber(item.row.distancia_total), 0);
      const totalTime = enriched.reduce(
        (sum, item) => sum + safeNumber(item.row.tempo_operacao_s ?? item.row.tempo_operacao_seg),
        0
      );
      const velDay = totalTime > 0 ? totalDistance / (totalTime / 3600.0) : null;
      const nowMs = Date.now();
      const cutoffHour = nowMs - 60 * 60 * 1000;
      const lastHourItems = enriched.filter(item => {
        const t = item.ts.getTime();
        return t >= cutoffHour && t <= nowMs;
      });
      const lastHourSum = lastHourItems.reduce(
        (sum, item) => sum + safeNumber(item.row.velocidade_media ?? item.row.velocidade_comercial ?? item.row.vel_comercial),
        0
      );
      const velHour =
        lastHourItems.length > 0 ? lastHourSum / lastHourItems.length : velDay ?? 0;
      const latest = enriched[enriched.length - 1];
      const vehicles =
        safeNumber(
          latest.row.num_veiculos ??
          latest.row.Volume_Frota ??
          latest.row.Volume_Frota_Ativa ??
          latest.row.volume_frota ??
          latest.row.volume ??
          latest.row.Volume ??
          latest.row.numVeiculos
        );
      const counts = enriched
        .map(item =>
          safeNumber(
            item.row.num_veiculos ??
              item.row.Volume_Frota ??
              item.row.Volume_Frota_Ativa ??
              item.row.volume_frota ??
              item.row.volume ??
              item.row.Volume ??
              item.row.numVeiculos
          )
        )
        .filter(value => value > 0);
      const avgVehicles = counts.length ? counts.reduce((sum, num) => sum + num, 0) / counts.length : null;
      const frequency = avgVehicles ? 60 / avgVehicles : null;
      const deltaVel = (velHour ?? 0) - (velDay ?? velHour ?? 0);
      return {
        timestamp: latest.ts.toISOString(),
        veiculos_ativos: Math.round(vehicles),
        vel_comercial: Number.isFinite(velDay) ? Number(velDay) : Number(velHour ?? 0),
        vel_comercial_1h: Number.isFinite(velHour) ? Number(velHour) : Number(velDay ?? 0),
        delta_vel_comercial: Number.isFinite(deltaVel) ? Number(deltaVel) : 0,
        distancia_total: Number.isFinite(totalDistance) ? Number(totalDistance) : 0,
        frequencia: Number.isFinite(frequency) ? Number(frequency) : null,
      };
    }

    const TREND_BUCKET_MS = 5 * 60 * 1000;
    const TREND_MAX_SPAN_MINUTES = 25;
    const TREND_MAX_SPAN_BUCKETS = Math.floor((TREND_MAX_SPAN_MINUTES * 60 * 1000) / TREND_BUCKET_MS);

    function aggregateTrendRows(rows) {
      if (!Array.isArray(rows) || rows.length === 0) return [];
      const buckets = new Map();
      const intervalMs = TREND_BUCKET_MS;
      rows.forEach(row => {
        const rawTimestamp = row.timestamp_intervalo || row.timestamp_bloco || row.ts_ref || row.timestamp;
        if (!rawTimestamp) return;
        const parsed = new Date(rawTimestamp);
        if (!Number.isFinite(parsed.getTime())) return;
        const bucketKey = Math.floor(parsed.getTime() / intervalMs) * intervalMs;
        const bucket = buckets.get(bucketKey) || {
          distancia_total: 0,
          tempo_operacao_s: 0,
          velocidade_sum: 0,
          velocidade_count: 0,
          num_veiculos: 0,
          uniqueVehicles: new Set()
        };
        bucket.distancia_total += safeNumber(row.distancia_total);
        bucket.tempo_operacao_s += safeNumber(row.tempo_operacao_s ?? row.tempo_operacao_seg);
        const rawSpeed = row.velocidade_media ?? row.velocidade_comercial ?? row.vel_comercial;
        const media = Number(rawSpeed);
        if (Number.isFinite(media)) {
          bucket.velocidade_sum += media;
          bucket.velocidade_count += 1;
        }
        const volumeValue =
          row.num_veiculos ??
          row.Volume_Frota ??
          row.Volume_Frota_Ativa ??
          row.volume_frota ??
          row.volume ??
          row.Volume ??
          row.numVeiculos;
        bucket.num_veiculos += safeNumber(volumeValue);
        const vehicleId = vehicleKeyFromRow(row);
        if (vehicleId) bucket.uniqueVehicles.add(vehicleId);
        buckets.set(bucketKey, bucket);
      });
      const sorted = Array.from(buckets.entries()).sort((a, b) => a[0] - b[0]);
      const timeline = sorted.map(([timestamp, data]) => {
        const interval = new Date(Number(timestamp));
        const meanSpeed = data.velocidade_count > 0 ? data.velocidade_sum / data.velocidade_count : 0;
        const velocidade = data.tempo_operacao_s > 0
          ? data.distancia_total / (data.tempo_operacao_s / 3600.0)
          : meanSpeed;
        const uniqueCount = data.uniqueVehicles?.size;
        const volumeValue = Number.isFinite(uniqueCount) && uniqueCount > 0 ? uniqueCount : data.num_veiculos;
        return {
          interval,
          velComercial: Number.isFinite(velocidade) ? velocidade : 0,
          volume: Number.isFinite(volumeValue) ? volumeValue : 0
        };
      });
      return applyRollingAverage(timeline);
    }

    function applyRollingAverage(entries) {
      const windowMs = 15 * 60 * 1000;
      return entries.map((entry, index) => {
        const currentMs = entry.interval.getTime();
        let sum = 0;
        let count = 0;
        for (let cursor = index; cursor >= 0; cursor -= 1) {
          const previous = entries[cursor];
          const delta = currentMs - previous.interval.getTime();
          if (delta > windowMs) break;
          const value = previous.velComercial;
          if (Number.isFinite(value)) {
            sum += value;
            count += 1;
          }
        }
        return {
          ...entry,
          vel15m: count ? sum / count : entry.velComercial
        };
      });
    }

    function normalizeTimelineEntries(entries) {
      if (!Array.isArray(entries)) return [];
      const mapped = entries
        .map(entry => {
          const ts = parseRowTimestamp(entry);
          if (!ts) return null;
          const baseSpeed = Number(
            entry.vel_comercial ??
            entry.velComercial ??
            entry.velocidade ??
            entry.velocidade_comercial ??
            entry.velocidade_media ??
            entry.velocidade
          );
          const vel15 = Number(entry.vel_15m ?? entry.vel15m ?? entry.vel_media_15 ?? entry.vel_media_15m);
          const volumeRaw =
            entry.volume ??
            entry.num_veiculos ??
            entry.Volume_Frota ??
            entry.Volume_Frota_Ativa ??
            entry.volume_frota ??
            entry.volume ??
            entry.Volume ??
            entry.numVeiculos;
          return {
            interval: ts,
            velComercial: Number.isFinite(baseSpeed) ? baseSpeed : 0,
            vel15m: Number.isFinite(vel15) ? vel15 : null,
            volume: Number.isFinite(Number(volumeRaw)) ? Number(volumeRaw) : 0
          };
        })
        .filter(Boolean)
        .sort((a, b) => a.interval - b.interval);
      return mapped;
    }

    function densifyTrendTimeline(entries) {
      if (!Array.isArray(entries) || entries.length === 0) return [];
      const sorted = entries.slice().sort((a, b) => a.interval - b.interval);
      const byMs = new Map();
      for (const entry of sorted) {
        const bucketMs = Math.floor(entry.interval.getTime() / TREND_BUCKET_MS) * TREND_BUCKET_MS;
        byMs.set(bucketMs, { ...entry, interval: new Date(bucketMs) });
      }
      const startMs = Math.floor(sorted[0].interval.getTime() / TREND_BUCKET_MS) * TREND_BUCKET_MS;
      const endMs = Math.floor(sorted[sorted.length - 1].interval.getTime() / TREND_BUCKET_MS) * TREND_BUCKET_MS;
      const result = [];
      for (let t = startMs; t <= endMs; t += TREND_BUCKET_MS) {
        const existing = byMs.get(t);
        if (existing) {
          result.push(existing);
        } else {
          result.push({
            interval: new Date(t),
            velComercial: null,
            vel15m: null,
            volume: null
          });
        }
      }
      return result;
    }

    function buildSegmentedLineDatasets({ values, label, color, fill, fillMode, borderWidth = 2, tension = 0.2 }) {
      const datasets = [];
      let lastDefinedIndex = null;
      let segmentStart = null;

      const pushSegment = (startIndex, endIndex) => {
        if (startIndex == null || endIndex == null || endIndex < startIndex) return;
        const data = new Array(values.length).fill(null);
        for (let i = startIndex; i <= endIndex; i += 1) {
          data[i] = values[i];
        }
        datasets.push({
          label,
          data,
          borderColor: color,
          backgroundColor: fill,
          borderWidth,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHitRadius: 12,
          fill: fillMode,
          tension,
          spanGaps: true
        });
      };

      for (let i = 0; i < values.length; i += 1) {
        const val = values[i];
        const isDefined = val != null && Number.isFinite(Number(val));
        if (!isDefined) continue;
        if (lastDefinedIndex == null) {
          segmentStart = i;
        } else {
          const gapBuckets = i - lastDefinedIndex - 1;
          if (gapBuckets > TREND_MAX_SPAN_BUCKETS) {
            pushSegment(segmentStart, lastDefinedIndex);
            segmentStart = i;
          }
        }
        lastDefinedIndex = i;
      }

      if (lastDefinedIndex != null && segmentStart != null) {
        pushSegment(segmentStart, lastDefinedIndex);
      }

      return datasets.length ? datasets : [{
        label,
        data: values,
        borderColor: color,
        backgroundColor: fill,
        borderWidth,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHitRadius: 12,
        fill: fillMode,
        tension,
        spanGaps: true
      }];
    }

    function ensureRollingTimeline(entries) {
      if (!Array.isArray(entries) || entries.length === 0) return [];
      const hasRolling = entries.some(entry => Number.isFinite(entry.vel15m));
      if (hasRolling) {
        return entries.map(entry => ({
          ...entry,
          vel15m: Number.isFinite(entry.vel15m) ? entry.vel15m : entry.velComercial
        }));
      }
      return applyRollingAverage(entries);
    }

    function normalizeTrendPayload(payload) {
      if (!payload) {
        return { timeline: [], kpi: null, rows: [] };
      }
      if (Array.isArray(payload)) {
        const timelineFromRows = aggregateTrendRows(payload);
        return {
          timeline: ensureRollingTimeline(timelineFromRows),
          kpi: computeRouteKpiFromRows(payload),
          rows: payload
        };
      }
      const rows = Array.isArray(payload.rows)
        ? payload.rows
        : Array.isArray(payload.metricas)
          ? payload.metricas
          : [];
      const timelineRaw = Array.isArray(payload.timeline) ? normalizeTimelineEntries(payload.timeline) : [];
      const timeline = ensureRollingTimeline(timelineRaw.length ? timelineRaw : aggregateTrendRows(rows));
      const kpi = payload.kpi || computeRouteKpiFromRows(rows);
      return { timeline, kpi, rows };
    }

    function filterTrendSummaryByCategory(summary) {
      if (!summary || selectedCategory === CATEGORY_FILTER_ALL) return summary;
      const normalizeCat = (value) => (value || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
      const target = normalizeCat(selectedCategory);

      const rows = Array.isArray(summary.rows) ? summary.rows : [];
      const timelineRaw = Array.isArray(summary.timeline) ? summary.timeline : [];
      const originalTimeline = ensureRollingTimeline(
        timelineRaw.length ? normalizeTimelineEntries(timelineRaw) : aggregateTrendRows(rows)
      );

      // If the payload already declares the category, trust it.
      const summaryCat = normalizeCat(summary.categoria ?? summary.category);
      if (summaryCat && summaryCat === target) {
        return { ...summary, timeline: originalTimeline, kpi: summary.kpi || computeRouteKpiFromRows(rows) };
      }

      // Special-case Rede Madrugada: some payloads omit linha/categoria but are already scoped.
      if (target === normalizeCat("Rede Madrugada") && rows.length && !timelineRaw.length) {
        return { ...summary, timeline: originalTimeline, kpi: summary.kpi || computeRouteKpiFromRows(rows) };
      }

      const filteredRows = rows.filter(row => {
        const explicitCat = normalizeCat(row?.categoria ?? row?.categoria_frota ?? row?.category);
        if (explicitCat && explicitCat === target) return true;
        const linha = row?.linha ?? row?.line_id ?? row?.line ?? row?.route_id ?? "";
        const inferred = definirCategoria(linha);
        return normalizeCat(inferred) === target;
      });

      const filteredTimeline = timelineRaw.filter(entry => {
        const entryCat = normalizeCat(entry?.categoria ?? entry?.category);
        if (entryCat && entryCat === target) return true;
        const linha = entry?.linha ?? entry?.line_id ?? entry?.line ?? entry?.route_id ?? "";
        const inferred = definirCategoria(linha);
        return normalizeCat(inferred) === target;
      });

      const timeline = ensureRollingTimeline(filteredTimeline.length ? normalizeTimelineEntries(filteredTimeline) : aggregateTrendRows(filteredRows));
      const kpi = computeRouteKpiFromRows(filteredRows);
      if (!filteredRows.length && !timeline.length) {
        // Fall back to original data if backend likely already filtered by category but didn't provide per-line info.
        if (originalTimeline.length || rows.length) {
          return { ...summary, timeline: originalTimeline, kpi: summary.kpi || computeRouteKpiFromRows(rows), rows };
        }
        return { ...summary, rows: [], timeline: [], kpi: null };
      }
      return { ...summary, rows: filteredRows, timeline, kpi };
    }

    function updateTrendTimeline(entries) {
      trendTimeline = densifyTrendTimeline(ensureRollingTimeline(entries));
      updatePreviewChartsDisplay();
      if (currentOverlayType) {
        renderOverlayChart(currentOverlayType);
      }
      if (pendingChartFocus && trendTimeline.length) {
        openChartOverlay(pendingChartFocus);
        pendingChartFocus = null;
      }
    }

    function normalizeTimestampMs(value) {
      if (value == null) return null;
      const num = Number(value);
      if (Number.isFinite(num)) {
        const ms = num > 1e12 ? num : num * 1000; // seconds -> ms
        const d = new Date(ms);
        return Number.isFinite(d.getTime()) ? d.getTime() : null;
      }
      const d = new Date(value);
      return Number.isFinite(d.getTime()) ? d.getTime() : null;
    }

    function formatTimeOnly(value) {
      const ts = normalizeTimestampMs(value);
      if (!Number.isFinite(ts)) return "";
      const d = new Date(ts);
      return d.toLocaleTimeString("pt-PT", { hour: "2-digit", minute: "2-digit" });
    }

    function formatKm(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "";
      // Heurstica: valores grandes tratam-se como metros, seno assume km.
      if (num > 10_000) return (num / 1000).toFixed(1);
      if (num > 1_000) return (num / 1000).toFixed(2);
      return num.toFixed(2);
    }

    function kmValueForSort(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return NaN;
      if (num > 10_000) return num / 1000;
      if (num > 1_000) return num / 1000;
      return num;
    }

    function statusDotHtml(isActive) {
      const cls = isActive ? "active" : "inactive";
      const label = isActive ? "Ativo" : "Inativo";
      return `<span class="overlay-status-dot ${cls}" title="${label}" aria-label="${label}"></span>`;
    }

    function compareNullable(a, b) {
      const aNull = a == null || Number.isNaN(a);
      const bNull = b == null || Number.isNaN(b);
      if (aNull && bNull) return 0;
      if (aNull) return 1;
      if (bNull) return -1;
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function isDarkThemeActive() {
      const body = document.body;
      if (!body) return false;
      if (body.classList.contains("theme-dark")) return true;
      if (body.classList.contains("theme-auto")) {
        return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      }
      return false;
    }

    function getChartColors() {
      const styles = getComputedStyle(document.body);
      const dark = isDarkThemeActive();
      const axis = (styles.getPropertyValue("--chart-axis-color") || (dark ? "#f9fafb" : "#0f172a")).trim();
      const grid = (styles.getPropertyValue("--chart-grid-color") || (dark ? "rgba(255, 255, 255, 0.18)" : "rgba(15, 23, 42, 0.12)")).trim();
      const tooltipBg = (styles.getPropertyValue("--panel-bg") || (dark ? "rgba(15,23,42,0.92)" : "rgba(255,255,255,0.95)")).trim();
      const tooltipFg = (styles.getPropertyValue("--text-primary") || (dark ? "#f9fafb" : "#0f172a")).trim();
      return { axis, grid, tooltipBg, tooltipFg };
    }

    async function checkApiHealth() {
      for (const url of HEALTH_ENDPOINTS) {
        try {
          const resp = await fetch(url, withNgrokBypass({ cache: "no-store" }));
          if (resp.ok) return true;
        } catch (err) {
          continue;
        }
      }
      return false;
    }

    async function fetchRouteDayVehicles(lineId, dateStr) {
      if (!lineId) return [];
      const endpoints = routeDetailEndpoints(lineId, dateStr);
      const params = buildTrendQueryParams(lineId);
      params.line_id = lineId;
      params.linha = lineId;
      try {
        const payload = await fetchFromEndpoints(endpoints, params);
        const rows = Array.isArray(payload) ? payload : (Array.isArray(payload?.rows) ? payload.rows : []);
        return rows;
      } catch (err) {
        console.warn("Falha ao carregar veculos do dia:", err);
        return [];
      }
    }

    function normalizeVehicleDayRow(row) {
      if (!row || typeof row !== "object") return null;
      const id = row.vehicle_id ?? row.id_veiculo ?? row.veiculo ?? row.id ?? row.vehicle ?? null;
      if (!id) return null;
      const model = row.modelo ?? row.model ?? row.vehicle_model ?? row.tipo ?? row.type ?? "";
      const first = row.first_ping ?? row.primeiro_ping ?? row.hora_inicio ?? row.ts_inicio ?? row.start_time ?? row.primeiro_ts ?? row.timestamp_inicio ?? null;
      const last = row.last_ping ?? row.ultimo_ping ?? row.hora_fim ?? row.ts_fim ?? row.end_time ?? row.ultimo_ts ?? row.timestamp_fim ?? row.ts ?? row.timestamp ?? null;
      const dist =
        row.distancia_total_km ??
        row.distancia_total_m ??
        row.distancia_total ??
        row.distancia ??
        row.km_total ??
        row.total_distance ??
        null;
      const trips = row.viagens ?? row.num_viagens ?? row.trips ?? row.total_trips ?? row.viagens_concluidas ?? null;
      const rawPlate = row.plate ?? row.placa ?? row.chapa ?? row.veiculo ?? row.vehicle_label ?? row.vehicle ?? "";
      const plate = rawPlate ? String(rawPlate).trim() : "";
      const chapa = parsePlateChapa(row.chapa ?? plate);
      const firstTs = normalizeTimestampMs(first);
      const lastTs = normalizeTimestampMs(last);
      return { id, model, first: firstTs, last: lastTs, dist, trips, plate, chapa };
    }

    function vehicleKeyFromRow(row) {
      if (!row || typeof row !== "object") return null;
      const candidate = row.vehicle_id ?? row.id_veiculo ?? row.veiculo ?? row.id ?? row.vehicle ?? row.vehicleId ?? null;
      if (candidate == null) return null;
      const normalized = typeof candidate === "string"
        ? candidate.trim()
        : String(candidate);
      return normalized ? normalized : null;
    }

    function cacheOverlayChapaEntry(idKey, plate, chapa) {
      if (!idKey) return;
      const safePlate = plate || "";
      const safeChapa = chapa || "";
      if (!safePlate && !safeChapa) return;
      volumeOverlayChapaCache.set(idKey, { plate: safePlate, chapa: safeChapa });
    }

    function seedVolumeOverlayChapaCacheFromVehicleMap() {
      // Keep the overlay cache populated with the latest snapshot entries so inactive vehicles keep their chapas.
      for (const [entryId, entry] of vehicleChapaMap.entries()) {
        cacheOverlayChapaEntry(entryId, entry?.plate, entry?.chapa);
      }
    }

    function mergeVehicleRows(rows, startMs, endMs) {
      const byId = new Map();
      rows.forEach(row => {
        if (!row || !row.id) return;
        if (startMs != null && endMs != null) {
          const inRangeFirst = row.first != null && row.first >= startMs && row.first < endMs;
          const inRangeLast = row.last != null && row.last >= startMs && row.last < endMs;
          if (!inRangeFirst && !inRangeLast) return;
        }
        const key = String(row.id);
        const existing = byId.get(key);
        if (!existing) {
          byId.set(key, { ...row });
          return;
        }
        const merged = { ...existing };
        const numDist = Number(row.dist);
        const numTrips = Number(row.trips);
        merged.model = merged.model || row.model || "";
        merged.plate = merged.plate || row.plate || "";
        merged.chapa = merged.chapa || row.chapa || "";
        if (row.first != null && (merged.first == null || row.first < merged.first)) merged.first = row.first;
        if (row.last != null && (merged.last == null || row.last > merged.last)) merged.last = row.last;
        if (Number.isFinite(numDist)) {
          const existingDist = Number(merged.dist);
          const accumulatedDist = (Number.isFinite(existingDist) ? existingDist : 0) + numDist;
          if (Number.isFinite(accumulatedDist)) merged.dist = accumulatedDist;
        }
        if (Number.isFinite(numTrips)) {
          const existingTrips = Number(merged.trips);
          const accumulatedTrips = (Number.isFinite(existingTrips) ? existingTrips : 0) + numTrips;
          if (Number.isFinite(accumulatedTrips)) merged.trips = accumulatedTrips;
        }
        byId.set(key, merged);
      });
      return Array.from(byId.values());
    }

    function buildLiveVehiclesById(lineIds = []) {
      const map = new Map();
      if (!Array.isArray(lastVehicles) || !lastVehicles.length) return map;
      const ids = Array.isArray(lineIds) ? lineIds.map(normalizeOptionKey) : [];
      const allowedVariants = new Set(ids.filter(Boolean));
      const allowedBases = new Set();
      if (selectedVariant === VARIANT_FILTER_ALL) {
        ids.forEach(id => {
          const base = getBaseRouteKey(id);
          if (base) allowedBases.add(base);
        });
        const baseSelected = getBaseRouteKey(selectedRoute);
        if (baseSelected) allowedBases.add(baseSelected);
      }
      const activeCutoff = Date.now() - 10 * 60 * 1000;
      for (const v of lastVehicles) {
        const vid = v?.id ?? v?.vehicle_id ?? v?.vehicleId ?? v?.vehicle;
        if (!vid) continue;
        const variantKey = normalizeOptionKey(v?.routeId || v?.routeLabel || v?.linha || "");
        const baseKey = getBaseRouteKey(variantKey);
        const matchVariant = allowedVariants.size === 0 || (variantKey && allowedVariants.has(variantKey));
        const matchBase = allowedBases.size === 0 || (baseKey && allowedBases.has(baseKey));
        if (!matchVariant && !matchBase) continue;
        const tsMs = normalizeTimestampMs(v?.ts ?? v?.timestamp ?? v?.serverTsSec ?? v?.server_ts ?? v?.time ?? null);
        if (!Number.isFinite(tsMs)) continue;
        const active = tsMs >= activeCutoff;
        map.set(String(vid), { tsMs, active });
      }
      return map;
    }

    function sortedVolumeRows() {
      const rows = Array.isArray(volumeTableRows) ? [...volumeTableRows] : [];
      const { key, dir } = volumeTableSort;
      const factor = dir === "asc" ? 1 : -1;
      rows.sort((a, b) => {
        switch (key) {
          case "id": {
            const left = (a.id ?? "").toString();
            const right = (b.id ?? "").toString();
            return factor * left.localeCompare(right, "pt-PT", { numeric: true });
          }
          case "model": {
            const left = (a.model ?? "").toString();
            const right = (b.model ?? "").toString();
            return factor * left.localeCompare(right, "pt-PT", { numeric: true });
          }
          case "chapa": {
            const left = (a.chapa ?? "").toString();
            const right = (b.chapa ?? "").toString();
            return factor * left.localeCompare(right, "pt-PT", { numeric: true });
          }
          case "first":
            return factor * compareNullable(a.first ?? null, b.first ?? null);
          case "last":
            return factor * compareNullable(a.last ?? null, b.last ?? null);
          case "dist":
            return factor * compareNullable(a.distKm ?? null, b.distKm ?? null);
          case "trips":
            return factor * compareNullable(a.tripsNum ?? null, b.tripsNum ?? null);
          case "active":
            return factor * compareNullable(a.active ? 1 : 0, b.active ? 1 : 0);
          default:
            return 0;
        }
      });
      return rows;
    }

    function renderVolumeTableRows() {
      if (!chartOverlayVehicleRows) return;
      const rows = sortedVolumeRows();
      if (!rows.length) {
        chartOverlayVehicleRows.innerHTML = `<tr><td colspan="8" class="overlay-empty">Sem dados desta carreira para hoje.</td></tr>`;
        return;
      }
      const html = rows.map(row => {
        const active = row.active;
        return `<tr>
          <td>${escapeHtml(row.id || "")}</td>
          <td>${escapeHtml(row.chapa || "")}</td>
          <td>${escapeHtml(row.model || "")}</td>
          <td>${escapeHtml(formatTimeOnly(row.first))}</td>
          <td>${escapeHtml(formatTimeOnly(row.last))}</td>
          <td>${escapeHtml(formatKm(row.dist))}</td>
          <td>${escapeHtml(row.trips != null ? String(row.trips) : "")}</td>
          <td>${statusDotHtml(active)}</td>
        </tr>`;
      }).join("");
      chartOverlayVehicleRows.innerHTML = html;
    }

    function setVolumeSort(key) {
      if (!key) return;
      if (volumeTableSort.key === key) {
        volumeTableSort.dir = volumeTableSort.dir === "asc" ? "desc" : "asc";
      } else {
        volumeTableSort = { key, dir: key === "id" || key === "first" || key === "chapa" ? "asc" : "desc" };
      }
      renderVolumeTableRows();
      updateVolumeSortButtons();
    }

    function updateVolumeSortButtons() {
      if (!overlaySortButtons || !overlaySortButtons.length) return;
      const { key, dir } = volumeTableSort;
      overlaySortButtons.forEach(btn => {
        const active = btn.dataset.sort === key;
        btn.classList.toggle("active", active);
        const icon = btn.querySelector(".sort-icon");
        if (icon) icon.textContent = active ? (dir === "asc" ? "" : "") : "";
      });
    }

    function renderVolumeOverlayTable() {
      if (!chartOverlayExtra || !chartOverlayVehicleRows) return;
      const lineIds = resolveOverlayVariantIds();
      if (!lineIds.length) {
        chartOverlayExtra.hidden = true;
        if (chartOverlayContent) chartOverlayContent.classList.remove("volume-layout");
        if (chartOverlayContent) chartOverlayContent.classList.remove("volume-tight");
        resetOverlayTint();
        volumeTableRows = [];
        if (chartOverlayVehicleRows) {
          chartOverlayVehicleRows.innerHTML = `<tr><td colspan="8" class="overlay-empty">Sem dados desta seleo.</td></tr>`;
        }
        return;
      }
      chartOverlayExtra.hidden = false;
      if (chartOverlayContent) chartOverlayContent.classList.add("volume-layout");
      applyVolumeOverlayTint();
      updateVolumeOverlayLayout();
      chartOverlayVehicleRows.innerHTML = `<tr><td colspan="8" class="overlay-empty">A carregar</td></tr>`;
      const today = new Date().toISOString().split("T")[0];
      const startMs = normalizeTimestampMs(`${today}T00:00:00`);
      const endMs = startMs != null ? startMs + 24 * 60 * 60 * 1000 : null;
      const liveById = buildLiveVehiclesById(lineIds);
      const activeCutoff = Date.now() - 10 * 60 * 1000;
      return Promise.all(lineIds.map(id => fetchRouteDayVehicles(id, today))).then(results => {
        const rows = results.flat();
        const normalized = rows.map(normalizeVehicleDayRow).filter(Boolean);
        const merged = mergeVehicleRows(normalized, startMs, endMs);
        if (!merged.length) {
          chartOverlayVehicleRows.innerHTML = `<tr><td colspan="8" class="overlay-empty">Sem dados desta carreira para hoje.</td></tr>`;
          return;
        }
        volumeTableRows = merged.map(row => {
          const chapaEntry = getVehicleChapaEntryById(row.id);
          const idKey = normalizeVehicleChapaId(row.id);
          const historical = idKey ? volumeOverlayChapaCache.get(idKey) : null;
          const historicalPlate = historical?.plate || "";
          const historicalChapa = historical?.chapa || "";
          const plateValue = chapaEntry?.plate || row.plate || historicalPlate;
          const chapaValue = chapaEntry?.chapa || row.chapa || historicalChapa || parsePlateChapa(plateValue);
          const live = liveById.get(String(row.id));
          const liveLast = live?.tsMs;
          const finalLast = Number.isFinite(liveLast)
            ? Math.max(row.last ?? -Infinity, liveLast)
            : row.last;
          const active = live?.active ?? (finalLast != null && finalLast >= activeCutoff);
          const distKm = kmValueForSort(row.dist);
          const tripsNum = Number(row.trips);
          return {
            ...row,
            plate: plateValue,
            chapa: chapaValue,
            last: finalLast,
            active,
            distKm: Number.isFinite(distKm) ? distKm : null,
            tripsNum: Number.isFinite(tripsNum) ? tripsNum : null
          };
        });
        volumeTableRows.forEach(row => {
          const idKey = normalizeVehicleChapaId(row.id);
          if (!idKey) return;
          cacheOverlayChapaEntry(idKey, row.plate, row.chapa);
        });
        renderVolumeTableRows();
        updateVolumeSortButtons();
        updateVolumeOverlayLayout();
      }).catch(err => {
        console.warn("Falha ao carregar veculos do dia:", err);
        chartOverlayVehicleRows.innerHTML = `<tr><td colspan="8" class="overlay-empty">Erro ao carregar dados.</td></tr>`;
      });
    }

    function updatePreviewChartsDisplay() {
      const labels = trendTimeline.map(entry => timeLabelFormatter.format(entry.interval));
      if (previewCharts.speed) {
        previewCharts.speed.data.labels = labels;
        const values = trendTimeline.map(entry =>
          Number.isFinite(entry.vel15m) ? Number(entry.vel15m.toFixed(1)) : null
        );
        previewCharts.speed.data.datasets = buildSegmentedLineDatasets({
          values,
          label: "Velocidade Comercial",
          color: "#ff4b4b",
          fill: "transparent",
          fillMode: false,
          borderWidth: 2,
          tension: 0.3
        });
        previewCharts.speed.update("none");
      }
      if (previewCharts.volume) {
        previewCharts.volume.data.labels = labels;
        const values = trendTimeline.map(entry =>
          Number.isFinite(entry.volume) ? Number(entry.volume.toFixed(0)) : null
        );
        previewCharts.volume.data.datasets = buildSegmentedLineDatasets({
          values,
          label: "Volume da Frota",
          color: "#f59f00",
          fill: "rgba(245, 159, 0, 0.25)",
          fillMode: "start",
          borderWidth: 2,
          tension: 0.3
        });
        previewCharts.volume.update("none");
      }
    }

	    function initPreviewCharts() {
	      if (window.Chart && chartSpeedCanvas) {
	        previewCharts.speed = new Chart(chartSpeedCanvas.getContext("2d"), {
	          type: "line",
	          data: {
	            labels: [],
	            datasets: [{
	              label: "Velocidade Comercial",
	              data: [],
	              borderColor: "#ff4b4b",
	              backgroundColor: "transparent",
	              borderWidth: 2,
	              pointRadius: 0,
	              fill: false,
	              tension: 0.3,
	              spanGaps: true
	            }]
	          },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false, min: 0 }
              }
            }
        });
      }
      if (window.Chart && chartVolumeCanvas) {
        previewCharts.volume = new Chart(chartVolumeCanvas.getContext("2d"), {
          type: "line",
          data: {
            labels: [],
            datasets: [{
              label: "Volume da Frota",
              data: [],
              borderColor: "#f59f00",
              backgroundColor: "rgba(245, 159, 0, 0.25)",
              borderWidth: 2,
              pointRadius: 0,
              fill: "start",
              tension: 0.3,
              spanGaps: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false, min: 0 }
            }
          }
        });
      }
    }

    async function refreshCharts(force = false) {
      const routeCandidates = getRouteLineCandidates();
      // Se uma carreira est selecionada, s tenta essa; caso contrrio, usa o agregado (null).
      const chartLineCandidates = routeCandidates.length ? [...routeCandidates] : [null];
      const now = Date.now();
      let found = false;
      const selectionKey = JSON.stringify({
        category: selectedCategory || null,
        route: routeCandidates.join("|") || null
      });

      if (!force) {
        if (chartCache.selectionKey === selectionKey && now - lastChartFetchTs < CHARTS_MIN_INTERVAL_MS && chartCache.summary) {
          lastTrendSummary = { ...(chartCache.summary || {}), lineCandidate: chartCache.lineCandidate ?? null };
          lastTrendLineCandidate = chartCache.lineCandidate ?? null;
          updateTrendTimeline(lastTrendSummary.timeline || []);
          return lastTrendSummary;
        }
      }

      for (const candidate of chartLineCandidates) {
        const params = buildTrendQueryParams(candidate);
        const paramsKey = JSON.stringify(params);

        if (!force && chartCache.selectionKey === selectionKey && paramsKey === chartCache.paramsKey && now - chartCache.timestamp < CHARTS_CACHE_TTL_MS && chartCache.summary) {
          lastTrendSummary = { ...(chartCache.summary || {}), lineCandidate: chartCache.lineCandidate ?? candidate };
          lastTrendLineCandidate = chartCache.lineCandidate ?? candidate;
          updateTrendTimeline(lastTrendSummary.timeline || []);
          return lastTrendSummary;
        }

        let summary = await fetchTrendSummary(candidate).catch(err => {
          showAppError(`Falha nos grficos: ${err?.message || err}`);
          return { timeline: [], rows: [], kpi: null };
        });
        let paramsKeyUsed = paramsKey;
        const unfilteredSummary = summary;
        if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) {
          const filtered = filterTrendSummaryByCategory(summary);
          const filteredEmpty = (!filtered.timeline?.length) && (!filtered.rows?.length) && !filtered.kpi;
          const unfilteredHasData = (unfilteredSummary.timeline?.length) || (unfilteredSummary.rows?.length) || unfilteredSummary.kpi;
          summary = (!filteredEmpty || !unfilteredHasData) ? filtered : unfilteredSummary;
        }
        if (!summary.timeline.length && !summary.rows.length && !summary.kpi) continue;

        chartCache = { paramsKey: paramsKeyUsed, summary, timestamp: now, lineCandidate: candidate, selectionKey };
        lastChartFetchTs = now;
        lastTrendSummary = { ...summary, lineCandidate: candidate };
        lastTrendLineCandidate = candidate;
        updateTrendTimeline(summary.timeline || []);
        await refreshKpis(true);
        found = true;
        return summary;
      }

      // If nothing worked for the current selection (route/category), clear charts instead of keeping stale data.
      chartCache = { paramsKey: "", summary: null, timestamp: 0, lineCandidate: null, selectionKey };
      lastTrendSummary = { timeline: [], kpi: null, rows: [], lineCandidate: null };
      lastTrendLineCandidate = null;
      updateTrendTimeline([]);
      return lastTrendSummary;
    }

    function startChartRefreshLoop() {
      if (chartRefreshIntervalId) return;
      chartRefreshIntervalId = setInterval(() => {
        refreshCharts().catch(err => showAppError(`Falha nos grficos: ${err?.message || err}`));
      }, CHARTS_REFRESH_INTERVAL_MS);
    }

    function renderOverlayChart(type) {
      if (!chartOverlayCanvas) return;
      const context = chartOverlayCanvas.getContext("2d");
      if (!context) return;
      if (type === "volume") {
        updateVolumeOverlayLayout();
        applyVolumeOverlayTint();
      }
      const { axis, grid, tooltipBg, tooltipFg } = getChartColors();
      if (!trendTimeline.length) {
        if (chartOverlayTitle) chartOverlayTitle.textContent = "Sem dados";
        chartOverlayCanvas.getContext("2d").clearRect(0, 0, chartOverlayCanvas.width, chartOverlayCanvas.height);
        if (chartOverlayExtra) chartOverlayExtra.hidden = true;
        overlayChartState = { type: null, labels: [], values: [] };
        return;
      }
      const labels = trendTimeline.map(entry => timeLabelFormatter.format(entry.interval));
      const data = trendTimeline.map(entry =>
        type === "volume"
          ? Number.isFinite(entry.volume) ? Number(entry.volume.toFixed(0)) : null
          : Number.isFinite(entry.vel15m) ? Number(entry.vel15m.toFixed(1)) : null
      );
      const numericValues = data.filter(v => Number.isFinite(v));
      const suggestedMax = numericValues.length ? Math.max(...numericValues) * 1.12 : undefined;
      const yTickFormatter = (value) => {
        if (type === "volume") return Math.round(value).toString();
        const num = Number(value);
        return Number.isFinite(num) ? num.toFixed(1) : value;
      };
      const zoneTint = type === "volume" ? (resolveOverlayZoneInfo().color || "#f59f00") : null;
      const color = type === "volume" ? (normalizeHexColor(zoneTint) || "#f59f00") : "#ff4b4b";
      const fill = type === "volume" ? hexToRgba(color, 0.22) : "transparent";
      const title = type === "volume" ? "Volume da Frota" : "Velocidade Comercial";
      const fillMode = type === "volume" ? "start" : false;
      const valueUnit = type === "volume" ? "veculos" : "km/h";
      const compactTicks = type === "volume";
      const volumeTight = type === "volume" && chartOverlayContent?.classList.contains("volume-tight");
      const xTickOpts = {
        color: axis,
        maxTicksLimit: volumeTight ? 3 : (compactTicks ? 4 : 5),
        autoSkip: true,
        autoSkipPadding: volumeTight ? 32 : (compactTicks ? 28 : 24),
        maxRotation: 0,
        minRotation: 0,
        font: { size: compactTicks ? 11 : 12, weight: "700" }
      };
      const yTickOpts = {
        color: axis,
        beginAtZero: true,
        padding: volumeTight ? 14 : (compactTicks ? 10 : 12),
        maxTicksLimit: volumeTight ? 4 : (compactTicks ? 4 : 5),
        autoSkipPadding: volumeTight ? 16 : (compactTicks ? 12 : 14),
        font: { size: volumeTight ? 11 : (compactTicks ? 11 : 12), weight: "700" },
        callback: yTickFormatter
      };
      if (chartOverlayTitle) {
        let contextLabel = "";
        if (selectedRoute && selectedRoute !== ROUTE_FILTER_ALL) {
          const ctx = buildRouteContext();
          contextLabel = ctx.html || escapeHtml(ctx.text || "");
        } else if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) {
          contextLabel = escapeHtml(selectedCategory);
        } else {
          contextLabel = "pesquise carreira, paragem";
        }
        const safeTitle = escapeHtml(title);
        chartOverlayTitle.innerHTML = contextLabel
          ? `<span class=\"chart-overlay-title-main\">${safeTitle}</span><span class=\"chart-overlay-context\">${contextLabel}</span>`
          : safeTitle;
      }

      const sameType = overlayChartState.type === type;
      const sameLabels = sameType && overlayChartState.labels.length === labels.length && overlayChartState.labels.every((v, i) => v === labels[i]);
      const sameValues = sameType && overlayChartState.values.length === data.length && overlayChartState.values.every((v, i) => v === data[i]);
      const datasets = buildSegmentedLineDatasets({
        values: data,
        label: title,
        color,
        fill,
        fillMode,
        borderWidth: 2,
        tension: 0.2
      });

      if (!overlayChartInstance) {
        overlayChartInstance = new Chart(context, {
          type: "line",
          data: { labels, datasets },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 10, right: 18, bottom: 18, left: 28 } },
            interaction: { mode: "nearest", intersect: false, axis: "x" },
            hover: { mode: "nearest", intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: tooltipBg,
                titleColor: tooltipFg,
                bodyColor: tooltipFg,
                borderWidth: 0,
                displayColors: false,
                mode: "nearest",
                intersect: false,
                titleFont: { size: 11, weight: "700" },
                bodyFont: { size: 11, weight: "600" },
                padding: 8,
                callbacks: {
                  title: (items) => items?.[0]?.label || "",
                  label: (ctx) => {
                    const v = ctx?.parsed?.y;
                    if (!Number.isFinite(v)) return "";
                    const val = type === "volume" ? Math.round(v) : Number(v).toFixed(1);
                    return `${val} ${valueUnit}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  color: axis,
                  maxTicksLimit: 5,
                  autoSkip: true,
                  autoSkipPadding: 24,
                  maxRotation: 0,
                  minRotation: 0,
                  font: { size: 11, weight: "700" }
                }
              },
              y: {
                grid: { color: grid, borderDash: [4, 4] },
                ticks: yTickOpts,
                min: 0,
                suggestedMax
              }
            },
            elements: {
              line: { borderCapStyle: "round", borderJoinStyle: "round" },
              point: { radius: 0, hoverRadius: 6, hitRadius: 12 }
            }
          }
        });
      } else if (!sameLabels || !sameValues || !sameType) {
        overlayChartInstance.data.labels = labels;
        overlayChartInstance.data.datasets = datasets;
        overlayChartInstance.options.animation = false;
        overlayChartInstance.options.scales.x.ticks.color = axis;
        overlayChartInstance.options.scales.y.ticks.color = axis;
        overlayChartInstance.options.scales.y.grid.color = grid;
        overlayChartInstance.options.scales.y.grid.borderDash = [4, 4];
        overlayChartInstance.options.scales.y.ticks.callback = yTickFormatter;
        overlayChartInstance.options.scales.y.suggestedMax = suggestedMax;
        overlayChartInstance.options.plugins.tooltip.backgroundColor = tooltipBg;
        overlayChartInstance.options.plugins.tooltip.titleColor = tooltipFg;
        overlayChartInstance.options.plugins.tooltip.bodyColor = tooltipFg;
        overlayChartInstance.options.plugins.tooltip.callbacks = {
          title: (items) => items?.[0]?.label || "",
          label: (ctx) => {
            const v = ctx?.parsed?.y;
            if (!Number.isFinite(v)) return "";
            const val = type === "volume" ? Math.round(v) : Number(v).toFixed(1);
            return `${val} ${valueUnit}`;
          }
        };
        overlayChartInstance.options.plugins.tooltip.titleFont = { size: 11, weight: "700" };
        overlayChartInstance.options.plugins.tooltip.bodyFont = { size: 11, weight: "600" };
        overlayChartInstance.options.plugins.tooltip.padding = 8;
        overlayChartInstance.options.scales.x.ticks = xTickOpts;
        overlayChartInstance.options.scales.y.ticks = yTickOpts;
        overlayChartInstance.options.layout = { padding: { top: 10, right: 18, bottom: 18, left: 28 } };
        overlayChartInstance.update("none");
      }

      overlayChartState = { type, labels: labels.slice(), values: data.slice() };

      if (type === "volume") {
        renderVolumeOverlayTable().catch(err => console.warn("Falha ao renderizar tabela de veculos:", err));
      } else if (chartOverlayExtra) {
        chartOverlayExtra.hidden = true;
      }
    }

    function openChartOverlay(type) {
      if (!chartOverlay || !trendTimeline.length) return;
      currentOverlayType = type;
      chartOverlay.classList.add("visible");
      if (chartOverlayContent) {
        chartOverlayContent.classList.toggle("volume-layout", type === "volume");
        if (type === "volume") {
          updateVolumeOverlayLayout();
          applyVolumeOverlayTint();
        } else {
          chartOverlayContent.classList.remove("volume-tight");
          resetOverlayTint();
        }
      }
      renderOverlayChart(type);
      setHashChart(type);
    }

    function closeChartOverlay() {
      if (chartOverlay) chartOverlay.classList.remove("visible");
      if (chartOverlayContent) {
        chartOverlayContent.classList.remove("volume-layout");
        chartOverlayContent.classList.remove("volume-tight");
      }
      resetOverlayTint();
      currentOverlayType = null;
      setHashChart(null);
    }

    if (chartOverlayCanvas && !chartOverlayCanvas.dataset.tooltipClickBound) {
      chartOverlayCanvas.dataset.tooltipClickBound = "1";
      chartOverlayCanvas.addEventListener("click", event => {
        if (!overlayChartInstance || !window.Chart) return;
        const points = overlayChartInstance.getElementsAtEventForMode(
          event,
          "nearest",
          { intersect: false },
          true
        );
        if (!points.length) return;
        const { datasetIndex, index } = points[0];
        const active = [{ datasetIndex, index }];
        overlayChartInstance.setActiveElements(active);
        const pos = window.Chart.helpers?.getRelativePosition
          ? window.Chart.helpers.getRelativePosition(event, overlayChartInstance)
          : null;
        if (overlayChartInstance.tooltip && pos) {
          overlayChartInstance.tooltip.setActiveElements(active, pos);
        }
        overlayChartInstance.update();
      });
    }

    if (chartOverlay) {
      chartOverlay.addEventListener("click", event => {
        if (event.target === chartOverlay) closeChartOverlay();
      });
    }

    if (chartOverlayClose) {
      chartOverlayClose.addEventListener("click", closeChartOverlay);
    }

    if (overlayTabChart) {
      overlayTabChart.addEventListener("click", () => setVolumeMobileTab("chart"));
    }
    if (overlayTabTable) {
      overlayTabTable.addEventListener("click", () => setVolumeMobileTab("table"));
    }
    if (overlaySortButtons && overlaySortButtons.length) {
      overlaySortButtons.forEach(btn => {
        btn.addEventListener("click", () => setVolumeSort(btn.dataset.sort));
      });
      updateVolumeSortButtons();
    }

    document.addEventListener("keydown", event => {
      if (event.key === "Escape") closeChartOverlay();
    });

    window.addEventListener("resize", () => {
      if (currentOverlayType === "volume") updateVolumeOverlayLayout();
    });
    window.addEventListener("resize", () => {
      requestAnimationFrame(refreshFloatingSpacing);
    });
    requestAnimationFrame(refreshFloatingSpacing);

    if (chartSpeedCard) {
      chartSpeedCard.addEventListener("click", () => openChartOverlay("speed"));
    }
    if (chartVolumeCard) {
      chartVolumeCard.addEventListener("click", () => openChartOverlay("volume"));
    }

    function findCategoryRow(data, category) {
      if (!Array.isArray(data) || data.length === 0) return null;
      if (category && category !== CATEGORY_FILTER_ALL) {
        const match = data.find(item => item.categoria === category);
        if (match) return match;
      }
      return data.find(item => item.categoria === "Global") || data[0];
    }

    function getCachedCategoryRow(category) {
      if (!categoryKpisCache.data || !categoryKpisCache.data.length) return null;
      return findCategoryRow(categoryKpisCache.data, category);
    }

    function buildUrlWithParams(endpoint, params) {
      try {
        const url = new URL(endpoint);
        Object.entries(params || {}).forEach(([key, value]) => {
          if (value != null && value !== "") {
            url.searchParams.set(key, value);
          }
        });
        if (!url.searchParams.has("_ts")) {
          url.searchParams.set("_ts", String(Date.now()));
        }
        return url.toString();
      } catch (err) {
        console.warn("URL invlida ignorada:", endpoint, err);
        return null;
      }
    }

    async function fetchFromEndpoints(endpoints, params = {}, opts = {}) {
      const resolved = (endpoints || [])
        .map(endpoint => buildUrlWithParams(endpoint, params))
        .filter(Boolean);
      if (!resolved.length) throw new Error("Nenhum endpoint vlido para chamada.");
      let lastError = null;
      for (const url of resolved) {
        try {
          const response = await fetchWithTimeout(url, withNgrokBypass({ cache: "no-store", signal: opts.signal }), opts.timeoutMs || 6000);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (err) {
          if (opts.signal && opts.signal.aborted) throw err;
          lastError = err;
          console.warn("Falha ao contactar endpoint", url, err);
        }
      }
      throw lastError || new Error("Todos os endpoints falharam");
    }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 6000) {
      const controller = new AbortController();
      const origSignal = options.signal;
      const onOrigAbort = () => controller.abort();
      if (origSignal) {
        if (origSignal.aborted) controller.abort();
        origSignal.addEventListener("abort", onOrigAbort, { once: true });
      }
      const timer = setTimeout(() => {
        controller.abort();
      }, timeoutMs);
      try {
        const resp = await fetch(url, { ...options, signal: controller.signal });
        return resp;
      } finally {
        clearTimeout(timer);
        if (origSignal) origSignal.removeEventListener("abort", onOrigAbort);
      }
    }

    async function fetchCategoryKpis(force = false) {
      if (!kpiPanel) return [];
      const now = Date.now();
      if (!force && now - categoryKpisCache.timestamp < KPI_CACHE_TTL_MS) {
        return categoryKpisCache.data || [];
      }
      try {
        const payload = await fetchFromEndpoints(KPI_ENDPOINTS.categories);
        const data = Array.isArray(payload) ? payload : [];
        categoryKpisCache = { timestamp: now, data };
        return data;
      } catch (err) {
        console.warn("Falha ao carregar KPIs de categoria:", err);
        return categoryKpisCache.data || [];
      }
    }

    async function fetchFleetDistanceTotals(force = false) {
      const today = new Date().toISOString().split("T")[0];
      const now = Date.now();
      if (!force && fleetDistanceCache.payload && fleetDistanceCache.date === today && (now - fleetDistanceCache.ts) < FLEET_AGGREGATE_TTL_MS) {
        return fleetDistanceCache.payload;
      }
      if (!force && fleetDistanceFetchPromise) {
        return fleetDistanceFetchPromise;
      }
      const promise = (async () => {
        try {
          const payload = await fetchFromEndpoints(FLEET_AGGREGATE_ENDPOINTS, { date: today });
          if (payload && typeof payload === "object") {
            fleetDistanceCache = { date: today, ts: Date.now(), payload };
            return payload;
          }
        } catch (err) {
          console.warn("Falha ao carregar distncias agregadas da frota:", err);
        } finally {
          fleetDistanceFetchPromise = null;
        }
        return fleetDistanceCache.payload;
      })();
      fleetDistanceFetchPromise = promise;
      return promise;
    }

    function normalizeCategoryKey(value) {
      if (!value) return "";
      const text = String(value).trim();
      if (!text) return "";
      return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function resolveFleetDistanceOverride(totals, context) {
      if (!totals || typeof totals !== "object") return null;
      const lines = Array.isArray(totals.por_linha) ? totals.por_linha : [];
      const categories = Array.isArray(totals.por_categoria) ? totals.por_categoria : [];
      const ctx = context || {};
      const hasSelection = Boolean(ctx.variant) || Boolean(ctx.route) || Boolean(ctx.category);
      if (ctx.variant) {
        const variantKey = normalizeRouteKey(ctx.variant);
        const variantBase = getBaseRouteKey(variantKey);
        const variantDistance = lines.reduce((sum, entry) => {
          const entryKey = normalizeRouteKey(entry?.linha);
          if (!entryKey) return sum;
          const entryBase = getBaseRouteKey(entryKey);
          if (entryKey === variantKey || (variantBase && entryBase === variantBase)) {
            return sum + safeNumber(entry.distancia_total);
          }
          return sum;
        }, 0);
        if (variantDistance > 0) return variantDistance;
      }
      if (ctx.route) {
        const routeBase = getBaseRouteKey(ctx.route);
        const routeDistance = lines.reduce((sum, entry) => {
          const entryKey = normalizeRouteKey(entry?.linha);
          if (!entryKey) return sum;
          if (getBaseRouteKey(entryKey) === routeBase) {
            return sum + safeNumber(entry.distancia_total);
          }
          return sum;
        }, 0);
        if (routeDistance > 0) return routeDistance;
      }
      if (ctx.category) {
        const normalizedCategory = normalizeCategoryKey(ctx.category);
        const match = categories.find(item => normalizeCategoryKey(item?.categoria) === normalizedCategory);
        if (match) {
          const value = safeNumber(match.distancia_total);
          if (value > 0) return value;
        }
      }
      if (!hasSelection && categories.length) {
        const total = categories.reduce((sum, item) => sum + safeNumber(item.distancia_total), 0);
        if (total > 0) return total;
      }
      return null;
    }

    function applyFleetDistanceOverride(row, totals, context) {
      if (!row || !totals) return row;
      const override = resolveFleetDistanceOverride(totals, context);
      if (!Number.isFinite(override) || override <= 0) return row;
      return { ...row, distancia_total: override };
    }

    async function fetchRouteKpi(lineId, force = false) {
      if (!kpiPanel) return null;
      const now = Date.now();
      const key = JSON.stringify({ scope: "route", lineId: lineId || null, categoria: selectedCategory || null });
      if (!force && routeKpisCache.row && routeKpisCache.key === key && (now - routeKpisCache.timestamp) < REFRESH_RATE_MS) {
        return routeKpisCache.row;
      }
      try {
	        if (!lineId) return null;
	        const encoded = encodeURIComponent(String(lineId));
	        const endpoints = KPI_ENDPOINTS.route.map(base => `${base}/${encoded}`);
	        const params = { active_window_min: ACTIVE_WINDOW_MIN };
	        if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) params.categoria = selectedCategory;
	        const payload = await fetchFromEndpoints(endpoints, params);
	        const row = Array.isArray(payload) ? (payload[0] || null) : payload;
	        routeKpisCache = { timestamp: now, key, row };
	        return row;
	      } catch (err) {
	        console.warn("Falha ao carregar KPI da rota (novo endpoint), a tentar legacy:", err);
	        try {
	          const legacyParams = { active_window_min: ACTIVE_WINDOW_MIN };
	          legacyParams.linha = lineId;
	          if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) legacyParams.categoria = selectedCategory;
	          const payload = await fetchFromEndpoints(KPI_ENDPOINTS.routeLegacy, legacyParams);
	          const row = Array.isArray(payload) ? (payload[0] || null) : payload;
	          routeKpisCache = { timestamp: now, key, row };
          return row;
        } catch (legacyErr) {
          console.warn("Falha ao carregar KPI da rota (legacy):", legacyErr);
          return routeKpisCache.row || null;
        }
      }
    }

    async function fetchRouteVariantKpi(variantId, force = false) {
      if (!kpiPanel) return null;
      const now = Date.now();
      const key = JSON.stringify({ scope: "route_variant", variantId: variantId || null, categoria: selectedCategory || null });
      if (!force && routeKpisCache.row && routeKpisCache.key === key && (now - routeKpisCache.timestamp) < REFRESH_RATE_MS) {
        return routeKpisCache.row;
      }
      try {
	        if (!variantId) return null;
	        const encoded = encodeURIComponent(String(variantId));
	        const endpoints = KPI_ENDPOINTS.routeVariant.map(base => `${base}/${encoded}`);
	        const params = { active_window_min: ACTIVE_WINDOW_MIN };
	        if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) params.categoria = selectedCategory;
	        const payload = await fetchFromEndpoints(endpoints, params);
	        const row = Array.isArray(payload) ? (payload[0] || null) : payload;
	        routeKpisCache = { timestamp: now, key, row };
	        return row;
      } catch (err) {
        console.warn("Falha ao carregar KPI da variante:", err);
        return routeKpisCache.row || null;
      }
    }

    async function fetchCategoryKpi(category, force = false) {
      if (!kpiPanel) return null;
      const now = Date.now();
      const key = JSON.stringify({ scope: "category", category: category || null });
      if (!force && routeKpisCache.row && routeKpisCache.key === key && (now - routeKpisCache.timestamp) < KPI_CACHE_TTL_MS) {
        return routeKpisCache.row;
      }
      try {
	        if (!category) return null;
	        const encoded = encodeURIComponent(String(category));
	        const endpoints = KPI_ENDPOINTS.category.map(base => `${base}/${encoded}`);
	        const params = { active_window_min: ACTIVE_WINDOW_MIN };
	        const payload = await fetchFromEndpoints(endpoints, params);
	        const row = Array.isArray(payload) ? (payload[0] || null) : payload;
	        routeKpisCache = { timestamp: now, key, row };
	        return row;
	      } catch (err) {
        console.warn("Falha ao carregar KPI da categoria (novo endpoint):", err);
        return routeKpisCache.row || null;
      }
    }

    function buildRouteContext() {
      const baseLabel = resolvePublicRouteLabel(selectedRoute) || "Carreira";
      let displayLabel = baseLabel;
      let routeIdForPill = selectedRoute;
      if (selectedVariant && selectedVariant !== VARIANT_FILTER_ALL) {
        const variantEntry = routeOptions.get(selectedRoute)?.variants?.get(selectedVariant);
        displayLabel = variantEntry || formatRouteLabel(selectedVariant, baseLabel) || baseLabel;
        routeIdForPill = selectedVariant || selectedRoute;
      }
      const { code } = parseRouteCodeParts(displayLabel || routeIdForPill);
      if (!code) return { text: displayLabel, html: null };
      const style = pillStyleForRoute(displayLabel || routeIdForPill);
      const regex = new RegExp(`^${escapeRegex(code)}\\s*`, "i");
      const rest = (displayLabel || "").replace(regex, "").trim();
      const pillHtml = `<span class="route-pill route-pill--inline" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}">${escapeHtml(code)}</span>`;
      const html = rest ? `${pillHtml} <span class="route-title-rest">${escapeHtml(rest)}</span>` : pillHtml;
      const text = rest ? `${code} ${rest}` : code;
      return { text, html };
    }

    function buildKpiContextKey() {
      return `${selectedRoute || ""}|${selectedVariant || ""}|${selectedCategory || ""}`;
    }

    function setKpiLoading(isLoading) {
      if (!kpiPanel) return;
      kpiPanel.classList.toggle("kpi-panel--loading", Boolean(isLoading));
    }

    function clearKpiDisplay() {
      updateKpiDisplay(null);
    }

    async function refreshKpis(force = false) {
      if (!kpiPanel) return;
      updateFloatingContext();
      const contextKey = buildKpiContextKey();
      const requestToken = ++kpiRefreshToken;
      kpiRefreshContextKey = contextKey;
      clearKpiDisplay();
      setKpiLoading(true);
      const fleetTotalsPromise = fetchFleetDistanceTotals();
      const fleetContext = {
        variant: selectedVariant && selectedVariant !== VARIANT_FILTER_ALL ? selectedVariant : null,
        route: selectedRoute && selectedRoute !== ROUTE_FILTER_ALL ? selectedRoute : null,
        category: selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL ? selectedCategory : null,
      };
      const showRow = async (row, context) => {
        if (requestToken !== kpiRefreshToken || contextKey !== kpiRefreshContextKey) return false;
        if (!row) {
          if (requestToken === kpiRefreshToken && contextKey === kpiRefreshContextKey) {
            setKpiLoading(false);
          }
          return false;
        }
        updateKpiDisplay(row, context);
        let totals = null;
        try {
          totals = await fleetTotalsPromise;
        } catch (err) {
          totals = null;
        }
        const enhanced = applyFleetDistanceOverride(row, totals, fleetContext);
        updateKpiDisplay(enhanced, context);
        setKpiLoading(false);
        return true;
      };
      const routeCandidates = getRouteLineCandidates();
      const computedRow =
        lastTrendSummary?.kpi ||
        computeRouteKpiFromRows(lastTrendSummary?.rows || []);
      const isGlobalMode =
        (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) &&
        (!selectedVariant || selectedVariant === VARIANT_FILTER_ALL) &&
        (!selectedCategory || selectedCategory === CATEGORY_FILTER_ALL);
      // Show cached category KPIs immediately when filtering only by category.
      const isCategoryOnlyMode =
        (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) &&
        (!selectedVariant || selectedVariant === VARIANT_FILTER_ALL) &&
        Boolean(selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL);
      if (isCategoryOnlyMode) {
        const cachedCategoryRow = getCachedCategoryRow(selectedCategory);
        if (cachedCategoryRow) {
          showRow(cachedCategoryRow, buildCategoryContext(selectedCategory) || { text: selectedCategory }).catch(() => {});
        }
      }
      if (isGlobalMode) {
        const cachedGlobalRow = getCachedCategoryRow("global");
        if (cachedGlobalRow) {
          showRow(cachedGlobalRow, buildFloatingContext()).catch(() => {});
        }
      }
      if (routeCandidates.length > 0) {
        const contextText = buildRouteContext();
        const hasRouteData = lastTrendLineCandidate != null && routeCandidates.includes(lastTrendLineCandidate);
        let realtimeKpi = null;
        if (selectedVariant && selectedVariant !== VARIANT_FILTER_ALL) {
          realtimeKpi = await fetchRouteVariantKpi(selectedVariant, force);
        } else {
          realtimeKpi = await fetchRouteKpi(routeCandidates[0], force);
        }
        if (realtimeKpi && computedRow) {
          return showRow(
            {
              ...computedRow,
              veiculos_ativos: realtimeKpi.veiculos_ativos ?? computedRow.veiculos_ativos,
              timestamp: realtimeKpi.timestamp ?? computedRow.timestamp,
              vel_comercial: realtimeKpi.vel_comercial ?? computedRow.vel_comercial,
              vel_comercial_1h: realtimeKpi.vel_comercial_1h ?? computedRow.vel_comercial_1h,
              delta_vel_comercial: realtimeKpi.delta_vel_comercial ?? computedRow.delta_vel_comercial,
              viagens_realizadas: realtimeKpi.viagens_realizadas ?? computedRow.viagens_realizadas,
              viagens_previstas: realtimeKpi.viagens_previstas ?? computedRow.viagens_previstas,
              viagens_realizadas_pct: realtimeKpi.viagens_realizadas_pct ?? computedRow.viagens_realizadas_pct,
              frequencia: realtimeKpi.frequencia ?? computedRow.frequencia,
              distancia_total: realtimeKpi.distancia_total ?? computedRow.distancia_total,
            },
            contextText
          );
        }
        if (realtimeKpi) {
          return showRow(realtimeKpi, contextText);
        }
        if (hasRouteData && computedRow) {
          return showRow(computedRow, contextText);
        }
      }
      if (selectedCategory && selectedCategory !== CATEGORY_FILTER_ALL) {
        const categoryKpi = await fetchCategoryKpi(selectedCategory, force);
        if (categoryKpi) {
          return showRow(categoryKpi, buildCategoryContext(selectedCategory) || { text: selectedCategory });
        }
      } else {
        const globalKpi = await fetchCategoryKpi("global", force);
        if (globalKpi) {
          return showRow(globalKpi, buildFloatingContext());
        }
      }
      if (computedRow && !isGlobalMode) {
        return showRow(computedRow, buildFloatingContext());
      }
      const data = await fetchCategoryKpis(force);
      const row = findCategoryRow(data, selectedCategory);
      return showRow(row, buildFloatingContext());
    }

    function handleRouteInputCommit() {
      if (!routeInput) return;
      const focusCleared = routeInput.dataset.focusCleared === "true";
      routeInput.dataset.focusCleared = "false";
      if (routePreview) routePreview.classList.add("hidden");
      const value = routeInput.value || "";
      const trimmedValue = value.trim();
      if (!trimmedValue && focusCleared) {
        const prevRoute = routeInput.dataset.previousRoute || selectedRoute || ROUTE_FILTER_ALL;
        selectedRoute = prevRoute;
        syncRouteInputValue();
        return;
      }
      const resolved = resolveRouteInputValue(value);
      selectedRoute = resolved;
      clearCategoryFilter();
      if (resolved === ROUTE_FILTER_ALL) {
        routeInput.value = ROUTE_GLOBAL_LABEL;
      } else {
        routeInput.value = routeLabelById.get(resolved) || value;
      }
      selectedVariant = VARIANT_FILTER_ALL;
      updateVariantOptions();
      renderVehicles();
      refreshRouteOverlay(true).catch(() => {});
      refreshGlobalStops(true).catch(() => {});
      refreshCharts(true).catch(() => {});
      refreshKpis(true);
      updateRouteClearVisibility();
      renderSelectedRoutePill();
      updateRouteChartHintVisibility();
      routeInputWrapper?.classList.remove("input-focused");
    }

    function resolveRouteInputValue(raw) {
      const value = (raw || "").trim();
      if (!value || value.toLowerCase() === ROUTE_GLOBAL_LABEL.toLowerCase()) {
        return ROUTE_FILTER_ALL;
      }
      const lower = value.toLowerCase();
      if (routeLabelLookup.has(lower)) {
        return routeLabelLookup.get(lower);
      }
      if (routeOptions.has(value)) return value;
      for (const [baseId, data] of routeOptions.entries()) {
        const label = (data.label || "").toLowerCase();
        if (label && label === lower) return baseId;
      }
      return ROUTE_FILTER_ALL;
    }

    function syncRouteInputValue() {
      if (!routeInput) return;
      if (selectedRoute === ROUTE_FILTER_ALL) {
        routeInput.value = ROUTE_GLOBAL_LABEL;
      } else {
        routeInput.value = routeLabelById.get(selectedRoute) || selectedRoute;
      }
    }

    function updateVariantOptions() {
      if (!variantSelect || !variantGroup) return;
      variantSelect.innerHTML = "";
      variantSelect.appendChild(new Option("Todas as variantes", VARIANT_FILTER_ALL));
      variantSelect.value = VARIANT_FILTER_ALL;
      if (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) {
        variantGroup.classList.add("hidden");
        selectedVariant = VARIANT_FILTER_ALL;
        return;
      }
      const entry = routeOptions.get(selectedRoute);
      if (!entry) {
        variantGroup.classList.add("hidden");
        selectedVariant = VARIANT_FILTER_ALL;
        return;
      }
      const variantEntries = entry.variants ? Array.from(entry.variants.entries()) : [];
      if (variantEntries.length === 0) {
        variantGroup.classList.add("hidden");
        selectedVariant = VARIANT_FILTER_ALL;
        return;
      }
      if (variantEntries.length === 1) {
        variantGroup.classList.add("hidden");
        selectedVariant = variantEntries[0][0];
        return;
      }
      variantEntries.sort((a, b) => a[1].localeCompare(b[1], "pt-PT", { numeric: true, sensitivity: "base" }));
      variantEntries.forEach(([value, label]) => {
        variantSelect.appendChild(new Option(label, value));
      });
      const hasSelected = variantEntries.some(([value]) => value === selectedVariant);
      if (hasSelected) {
        variantSelect.value = selectedVariant;
      } else {
        selectedVariant = VARIANT_FILTER_ALL;
        variantSelect.value = VARIANT_FILTER_ALL;
      }
      variantGroup.classList.remove("hidden");
    }

    function normalizeOptionKey(value) {
      return normalizeRouteKey(value);
    }

    function updateRouteOptionsFromVehicles(list) {
      let dirty = false;
      list.forEach(v => {
        const variantId = normalizeOptionKey(v.routeId || v.routeLabel);
        if (!variantId) return;
        const baseId = getBaseRouteKey(variantId);
        if (!baseId) return;
        const routeCategory = v.categoryResolved || v.category;
        if (registerRoute(baseId, variantId, { label: v.routeLabel, category: routeCategory })) dirty = true;
      });
      if (dirty) {
        rebuildRouteSuggestions();
        updateVariantOptions();
        refreshRouteTaxonomy();
      }
    }

    function rebuildRouteSuggestions() {
      if (!routeDatalist) return;
      const entries = [];
      routeOptions.forEach((data, baseId) => {
        const label = data.label || baseId;
        const baseLabel = data.label || baseId;
        entries.push({ id: baseId, label: baseLabel });
      });
      const collator = new Intl.Collator("pt-PT", { numeric: true, sensitivity: "base" });
      entries.sort((a, b) => collator.compare(a.label || a.id, b.label || b.id));

      routeDatalist.innerHTML = "";
      routeLabelById.clear();
      routeLabelLookup.clear();
      routeLabelById.set(ROUTE_FILTER_ALL, ROUTE_GLOBAL_LABEL);
      routeLabelLookup.set(ROUTE_GLOBAL_LABEL.toLowerCase(), ROUTE_FILTER_ALL);

      const seenLabels = new Set();
      entries.forEach(({ id, label }) => {
        const text = ((label || id) ?? "").trim();
        if (!text) return;
        const key = text.toLowerCase();
        if (!seenLabels.has(key)) {
          const option = document.createElement("option");
          option.value = text;
          routeDatalist.appendChild(option);
          seenLabels.add(key);
        }
        routeLabelById.set(id, text);
        if (!routeLabelLookup.has(key)) {
          routeLabelLookup.set(key, id);
        }
      });
      if (floatingSearch && floatingSearch.classList.contains("visible")) {
        renderFloatingRoutePreview(floatingRouteInput?.value || "");
      }
      renderRoutePreview(routeInput?.value || "");
    }

    function translateRoute(routeId) {
      const raw = normalizeRouteKey(routeId);
      if (!raw) return "";
      const base = getBaseRouteKey(raw);
      // Only use GTFS metadata/translator for variant-like ids (e.g., 728_0); keep base ids untouched.
      const isVariantId = raw.includes("_");
      if (isVariantId) {
        const metaVariant = raw ? ROUTE_DETAILS.get(raw) : null;
        if (metaVariant?.shortName) return metaVariant.shortName;
        const metaBase = base ? ROUTE_DETAILS.get(`${base}_0`) || BASE_ROUTE_DETAILS.get(base) : null;
        if (metaBase?.shortName) return metaBase.shortName;
        if (ROUTE_TRANSLATOR.byId[raw]) return ROUTE_TRANSLATOR.byId[raw];
        const alt0 = `${base}_0`;
        const alt1 = `${base}_1`;
        if (ROUTE_TRANSLATOR.byId[alt0]) return ROUTE_TRANSLATOR.byId[alt0];
        if (ROUTE_TRANSLATOR.byId[alt1]) return ROUTE_TRANSLATOR.byId[alt1];
        if (ROUTE_TRANSLATOR.base[base]) return ROUTE_TRANSLATOR.base[base];
      }
      return raw;
    }

    function parseRouteCodeParts(routeIdOrName) {
      const rawLabel = String(routeIdOrName ?? "").trim();
      const normalizedInput = normalizeRouteKey(rawLabel);
      // Preferir cdigo que aparea no incio do texto (antes de espaos/pontuao) para no capturar letras da descrio.
      const leading = rawLabel.match(/^\s*([0-9]{1,3}[A-Z]?)(?=[^0-9A-Z]|$)/i);
      if (leading) {
        const code = leading[1].toUpperCase();
        const digits = code.match(/(\d{1,3})/);
        const codeBase = (/^\d{3}[01]$/.test(code)) ? code.slice(0, 3) : (digits ? digits[1] : code);
        return { code, codeBase };
      }
      // If already parece um cdigo curto (ex.: "208", "35B") e sem sufixo, no deixar metadata/tradutor interferir.
      if (normalizedInput && !normalizedInput.includes("_")) {
        const simpleMatch = normalizedInput.match(/^([0-9]{1,3}[A-Z]?)/i);
        if (simpleMatch && simpleMatch[0].length === normalizedInput.length) {
          const code = simpleMatch[1].toUpperCase();
          const digits = code.match(/(\d{1,3})/);
          const codeBase = (code.match(/^\d{3}[01]$/)) ? code.slice(0, 3) : (digits ? digits[1] : code);
          return { code, codeBase };
        }
      }
      const base = getBaseRouteKey(normalizedInput);
      const metaVariant = normalizedInput ? ROUTE_DETAILS.get(normalizedInput) : null;
      const metaBase = base ? BASE_ROUTE_DETAILS.get(base) : null;
      const translated = translateRoute(normalizedInput || base);
      const metaShort = (metaVariant?.shortName || metaBase?.shortName || "").trim();
      const fallback = routeIdOrName != null ? String(routeIdOrName) : "";
      const candidate = (metaShort || translated || fallback).toUpperCase();
      const normalizedCandidate = candidate.replace(/[^A-Z0-9]/g, "");
      const match = normalizedCandidate.match(/(\d{1,3}[A-Z]?)/); // allow codes that are not at the start of the string
      const code = match ? match[1] : normalizedCandidate;
      const codeBase = (() => {
        if (/^\d{3}[01]$/.test(code)) return code.slice(0, 3);
        const digits = code.match(/(\d{1,3})/);
        return digits ? digits[1] : code;
      })();
      return { code, codeBase };
    }

    function careerCodeFromLabel(label) {
      const text = (label || "").trim();
      if (!text) return { code: "", codeBase: "" };
      // Try leading code first (fast path).
      let match = text.match(/^\s*(\d{2,3}[A-Z]?)/);
      if (!match) {
        // Fallback: find the first occurrence anywhere in the string.
        match = text.match(/(\d{2,3}[A-Z]?)/);
      }
      if (!match) return { code: "", codeBase: "" };
      const code = match[1].toUpperCase();
      const digits = code.match(/^\d{2,3}/)?.[0] || code;
      return { code, codeBase: digits };
    }

    function definirCategoria(routeIdOrName) {
      const raw = normalizeRouteKey(routeIdOrName);
      const resolvedLabel = raw.includes("_") ? (resolvePublicRouteLabel(raw) || raw) : raw;
      const { code, codeBase } = careerCodeFromLabel(resolvedLabel);
      if (code.match(/^2\d{2}$/)) return "Rede Madrugada";
      if (code.endsWith("E")) return "Eltricos";
      if (code.endsWith("B")) return "Carreiras de Bairro";
      return "Autocarros Diurnos";
    }

    function definirZona(routeIdOrName) {
      const { code, codeBase } = parseRouteCodeParts(routeIdOrName);
      if (!code && !codeBase) return null;
      if (code.endsWith("B")) return "Bairro";
      if (ZONE_ROUTE_BASES.Madrugada.has(codeBase)) return "Madrugada";
      for (const [zone, routes] of Object.entries(ZONE_ROUTE_BASES)) {
        if (routes.has(code) || routes.has(codeBase)) return zone;
      }
      return null;
    }

    function getZoneColor(zoneName) {
      return ZONE_COLOR_BY_NAME[zoneName] || null;
    }

    function vehicleIconMarkup(style) {
      return `<div class="veh-marker" style="--c:${style.color}">
        <div class="veh-pin"></div>
        <i class="fa ${style.icon} veh-icon"></i>
      </div>`;
    }

    function stripRouteCodeFromLabel(label) {
      const text = (label || "").trim();
      if (!text) return "";
      const { code } = parseRouteCodeParts(text);
      if (!code) return text;
      const pattern = new RegExp(`^${escapeRegex(code)}\\s*[-:]?\\s*`, "i");
      if (!pattern.test(text)) return text;
      const cleaned = text.replace(pattern, "").trim();
      if (!cleaned && text.replace(/\s+/g, "").toUpperCase() === code.toUpperCase()) return "";
      return cleaned || text;
    }

    function popupHtml(v, style) {
      const label = v.routeLabel || v.linha || "";
      const dirId = getDirectionId(v);
      const dirLabel = directionDisplayLabel(v?.routeId || v?.linha || "", dirId);
      const { code } = parseRouteCodeParts(label);
      const zoneInfo = resolveRouteZone(label);
      const headerColor = zoneInfo.color || style.color;
      const headerFg = readableTextColor(headerColor, "#ffffff");
      const safeLabel = escapeHtml(label);
      const titleText = stripRouteCodeFromLabel(label);
      const safeTitle = escapeHtml(titleText || "");
      const safeDirLabel = dirLabel ? escapeHtml(dirLabel) : "";
      const pill = `<span class="route-pill route-pill--clickable popup-route-link" data-route-label="${safeLabel}" title="Filtrar pela carreira" style="--pill-bg:${headerFg === '#0f172a' ? '#ffffff' : 'rgba(255,255,255,0.14)'};--pill-fg:${headerFg};--pill-border:rgba(255,255,255,0.18)">${escapeHtml(code || label)}</span>`;
      const rawVehicleId = v.id ?? v.vehicleId ?? v.vehicle ?? v.id_veiculo ?? "";
      const normalizedVehicleId = (rawVehicleId == null) ? "" : String(rawVehicleId).trim().replace(/^#/, "");
      const vehicleIdLabel = normalizedVehicleId ? `#${normalizedVehicleId}` : "";
      const fleetModel = fleetModelLabelForId(normalizedVehicleId);
      const fallbackModel = (v.modelo || v.model || v.vehicle_model || v.tipo || v.type || "").trim();
      const modelLabel = fleetModel || fallbackModel;
      const safeVehicleIdLabel = escapeHtml(vehicleIdLabel);
      const safeVehicleInfo = modelLabel ? `${safeVehicleIdLabel} - ${escapeHtml(modelLabel)}` : safeVehicleIdLabel;
      const chapaDisplay = v.chapa || v.plate || "";
      const safeChapa = escapeHtml(chapaDisplay);
      return `
        <div class="pop-header" style="background-color: ${headerColor}; color:${headerFg}">
          <div class="pop-header__left">
            ${pill}
            <span class="pop-title" title="${safeTitle}">${safeTitle}</span>
          </div>
        </div>
        <div class="pop-body">
          <div class="pop-body__info">
            <span><b>Veculo:</b> ${safeVehicleInfo}</span>
          </div>
          ${safeDirLabel ? `<div style="margin-bottom:4px"><b>${safeDirLabel}</b></div>` : ""}
          <div style="margin-bottom:4px"><b>Chapa:</b> ${safeChapa}</div>
        </div>
      `;
    }

    function normalizeCoordinates(v) {
      const position = v?.position || v?.posicao || {};
      const lat = parseFloat(v.lat ?? v.latitude ?? position.lat ?? position.latitude);
      const lon = parseFloat(v.lon ?? v.longitude ?? position.lon ?? position.longitude);
      if (Number.isFinite(lat) && Number.isFinite(lon)) return [lon, lat];
      return null;
    }

    function normalizeTimestampSeconds(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return NaN;
      if (num > 1e12) return num / 1000;
      if (num > 1e10) return num / 1000;
      return num;
    }

    function mapSafePadding() {
      const mapEl = document.getElementById("map");
      const mapWidth = mapEl?.clientWidth || 0;
      const sidebar = document.getElementById("sidebar");
      const sidebarVisible = sidebar && sidebar.offsetParent !== null && !document.body.classList.contains("sidebar-collapsed");
      const sidebarWidth = sidebarVisible ? (sidebar.getBoundingClientRect().width || 0) : 0;
      const floating = document.querySelector(".kpi-floating-context");
      const floatingWidth = floating?.offsetWidth || 0;
      const left = Math.min(Math.max(260, sidebarWidth + 24), Math.max(mapWidth - 120, 320));
      const right = Math.max(24, floatingWidth + 24);
      return { top: 20, bottom: 28, left, right };
    }

    function isMobilePopupViewport(width = null) {
      const fallbackWidth = (typeof window !== "undefined" ? window.innerWidth : NaN);
      const candidate = Number.isFinite(width) ? width : fallbackWidth;
      return Number.isFinite(candidate) && candidate <= MOBILE_POPUP_BREAKPOINT;
    }

    function popupPanOptions() {
      const pad = mapSafePadding();
      const autoPanEnabled = !isMobilePopupViewport();
      return {
        className: "custom-popup",
        autoPan: autoPanEnabled,
        autoPanPaddingTopLeft: [pad.left, pad.top],
        autoPanPaddingBottomRight: [pad.right, pad.bottom]
      };
    }

    function ensurePopupVisible(lngLat, mapInstance) {
      const map = mapInstance || (adapter && adapter.map);
      if (!map || typeof map.project !== "function") return;
      if (isMobilePopupViewport()) return;
      const container = map.getContainer?.();
      if (!container) return;
      const pad = mapSafePadding();
      const pt = map.project(lngLat);
      const minX = pad.left;
      const maxX = container.clientWidth - pad.right;
      const minY = pad.top;
      const maxY = container.clientHeight - pad.bottom;
      let dx = 0;
      let dy = 0;
      if (pt.x < minX) dx = minX - pt.x;
      else if (pt.x > maxX) dx = maxX - pt.x;
      if (pt.y < minY) dy = minY - pt.y;
      else if (pt.y > maxY) dy = maxY - pt.y;
      if (dx !== 0 || dy !== 0) {
        try {
          map.panBy([dx, dy], { duration: 260 });
        } catch (e) {}
      }
    }

    function resolveRouteId(vehicle) {
      return vehicle?.routeId ?? vehicle?.route_id ?? vehicle?.route ?? vehicle?.linha ?? vehicle?.line ?? "";
    }

    function decorateVehicle(vehicle) {
      if (!vehicle) return vehicle;
      const enriched = { ...vehicle };
      const chapaEntry = getVehicleChapaEntryById(
        enriched.id ?? enriched.vehicleId ?? enriched.vehicle ?? enriched.vehicle_id ?? enriched.id_veiculo ?? ""
      );
      if (chapaEntry) {
        enriched.plate = chapaEntry.plate;
        enriched.chapa = chapaEntry.chapa;
      } else {
        const fallbackPlate = enriched.plate ?? enriched.placa ?? enriched.vehicle_plate ?? enriched.vehiclePlate ?? "";
        if (fallbackPlate) {
          enriched.plate = fallbackPlate;
          enriched.chapa = enriched.chapa || parsePlateChapa(fallbackPlate);
        }
      }
      const routeRaw = normalizeRouteKey(resolveRouteId(vehicle));
      const label = resolvePublicRouteLabel(routeRaw || vehicle.linha);
      const category = definirCategoria(label || routeRaw || vehicle.category);
      enriched.routeId = routeRaw;
      enriched.routeLabel = label || routeRaw;
      enriched.linha = enriched.routeLabel || enriched.linha || "";
      enriched.categoryResolved = category;
      enriched.category = category;
      const zone = definirZona(routeRaw || label || vehicle.zone);
      enriched.zone = zone || "";
      enriched.zoneColor = getZoneColor(zone) || "";
      return enriched;
    }

    function featureToVehicle(feature, index) {
      if (!feature || feature.type !== "Feature") return null;
      const geom = feature.geometry;
      if (!geom) return null;

      let coords = geom.coordinates;
      if (geom.type !== "Point" && Array.isArray(coords) && Array.isArray(coords[0])) coords = coords[0];
      if (!Array.isArray(coords) || coords.length < 2) return null;

      const lat = Number(coords[1]);
      const lon = Number(coords[0]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

      const props = feature.properties || {};
      const fallbackId = `offline-${index}`;
      const rawId = props.id_veiculo ?? props.id ?? props.vehicle_id ?? fallbackId;
      const toNumber = (value, fallback = 0) => {
        const num = Number(value);
        return Number.isFinite(num) ? num : fallback;
      };
      const routeId = props.route_id ?? props.route ?? props.linha ?? props.line ?? "";
      const tsValue = props.timestamp ?? props.ts ?? props.time ?? Date.now();
      const directionRaw = props.directionId ?? props.direction_id ?? props.direction ?? props.sentido ?? null;
      const directionId = (() => {
        const parsed = Number.parseInt(String(directionRaw), 10);
        return Number.isFinite(parsed) ? parsed : null;
      })();

      return {
        id: String(rawId),
        lat,
        lon,
        linha: routeId,
        routeId,
        directionId,
        bearing: toNumber(props.heading ?? props.bearing ?? props.azimuth ?? props.course ?? 0, 0),
        speed: toNumber(props.velocidade ?? props.speed ?? props.velocity ?? 0, 0),
        category: props.category ?? props.tipo ?? "",
        ts: tsValue
      };
    }

    async function loadOfflineVehicles() {
      if (offlineVehiclesCache) return offlineVehiclesCache;
      try {
        const response = await fetch(OFFLINE_VEHICLES_URL, withNgrokBypass());
        if (!response.ok) throw new Error("404");
        const data = await response.json();
        const features = Array.isArray(data?.features) ? data.features : [];
        offlineVehiclesCache = features.map(featureToVehicle).filter(Boolean);
      } catch (e) {
        offlineVehiclesCache = VEHICLES_MOCK;
      }
      return offlineVehiclesCache || VEHICLES_MOCK;
    }

    const CATEGORY_PALETTES = {
      // Requested: stronger contrast on Bus + Bairro; keep the same "family" as the Python palette.
      "Autocarros Diurnos": { color0: "#2ecc71", color1: "#0b5d38", icon: "fa-bus" },
      "Carreiras de Bairro": { color0: "#c084fc", color1: "#4c1d95", icon: "fa-home" },
      "Eltricos": { color0: "#f39c12", color1: "#ff6b6b", icon: "fa-train" },
      "Rede Madrugada": { color0: "#3498db", color1: "#2c3e90", icon: "fa-moon-o" }
    };
    const DEFAULT_CATEGORY_STYLE = CATEGORY_PALETTES["Autocarros Diurnos"];

    const DIRECTION_PALETTE = {
      0: { label: "Sentido 0" },
      1: { label: "Sentido 1" },
      unknown: { label: "Sentido " }
    };

    function inferDirectionFromRouteId(routeId) {
      const raw = (routeId == null) ? "" : String(routeId).trim();
      if (!raw) return null;
      const parts = raw.split("_");
      if (parts.length >= 2) {
        const maybeDir = Number.parseInt(parts[1], 10);
        if (maybeDir === 0 || maybeDir === 1) return maybeDir;
      }
      return null;
    }

    function splitRouteDestinations(longName) {
      const text = (longName || "").trim();
      if (!text) return null;
      const parts = text.split(/\s*[-]\s*/g).map(s => s.trim()).filter(Boolean);
      if (parts.length >= 2) return [parts[0], parts[1]];
      return null;
    }

    function normalizeDirectionForDisplay(directionId) {
      if (!(directionId === 0 || directionId === 1)) return directionId;
      // Requested: destinations are switched; invert mapping.
      return directionId === 0 ? 1 : 0;
    }

    function directionDisplayLabel(routeId, directionId) {
      if (!(directionId === 0 || directionId === 1)) return "";
      const normalized = normalizeOptionKey(routeId);
      const base = getBaseRouteKey(normalized);
      const meta = (normalized && ROUTE_DETAILS.get(normalized))
        || (base && BASE_ROUTE_DETAILS.get(base))
        || (base && ROUTE_DETAILS.get(`${base}_0`))
        || null;
      const pair = splitRouteDestinations(meta?.longName || "");
      if (!pair) return "Sentido: ";
      const idx = normalizeDirectionForDisplay(directionId) === 0 ? 0 : 1;
      const dest = pair[idx];
      const text = (dest || "").trim();
      return `Sentido: ${text || ""}`;
    }

    function getDirectionId(vehicle) {
      const raw = vehicle?.directionId ?? vehicle?.direction_id ?? vehicle?.direction;
      const parsed = Number.parseInt(String(raw), 10);
      if (parsed === 0 || parsed === 1) return parsed;
      // Some feeds encode direction in the route id itself (e.g. `170_0` / `170_1`)
      return inferDirectionFromRouteId(vehicle?.routeId ?? vehicle?.linha ?? "");
    }

	    function pickCategoryStyle(category, directionId, { allowDirection = false } = {}) {
	      const palette = CATEGORY_PALETTES[category] || DEFAULT_CATEGORY_STYLE;
	      const effectiveDir = (directionId === 0 || directionId === 1) ? directionId : 0;
	      const dir = allowDirection ? effectiveDir : 0;
	      return {
	        icon: palette.icon,
	        color: (dir === 1 ? (palette.color1 || palette.color0) : palette.color0),
	      };
	    }

    function getStyle(vehicle) {
      const cat = vehicle?.categoryResolved || vehicle?.category;
      const dirId = getDirectionId(vehicle);
      const allowDirection = Boolean(selectedRoute && selectedRoute !== ROUTE_FILTER_ALL);
      return pickCategoryStyle(cat, dirId, { allowDirection });
    }

    // --- LEAFLET ADAPTER ---
    class LeafletAdapter {
      constructor() {
        this.map = L.map('map', { zoomControl: false, preferCanvas: true, inertia: true }).setView(MAP_CENTER, MAP_ZOOM);
        this.markers = new Map();
        this.overlayGroup = L.layerGroup().addTo(this.map);
        this.routeShapesLayer = L.layerGroup().addTo(this.overlayGroup);
        this.routeStopsLayer = L.layerGroup().addTo(this.overlayGroup);
        this.userLocationMarker = null;
        this.userLocationAccuracy = null;
        this.isInteracting = false;
        this._interactionTimeout = null;
        this.animationDuration = Math.max(300, Math.min(ANIMATION_MS, REFRESH_RATE_MS - 150));
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OSM &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 19,
          detectRetina: true,
          updateWhenIdle: true,
          updateWhenZooming: false,
          keepBuffer: 4
        }).addTo(this.map);

        const clearInteraction = () => {
          this.isInteracting = false;
          const container = this.map.getContainer?.();
          if (container) container.classList.remove("map-interacting");
          document.body?.classList?.remove?.("map-interacting");
          this.clearAllTransitions();
        };

        const scheduleInteractionRelease = () => {
          if (this._interactionTimeout) clearTimeout(this._interactionTimeout);
          this._interactionTimeout = setTimeout(clearInteraction, 1200);
        };

        const startInteraction = () => {
          this.isInteracting = true;
          const container = this.map.getContainer?.();
          if (container) container.classList.add("map-interacting");
          document.body?.classList?.add?.("map-interacting");
          this.clearAllTransitions();
          scheduleInteractionRelease();
        };
        const endInteraction = () => {
          if (this._interactionTimeout) clearTimeout(this._interactionTimeout);
          clearInteraction();
        };
        this.map.on("zoomstart movestart dragstart", startInteraction);
        this.map.on("zoomend moveend dragend", endInteraction);

        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css';
        document.head.appendChild(link);
      }

      clearAllTransitions() {
        for (const entry of this.markers.values()) {
          if (entry?.transitionTimer) {
            clearTimeout(entry.transitionTimer);
            entry.transitionTimer = null;
          }
          const el = entry?.marker?.getElement?.();
          if (el) {
            el.classList.remove("veh-animating");
            el.style.removeProperty("--veh-move-ms");
          }
        }
      }

      slideMarkerTo(entry, lat, lon) {
        if (!entry?.marker) return;
        const marker = entry.marker;
        const el = marker.getElement?.();
        if (!el || this.isInteracting || this.animationDuration <= 0) {
          marker.setLatLng([lat, lon]);
          return;
        }

        if (entry.transitionTimer) {
          clearTimeout(entry.transitionTimer);
          entry.transitionTimer = null;
        }

        el.style.setProperty("--veh-move-ms", `${this.animationDuration}ms`);
        el.classList.add("veh-animating");
        // Defer the position update so the transition can apply.
        requestAnimationFrame(() => marker.setLatLng([lat, lon]));
        entry.transitionTimer = setTimeout(() => {
          const el2 = marker.getElement?.();
          if (el2) {
            el2.classList.remove("veh-animating");
            el2.style.removeProperty("--veh-move-ms");
          }
          entry.transitionTimer = null;
        }, this.animationDuration + 80);
      }

      setShapes(geojson) {
        if (this.shapesLayer) this.map.removeLayer(this.shapesLayer);
        this.shapesLayer = L.geoJSON(geojson || SHAPES_MOCK, {
          style: { color: "#3498db", weight: 4, opacity: 0.5 }
        }).addTo(this.routeShapesLayer);
      }

      clearOverlay() {
        this.routeShapesLayer?.clearLayers?.();
        this.routeStopsLayer?.clearLayers?.();
      }

      setUserLocation(coords, { center = false, accuracy = 0 } = {}) {
        if (!this.map || !coords || coords.length < 2) return;
        const [lat, lon] = coords;
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const radius = Number.isFinite(accuracy) ? Math.max(accuracy, 20) : 60;
        if (this.userLocationAccuracy) {
          this.userLocationAccuracy.setLatLng([lat, lon]);
          this.userLocationAccuracy.setRadius(radius);
        } else {
          this.userLocationAccuracy = L.circle([lat, lon], {
            radius,
            color: "rgba(59, 130, 246, 0.25)",
            fillColor: "rgba(59, 130, 246, 0.15)",
            weight: 0
          }).addTo(this.map);
        }
        if (this.userLocationMarker) {
          this.userLocationMarker.setLatLng([lat, lon]);
        } else {
          this.userLocationMarker = L.circleMarker([lat, lon], {
            radius: 7,
            color: "#3b82f6",
            weight: 2,
            fillColor: "#1d4ed8",
            fillOpacity: 0.95
          }).addTo(this.map);
        }
        if (center) {
          try {
            this.map.flyTo([lat, lon], Math.max(this.map.getZoom(), 13), { duration: 0.9, essential: true });
          } catch (e) {}
        }
      }

      clearUserLocation() {
        if (this.userLocationMarker) {
          this.userLocationMarker.remove();
          this.userLocationMarker = null;
        }
        if (this.userLocationAccuracy) {
          this.userLocationAccuracy.remove();
          this.userLocationAccuracy = null;
        }
      }

      setRouteOverlay(payload, { fit = false } = {}) {
        this.clearOverlay();
        if (!payload) return;

        const boundsLayers = [];
        const segments = buildShapeSegments(payload?.shapes);
        const shapes = Array.isArray(payload.shapes) ? payload.shapes : [];
        for (const item of shapes) {
          const geojson = item?.geojson;
          if (!geojson || !geojson.type) continue;
          const color = item?.color || "#3498db";
          const lyr = L.geoJSON(geojson, {
            style: { color, weight: 5, opacity: 0.65 }
          });
          lyr.addTo(this.routeShapesLayer);
          boundsLayers.push(lyr);
        }

        const stops = Array.isArray(payload.stops) ? payload.stops : [];
        for (const s of stops) {
          const lat = Number(s?.stop_lat);
          const lon = Number(s?.stop_lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
          const arrowColor = s?.color || "#3498db";
          const fallbackAngle = Number(s?.direction_angle);
          const alignedAngle = closestSegmentAngleForPoint(lat, lon, segments, fallbackAngle);
          const iconHtml = `<div class="stop-marker stop--hidden" style="--stop-border:${arrowColor}; --stop-arrow:${arrowColor}; --stop-ang:${alignedAngle}deg"><span class="stop-arrow"></span></div>`;
          const icon = L.divIcon({ html: iconHtml, className: "stop-fade", iconSize: [1, 1], iconAnchor: [0, 0] });
          const stopName = s.stop_name || "Paragem";
          const stopId = s.stop_id || "";
          const schedState = initialScheduleStateForContext();
          const marker = L.marker([lat, lon], { icon }).bindPopup(
            stopPopupHtml({ stopName, stopId, loading: true, schedule: schedState }),
            { ...popupPanOptions(), maxWidth: 320 }
          );
          marker.on("add", () => {
            const el = marker.getElement?.();
            const inner = el?.querySelector?.(".stop-marker");
            if (!inner) return;
            requestAnimationFrame(() => requestAnimationFrame(() => {
              try { inner.getBoundingClientRect(); } catch (e) {}
              inner.classList.remove("stop--hidden");
              inner.classList.add("stop--shown");
            }));
          });
          marker.on("popupopen", async () => {
            await hydrateStopPopup(marker, { stopId, stopName });
          });
          marker.on("popupclose", () => { hideMobileStopCard(); activeStopPopup = null; });
          marker.addTo(this.routeStopsLayer);
          boundsLayers.push(marker);
        }

        if (fit && boundsLayers.length) {
          try {
            const group = L.featureGroup(boundsLayers);
            const bounds = group.getBounds();
            if (bounds && bounds.isValid && bounds.isValid()) {
              this.map.fitBounds(bounds, { padding: [36, 36] });
            }
          } catch (e) {}
        }
      }

      makeDivIcon(style) {
        return L.divIcon({
          html: vehicleIconMarkup(style),
          className: "",
          iconSize: [34, 42],
          iconAnchor: [17, 42],
          popupAnchor: [0, -36]
        });
      }

      applyStyleToMarker(entry, style) {
        if (!entry?.marker || !style) return;
        const el = entry.marker.getElement?.();
        if (!el) return;
        const inner = el.querySelector?.('.veh-marker');
        if (inner) {
          inner.style.setProperty("--c", style.color);
          const icon = inner.querySelector?.('.veh-icon');
          if (icon) icon.className = `fa ${style.icon} veh-icon`;
        }
      }

      updateVehicles(vehicleList) {
        const EPS = 1e-7;
        const activeIDs = new Set();
        vehicleList.forEach(v => {
          if (!v || v.id == null) return;
          const coords = normalizeCoordinates(v);
          if (!coords) return;
          const [lon, lat] = coords;
          const style = getStyle(v);
          const vid = String(v.id);
          activeIDs.add(vid);
          const serverTsSec = normalizeTimestampSeconds(v.ts ?? v.timestamp ?? v.time ?? Date.now());

          let entry = this.markers.get(vid);
          if (!entry) {
            const marker = L.marker([lat, lon], {
              icon: this.makeDivIcon(style),
              riseOnHover: true,
              keyboard: false
            }).addTo(this.map);
            marker.bindPopup(popupHtml(v, style), popupPanOptions());
            marker.on("popupopen", () => {
              const current = this.markers.get(vid);
              if (current?.data) {
                prewarmRouteOverlayForVehicle(current.data).catch(() => {});
              }
            });
            entry = {
              marker,
              styleKey: `${style.color}|${style.icon}`,
              lat,
              lon,
              serverTsSec,
              lastServerTsSec: serverTsSec,
              transitionTimer: null
            };
            this.markers.set(vid, entry);
          } else {
            const prevTs = entry.lastServerTsSec;
            const hasNewTs = Number.isFinite(serverTsSec) && (!Number.isFinite(prevTs) || serverTsSec > prevTs);
            const coordsChanged = !Number.isFinite(entry.lon) || !Number.isFinite(entry.lat) ||
              Math.abs(entry.lon - lon) > EPS || Math.abs(entry.lat - lat) > EPS;
            if (hasNewTs || coordsChanged) {
              entry.lastServerTsSec = serverTsSec;
              entry.serverTsSec = serverTsSec;
              entry.lat = lat;
              entry.lon = lon;
              this.slideMarkerTo(entry, lat, lon);
            }
            const nextStyleKey = `${style.color}|${style.icon}`;
            if (entry.styleKey !== nextStyleKey) {
              entry.styleKey = nextStyleKey;
              this.applyStyleToMarker(entry, style);
              entry.marker.setPopupContent(popupHtml(v, style));
            }
            if (entry.marker.isPopupOpen()) {
              entry.marker.setPopupContent(popupHtml(v, style));
            }
          }
          entry.data = v;
        });

        for (const [vid, entry] of this.markers.entries()) {
          if (!activeIDs.has(vid)) {
            if (entry?.transitionTimer) clearTimeout(entry.transitionTimer);
            entry.marker.remove();
            this.markers.delete(vid);
          }
        }
        return activeIDs.size;
      }

      setVisibleIds(visibleIds) {
        let count = 0;
        for (const [vid, entry] of this.markers.entries()) {
          const el = entry?.marker?.getElement?.();
          if (!el) continue;
          const shouldShow = visibleIds.has(vid);
          el.style.display = shouldShow ? "" : "none";
          if (shouldShow) count += 1;
        }
        return count;
      }
    }

    // --- MAPLIBRE ADAPTER (Principal) ---
    class MapLibreAdapter {
      constructor() {
        this.map = null;
        this.markers = new Map();
        this.isInteracting = false;
        this._interactionTimeout = null;
        this.animationDuration = Math.max(300, Math.min(ANIMATION_MS, REFRESH_RATE_MS - 150));
        this.visualTickMs = 1000;
        this.visualIntervalId = null;
        this.overlaySourceId = "route-overlay";
        this.overlayReady = false;
        this.routeOverlayFeatures = [];
        this.globalStopFeatures = [];
        this.userLocationSourceId = "user-location-source";
        this.userLocationLayerId = "user-location-layer";
        this.userLocationAccuracyLayerId = "user-location-accuracy-layer";
        this._lastRouteStopsCount = 0;
        this._lastGlobalStopsCount = 0;
        this.activePopups = [];
        this._stopPieCache = new Map();
        this._stopRoutesInflight = new Set();
        this.globalStopTilesEnabled = false;
        this.ready = this.init();
      }

	      async init() {
        this.map = new maplibregl.Map({
          container: "map",
          style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json ",
          center: [MAP_CENTER[1], MAP_CENTER[0]],
          zoom: MAP_ZOOM,
          attributionControl: false
        });
        await new Promise(resolve => this.map.once("load", resolve));
        this.initOverlayLayers();

        const clearInteraction = () => {
          this.isInteracting = false;
          const container = this.map.getContainer?.();
          if (container) container.classList.remove("map-interacting");
          document.body?.classList?.remove?.("map-interacting");
          this.clearAllTransitions();
        };

        const scheduleInteractionRelease = () => {
          if (this._interactionTimeout) clearTimeout(this._interactionTimeout);
          this._interactionTimeout = setTimeout(clearInteraction, 1200);
        };

        const startInteraction = () => {
          this.isInteracting = true;
          const container = this.map.getContainer?.();
          if (container) container.classList.add("map-interacting");
          document.body?.classList?.add?.("map-interacting");
          this.clearAllTransitions();
          scheduleInteractionRelease();
        };
        const endInteraction = () => {
          if (this._interactionTimeout) clearTimeout(this._interactionTimeout);
          clearInteraction();
        };
        this.map.on("zoomstart", startInteraction);
        this.map.on("movestart", startInteraction);
        this.map.on("dragstart", startInteraction);
        this.map.on("zoomend", endInteraction);
        this.map.on("moveend", endInteraction);
        this.map.on("dragend", endInteraction);

        this.visualIntervalId = setInterval(() => this.tickVisuals(), this.visualTickMs);
      }

      ensureStopPieImage(colors) {
        if (!this.map) return null;
        const cols = canonicalPieColors(colors);
        const key = (cols.length ? cols.join("|") : "default");
        const cachedId = this._stopPieCache.get(key);
        if (cachedId && this.map.hasImage(cachedId)) return cachedId;
        const safeKey = key.replace(/[^a-z0-9]+/gi, "-") || "default";
        const id = `stop-pie-${safeKey}`;
        try {
          if (!this.map.hasImage(id)) {
            const canvas = buildPieImage(cols, 44);
            this.map.addImage(id, canvas, { pixelRatio: 2 });
          }
          this._stopPieCache.set(key, id);
          return id;
        } catch (e) {
          return this.map.hasImage("stop-pie-default") ? "stop-pie-default" : null;
        }
      }

	      _applyOverlayData() {
        if (!this.map) return;
        this.initOverlayLayers();
        const src = this.map.getSource(this.overlaySourceId);
        if (!src || typeof src.setData !== "function") return;
        const features = [
          ...(Array.isArray(this.routeOverlayFeatures) ? this.routeOverlayFeatures : []),
          ...(Array.isArray(this.globalStopFeatures) ? this.globalStopFeatures : [])
        ];
	        src.setData({ type: "FeatureCollection", features });
	      }

	      _fadeLayerPaint(layerId, paintProp, targetValue) {
	        if (!this.map) return;
	        try {
	          this.map.setPaintProperty(layerId, paintProp, 0);
	          requestAnimationFrame(() => {
	            try { this.map.setPaintProperty(layerId, paintProp, targetValue); } catch (e2) {}
	          });
	        } catch (e) {}
	      }

      _setLayerPaint(layerId, paintProp, value) {
        if (!this.map) return;
        try { this.map.setPaintProperty(layerId, paintProp, value); } catch (e) {}
      }

      initOverlayLayers() {
        if (!this.map) return;
        this._routeStopsCircleOpacity = 0.98;
        this._routeStopsIconOpacity = 0.95;
        // Use constant opacity so MapLibre transitions reliably animate (we clear global stops below the zoom threshold).
        this._globalStopsCircleOpacity = 0.98;
        this._globalStopsIconOpacity = 0.92;

        const empty = { type: "FeatureCollection", features: [] };
        if (!this.map.getSource(this.overlaySourceId)) {
          this.map.addSource(this.overlaySourceId, { type: "geojson", data: empty });
        }
        if (!this.map.hasImage?.("stop-triangle")) {
          const canvas = document.createElement("canvas");
          canvas.width = 24;
          canvas.height = 24;
	          const ctx = canvas.getContext("2d");
	          // Up-pointing triangle; MapLibre rotates clockwise (degrees).
	          ctx.fillStyle = "#000";
	          ctx.beginPath();
	          ctx.moveTo(12, 2);
	          ctx.lineTo(18.5, 22);
	          ctx.lineTo(5.5, 22);
	          ctx.closePath();
	          ctx.fill();
	          this.map.addImage("stop-triangle", ctx.getImageData(0, 0, 24, 24), { sdf: true });
	        }
        if (!this.map.getLayer("route-shape")) {
          this.map.addLayer({
            id: "route-shape",
            type: "line",
            source: this.overlaySourceId,
            filter: ["==", ["get", "kind"], "shape"],
            paint: {
              "line-color": ["get", "color"],
              "line-width": 5,
              "line-opacity": 0.65
            }
          });
        }
        if (!this.map.getLayer("route-stops")) {
          this.map.addLayer({
            id: "route-stops",
            type: "circle",
            source: this.overlaySourceId,
            filter: ["==", ["get", "kind"], "stop"],
            paint: {
              "circle-radius": ["interpolate", ["linear"], ["zoom"], 11, 5, 14, 7, 17, 9],
              "circle-color": ["coalesce", ["get", "fill"], "#ffffff"],
              "circle-opacity": this._routeStopsCircleOpacity,
              "circle-stroke-color": ["coalesce", ["get", "border"], "#f1c40f"],
              "circle-stroke-width": ["interpolate", ["linear"], ["zoom"], 11, 2, 14, 2.8, 17, 3.4]
            }
          });
        }
        if (!this.map.getLayer("route-stop-triangles")) {
          this.map.addLayer({
            id: "route-stop-triangles",
            type: "symbol",
            source: this.overlaySourceId,
            filter: ["==", ["get", "kind"], "stop"],
            layout: {
              "icon-image": "stop-triangle",
              "icon-size": ["interpolate", ["linear"], ["zoom"], 11, 0.34, 14, 0.42, 17, 0.5],
              "icon-allow-overlap": true,
              "icon-ignore-placement": true,
              // Our `direction_angle` is degrees from East (0=E, 90=N). The triangle icon points North by default,
              // so rotate by (90 - angle) to align correctly.
              "icon-rotate": ["-", 90, ["coalesce", ["get", "direction_angle"], 0]],
              "icon-rotation-alignment": "map",
              "icon-anchor": "center",
              // Offset the triangle slightly forward (in icon pixels). Note: this offset is in screen space,
              // so keep it subtle; the corrected rotation handles the direction.
              "icon-offset": [0, -1.7]
            },
            paint: {
              "icon-color": ["coalesce", ["get", "arrow"], "#f1c40f"],
              "icon-opacity": this._routeStopsIconOpacity
            }
          });
        }
        if (!this.map.getLayer("global-stops")) {
          this.map.addLayer({
            id: "global-stops",
            type: "circle",
            source: this.overlaySourceId,
            filter: ["==", ["get", "kind"], "global_stop"],
            paint: {
              "circle-radius": ["interpolate", ["linear"], ["zoom"], 10.5, 1.2, 11.5, 2.4, 12.5, 4.8, 15, 8],
              "circle-color": ["coalesce", ["get", "fill"], "#ffffff"],
              "circle-opacity": ["interpolate", ["linear"], ["zoom"], 10.5, 0, 12, 0.08, 13.5, 0.24, 15, 0.4],
              "circle-stroke-color": ["coalesce", ["get", "border"], "#ffd400"],
              "circle-stroke-width": ["interpolate", ["linear"], ["zoom"], 10.5, 0.8, 11.5, 1.4, 12.5, 2.2, 15, 3.1]
            }
          });
        }
        if (!this.map.hasImage("stop-pie-default")) {
          try { this.map.addImage("stop-pie-default", buildPieImage(["#ffd400"], 52), { pixelRatio: 2 }); } catch (e) {}
        }
        if (!this.map.getLayer("global-stops-symbol")) {
          this.map.addLayer({
            id: "global-stops-symbol",
            type: "symbol",
            source: this.overlaySourceId,
            filter: ["==", ["get", "kind"], "global_stop"],
            layout: {
              "icon-image": ["coalesce", ["get", "icon"], "stop-pie-default"],
              "icon-size": ["interpolate", ["linear"], ["zoom"], 10.5, 0.3, 11.5, 0.55, 12.5, 0.85, 15, 1.05],
              "icon-allow-overlap": true,
              "icon-ignore-placement": true,
              "icon-anchor": "center"
            },
            paint: {
              "icon-opacity": ["interpolate", ["linear"], ["zoom"], 10.5, 0, 12, 0.1, 13.5, this._globalStopsCircleOpacity]
            }
          });
        }
        if (!this.map.getLayer("global-stops-triangles")) {
          this.map.addLayer({
            id: "global-stops-triangles",
            type: "symbol",
            source: this.overlaySourceId,
            filter: ["==", ["get", "kind"], "global_stop"],
            layout: {
              "icon-image": "stop-triangle",
              "icon-size": 0.52,
              "icon-allow-overlap": true,
              "icon-ignore-placement": true,
              // Same convention as route stops: degrees from East (0=E, 90=N) -> rotate by (90 - angle)
              "icon-rotate": ["-", 90, ["coalesce", ["get", "direction_angle"], 0]],
              "icon-rotation-alignment": "map",
              "icon-anchor": "center"
            },
            paint: {
              "icon-color": ["coalesce", ["get", "arrow"], "#000000"],
              "icon-opacity": ["interpolate", ["linear"], ["zoom"], 10.5, 0, 12, 0.14, 13.5, this._globalStopsIconOpacity]
            }
          });
        }
        // Route labels above stops are rendered via DOM markers for richer pill styling; keep this layer disabled.
        if (this.map.getLayer("global-stops-routes")) {
          try { this.map.removeLayer("global-stops-routes"); } catch (e) {}
        }

        this.initGlobalStopTiles();

        // Smooth fade when we toggle paint properties (used on data refresh).
        try {
          this.map.setPaintProperty("route-stops", "circle-opacity-transition", { duration: 260, delay: 0 });
          this.map.setPaintProperty("route-stop-triangles", "icon-opacity-transition", { duration: 260, delay: 0 });
          this.map.setPaintProperty("global-stops", "circle-opacity-transition", { duration: 420, delay: 0 });
          this.map.setPaintProperty("global-stops-symbol", "icon-opacity-transition", { duration: 420, delay: 0 });
          this.map.setPaintProperty("global-stops-triangles", "icon-opacity-transition", { duration: 420, delay: 0 });
        } catch (e) {}

        const closeAllPopups = () => {
          const list = Array.isArray(this.activePopups) ? this.activePopups : [];
          list.forEach(p => p?.remove?.());
          this.activePopups = [];
        };

        this.map.on("click", "global-stops", (e) => {
          try {
            const feature = e?.features?.[0];
            if (!feature) return;
            const props = feature.properties || {};
            const stopName = props.stop_name || "Paragem";
            const stopId = props.stop_id || "";
            closeAllPopups();
            const schedState = initialScheduleStateForContext();
            const html = stopPopupHtml({ stopName, stopId, loading: true, schedule: schedState });
            const popup = new maplibregl.Popup({ offset: 12, className: "custom-popup" })
              .setLngLat(e.lngLat)
              .setHTML(html)
              .addTo(this.map);
            try { popup.on("open", () => ensurePopupVisible(e.lngLat, this.map)); } catch (e4) {}
            try { popup.on("close", () => { hideMobileStopCard(); activeStopPopup = null; }); } catch (e5) {}
            this.activePopups.push(popup);
            hydrateStopPopup(popup, { stopId, stopName }).catch(() => {});
          } catch (err) {}
        });
        this.map.on("click", "route-stops", (e) => {
          try {
            const feature = e?.features?.[0];
            if (!feature) return;
            const props = feature.properties || {};
            const stopName = props.stop_name || "Paragem";
            const stopId = props.stop_id || "";
            closeAllPopups();
            const popup = new maplibregl.Popup({ offset: 12, className: "custom-popup" })
              .setLngLat(e.lngLat)
              .setHTML(stopPopupHtml({ stopName, stopId, loading: true, schedule: initialScheduleStateForContext() }))
              .addTo(this.map);
            try { popup.on("open", () => ensurePopupVisible(e.lngLat, this.map)); } catch (e4) {}
            try { popup.on("close", () => { hideMobileStopCard(); activeStopPopup = null; }); } catch (e5) {}
            this.activePopups.push(popup);
            hydrateStopPopup(popup, { stopId, stopName }).catch(() => {});
          } catch (err) {}
        });
        this.map.on("mouseenter", "route-stops", () => { this.map.getCanvas().style.cursor = "pointer"; });
        this.map.on("mouseleave", "route-stops", () => { this.map.getCanvas().style.cursor = ""; });
        this.map.on("mouseenter", "global-stops", () => { this.map.getCanvas().style.cursor = "pointer"; });
        this.map.on("mouseleave", "global-stops", () => { this.map.getCanvas().style.cursor = ""; });

        this.overlayReady = true;
      }

      initGlobalStopTiles() {
        if (!this.map || this.globalStopTilesEnabled) return this.globalStopTilesEnabled;
        if (!STOP_TILES_ENABLED) {
          stopTilesAvailability = false;
          return false;
        }
        // Only enable tile source when availability is confirmed true; otherwise, rely on GeoJSON flow.
        if (stopTilesAvailability === null) {
          prewarmStopTilesAvailability()
            .then((val) => { if (val) try { this.initGlobalStopTiles(); } catch (e) {} })
            .catch(() => {});
          return false;
        }
        if (stopTilesAvailability === false) return false;
        const tiles = stopsTileTemplates();
        if (!tiles.length) return false;
        try {
          if (!this.map.getSource(STOP_TILE_SOURCE_ID)) {
            this.map.addSource(STOP_TILE_SOURCE_ID, {
              type: "vector",
              tiles,
              minzoom: 10,
              maxzoom: 20
            });
          }
          if (!this.map.getLayer(STOP_TILE_LAYER_IDS.circle)) {
            this.map.addLayer({
              id: STOP_TILE_LAYER_IDS.circle,
              type: "circle",
              source: STOP_TILE_SOURCE_ID,
              "source-layer": STOP_TILE_LAYER_NAME,
              paint: {
                "circle-radius": ["interpolate", ["linear"], ["zoom"], 10.5, 1.2, 11.5, 2.4, 12.5, 4.8, 15, 8],
                "circle-color": ["coalesce", ["get", "fill"], "#ffffff"],
                "circle-opacity": ["interpolate", ["linear"], ["zoom"], 10.5, 0, 12, 0.08, 13.5, 0.24, 15, 0.4],
                "circle-stroke-color": ["coalesce", ["get", "border"], "#ffd400"],
                "circle-stroke-width": ["interpolate", ["linear"], ["zoom"], 10.5, 0.8, 11.5, 1.4, 12.5, 2.2, 15, 3.1]
              }
            });
          }
          if (!this.map.getLayer(STOP_TILE_LAYER_IDS.symbol)) {
            if (!this.map.hasImage("stop-pie-default")) {
              try { this.map.addImage("stop-pie-default", buildPieImage(["#ffd400"], 52), { pixelRatio: 2 }); } catch (e) {}
            }
            this.map.addLayer({
              id: STOP_TILE_LAYER_IDS.symbol,
              type: "symbol",
              source: STOP_TILE_SOURCE_ID,
              "source-layer": STOP_TILE_LAYER_NAME,
              layout: {
                "icon-image": ["coalesce", ["get", "icon"], "stop-pie-default"],
                "icon-size": ["interpolate", ["linear"], ["zoom"], 10.5, 0.3, 11.5, 0.55, 12.5, 0.85, 15, 1.05],
                "icon-allow-overlap": true,
                "icon-ignore-placement": true,
                "icon-anchor": "center",
                visibility: "none"
              },
              paint: {
                "icon-opacity": ["interpolate", ["linear"], ["zoom"], 10.5, 0, 12, 0.1, 13.5, this._globalStopsCircleOpacity]
              }
            });
          }
          if (!this.map.getLayer(STOP_TILE_LAYER_IDS.triangle)) {
            this.map.addLayer({
              id: STOP_TILE_LAYER_IDS.triangle,
              type: "symbol",
              source: STOP_TILE_SOURCE_ID,
              "source-layer": STOP_TILE_LAYER_NAME,
              layout: {
                "icon-image": "stop-triangle",
                "icon-size": 0.52,
                "icon-allow-overlap": true,
                "icon-ignore-placement": true,
                "icon-rotate": ["-", 90, ["coalesce", ["get", "direction_angle"], 0]],
                "icon-rotation-alignment": "map",
                "icon-anchor": "center",
                visibility: "none"
              },
              paint: {
                "icon-color": ["coalesce", ["get", "arrow"], "#000000"],
                "icon-opacity": ["interpolate", ["linear"], ["zoom"], 10.5, 0, 12, 0.14, 13.5, this._globalStopsIconOpacity]
              }
            });
          }
          // Interactions for tile-based stops
          const clickHandler = (layerId) => {
            this.map.on("click", layerId, (e) => {
              try {
                const feature = e?.features?.[0];
                if (!feature) return;
                const props = feature.properties || {};
                const stopName = props.stop_name || "Paragem";
                const stopId = props.stop_id || "";
                const html = stopPopupHtml({ stopName, stopId, loading: true, schedule: initialScheduleStateForContext() });
                const popup = new maplibregl.Popup({ offset: 12, className: "custom-popup" })
                  .setLngLat(e.lngLat)
                  .setHTML(html)
                  .addTo(this.map);
                try { popup.on("close", () => { hideMobileStopCard(); activeStopPopup = null; }); } catch (e5) {}
                this.activePopups.push(popup);
                hydrateStopPopup(popup, { stopId, stopName }).catch(() => {});
              } catch (err) {}
            });
            this.map.on("mouseenter", layerId, () => { this.map.getCanvas().style.cursor = "pointer"; });
            this.map.on("mouseleave", layerId, () => { this.map.getCanvas().style.cursor = ""; });
          };
          [STOP_TILE_LAYER_IDS.circle, STOP_TILE_LAYER_IDS.symbol].forEach(clickHandler);
          this.globalStopTilesEnabled = true;
          this.setGlobalStopTilesVisible(true);
        } catch (err) {
          this.globalStopTilesEnabled = false;
        }
        return this.globalStopTilesEnabled;
      }

      setGlobalStopTilesVisible(show) {
        if (!this.map || !this.globalStopTilesEnabled) return;
        const visibility = show ? "visible" : "none";
        [STOP_TILE_LAYER_IDS.circle, STOP_TILE_LAYER_IDS.symbol, STOP_TILE_LAYER_IDS.triangle].forEach(id => {
          try { this.map.setLayoutProperty(id, "visibility", visibility); } catch (e) {}
        });
        // Hide GeoJSON overlay-based layers to avoid double rendering.
        try { this.map.setLayoutProperty("global-stops", "visibility", show ? "none" : "visible"); } catch (e) {}
        try { this.map.setLayoutProperty("global-stops-symbol", "visibility", show ? "none" : "visible"); } catch (e) {}
        try { this.map.setLayoutProperty("global-stops-triangles", "visibility", show ? "none" : "visible"); } catch (e) {}
      }

      clearOverlay() {
        if (!this.map) return;
        this.routeOverlayFeatures = [];
        this.globalStopFeatures = [];
        this._applyOverlayData();
      }

	      setRouteOverlay(payload, { fit = false } = {}) {
	        if (!this.map) return;
	        this.initOverlayLayers();
	        const prevStopCount = this._lastRouteStopsCount || 0;
	        const features = [];
	        const shapes = Array.isArray(payload?.shapes) ? payload.shapes : [];
	        const stops = Array.isArray(payload?.stops) ? payload.stops : [];
	        const segments = buildShapeSegments(shapes);

        for (const item of shapes) {
          const geojson = item?.geojson;
          if (!geojson || !Array.isArray(geojson.features)) continue;
          const color = item?.color || "#3498db";
          for (const f of geojson.features) {
            if (!f || f.type !== "Feature") continue;
            if (f.geometry?.type !== "LineString") continue;
            features.push({
              type: "Feature",
              properties: { ...(f.properties || {}), kind: "shape", color },
              geometry: f.geometry
            });
          }
        }

	        for (const s of stops) {
	          const lat = Number(s?.stop_lat);
	          const lon = Number(s?.stop_lon);
	          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
	          const color = s?.color || "#3498db";
	          const fallbackAngle = Number(s?.direction_angle);
	          const alignedAngle = closestSegmentAngleForPoint(lat, lon, segments, fallbackAngle);
	          features.push({
	            type: "Feature",
	            properties: {
	              kind: "stop",
              fill: "#ffffff",
              border: color,
              arrow: color,
              stop_id: s?.stop_id || "",
              stop_name: s?.stop_name || "",
              direction_angle: alignedAngle
            },
            geometry: { type: "Point", coordinates: [lon, lat] }
          });
        }

	        this.routeOverlayFeatures = features;
	        this._applyOverlayData();
	        this._lastRouteStopsCount = stops.length;

	        if (prevStopCount === 0 && stops.length > 0) {
	          this._fadeLayerPaint("route-stops", "circle-opacity", Number(this._routeStopsCircleOpacity ?? 0.98));
	          this._fadeLayerPaint("route-stop-triangles", "icon-opacity", Number(this._routeStopsIconOpacity ?? 0.95));
	        }

	        if (fit && features.length) {
	          try {
	            const bounds = new maplibregl.LngLatBounds();
	            for (const f of features) {
              if (f.geometry?.type === "Point") bounds.extend(f.geometry.coordinates);
              if (f.geometry?.type === "LineString") {
                for (const c of f.geometry.coordinates || []) bounds.extend(c);
              }
            }
            if (!bounds.isEmpty()) this.map.fitBounds(bounds, { padding: 40, maxZoom: 15 });
          } catch (e) {}
        }
      }

      initUserLocationLayer() {
        if (!this.map) return;
        const empty = { type: "FeatureCollection", features: [] };
        if (!this.map.getSource(this.userLocationSourceId)) {
          this.map.addSource(this.userLocationSourceId, { type: "geojson", data: empty });
        }
        if (!this.map.getLayer(this.userLocationAccuracyLayerId)) {
          this.map.addLayer({
            id: this.userLocationAccuracyLayerId,
            type: "circle",
            source: this.userLocationSourceId,
            paint: {
              "circle-radius": 40,
              "circle-color": "rgba(59, 130, 246, 0.15)",
              "circle-stroke-width": 0
            }
          });
        }
        if (!this.map.getLayer(this.userLocationLayerId)) {
          this.map.addLayer({
            id: this.userLocationLayerId,
            type: "circle",
            source: this.userLocationSourceId,
            paint: {
              "circle-radius": 8,
              "circle-color": "#3b82f6",
              "circle-stroke-color": "#ffffff",
              "circle-stroke-width": 2
            }
          });
        }
      }

      setUserLocation(coords, { center = false, accuracy = 0 } = {}) {
        if (!this.map || !coords || coords.length < 2) return;
        const [lat, lon] = coords;
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        this.initUserLocationLayer();
        const src = this.map.getSource(this.userLocationSourceId);
        if (src && typeof src.setData === "function") {
          const feature = {
            type: "FeatureCollection",
            features: [{
              type: "Feature",
              geometry: { type: "Point", coordinates: [lon, lat] },
              properties: { accuracy: Number.isFinite(accuracy) ? accuracy : 0 }
            }]
          };
          src.setData(feature);
        }
        const radius = Math.max(24, Math.min(accuracy ? accuracy / 2 : 32, 120));
        try {
          this.map.setPaintProperty(this.userLocationAccuracyLayerId, "circle-radius", radius);
        } catch (e) {}
        if (center) {
          try {
            this.map.easeTo({
              center: [lon, lat],
              zoom: Math.max(this.map.getZoom(), 13),
              duration: 0.8
            });
          } catch (e) {}
        }
      }

      clearUserLocation() {
        if (!this.map) return;
        const src = this.map.getSource(this.userLocationSourceId);
        if (src && typeof src.setData === "function") {
          src.setData({ type: "FeatureCollection", features: [] });
        }
      }

	      setGlobalStops(payload) {
	        if (!this.map) return;
	        // When vector tiles are enabled for global stops, skip GeoJSON overlay updates.
	        if (this.globalStopTilesEnabled) return;
	        this.initOverlayLayers();
	        const stops = Array.isArray(payload?.stops) ? payload.stops : [];
	        const prevCount = this._lastGlobalStopsCount || 0;
        const preferredAngles = stops.map(s => Number(s?.direction_angle));
        const fallbackAngles = estimateAnglesFromNeighbors(stops, preferredAngles);
        const angleDiff = (a, b) => {
          const da = Math.abs(wrapAngleDeg(a) - wrapAngleDeg(b));
          return Math.min(da, 360 - da);
        };
        const features = [];
        const comboColors = new Map(); // key -> color array
        for (let idx = 0; idx < stops.length; idx++) {
          const s = stops[idx];
          const lat = Number(s?.stop_lat);
          const lon = Number(s?.stop_lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
          const stopId = (s?.stop_id == null) ? "" : String(s.stop_id);
          const angleRaw = Number(s?.direction_angle);
          const local = Number(fallbackAngles[idx] || 0);
          // Prefer backend-provided tangent; fallback to neighbor estimate only if missing.
          const angle = Number.isFinite(angleRaw) ? angleRaw : local;
          const routes = Array.isArray(s?.routes) ? s.routes : [];
          const routesLabel = routes.map(r => String(r || "").trim()).filter(Boolean).slice(0, 6).join("  ");
          if (stopId && routes.length) stopRoutesCache.set(stopId, routes);
          const finalColors = ["#ffd400"]; // brighter uniform yellow ring
          const comboKey = finalColors.length ? finalColors.join("|") : "default";
          if (!comboColors.has(comboKey)) comboColors.set(comboKey, finalColors);
          const primaryColor = "#ffd400";
          const arrowColor = "#000000";
          features.push({
            type: "Feature",
            properties: {
              kind: "global_stop",
              stop_id: stopId,
              stop_name: s?.stop_name || "",
              direction_angle: Number.isFinite(angle) ? angle : 0,
              routes,
              routes_label: routesLabel,
              colors: finalColors,
              fill: "#ffffff",
              border: primaryColor,
              arrow: arrowColor,
              icon: null, // filled after icons ensured
              iconId: null
            },
            geometry: { type: "Point", coordinates: [lon, lat] }
          });
        }
        // Pre-render one image per color combo and assign icon ids to features.
        const comboToId = new Map();
        for (const [key, colors] of comboColors.entries()) {
          const id = this.ensureStopPieImage(colors) || "stop-pie-default";
          comboToId.set(key, id);
        }
        for (const f of features) {
          const cols = Array.isArray(f.properties?.colors) ? f.properties.colors : [];
          const k = cols.length ? cols.join("|") : "default";
          const imgId = comboToId.get(k) || "stop-pie-default";
          f.properties.icon = imgId;
          f.properties.iconId = imgId;
        }
        const targetCircle = Number(this._globalStopsCircleOpacity ?? 0.98);
        const targetIcon = Number(this._globalStopsIconOpacity ?? 0.92);
        const shouldFadeStops = (prevCount === 0 && features.length > 0) || Math.abs(features.length - prevCount) >= 4;

        this.globalStopFeatures = features;
        this._applyOverlayData();
        this._lastGlobalStopsCount = features.length;

        // Smooth fade in/out on refresh; avoid flashing when only small updates occur.
        if (shouldFadeStops) {
          this._fadeLayerPaint("global-stops", "circle-opacity", targetCircle);
          this._fadeLayerPaint("global-stops-symbol", "icon-opacity", targetCircle);
          this._fadeLayerPaint("global-stops-triangles", "icon-opacity", targetIcon);
        } else {
          this._setLayerPaint("global-stops", "circle-opacity", targetCircle);
          this._setLayerPaint("global-stops-symbol", "icon-opacity", targetCircle);
          this._setLayerPaint("global-stops-triangles", "icon-opacity", targetIcon);
        }
      }

      createMarker(id, coords, style, vehicle, serverTsSec) {
        const wrapper = document.createElement("div");
        wrapper.className = "veh-wrapper";
        wrapper.innerHTML = vehicleIconMarkup(style);
        const inner = wrapper.querySelector('.veh-marker');
        const marker = new maplibregl.Marker({ element: wrapper, anchor: "bottom" })
          .setLngLat(coords)
          .addTo(this.map);
        const popup = new maplibregl.Popup({ offset: 18, className: "custom-popup" }).setHTML(popupHtml(vehicle, style));
        marker.setPopup(popup);
        try {
          popup.on("open", () => {
            ensurePopupVisible(marker.getLngLat(), this.map);
            const current = this.markers.get(id);
            if (current?.data) {
              prewarmRouteOverlayForVehicle(current.data).catch(() => {});
            }
          });
        } catch (e) {}
        const state = {
          id,
          marker,
          inner,
          popup,
          lon: coords[0],
          lat: coords[1],
          serverTsSec,
          lastServerTsSec: serverTsSec,
          data: vehicle,
          transitionTimer: null
        };
        this.markers.set(id, state);
        this.applyStyle(state, style);
        this.updateMarkerVisual(state);
        return state;
      }

      clearAllTransitions() {
        for (const state of this.markers.values()) {
          if (state?.transitionTimer) {
            clearTimeout(state.transitionTimer);
            state.transitionTimer = null;
          }
          const el = state?.marker?.getElement?.();
          if (el) {
            el.classList.remove("veh-animating");
            el.style.removeProperty("--veh-move-ms");
          }
        }
      }

      slideMarkerTo(state, coords) {
        const markerEl = state?.marker?.getElement?.();
        if (!markerEl || this.isInteracting || this.animationDuration <= 0) {
          state.marker.setLngLat(coords);
          return;
        }

        if (state.transitionTimer) {
          clearTimeout(state.transitionTimer);
          state.transitionTimer = null;
        }

        markerEl.style.setProperty("--veh-move-ms", `${this.animationDuration}ms`);
        markerEl.classList.add("veh-animating");
        requestAnimationFrame(() => state.marker.setLngLat(coords));
        state.transitionTimer = setTimeout(() => {
          const el2 = state.marker.getElement?.();
          if (el2) {
            el2.classList.remove("veh-animating");
            el2.style.removeProperty("--veh-move-ms");
          }
          state.transitionTimer = null;
        }, this.animationDuration + 80);
      }

      updateMarker(state, coords, style, vehicle, serverTsSec) {
        const EPS = 1e-7;
        const prevTs = state.lastServerTsSec;
        const hasNewTs = Number.isFinite(serverTsSec) && (!Number.isFinite(prevTs) || serverTsSec > prevTs);
        const coordsChanged = !Number.isFinite(state.lon) || !Number.isFinite(state.lat) ||
          Math.abs(state.lon - coords[0]) > EPS || Math.abs(state.lat - coords[1]) > EPS;

        if (hasNewTs || coordsChanged) {
          state.lastServerTsSec = serverTsSec;
          state.lon = coords[0];
          state.lat = coords[1];
          this.slideMarkerTo(state, coords);
        }

        state.serverTsSec = serverTsSec;
        state.data = vehicle;
        this.applyStyle(state, style);
        if (state.popup && typeof state.popup.isOpen === "function" && state.popup.isOpen()) {
          state.popup.setHTML(popupHtml(vehicle, style));
        }
        this.updateMarkerVisual(state, Date.now() / 1000);
      }

      applyStyle(state, style) {
        const inner = state.inner;
        if (!inner) return;
        inner.style.setProperty("--c", style.color);
        const icon = inner.querySelector('.veh-icon');
        if (icon) icon.className = `fa ${style.icon} veh-icon`;
      }

      updateMarkerVisual(state, nowSec = Date.now() / 1000) {
        const inner = state.inner;
        if (!inner) return;
        const pingAge = Number.isFinite(state.serverTsSec) ? nowSec - state.serverTsSec : Infinity;
        const isInactive = pingAge > INACTIVE_SECONDS;
        const isStale = pingAge > ACTIVE_SECONDS && !isInactive;
        inner.classList.toggle("veh--stale", isStale);
        inner.classList.toggle("veh--inactive", isInactive);
      }

      updateVehicles(vehicleList) {
        if (!this.map) return 0;
        const activeIDs = new Set();
        vehicleList.forEach(v => {
          if (!v || v.id == null) return;
          const coords = normalizeCoordinates(v);
          if (!coords) return;
          const style = getStyle(v);
          const vid = String(v.id);
          activeIDs.add(vid);
          const serverTsSec = normalizeTimestampSeconds(v.ts ?? v.timestamp ?? v.time ?? Date.now());
          let state = this.markers.get(vid);
          if (!state) {
            state = this.createMarker(vid, coords, style, v, serverTsSec);
          } else {
            this.updateMarker(state, coords, style, v, serverTsSec);
          }
        });

        for (const [vid, state] of this.markers.entries()) {
          if (!activeIDs.has(vid)) {
            if (state?.transitionTimer) clearTimeout(state.transitionTimer);
            state.marker.remove();
            if (state.popup) state.popup.remove();
            this.markers.delete(vid);
          }
        }
        return activeIDs.size;
      }

      tickVisuals() {
        if (!this.map) return;
        const nowSec = Date.now() / 1000;
        for (const state of this.markers.values()) {
          this.updateMarkerVisual(state, nowSec);
        }
      }

      setVisibleIds(visibleIds) {
        let count = 0;
        for (const [vid, state] of this.markers.entries()) {
          const el = state?.marker?.getElement?.();
          if (!el) continue;
          const shouldShow = visibleIds.has(vid);
          el.style.display = shouldShow ? "" : "none";
          if (shouldShow) count += 1;
        }
        return count;
      }
    }

    // --- Inicializao ---
    function createAdapter() {
      const rendererPref = (urlParams.get('renderer') || "").toLowerCase();
      const hasMapLibre = typeof maplibregl !== "undefined";
      const hasLeaflet = typeof L !== "undefined";

      // Prefer MapLibre (WebGL) for smoother zoom/interaction with many markers.
      if (rendererPref === "leaflet" && hasLeaflet) return new LeafletAdapter();
      if (rendererPref === "maplibre" && hasMapLibre) return new MapLibreAdapter();

      if (hasMapLibre) {
        try {
          return new MapLibreAdapter();
        } catch (err) {
          console.warn("MapLibre falhou, alternando para Leaflet:", err);
        }
      }
      if (hasLeaflet) return new LeafletAdapter();
      throw new Error("Nenhum renderer de mapa disponvel (MapLibre ou Leaflet).");
    }

    let adapter;
    try {
      adapter = createAdapter();
    } catch (err) {
      showAppError(`Falha ao inicializar o mapa: ${err?.message || err}`);
      adapter = {
        ready: Promise.resolve(),
        updateVehicles: () => 0,
        setVisibleIds: () => 0,
        clearOverlay: () => {},
        setRouteOverlay: () => {},
        setUserLocation: () => {},
        clearUserLocation: () => {}
      };
    }

    const adapterReady = Promise.resolve(adapter.ready);
    adapterReady.then(() => {
      maybePromptMobileLocation();
    });
    window.addEventListener("resize", () => maybePromptMobileLocation(), { passive: true });
    if (userLocationButton) {
      userLocationButton.addEventListener("click", () => requestUserLocation({ center: true }));
    }

    function clampNumber(v, min, max) {
      const n = Number(v);
      if (!Number.isFinite(n)) return min;
      return Math.min(max, Math.max(min, n));
    }

    function debounce(fn, wait = 160) {
      let t = null;
      return (...args) => {
        if (t) clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

	    function wrapAngleDeg(deg) {
	      const n = Number(deg);
	      if (!Number.isFinite(n)) return 0;
	      let out = n % 360;
	      if (out < 0) out += 360;
	      return out;
	    }

	    // Bearing in degrees from East (0=E, 90=N), matching `direction_angle` convention in this app.
	    function bearingDegFromEast(lat1, lon1, lat2, lon2) {
	      const 1 = (Number(lat1) * Math.PI) / 180;
	      const 2 = (Number(lat2) * Math.PI) / 180;
	      const  = ((Number(lon2) - Number(lon1)) * Math.PI) / 180;
	      const y = Math.sin() * Math.cos(2);
	      const x = Math.cos(1) * Math.sin(2) - Math.sin(1) * Math.cos(2) * Math.cos();
	      // `atan2(y, x)` gives bearing from North (clockwise). Convert to "from East" convention.
	      const bearingFromNorth = Math.atan2(y, x) * (180 / Math.PI); // -180..180
	      const bearingFromEast = 90 - bearingFromNorth;
	      return wrapAngleDeg(bearingFromEast);
	    }

    function estimateAnglesFromNeighbors(stops, preferredAngles = null) {
      const list = Array.isArray(stops) ? stops : [];
	      const pts = [];
	      for (let i = 0; i < list.length; i++) {
	        const s = list[i];
	        const lat = Number(s?.stop_lat);
	        const lon = Number(s?.stop_lon);
	        if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
	        pts.push({ i, lat, lon });
	      }
	      const out = new Array(list.length).fill(0);
	      if (pts.length < 2) return out;

	      const R = 6371000;
	      const K = 8;
	      const MAX_D_M = 260;
	      const MAX_D2 = MAX_D_M * MAX_D_M;
	      const preferred = Array.isArray(preferredAngles) ? preferredAngles : null;

	      const angleDiff = (a, b) => {
	        const da = Math.abs(wrapAngleDeg(a) - wrapAngleDeg(b));
	        return Math.min(da, 360 - da);
	      };

	      for (const p of pts) {
	        const refLat = (p.lat * Math.PI) / 180;
	        const cosRef = Math.cos(refLat);
	        const px = ((p.lon * Math.PI) / 180) * cosRef * R;
	        const py = ((p.lat * Math.PI) / 180) * R;
	        const neigh = [];
	        for (const q of pts) {
	          if (q.i === p.i) continue;
	          const qx = ((q.lon * Math.PI) / 180) * cosRef * R;
	          const qy = ((q.lat * Math.PI) / 180) * R;
	          const dx = qx - px;
	          const dy = qy - py;
	          const d2 = dx * dx + dy * dy;
	          if (d2 <= MAX_D2) neigh.push({ q, dx, dy, d2 });
	        }
	        if (neigh.length === 0) continue;
	        neigh.sort((a, b) => a.d2 - b.d2);
		        const use = neigh.slice(0, K);

		        if (use.length === 1) {
		          out[p.i] = bearingDegFromEast(p.lat, p.lon, use[0].q.lat, use[0].q.lon);
		          continue;
		        }

	        let sxx = 0, syy = 0, sxy = 0;
	        for (const n of use) {
	          const dx = n.dx;
	          const dy = n.dy;
	          sxx += dx * dx;
	          syy += dy * dy;
	          sxy += dx * dy;
	        }
	        // Principal axis angle relative to x-axis (East), sign-ambiguous.
	        const theta = 0.5 * Math.atan2(2 * sxy, (sxx - syy));
	        const axisDeg = wrapAngleDeg(theta * (180 / Math.PI));
	        const axisDegOpp = wrapAngleDeg(axisDeg + 180);

	        const nearestBearing = bearingDegFromEast(p.lat, p.lon, use[0].q.lat, use[0].q.lon);
	        const want = Number.isFinite(Number(preferred?.[p.i])) ? Number(preferred[p.i]) : nearestBearing;
        out[p.i] = (angleDiff(axisDegOpp, want) < angleDiff(axisDeg, want)) ? axisDegOpp : axisDeg;
      }
      return out;
    }

    function canonicalPieColors(colors) {
      const seen = new Set();
      const list = Array.isArray(colors) ? colors : [];
      const deduped = [];
      for (const raw of list) {
        const c = (raw == null) ? "" : String(raw).trim();
        if (!c) continue;
        const key = c.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        deduped.push(c);
      }
      return deduped.sort();
    }

    const ROUTE_PIE_COLORS = [
      "#e74c3c", "#f39c12", "#f1c40f", "#2ecc71", "#1abc9c", "#16a085",
      "#3498db", "#9b59b6", "#8e44ad", "#e67e22", "#d35400", "#34495e",
      "#ff6b6b", "#1dd1a1", "#48dbfb", "#5f27cd"
    ];

    // Route colors are derived from zone colors instead of per-route hashes for stop pies.

    function buildPieImage(colors, size = 44) {
      const cols = Array.isArray(colors) && colors.length ? colors : ["#f1c40f"];
      const canvas = document.createElement("canvas");
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext("2d");
      const cx = size / 2;
      const cy = size / 2;
      const radius = size / 2 - 1;
      const innerR = radius * 0.52;
      const slice = (Math.PI * 2) / cols.length;
      let start = -Math.PI / 2;
      cols.forEach((c) => {
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.fillStyle = c;
        ctx.arc(cx, cy, radius, start, start + slice);
        ctx.closePath();
        ctx.fill();
        start += slice;
      });
      // Punch a hole for the arrow to sit cleanly.
      ctx.save();
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
      // Outer stroke for crisp edges.
      ctx.beginPath();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2;
      ctx.arc(cx, cy, radius - 0.5, 0, Math.PI * 2);
      ctx.stroke();
      return canvas;
    }

	    function buildShapeSegments(shapes) {
	      const segments = [];
	      const list = Array.isArray(shapes) ? shapes : [];
	      for (const item of list) {
	        const geojson = item?.geojson;
	        const feats = Array.isArray(geojson?.features) ? geojson.features : [];
	        for (const f of feats) {
	          if (f?.geometry?.type !== "LineString") continue;
	          const coords = Array.isArray(f.geometry.coordinates) ? f.geometry.coordinates : [];
	          for (let i = 1; i < coords.length; i++) {
	            const a = coords[i - 1];
	            const b = coords[i];
	            if (!Array.isArray(a) || !Array.isArray(b)) continue;
	            const lon1 = Number(a[0]), lat1 = Number(a[1]);
	            const lon2 = Number(b[0]), lat2 = Number(b[1]);
	            if (!Number.isFinite(lon1) || !Number.isFinite(lat1) || !Number.isFinite(lon2) || !Number.isFinite(lat2)) continue;
	            segments.push({ lon1, lat1, lon2, lat2 });
	          }
	        }
	      }
	      return segments;
	    }

	    function closestSegmentAngleForPoint(lat, lon, segments, fallbackAngleDeg) {
	      const segs = Array.isArray(segments) ? segments : [];
	      if (!segs.length) return Number.isFinite(Number(fallbackAngleDeg)) ? Number(fallbackAngleDeg) : 0;

	      const R = 6371000;
	      const refLat = (Number(lat) * Math.PI) / 180;
	      const cosRef = Math.cos(refLat);
	      const px = ((Number(lon) * Math.PI) / 180) * cosRef * R;
	      const py = ((Number(lat) * Math.PI) / 180) * R;

	      let best = null;
	      let bestD2 = Infinity;
	      for (const s of segs) {
	        const ax = ((s.lon1 * Math.PI) / 180) * cosRef * R;
	        const ay = ((s.lat1 * Math.PI) / 180) * R;
	        const bx = ((s.lon2 * Math.PI) / 180) * cosRef * R;
	        const by = ((s.lat2 * Math.PI) / 180) * R;
	        const abx = bx - ax;
	        const aby = by - ay;
	        const apx = px - ax;
	        const apy = py - ay;
	        const denom = abx * abx + aby * aby;
	        if (denom <= 1e-12) continue;
	        const t = clampNumber((apx * abx + apy * aby) / denom, 0, 1);
	        const cx = ax + abx * t;
	        const cy = ay + aby * t;
	        const dx = px - cx;
	        const dy = py - cy;
	        const d2 = dx * dx + dy * dy;
	        if (d2 < bestD2) {
	          bestD2 = d2;
	          best = s;
	        }
	      }

	      if (!best) return Number.isFinite(Number(fallbackAngleDeg)) ? Number(fallbackAngleDeg) : 0;

	      const a = bearingDegFromEast(best.lat1, best.lon1, best.lat2, best.lon2);
	      const b = wrapAngleDeg(a + 180);
	      const fallback = wrapAngleDeg(Number.isFinite(Number(fallbackAngleDeg)) ? Number(fallbackAngleDeg) : 0);
	      const da = Math.min(Math.abs(a - fallback), 360 - Math.abs(a - fallback));
	      const db = Math.min(Math.abs(b - fallback), 360 - Math.abs(b - fallback));
	      return (db < da) ? b : a;
	    }

	    async function wireMapEvents() {
	      try {
	        if (adapter.ready instanceof Promise) await adapter.ready;
	        if (!adapter?.map) return;
	        const applyStopMarkerSize = () => {
	          try {
	            const z = Number(adapter.map.getZoom?.());
            const px = stopPixelSizeForZoom(z);
            document.documentElement.style.setProperty("--map-zoom-size", `${px}px`);
          } catch (e) {}
        };
	        // Leaflet supports multiple events in a single string; MapLibre doesn't.
        if (adapter instanceof LeafletAdapter) {
          const handleStopsUpdate = () => scheduleRefreshStops(false);
          adapter.map.on("zoomend", () => {
            handleStopsUpdate();
            applyStopMarkerSize();
            scheduleHashCenterSync();
          });
          adapter.map.on("moveend", () => {
            handleStopsUpdate();
            scheduleHashCenterSync();
          });
          adapter.map.on("movestart", cancelGlobalStopsFetch);
          adapter.map.on("zoomstart", cancelGlobalStopsFetch);
          applyStopMarkerSize();
        } else if (adapter instanceof MapLibreAdapter) {
          const handleStopsUpdate = () => scheduleRefreshStops(false);
          adapter.map.on("zoomend", () => {
            handleStopsUpdate();
            applyStopMarkerSize();
            updateMapLibreStopLabels();
            scheduleHashCenterSync();
          });
          adapter.map.on("moveend", () => {
            handleStopsUpdate();
            updateMapLibreStopLabels();
            scheduleHashCenterSync();
          });
	          adapter.map.on("movestart", cancelGlobalStopsFetch);
	          adapter.map.on("zoomstart", cancelGlobalStopsFetch);
	          applyStopMarkerSize();
	          updateMapLibreStopLabels();
	        }
	      } catch (err) {}
	    }

	    const OVERLAY_DIRECTIONS = [0, 1];
	    const overlayCache = new Map(); // key -> { ts, payload }
	    let currentOverlayKey = null;
	    let currentOverlayFitKey = null;
	    let overlayInflight = null;

    // Stop marker tuning: LOD threshold and transition timing (CSS uses ~260ms).
    const STOPS_MIN_ZOOM = 13;
    const STOP_ANIMATION_MS = 320;
    const STOP_REMOVE_DELAY_MS = STOP_ANIMATION_MS + 80;
    const GLOBAL_STOPS_LIMIT = 1200;
    const GLOBAL_STOPS_LIMIT_MIN = 600;
    const GLOBAL_STOPS_KEY_PRECISION = 1e4;
    const GLOBAL_STOPS_CACHE_TTL_MS = 120_000;
	    const globalStopsCache = new Map(); // key -> { ts, payload }
    let globalStopsAbort = null;
    let globalStopsKey = null;
    let lastRenderedGlobalStopsKey = null;
    const renderedStopsMap = new Map(); // stopKey -> { marker, lat, lon, angleDeg }
    const mapLibreStopLabelMarkers = new Map();
    const STOP_LABEL_ZOOM_THRESHOLD = 15.2; // Zoom onde as pills comeam a aparecer
    const STOP_LABEL_FADE_MS = 260;
    let mapLibreStopsFadeTimer = null;
    const STOP_TILE_SOURCE_ID = "global-stop-tiles";
    const STOP_TILE_LAYER_NAME = "stops";
    const STOP_TILE_LAYER_IDS = {
      circle: "global-stops-tiles",
      symbol: "global-stops-symbol-tiles",
      triangle: "global-stops-triangles-tiles"
    };
    const STOP_TILES_ENABLED = false; // Temporarily disable tile mode to ensure stops load via GeoJSON
    let stopTilesAvailability = null;
    let stopTilesAvailabilityPromise = null;

    // IndexedDB-backed persistent cache (route overlays: shapes + stops)
    const OVERLAY_CACHE_TTL_MS = 30 * 60_000;
    const OVERLAY_PERSIST_TTL_MS = 12 * 60 * 60_000; // 12h persisted
    const OVERLAY_IDB_NAME = "carris-overlay-cache";
    const OVERLAY_IDB_STORE = "routeOverlays";
    let overlayDbPromise = null;

    function openOverlayDb() {
      if (overlayDbPromise) return overlayDbPromise;
      if (!("indexedDB" in window)) {
        overlayDbPromise = Promise.resolve(null);
        return overlayDbPromise;
      }
      overlayDbPromise = new Promise((resolve) => {
        const req = indexedDB.open(OVERLAY_IDB_NAME, 1);
        req.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(OVERLAY_IDB_STORE)) {
            db.createObjectStore(sOVERLAY_IDB_STORE, { keyPath: "key" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      });
      return overlayDbPromise;
    }

    async function readOverlayFromIdb(key) {
      try {
        const db = await openOverlayDb();
        if (!db) return null;
        return await new Promise((resolve) => {
          const tx = db.transaction([OVERLAY_IDB_STORE], "readonly");
          const store = tx.objectStore(OVERLAY_IDB_STORE);
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => resolve(null);
        });
      } catch (err) {
        return null;
      }
    }

    async function writeOverlayToIdb(key, payload) {
      try {
        const db = await openOverlayDb();
        if (!db) return;
        const record = { key, ts: Date.now(), payload };
        await new Promise((resolve) => {
          const tx = db.transaction([OVERLAY_IDB_STORE], "readwrite");
          const store = tx.objectStore(OVERLAY_IDB_STORE);
          store.put(record);
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
        });
      } catch (err) {
        /* ignore */
      }
    }



    function stopPixelSizeForZoom(z) {
      if (!Number.isFinite(z)) return 9;
      const t = Math.max(0, z - STOPS_MIN_ZOOM);
      const px = Math.round(4 + t * 3.8);
      return Math.max(4, Math.min(32, px));
    }

    function roundBoundsForStops(bounds, factor = GLOBAL_STOPS_KEY_PRECISION) {
      if (!bounds) return null;
      const round = (n) => Math.round(Number(n) * factor) / factor;
      return {
        minLat: round(bounds.minLat),
        minLon: round(bounds.minLon),
        maxLat: round(bounds.maxLat),
        maxLon: round(bounds.maxLon)
      };
    }

    function dynamicGlobalStopsLimit(z) {
      const minZ = STOPS_MIN_ZOOM;
      const maxZ = minZ + 4; // scale up over ~4 zoom levels
      const t = clampNumber((Number(z) - minZ) / (maxZ - minZ), 0, 1);
      const val = GLOBAL_STOPS_LIMIT_MIN + t * (GLOBAL_STOPS_LIMIT - GLOBAL_STOPS_LIMIT_MIN);
      return Math.round(val);
    }

    function stopKeyForStop(s) {
      const stopId = (s?.stop_id || "").trim();
      if (stopId) return `id:${stopId}`;
      const lat = Number(s?.stop_lat);
      const lon = Number(s?.stop_lon);
      if (Number.isFinite(lat) && Number.isFinite(lon)) return `c:${lat.toFixed(6)},${lon.toFixed(6)}`;
      return null;
    }

    function resetMapLibreStopOpacity() {
      if (!(adapter instanceof MapLibreAdapter) || !adapter.map) return;
      const map = adapter.map;
      const circle = Number(adapter._globalStopsCircleOpacity ?? 0.98);
      const icon = Number(adapter._globalStopsIconOpacity ?? 0.92);
      try { map.setPaintProperty("global-stops", "circle-opacity", circle); } catch (e) {}
      try { map.setPaintProperty("global-stops-symbol", "icon-opacity", circle); } catch (e) {}
      try { map.setPaintProperty("global-stops-triangles", "icon-opacity", icon); } catch (e) {}
      if (adapter.globalStopTilesEnabled) {
        try { map.setPaintProperty(STOP_TILE_LAYER_IDS.circle, "circle-opacity", circle); } catch (e) {}
        try { map.setPaintProperty(STOP_TILE_LAYER_IDS.symbol, "icon-opacity", circle); } catch (e) {}
        try { map.setPaintProperty(STOP_TILE_LAYER_IDS.triangle, "icon-opacity", icon); } catch (e) {}
      }
    }

    function fadeOutMapLibreStops() {
      if (!(adapter instanceof MapLibreAdapter) || !adapter.map) return;
      const map = adapter.map;
      if (mapLibreStopsFadeTimer) {
        clearTimeout(mapLibreStopsFadeTimer);
        mapLibreStopsFadeTimer = null;
      }
      try { map.setPaintProperty("global-stops", "circle-opacity", 0); } catch (e) {}
      try { map.setPaintProperty("global-stops-symbol", "icon-opacity", 0); } catch (e) {}
      try { map.setPaintProperty("global-stops-triangles", "icon-opacity", 0); } catch (e) {}
      if (adapter.globalStopTilesEnabled) {
        try { map.setPaintProperty(STOP_TILE_LAYER_IDS.circle, "circle-opacity", 0); } catch (e) {}
        try { map.setPaintProperty(STOP_TILE_LAYER_IDS.symbol, "icon-opacity", 0); } catch (e) {}
        try { map.setPaintProperty(STOP_TILE_LAYER_IDS.triangle, "icon-opacity", 0); } catch (e) {}
      }
      mapLibreStopsFadeTimer = setTimeout(() => {
        try { adapter.setGlobalStops({ stops: [] }); } catch (e) {}
        clearMapLibreStopLabels();
        mapLibreStopsFadeTimer = null;
      }, STOP_REMOVE_DELAY_MS + 40);
    }

    function clearMapLibreStopLabels() {
      for (const marker of mapLibreStopLabelMarkers.values()) {
        try {
          const el = marker.getElement?.();
          if (el) {
            el.classList.remove("stop-label--shown");
            el.classList.add("stop-label--hidden");
          }
          setTimeout(() => {
            try { marker.remove?.(); } catch (e) {}
          }, STOP_LABEL_FADE_MS + 40);
        } catch (e) {}
      }
      mapLibreStopLabelMarkers.clear();
    }

    function updateMapLibreStopLabels() {
      const m = (adapter instanceof MapLibreAdapter) ? adapter.map : (adapter?.getMap?.());
      if (!m || !(adapter instanceof MapLibreAdapter)) return;
      const zoom = Number(m.getZoom?.());

      if (!Number.isFinite(zoom) || zoom < STOP_LABEL_ZOOM_THRESHOLD) {
        clearMapLibreStopLabels();
        return;
      }

      const labelLayer = adapter.globalStopTilesEnabled ? STOP_TILE_LAYER_IDS.circle : "global-stops";
      const features = m.queryRenderedFeatures?.({ layers: [labelLayer] }) || [];
      const currentIds = new Set();

      features.forEach(f => {
        const stopId = f?.properties?.stop_id;
        if (!stopId) return;
        currentIds.add(stopId);

        if (!mapLibreStopLabelMarkers.has(stopId)) {
          const container = document.createElement("div");
          container.className = "stop-label-container stop-label--hidden";

          const marker = new maplibregl.Marker({
            element: container,
            anchor: "bottom",
            offset: [0, -10]
          })
            .setLngLat(f.geometry?.coordinates || [0, 0])
            .addTo(m);

          mapLibreStopLabelMarkers.set(stopId, marker);
          requestAnimationFrame(() => {
            container.classList.remove("stop-label--hidden");
            container.classList.add("stop-label--shown");
          });
          renderStopPillsAsync(stopId, container);
        } else {
          const el = mapLibreStopLabelMarkers.get(stopId)?.getElement?.();
          if (el) {
            el.classList.remove("stop-label--hidden");
            el.classList.add("stop-label--shown");
          }
        }
      });

      for (const [id, marker] of mapLibreStopLabelMarkers.entries()) {
        if (!currentIds.has(id)) {
          const el = marker.getElement?.();
          if (el) {
            el.classList.remove("stop-label--shown");
            el.classList.add("stop-label--hidden");
          }
          setTimeout(() => {
            try { marker.remove(); } catch (e) {}
            mapLibreStopLabelMarkers.delete(id);
          }, STOP_LABEL_FADE_MS + 40);
        }
      }
    }

    async function renderStopPillsAsync(stopId, container) {
      try {
        const routes = await ensureStopRoutes(stopId);
        if (!routes || routes.length === 0 || !container) return;
        const displayRoutes = routes;
        const pillsHtml = displayRoutes.map(routeLabel => {
          const { code } = parseRouteCodeParts(routeLabel);
          const style = pillStyleForRoute(routeLabel);
          const bg = style?.bg || "#444";
          const fg = style?.fg || "#fff";
          const border = style?.border || "rgba(0,0,0,0.2)";
          return `<span class="stop-label-pill-mini" style="background-color:${bg}; color:${fg}; border-color:${border}">${code}</span>`;
        }).join("");
        container.innerHTML = `<div class="stop-label-pills">${pillsHtml}</div>`;
        const pillsEl = container.querySelector?.(".stop-label-pills");
        if (pillsEl) {
          requestAnimationFrame(() => pillsEl.classList.add("stop-label-pills--visible"));
        }
      } catch (err) {
        console.warn("Erro ao carregar rotas para pill:", stopId);
      }
    }

    function cancelGlobalStopsFetch() {
      if (globalStopsAbort) {
        try { globalStopsAbort.abort(); } catch (e) {}
        globalStopsAbort = null;
      }
    }

    const scheduleRefreshStops = (() => {
      const debounced = debounce((force = false) => refreshGlobalStops(force).catch(() => {}), 220);
      return (force = false) => {
        cancelGlobalStopsFetch();
        debounced(force);
      };
    })();

    wireMapEvents().catch(() => {});
    prewarmStopTilesAvailability().catch(() => {});

    function activeVariantIdsForSelectedRoute() {
      if (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) return [];
      const out = new Set();
      const list = Array.isArray(lastVehicles) ? lastVehicles : [];
      for (const v of list) {
        const variantKey = normalizeOptionKey(v?.routeId || v?.routeLabel);
        if (!variantKey) continue;
        const baseKey = getBaseRouteKey(variantKey);
        if (baseKey && baseKey === selectedRoute) out.add(variantKey);
      }
      // If the feed didn't give us any active variants, fallback to what we know from the catalog.
      if (out.size === 0) {
        const entry = routeOptions.get(selectedRoute);
        const variants = entry?.variants ? Array.from(entry.variants.keys()) : [];
        variants.forEach(v => out.add(normalizeOptionKey(v)));
      }
      return Array.from(out).filter(Boolean).sort();
    }

    function resolveOverlayVariantIds() {
      if (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) return [];
      if (selectedVariant && selectedVariant !== VARIANT_FILTER_ALL) return [normalizeOptionKey(selectedVariant)];
      // "Todas as variantes": render every variant that currently has active vehicles.
      return activeVariantIdsForSelectedRoute();
    }

    function setVolumeMobileTab(target = "chart") {
      if (!chartOverlayContent) return;
      chartOverlayContent.classList.remove("show-chart", "show-table");
      if (target === "table") {
        chartOverlayContent.classList.add("show-table");
      } else {
        chartOverlayContent.classList.add("show-chart");
      }
      if (overlayTabChart && overlayTabTable) {
        overlayTabChart.classList.toggle("active", target !== "table");
        overlayTabTable.classList.toggle("active", target === "table");
      }
    }

    function updateVolumeOverlayLayout() {
      if (!chartOverlayContent) return;
      const width = chartOverlayContent.getBoundingClientRect().width || 0;
      const compact = width < 1160;
      if (compact) {
        chartOverlayContent.classList.add("volume-tight");
      } else {
        chartOverlayContent.classList.remove("volume-tight");
      }
      const mobileTabs = width < 860;
      chartOverlayContent.classList.toggle("mobile-tabs", mobileTabs);
      if (mobileTabs) {
        if (!chartOverlayContent.classList.contains("show-chart") && !chartOverlayContent.classList.contains("show-table")) {
          setVolumeMobileTab("chart");
        }
      } else {
        chartOverlayContent.classList.remove("show-chart", "show-table");
        if (overlayTabChart && overlayTabTable) {
          overlayTabChart.classList.remove("active");
          overlayTabTable.classList.remove("active");
        }
      }
    }

    function normalizeHexColor(color) {
      if (!color) return null;
      const trimmed = color.trim().replace("#", "");
      if (!/^[0-9a-fA-F]{6}$/.test(trimmed)) return null;
      return `#${trimmed.toUpperCase()}`;
    }

    function hexToRgba(hex, alpha = 1) {
      const normalized = normalizeHexColor(hex);
      if (!normalized) return `rgba(245, 159, 0, ${alpha})`;
      const r = parseInt(normalized.slice(1, 3), 16);
      const g = parseInt(normalized.slice(3, 5), 16);
      const b = parseInt(normalized.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function resolveOverlayPrimaryLabel() {
      if (selectedVariant && selectedVariant !== VARIANT_FILTER_ALL) {
        const variantLabel = routeOptions.get(selectedRoute)?.variants?.get(selectedVariant);
        return variantLabel || selectedVariant || selectedRoute;
      }
      if (selectedRoute && selectedRoute !== ROUTE_FILTER_ALL) {
        const entry = routeOptions.get(selectedRoute);
        return entry?.label || selectedRoute;
      }
      return null;
    }

    function resolveOverlayZoneInfo() {
      const label = resolveOverlayPrimaryLabel();
      if (!label) return { zone: null, color: null };
      const byLabel = resolveRouteZone(label);
      if (byLabel.zone && byLabel.color) return byLabel;
      const base = getBaseRouteKey(label);
      const entry = base ? routeOptions.get(base) : null;
      const zone = entry?.zones ? Array.from(entry.zones)[0] : null;
      return { zone: zone || null, color: zone ? getZoneColor(zone) : null };
    }

    function applyVolumeOverlayTint() {
      const { color } = resolveOverlayZoneInfo();
      const tint = normalizeHexColor(color) || "#f59f00";
      const soft = hexToRgba(tint, 0.12);
      const ultra = hexToRgba(tint, 0.04);
      if (chartOverlayContent) {
        chartOverlayContent.style.setProperty("--overlay-tint", tint);
        chartOverlayContent.style.setProperty("--overlay-tint-soft", soft);
        chartOverlayContent.style.setProperty("--overlay-tint-ultra", ultra);
      }
      if (chartOverlayVisual) {
        chartOverlayVisual.style.background = `radial-gradient(130% 130% at 18% 16%, ${soft}, ${ultra})`;
        chartOverlayVisual.style.borderColor = hexToRgba(tint, 0.35);
      }
      if (chartOverlayExtra && chartOverlayContent?.classList.contains("volume-layout")) {
        chartOverlayExtra.style.background = `linear-gradient(160deg, ${soft}, transparent 46%), var(--surface-1)`;
        chartOverlayExtra.style.borderColor = hexToRgba(tint, 0.24);
      }
      if (overlayTabChart && overlayTabTable) {
        const activeBg = hexToRgba(tint, 0.16);
        const border = hexToRgba(tint, 0.24);
        const fg = readableTextColor(tint, "#8d5a00");
        overlayTabChart.style.setProperty("--overlay-tab-active-bg", activeBg);
        overlayTabChart.style.setProperty("--overlay-tab-border", border);
        overlayTabChart.style.setProperty("--overlay-tab-fg", fg);
        overlayTabTable.style.setProperty("--overlay-tab-active-bg", activeBg);
        overlayTabTable.style.setProperty("--overlay-tab-border", border);
        overlayTabTable.style.setProperty("--overlay-tab-fg", fg);
      }
      const pill = document.querySelector(".overlay-pill");
      if (pill) {
        pill.style.setProperty("--overlay-pill-bg", hexToRgba(tint, 0.14));
        pill.style.setProperty("--overlay-pill-border", hexToRgba(tint, 0.22));
      }
    }

    function resetOverlayTint() {
      if (chartOverlayContent) {
        chartOverlayContent.style.setProperty("--overlay-tint", "#f59f00");
        chartOverlayContent.style.setProperty("--overlay-tint-soft", "rgba(245, 159, 0, 0.12)");
        chartOverlayContent.style.setProperty("--overlay-tint-ultra", "rgba(15, 23, 42, 0.02)");
      }
      if (chartOverlayVisual) {
        chartOverlayVisual.style.background = "radial-gradient(120% 120% at 20% 18%, rgba(245, 159, 0, 0.12), rgba(15, 23, 42, 0.02))";
        chartOverlayVisual.style.borderColor = "rgba(245, 159, 0, 0.24)";
      }
      if (chartOverlayExtra) {
        chartOverlayExtra.style.background = "var(--surface-1)";
        chartOverlayExtra.style.borderColor = "var(--border-strong)";
      }
      const pill = document.querySelector(".overlay-pill");
      if (pill) {
        pill.style.removeProperty("--overlay-pill-bg");
        pill.style.removeProperty("--overlay-pill-border");
      }
    }

    function shapeEndpoints(routeId) {
      const encoded = encodeURIComponent(String(routeId || ""));
      return (LOCAL_BACKENDS || []).map(base => `${base}/api/shapes/${encoded}`);
    }

    function routeCategoryForId(routeId) {
      const normalized = normalizeOptionKey(routeId);
      const base = getBaseRouteKey(normalized);
      const displayLabel = resolvePublicRouteLabel(normalized);
      const category = definirCategoria(displayLabel || normalized || base);
      const baseCategory = definirCategoria(base || normalized);
      // If short name exists, trust it first; only fall back to base category when we couldn't classify.
      return category || baseCategory;
    }

    function routeDirectionColor(routeId, directionId) {
      const category = routeCategoryForId(routeId);
      const style = pickCategoryStyle(category, directionId, { allowDirection: true });
      return style.color;
    }

	    function serverDirectionForClientDirection(directionId) {
	      // Use the same direction id for both vehicles and overlays.
	      return directionId;
	    }

    function stopsEndpoints(routeId) {
      const encoded = encodeURIComponent(String(routeId || ""));
      return (LOCAL_BACKENDS || []).map(base => `${base}/api/stops/${encoded}`);
    }

    function stopsTileTemplates() {
      return dedupeList((LOCAL_BACKENDS || []).map(base => `${base}/api/tiles/stops/{z}/{x}/{y}.pbf`));
    }

    function prewarmStopTilesAvailability() {
      if (!STOP_TILES_ENABLED) {
        stopTilesAvailability = false;
        stopTilesAvailabilityPromise = Promise.resolve(false);
        return stopTilesAvailabilityPromise;
      }
      if (stopTilesAvailabilityPromise) return stopTilesAvailabilityPromise;
      stopTilesAvailabilityPromise = (async () => {
        const templates = stopsTileTemplates();
        if (!templates.length) {
          stopTilesAvailability = false;
          return stopTilesAvailability;
        }
        const sample = templates[0].replace("{z}", "12").replace("{x}", "1944").replace("{y}", "1568");
        try {
          const resp = await fetch(sample, { method: "HEAD", cache: "no-store" });
          stopTilesAvailability = resp.ok;
        } catch (err) {
          stopTilesAvailability = false;
        }
        return stopTilesAvailability;
      })();
      return stopTilesAvailabilityPromise;
    }

    function routeDetailEndpoints(routeId, dateStr) {
      const encoded = encodeURIComponent(String(routeId || ""));
      const day = dateStr || new Date().toISOString().split("T")[0];
      return VEHICLE_DAY_ENDPOINTS.map(base => `${base}?date=${encodeURIComponent(day)}&line_id=${encoded}`);
    }

    async function fetchRouteOverlayPayload(routeIds, { forceNetwork = false, signal } = {}) {
      const now = Date.now();
      const ids = normalizeOverlayIds(routeIds);
      const cacheKey = JSON.stringify({ ids });
      const cached = overlayCache.get(cacheKey);
      if (!forceNetwork && cached && (now - cached.ts) < OVERLAY_CACHE_TTL_MS) {
        return cached.payload;
      }

      // Persistent cache: return quickly if present (and reasonably fresh)
      if (!forceNetwork) {
        const stored = await readOverlayFromIdb(cacheKey);
        if (stored && stored.payload && (now - (stored.ts || 0)) < OVERLAY_PERSIST_TTL_MS) {
          overlayCache.set(cacheKey, { ts: stored.ts || now, payload: stored.payload });
          return stored.payload;
        }
      }

      const shapes = [];
      const stops = [];
      const seenStops = new Set();
      const tasks = [];

      for (const routeId of ids) {
        for (const dirId of OVERLAY_DIRECTIONS) {
          const color = routeDirectionColor(routeId, dirId);
          tasks.push((async () => {
            const [shapeResult, stopsResult] = await Promise.allSettled([
              fetchFromEndpoints(
                shapeEndpoints(routeId),
                { direction: String(serverDirectionForClientDirection(dirId)) },
                { signal }
              ),
              fetchFromEndpoints(
                stopsEndpoints(routeId),
                { direction: String(serverDirectionForClientDirection(dirId)), limit: "220" },
                { signal }
              )
            ]);
            if (shapeResult.status === "fulfilled" && shapeResult.value && shapeResult.value.type) {
              shapes.push({ routeId, directionId: dirId, color, geojson: shapeResult.value });
            }
            if (stopsResult.status === "fulfilled") {
              const list = Array.isArray(stopsResult.value) ? stopsResult.value : [];
              for (const s of list) {
                const key = `${s?.stop_id || ""}|${Number(s?.stop_lat).toFixed(6)}|${Number(s?.stop_lon).toFixed(6)}|${dirId}|${routeId}`;
                if (seenStops.has(key)) continue;
                seenStops.add(key);
                stops.push({ ...s, routeId, directionId: dirId, color });
              }
            }
          })());
        }
      }

      let fetchFailed = false;
      try {
        await Promise.allSettled(tasks);
      } catch (err) {
        fetchFailed = true;
      }

      if (signal?.aborted) {
        if (fetchFailed && cached?.payload) return cached.payload;
        return cached?.payload || null;
      }

      const payload = { routeIds: ids, shapes, stops };
      overlayCache.set(cacheKey, { ts: now, payload });
      writeOverlayToIdb(cacheKey, payload);

      if (fetchFailed && cached?.payload) return cached.payload;
      return payload;
    }

    const routeOverlayPrefetchSet = new Set();

    let routeOverlayPrefetchAbortController = null;

    function cancelRouteOverlayPrefetch() {
      if (routeOverlayPrefetchAbortController) {
        routeOverlayPrefetchAbortController.abort();
        routeOverlayPrefetchAbortController = null;
      }
    }

    function overlayVariantIdsFromLabel(label) {
      const normalized = normalizeOptionKey(label);
      if (!normalized) return [];
      const candidates = new Set();
      const baseId =
        resolveBaseIdFromLabel(normalized) ||
        resolveRouteInputValue(normalized) ||
        getBaseRouteKey(normalized) ||
        "";
      const entry = routeOptions.get(baseId);
      if (entry && entry.variants) {
        for (const variantId of entry.variants.keys()) {
          const candidate = normalizeOptionKey(variantId);
          if (candidate) candidates.add(candidate);
        }
      }
      if (!candidates.size) {
        candidates.add(normalizeOptionKey(normalized));
        if (baseId && baseId !== ROUTE_FILTER_ALL) {
          const baseCandidate = normalizeOptionKey(baseId);
          if (baseCandidate) candidates.add(baseCandidate);
        }
      }
      return Array.from(candidates);
    }

    function collectOverlayVariantIds(labels) {
      const list = Array.isArray(labels) ? labels : [labels];
      const ids = new Set();
      list.forEach(label => {
        overlayVariantIdsFromLabel(label).forEach(id => ids.add(id));
      });
      return Array.from(ids);
    }

    async function prewarmRouteOverlayForIds(routeIds = []) {
      const normalized = normalizeOverlayIds(routeIds);
      if (!normalized.length) return;
      const unseen = normalized.filter(id => !routeOverlayPrefetchSet.has(id));
      if (!unseen.length) return;
      unseen.forEach(id => routeOverlayPrefetchSet.add(id));
      cancelRouteOverlayPrefetch();
      const controller = new AbortController();
      routeOverlayPrefetchAbortController = controller;
      try {
        await fetchRouteOverlayPayload(unseen, { signal: controller.signal });
      } catch (err) {
        // Ignore failures to keep popup interactions fast.
      } finally {
        if (routeOverlayPrefetchAbortController === controller) {
          routeOverlayPrefetchAbortController = null;
        }
      }
    }

    function prewarmRouteOverlayForRouteLabels(labels) {
      const ids = collectOverlayVariantIds(labels);
      if (!ids.length) return Promise.resolve();
      return prewarmRouteOverlayForIds(ids);
    }

    function prewarmRouteOverlayForVehicle(vehicle) {
      if (!vehicle) return Promise.resolve();
      const candidates = [];
      if (vehicle.routeId) candidates.push(vehicle.routeId);
      if (vehicle.routeLabel) candidates.push(vehicle.routeLabel);
      if (vehicle.route) candidates.push(vehicle.route);
      if (vehicle.linha) candidates.push(vehicle.linha);
      if (vehicle.line_id) candidates.push(vehicle.line_id);
      if (vehicle.linha_id) candidates.push(vehicle.linha_id);
      return prewarmRouteOverlayForRouteLabels(candidates);
    }

    async function refreshRouteOverlay(force = false) {
      cancelRouteOverlayPrefetch();
      const ids = normalizeOverlayIds(resolveOverlayVariantIds());
      const wantKey = ids.length ? JSON.stringify(ids) : null;

      if (!wantKey) {
        if (currentOverlayKey) {
          currentOverlayKey = null;
          currentOverlayFitKey = null;
          adapter?.clearOverlay?.();
        }
        return;
      }

      if (!force && currentOverlayKey === wantKey) return;
      currentOverlayKey = wantKey;

      // Prevent overlapping refreshes for rapid filter changes.
      if (overlayInflight) return;
      overlayInflight = (async () => {
        try {
          if (adapter.ready instanceof Promise) await adapter.ready;
          const payload = await fetchRouteOverlayPayload(ids);
          const shouldFit = currentOverlayFitKey !== wantKey;
          adapter?.setRouteOverlay?.(payload, { fit: shouldFit });
          if (shouldFit) currentOverlayFitKey = wantKey;
        } catch (err) {
          console.warn("Falha ao carregar overlay de rota:", err);
        } finally {
          overlayInflight = null;
        }
      })();
    }

    function stopsBboxEndpoints() {
      return (LOCAL_BACKENDS || []).map(base => `${base}/api/stops_bbox`);
    }

    function stopRoutesEndpoints(stopId) {
      const encoded = encodeURIComponent(String(stopId || ""));
      return (LOCAL_BACKENDS || []).map(base => `${base}/api/stop_routes/${encoded}`);
    }

    const stopRoutesCache = new Map(); // stop_id -> [routeShortNames]
    const stopRoutesInflight = new Map(); // stop_id -> Promise

    async function ensureStopRoutes(stopId) {
      const key = String(stopId || "");
      if (!key) return [];
      if (stopRoutesCache.has(key)) return stopRoutesCache.get(key) || [];
      const inflight = stopRoutesInflight.get(key);
      if (inflight) return inflight;
      const promise = (async () => {
        try {
          const payload = await fetchFromEndpoints(stopRoutesEndpoints(key), {});
          const routes = Array.isArray(payload?.routes) ? payload.routes : [];
          stopRoutesCache.set(key, routes);
          return routes;
        } catch (err) {
          return [];
        } finally {
          stopRoutesInflight.delete(key);
        }
      })();
      stopRoutesInflight.set(key, promise);
      return promise;
    }

    const GTFS_TRIPS_ENDPOINTS = (LOCAL_BACKENDS || []).map(base => `${base}/api/gtfs/trips`);
    const GTFS_STOP_TIMES_ENDPOINTS = (LOCAL_BACKENDS || []).map(base => `${base}/api/gtfs/stop_times`);
    const TRIPS_CACHE_TTL_MS = 10 * 60_000;
    const STOP_TIMES_CACHE_TTL_MS = 3 * 60_000;
    const STOP_SCHEDULE_LIMIT = 10;
    const tripsCache = new Map(); // route|direction|shape -> { ts, trips }
    const tripsInflight = new Map(); // cacheKey -> Promise
    const stopTimesCache = new Map(); // stop_id -> { ts, rows }
    const stopTimesInflight = new Map(); // stop_id -> Promise
    const STOP_SCHEDULE_CACHE_TTL_MS = 20_000;
    const stopScheduleCache = new Map(); // "{stopId}|{contextKey}" -> { ts, schedule }
    let stopScheduleRequestSeq = 0;
    const stopScheduleTracker = new Map(); // stop_id -> { requestId, contextKey }
    let activeStopPopup = null; // { stopId, stopName, target }

    function buildScheduleContextKey() {
      return "all-routes";
    }

    function stopScheduleCacheKey(stopId, contextKey) {
      const id = (stopId == null) ? "" : String(stopId).trim();
      if (!id) return null;
      const ctx = (contextKey == null) ? "" : String(contextKey);
      return `${id}|${ctx}`;
    }

    function readStopScheduleCache(stopId, contextKey) {
      const key = stopScheduleCacheKey(stopId, contextKey);
      if (!key) return null;
      const entry = stopScheduleCache.get(key);
      if (!entry) return null;
      if ((Date.now() - entry.ts) > STOP_SCHEDULE_CACHE_TTL_MS) {
        stopScheduleCache.delete(key);
        return null;
      }
      return entry.schedule;
    }

    function writeStopScheduleCache(stopId, contextKey, schedule) {
      const key = stopScheduleCacheKey(stopId, contextKey);
      if (!key || !schedule) return;
      stopScheduleCache.set(key, { ts: Date.now(), schedule });
    }

    function resolveActiveRouteContext() {
      return { routeId: null, directionId: null, shapeId: null };
    }

    function resolveRouteFilter() {
      // Use the route that est ativa no contexto (flutuante): variante preferida, seno base.
      if (selectedVariant && selectedVariant !== VARIANT_FILTER_ALL) return selectedVariant;
      if (selectedRoute && selectedRoute !== ROUTE_FILTER_ALL) return selectedRoute;
      return null;
    }

    function refreshActiveStopSchedule() {
      if (!activeStopPopup) return;
      const { stopId, stopName, target } = activeStopPopup;
      if (!stopId || !target) return;
      hydrateStopPopup(target, { stopId, stopName }).catch(() => {});
    }

    function normalizeDirectionId(value) {
      const num = Number.parseInt(String(value), 10);
      return Number.isFinite(num) ? num : null;
    }

    function timeToSeconds(value) {
      if (value == null) return NaN;
      const parts = String(value).trim().split(":");
      if (parts.length < 2) return NaN;
      const h = Number.parseInt(parts[0], 10);
      const m = Number.parseInt(parts[1], 10);
      const s = Number.parseInt(parts[2] ?? "0", 10);
      if (![h, m, s].every(Number.isFinite)) return NaN;
      if (m < 0 || m >= 60 || s < 0 || s >= 60) return NaN;
      return h * 3600 + m * 60 + s;
    }

    function formatSecondsToClock(seconds) {
      if (!Number.isFinite(seconds)) return "";
      const totalMinutes = Math.floor(seconds / 60);
      const mins = totalMinutes % 60;
      const hours = Math.floor(totalMinutes / 60);
      const hh = String(Math.max(0, hours)).padStart(2, "0");
      const mm = String(Math.max(0, mins)).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function getNowSeconds() {
      const now = new Date();
      return now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
    }

    async function fetchStopTimesForStop(stopId) {
      const key = (stopId == null) ? "" : String(stopId);
      if (!key) return [];
      const now = Date.now();
      const cached = stopTimesCache.get(key);
      if (cached && (now - cached.ts) < STOP_TIMES_CACHE_TTL_MS) return cached.rows;
      const inflight = stopTimesInflight.get(key);
      if (inflight) return inflight;
      const promise = (async () => {
        let rows = [];
        try {
          const payload = await fetchFromEndpoints(GTFS_STOP_TIMES_ENDPOINTS, { stop_id: key, limit: "5000" });
          rows = Array.isArray(payload) ? payload : [];
        } catch (err) {
          console.warn("Falha ao carregar stop_times GTFS:", err);
          rows = [];
        }
        stopTimesCache.set(key, { ts: Date.now(), rows });
        return rows;
      })();
      stopTimesInflight.set(key, promise);
      try {
        return await promise;
      } finally {
        stopTimesInflight.delete(key);
      }
    }

    function computeUpcomingDepartures(stopTimes, routeFilter, nowSeconds, limit = STOP_SCHEDULE_LIMIT) {
      const byKey = new Map();
      const routeFilterBase = routeFilter ? getBaseRouteKey(routeFilter) : "";
      for (const st of Array.isArray(stopTimes) ? stopTimes : []) {
        const tripId = st?.trip_id ?? st?.tripId ?? st?.tripID;
        const rawTime = st?.arrival_time ?? st?.departure_time ?? st?.arrivalTime ?? st?.departureTime;
        const seconds = timeToSeconds(rawTime);
        if (!Number.isFinite(seconds)) continue;
        if (seconds < nowSeconds) continue;
        const routeId = st?.route_id ?? st?.routeId ?? "";
        const routeBase = routeId ? getBaseRouteKey(routeId) : "";
        const directionId = normalizeDirectionId(st?.direction_id ?? st?.directionId ?? st?.direction);
        if (routeFilter) {
          const match =
            routeId === routeFilter ||
            routeBase && routeBase === routeFilter ||
            routeFilterBase && (routeId === routeFilterBase || routeBase === routeFilterBase);
          if (!match) continue;
        }
        const key = `route:${routeId || "?"}|${directionId ?? "x"}|${seconds}`;
        const existing = byKey.get(key);
        if (existing) {
          existing.count += 1;
          if (tripId) existing.tripIds.add(String(tripId));
        } else {
          byKey.set(key, {
            tripIds: new Set(tripId ? [String(tripId)] : []),
            seconds,
            rawTime,
            routeId,
            directionId,
            count: 1
          });
        }
      }
      const rows = Array.from(byKey.values()).map(item => ({
        tripIds: Array.from(item.tripIds),
        seconds: item.seconds,
        rawTime: item.rawTime,
        routeId: item.routeId,
        directionId: item.directionId,
        count: item.count
      }));
      rows.sort((a, b) => a.seconds - b.seconds);
      return rows.slice(0, limit);
    }

    function initialScheduleStateForContext() {
      return { status: "loading" };
    }

    async function requestStopSchedule(stopId, options = {}) {
      const contextKey = options.contextKey ?? buildScheduleContextKey();
      const key = (stopId == null) ? "" : String(stopId);
      if (!key) return { status: "idle", contextKey };
      const requestId = ++stopScheduleRequestSeq;
      stopScheduleTracker.set(key, { requestId, contextKey });
      try {
        const stopTimes = await fetchStopTimesForStop(key);
        const nowSeconds = getNowSeconds();
        const routeFilter = resolveRouteFilter();
        const upcoming = computeUpcomingDepartures(stopTimes, routeFilter, nowSeconds, STOP_SCHEDULE_LIMIT);
        const latest = stopScheduleTracker.get(key);
        if (!latest || latest.requestId !== requestId || latest.contextKey !== contextKey) return null;
        const departures = upcoming.map(item => ({
          ...item,
          clock: formatSecondsToClock(item.seconds),
          etaMinutes: Math.max(0, Math.round((item.seconds - nowSeconds) / 60))
        }));
        const scheduleResult = {
          status: departures.length ? "success" : "empty",
          departures,
          contextKey
        };
        writeStopScheduleCache(key, contextKey, scheduleResult);
        return scheduleResult;
      } catch (err) {
        const latest = stopScheduleTracker.get(key);
        if (!latest || latest.requestId !== requestId || latest.contextKey !== contextKey) return null;
        console.warn("Falha ao calcular horrios para a paragem:", stopId, err);
        return { status: "empty", contextKey };
      }
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function escapeRegex(value) {
      return String(value ?? "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function pillBgForCategory(category) {
      if (category === "Autocarros Diurnos") return "#2ecc71";
      if (category === "Carreiras de Bairro") return "#c084fc";
      if (category === "Eltricos") return "#f39c12";
      if (category === "Rede Madrugada") return "#3498db";
      return "#e2e8f0";
    }

    function resolveRouteZone(label) {
      const zone = definirZona(label);
      const color = getZoneColor(zone);
      return { zone: zone || null, color: color || null };
    }

    function normalizeOverlayIds(list) {
      if (!Array.isArray(list)) return [];
      const uniq = Array.from(new Set(list.map(v => (v == null ? "" : String(v)))));
      return uniq.filter(Boolean).sort();
    }

    function readableTextColor(bg, fallback = "#ffffff") {
      if (!bg || typeof bg !== "string") return fallback;
      const hex = bg.replace("#", "").trim();
      if (hex.length !== 6) return fallback;
      const r = parseInt(hex.slice(0, 2), 16);
      const g = parseInt(hex.slice(2, 4), 16);
      const b = parseInt(hex.slice(4, 6), 16);
      if ([r, g, b].some(v => Number.isNaN(v))) return fallback;
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.65 ? "#0f172a" : "#ffffff";
    }

    function pillStyleForRoute(label) {
      const { zone, color } = resolveRouteZone(label);
      const cat = categoryForRouteLabel(label) || definirCategoria(label);
      const bg = color || pillBgForCategory(cat);
      const fg = color ? "#ffffff" : "#0b1220";
      const border = color || "rgba(15, 23, 42, 0.12)";
      const title = zone || cat || "Carreira";
      return { bg, fg, border, title, zone };
    }

    function categoryForRouteLabel(label) {
      const text = (label || "").trim();
      if (!text) return null;
      // Use displayed label; do not trust internal ids.
      return definirCategoria(text);
    }

	    function routePillsHtml(routes, selected = null) {
	      const list = Array.isArray(routes) ? routes : [];
	      const selectedNorm = normalizeRouteKey(selected || "");
	      const selectedBase = getBaseRouteKey(selectedNorm);
	      const selectedCode = parseRouteCodeParts(selectedNorm).code.toUpperCase?.() || selectedNorm.toUpperCase?.() || "";
	      const selectedBaseCode = parseRouteCodeParts(selectedBase).code.toUpperCase?.() || selectedBase.toUpperCase?.() || "";
	      if (!list.length) {
	        return `<span class="route-pill" style="--pill-bg:#e2e8f0"></span>`;
	      }
	      return list.map(r => {
	        const label = (r == null) ? "" : String(r).trim();
	        if (!label) return "";
	        const style = pillStyleForRoute(label);
	        const safeLabel = escapeHtml(label);
	        const safeTitle = escapeHtml(style.title || label);
	        const code = parseRouteCodeParts(label).code.toUpperCase?.() || label.toUpperCase?.() || "";
	        const base = getBaseRouteKey(label);
	        const baseCode = parseRouteCodeParts(base).code.toUpperCase?.() || base.toUpperCase?.() || "";
	        const active = Boolean(
	          (selectedCode && code && selectedCode === code) ||
	          (selectedBaseCode && code && selectedBaseCode === code) ||
	          (selectedCode && baseCode && selectedCode === baseCode) ||
	          (selectedBase && selectedBase === base)
	        );
	        const activeClass = active ? " route-pill--active" : "";
	        return `<span class="route-pill route-pill--clickable${activeClass}" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}" title="${safeTitle}" role="button" tabindex="0" data-route-label="${safeLabel}">${safeLabel}</span>`;
	      }).filter(Boolean).join("");
	    }

    function formatEtaLabel(etaMinutes, clock) {
      if (!Number.isFinite(etaMinutes)) return escapeHtml(clock || "");
      if (etaMinutes <= 0) return "Agora";
      if (etaMinutes < 60) return `${etaMinutes} min`;
      return escapeHtml(clock || "");
    }

    function renderStopSchedule(schedule = { status: "idle" }) {
      const status = schedule?.status || "idle";
      if (status === "loading") return `<div class="stop-schedule__loading">A carregar horrios</div>`;
      if (status === "error") return `<div class="stop-schedule__empty">No foi possvel carregar horrios.</div>`;
      const departures = Array.isArray(schedule?.departures) ? schedule.departures : [];
      if (!departures.length) return `<div class="stop-schedule__empty">Sem partidas programadas</div>`;
      return `<div class="stop-schedule__list">` + departures.map(dep => {
        const etaLabel = formatEtaLabel(dep.etaMinutes, dep.clock || dep.rawTime || formatSecondsToClock(dep.seconds));
        const displayLabel = resolvePublicRouteLabel(dep.routeId || dep.routeLabel || "") || dep.routeId || dep.routeLabel || "";
        const style = pillStyleForRoute(displayLabel);
        const routeCode = parseRouteCodeParts(displayLabel).code || displayLabel || "";
        const pill = `<span class="route-pill pill--tiny" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}">${escapeHtml(routeCode)}</span>`;
        const dirLabel = directionDisplayLabel(dep.routeId || dep.routeLabel || "", dep.directionId);
        const dirText = dirLabel ? dirLabel.replace(/^\s*Sentido:\s*/i, "").trim() : "";
        const dirHtml = dirText ? `<span class="stop-schedule__dir">${escapeHtml(dirText)}</span>` : "";
        return `<div class="stop-schedule__row"><div class="stop-schedule__info">${pill}${dirHtml}</div><span class="stop-schedule__time">${escapeHtml(etaLabel)}</span></div>`;
      }).join("") + `</div>`;
    }

    function stopPopupHtml({ stopName, stopId, routes, loading = false, schedule } = {}) {
      const title = (stopName || "Paragem").trim();
      const meta = (stopId || "").trim();
      const pills = loading
        ? `<span class="route-pill route-pill--loading">a carregar</span>`
        : routePillsHtml(routes, resolveRouteFilter());
      const scheduleState = schedule || { status: "loading" };
      const safeMeta = escapeHtml(meta);
      return `
        <div class="stop-popup stop-popup--compact">
          <div class="stop-popup__title">${title}</div>
          <div class="stop-popup__meta">${safeMeta}</div>
          <div class="pill-row">${pills}</div>
          <div class="stop-schedule" data-stop-id="${safeMeta}">${renderStopSchedule(scheduleState)}</div>
        </div>
      `;
    }

    function showMobileStopCard({ stopName, stopId, schedule, routes }) {
      const card = document.getElementById("mobile-stop-card");
      const title = document.getElementById("mobile-stop-title");
      const meta = document.getElementById("mobile-stop-meta");
      const schedEl = document.getElementById("mobile-stop-schedule");
      const pillsEl = document.getElementById("mobile-stop-pills");
      if (!card || !title || !meta || !schedEl) return;
      title.textContent = stopName || "Paragem";
      meta.textContent = stopId || "";
      schedEl.innerHTML = renderStopSchedule(schedule || { status: "loading" });
      if (pillsEl) {
        pillsEl.innerHTML = routePillsHtml(routes || [], resolveRouteFilter());
        wireStopPopupPills(pillsEl);
      }
      card.classList.add("visible");
      document.body.classList.add("mobile-stop-open");
      const panel = document.getElementById("kpi-panel");
      if (panel) panel.style.display = "none";
    }

    function hideMobileStopCard() {
      const card = document.getElementById("mobile-stop-card");
      if (card) card.classList.remove("visible");
      document.body.classList.remove("mobile-stop-open");
      activeStopPopup = null;
      setHashFocus(null);
      if (adapter?.map && adapter.map.closePopup) {
        try { adapter.map.closePopup(); } catch (e) {}
      }
      const panel = document.getElementById("kpi-panel");
      if (panel) panel.style.display = "";
    }

    let searchDesktopStopPopup = null;

    function closeDesktopStopPopup() {
      if (!searchDesktopStopPopup) return;
      try {
        searchDesktopStopPopup.remove();
      } catch (e) {}
      searchDesktopStopPopup = null;
    }

    function createDesktopStopPopupTarget({ stopId, stopName, lat, lon }) {
      if (!adapter?.map) return null;
      const parsedLat = Number(lat);
      const parsedLon = Number(lon);
      if (!Number.isFinite(parsedLat) || !Number.isFinite(parsedLon)) return null;
      closeDesktopStopPopup();
      if (adapter instanceof LeafletAdapter) {
        const popup = L.popup({ ...popupPanOptions(), className: "custom-popup" })
          .setLatLng([parsedLat, parsedLon])
          .setContent("")
          .openOn(adapter.map);
        try { ensurePopupVisible(popup.getLatLng(), adapter.map); } catch (e) {}
        searchDesktopStopPopup = popup;
        return popup;
      }
      if (adapter instanceof MapLibreAdapter && typeof maplibregl !== "undefined") {
        const popup = new maplibregl.Popup({ offset: 18, className: "custom-popup" })
          .setLngLat([parsedLon, parsedLat])
          .addTo(adapter.map);
        try { ensurePopupVisible(popup.getLngLat(), adapter.map); } catch (e) {}
        popup.on("close", () => {
          if (searchDesktopStopPopup === popup) searchDesktopStopPopup = null;
        });
        searchDesktopStopPopup = popup;
        return popup;
      }
      return null;
    }

    const mobileStopClose = document.getElementById("mobile-stop-close");
    if (mobileStopClose) {
      mobileStopClose.addEventListener("click", () => hideMobileStopCard());
    }

    function applyStopPopupContent(target, params = {}) {
      if (!target) return;
      const html = stopPopupHtml(params);
      if (typeof target.setPopupContent === "function") {
        target.setPopupContent(html);
      } else if (typeof target.setHTML === "function") {
        target.setHTML(html);
      } else if (typeof target.setContent === "function") {
        target.setContent(html);
      }
      const el =
        target?.getPopup?.()?.getElement?.() ||
        target?.getElement?.() ||
        target?._contentNode ||
        null;
      // No mobile: no abrir tooltip, usamos o carto.
      if (isMobileViewport()) {
        try { target.closePopup?.(); } catch (e) {}
        if (el) el.style.display = "none";
      } else {
        try { wireStopPopupPills(el); } catch (e) {}
      }
    }

    async function hydrateStopPopup(target, { stopId, stopName } = {}) {
      const stopKey = (stopId == null) ? "" : String(stopId);
      const contextKey = buildScheduleContextKey();
      const cachedSchedule = stopKey ? readStopScheduleCache(stopKey, contextKey) : null;
      let scheduleState = cachedSchedule || initialScheduleStateForContext();
      const initialLoading = !Boolean(cachedSchedule);
      applyStopPopupContent(target, { stopName, stopId, loading: initialLoading, routes: [], schedule: scheduleState });
      if (!stopId) return;
      const routesPromise = ensureStopRoutes(stopId);
      const schedulePromise = requestStopSchedule(stopId, { contextKey });
      let routes = [];
      try {
        routes = await routesPromise;
      } catch (err) {
        routes = [];
      }
      try {
        const resolved = await schedulePromise;
        if (resolved) {
          scheduleState = resolved;
        } else if (scheduleState?.status === "loading") {
          scheduleState = { status: "error" };
        }
      } catch (err) {
        if (scheduleState?.status === "loading") {
          scheduleState = { status: "error" };
        }
      }
      applyStopPopupContent(target, { stopName, stopId, routes, loading: false, schedule: scheduleState });
      prewarmRouteOverlayForRouteLabels(routes).catch(() => {});
      if (isMobileViewport()) {
        showMobileStopCard({ stopName, stopId, schedule: scheduleState, routes });
      }
      activeStopPopup = { stopId, stopName, target };
    }

    function resolveBaseIdFromLabel(label) {
      const normalized = (label || "").trim();
      if (!normalized) return null;
      const { code } = parseRouteCodeParts(normalized);
      if (code) {
        const upperCode = code.toUpperCase();
        for (const [baseId, data] of routeOptions.entries()) {
          const entryLabel = data?.label || baseId;
          const entryCode = parseRouteCodeParts(entryLabel).code;
          if (entryCode && entryCode.toUpperCase() === upperCode) {
            return baseId;
          }
        }
      }
      return baseIdForPublicRouteLabel(normalized) || resolveRouteInputValue(normalized);
    }

    function baseIdForPublicRouteLabel(label) {
      const needle = (label || "").trim().toLowerCase();
      if (!needle) return null;

      // 1) Exact match against the translator base map (fast).
      for (const [baseId, shortName] of Object.entries(ROUTE_TRANSLATOR.base || {})) {
        if (!shortName) continue;
        if (String(shortName).trim().toLowerCase() === needle) return String(baseId);
      }

      // 2) Match against loaded GTFS route short names.
      for (const [routeId, meta] of ROUTE_DETAILS.entries()) {
        const shortName = (meta?.shortName || "").trim().toLowerCase();
        if (shortName && shortName === needle) return getBaseRouteKey(routeId);
      }

      return null;
    }

    function applyRouteSelection(baseId) {
      if (!baseId) return;
      selectedRoute = String(baseId);
      setHashFocus({ type: "route", id: selectedRoute });
      clearCategoryFilter();
      selectedVariant = VARIANT_FILTER_ALL;
      updateVariantOptions();
      syncRouteInputValue();
      updateRouteClearVisibility();
      renderSelectedRoutePill();
      if (routePreview) {
        routePreview.classList.add("hidden");
        routePreview.innerHTML = "";
      }
      routeInputWrapper?.classList.remove("input-focused");
      routeInputWrapper?.classList.add("pill-visible");
      renderVehicles();
      refreshRouteOverlay(true).catch(() => {});
      refreshGlobalStops(true).catch(() => {});
      refreshCharts(true).catch(() => {});
      refreshKpis(true);
      fetchData().catch(() => {});
      refreshActiveStopSchedule();
      updateRouteChartHintVisibility();
    }

    function handlePopupRouteActions() {
      document.addEventListener("click", (event) => {
        const link = event.target.closest(".popup-route-link");
        if (link) {
          event.preventDefault();
          const label = link.dataset.routeLabel || link.textContent || "";
          const baseId = resolveBaseIdFromLabel(label);
          if (baseId && baseId !== ROUTE_FILTER_ALL) applyRouteSelection(baseId);
          return;
        }
      });
    }

    function closeFloatingSearch() {
      if (floatingSearch) {
        floatingSearch.classList.add("hidden");
        floatingSearch.classList.remove("visible");
      }
      if (bodyEl) bodyEl.classList.remove("floating-search-open");
      if (floatingRoutePreview) floatingRoutePreview.innerHTML = "";
    }

    function commitFloatingRoutePreviewSelection() {
      if (!floatingRoutePreview) return false;
      const firstEntry = floatingRoutePreview.querySelector(".preview-item[data-stop-id], .preview-item[data-category], .preview-item[data-route-id]");
      if (!firstEntry) return false;
      const stopId = firstEntry.dataset.stopId;
      if (stopId) {
        const stopEntry = extractStopPreviewData(firstEntry);
        if (stopEntry) {
          openStopScheduleFromSearch(stopEntry);
          return true;
        }
        return false;
      }
      const categoryValue = firstEntry.dataset.category;
      if (categoryValue) {
        closeFloatingSearch();
        selectCategoryValue(categoryValue);
        return true;
      }
      const routeId = firstEntry.dataset.routeId;
      if (routeId) {
        closeFloatingSearch();
        applyRouteSelection(routeId);
        return true;
      }
      return false;
    }

    function parseCsvLine(line) {
      const columns = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === "\"") {
          if (inQuotes && line[i + 1] === "\"") {
            current += "\"";
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === "," && !inQuotes) {
          columns.push(current);
          current = "";
        } else {
          current += char;
        }
      }
      columns.push(current);
      return columns;
    }

    function buildStopCatalogEntries(csvText) {
      const normalized = (csvText || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      const lines = normalized.split("\n");
      if (!lines.length) return [];
      const headerLine = lines.shift();
      if (!headerLine) return [];
      const header = parseCsvLine(headerLine).map(col => (col || "").trim().toLowerCase());
      const idIndex = header.indexOf("stop_id");
      const nameIndex = header.indexOf("stop_name");
      if (idIndex === -1 || nameIndex === -1) return [];
      const codeIndex = header.indexOf("stop_code");
      const latIndex = header.indexOf("stop_lat");
      const lonIndex = header.indexOf("stop_lon");
      const seen = new Set();
      const entries = [];
      for (const rawLine of lines) {
        if (!rawLine) continue;
        const cols = parseCsvLine(rawLine);
        const stopId = (cols[idIndex] || "").trim();
        const stopName = (cols[nameIndex] || "").trim();
        if (!stopId || !stopName) continue;
        const key = `${stopId}|${stopName}`;
        if (seen.has(key)) continue;
        seen.add(key);
        const stopCode = (codeIndex >= 0 ? (cols[codeIndex] || "").trim() : "") || stopId;
        const latVal = (latIndex >= 0) ? Number(cols[latIndex]) : NaN;
        const lonVal = (lonIndex >= 0) ? Number(cols[lonIndex]) : NaN;
        const entry = {
          stopId,
          stopName,
          stopCode,
          displayNumber: stopCode || stopId,
          lat: Number.isFinite(latVal) ? latVal : null,
          lon: Number.isFinite(lonVal) ? lonVal : null,
          searchKey: `${stopName} ${stopCode} ${stopId}`.toLowerCase()
        };
        entries.push(entry);
      }
      const collator = new Intl.Collator("pt-PT", { sensitivity: "base" });
      entries.sort((a, b) => collator.compare(a.stopName, b.stopName));
      return entries;
    }

    async function preloadStopCatalog() {
      if (stopCatalogPromise) return stopCatalogPromise;
      if (!stopCatalogEntries.length) {
        stopCatalogEntries = buildStopCatalogEntries(STOP_CATALOG_CSV);
      }
      stopCatalogPromise = (async () => {
        try {
          const response = await fetch(STOP_CATALOG_URL, { cache: "no-store" });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const text = await response.text();
          stopCatalogEntries = buildStopCatalogEntries(text);
          return stopCatalogEntries;
        } catch (err) {
          console.warn("Falha ao carregar catlogo de paragens:", err);
          return stopCatalogEntries;
        }
      })();
      return stopCatalogPromise;
    }

    function getSearchPreviewCenter() {
      if (lastUserLocationCoords && Number.isFinite(lastUserLocationCoords.lat) && Number.isFinite(lastUserLocationCoords.lon)) {
        return { lat: lastUserLocationCoords.lat, lon: lastUserLocationCoords.lon };
      }
      const map = adapter?.map;
      if (map && typeof map.getCenter === "function") {
        const center = map.getCenter();
        const lat = Number(center?.lat);
        const lon = Number(center?.lng ?? center?.lon);
        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          return { lat, lon };
        }
      }
      return { lat: MAP_CENTER[0], lon: MAP_CENTER[1] };
    }

    function distanceBetweenCoords(lat1, lon1, lat2, lon2) {
      if (
        !Number.isFinite(lat1) || !Number.isFinite(lon1) ||
        !Number.isFinite(lat2) || !Number.isFinite(lon2)
      ) {
        return Infinity;
      }
      const toRad = (value) => (value * Math.PI) / 180;
      const 1 = toRad(lat1);
      const 2 = toRad(lat2);
      const  = toRad(lat2 - lat1);
      const  = toRad(lon2 - lon1);
      const a = Math.sin( / 2) ** 2
        + Math.cos(1) * Math.cos(2) * Math.sin( / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return 6371000 * c;
    }

    function nearestStopEntries(limit = MAX_STOP_SEARCH_RESULTS) {
      if (!stopCatalogEntries.length) return [];
      if (!lastUserLocationCoords) {
        // Only surface nearest stops once we have a confirmed user location.
        return [];
      }
      const safeLimit = Number.isFinite(limit) ? Math.max(1, Math.min(Math.round(limit), MAX_STOP_SEARCH_RESULTS)) : MAX_STOP_SEARCH_RESULTS;
      const center = getSearchPreviewCenter();
      if (!center) return [];
      const { lat: centerLat, lon: centerLon } = center;
      if (!Number.isFinite(centerLat) || !Number.isFinite(centerLon)) return [];
      const scored = [];
      const seen = new Set();
      for (const entry of stopCatalogEntries) {
        if (!entry) continue;
        const entryLat = Number(entry.lat);
        const entryLon = Number(entry.lon);
        if (!Number.isFinite(entryLat) || !Number.isFinite(entryLon)) continue;
        const stopKey = entry.stopId || `${entryLat.toFixed(5)}|${entryLon.toFixed(5)}`;
        if (seen.has(stopKey)) continue;
        seen.add(stopKey);
        const distance = distanceBetweenCoords(centerLat, centerLon, entryLat, entryLon);
        if (!Number.isFinite(distance)) continue;
        scored.push({ entry, distance });
      }
      if (!scored.length) return [];
      scored.sort((a, b) => a.distance - b.distance);
      const radius = Number.isFinite(NEAREST_STOP_RADIUS_METERS) ? Math.max(0, NEAREST_STOP_RADIUS_METERS) : Infinity;
      const withinRange = [];
      for (const item of scored) {
        if (item.distance <= radius) {
          withinRange.push(item);
        }
      }
      if (!withinRange.length) return [];
      const candidate = withinRange;
      const nearest = [];
      for (const { entry, distance } of candidate) {
        const isNearest = distance <= radius;
        nearest.push({ ...entry, isNearestStop: isNearest });
        if (nearest.length >= safeLimit) break;
      }
      return nearest;
    }

    function stopSearchEntries(query, { limit = MAX_STOP_SEARCH_RESULTS, allowEmpty = false } = {}) {
      if (!stopCatalogEntries.length) return [];
      const maxLimit = Number.isFinite(limit) ? Math.max(1, Math.min(Math.round(limit), MAX_STOP_SEARCH_RESULTS)) : MAX_STOP_SEARCH_RESULTS;
      const normalized = (query || "").trim().toLowerCase();
      if (!normalized) {
        if (!allowEmpty) return [];
        return nearestStopEntries(maxLimit);
      }
      const results = [];
      for (const entry of stopCatalogEntries) {
        if (!entry.searchKey.includes(normalized)) continue;
        results.push({ ...entry, isNearestStop: false });
        if (results.length >= maxLimit) break;
      }
      return results;
    }

    function focusMapOnCoordinates(lat, lon, forcedZoom = null) {
      if (!adapter?.map) return;
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      const map = adapter.map;
      const currentZoom = Number(map.getZoom?.());
      const baseZoom = Number.isFinite(forcedZoom) ? forcedZoom : currentZoom;
      const targetZoom = Number.isFinite(baseZoom)
        ? Math.max(MAP_ZOOM, baseZoom)
        : Math.max(MAP_ZOOM, Number.isFinite(currentZoom) ? currentZoom : MAP_ZOOM);
      try {
        if (typeof map.easeTo === "function") {
          map.easeTo({ center: [lon, lat], zoom: targetZoom, duration: 0.6 });
        } else if (typeof map.flyTo === "function") {
          map.flyTo([lat, lon], targetZoom, { duration: 0.6, animate: true });
        } else if (typeof map.setView === "function") {
          map.setView([lat, lon], targetZoom);
        }
      } catch (err) {
        console.warn("Falha ao centrar o mapa na paragem:", err);
      }
    }

    const HASH_CENTER_DECIMALS = { zoom: 2, coordinate: 5 };
    const HASH_FOCUS_TYPES = new Set(["stop", "route", "vehicle"]);
    let hashState = {
      center: { lat: MAP_CENTER[0], lon: MAP_CENTER[1], zoom: MAP_ZOOM },
      focus: null,
      chart: null,
      filters: { category: null, variant: null }
    };
    let pendingVehicleFocusId = null;
    let pendingChartFocus = null;
    let initialHashSpec = null;

    function formatNumber(value, decimals) {
      if (!Number.isFinite(value)) return null;
      const formatted = Number(value).toFixed(decimals);
      if (!formatted) return null;
      return String(Number(formatted));
    }

    function encodeMapSegment(center) {
      if (!center) return null;
      const lat = formatNumber(center.lat, HASH_CENTER_DECIMALS.coordinate);
      const lon = formatNumber(center.lon, HASH_CENTER_DECIMALS.coordinate);
      const zoom = formatNumber(center.zoom, HASH_CENTER_DECIMALS.zoom);
      if (!lat || !lon || !zoom) return null;
      return `${zoom},${lat},${lon}`;
    }

    function encodeFocusSegment(focus) {
      if (!focus || !focus.type || !focus.id) return null;
      const type = focus.type.toLowerCase();
      if (!HASH_FOCUS_TYPES.has(type)) return null;
      return `${type}:${encodeURIComponent(focus.id)}`;
    }

    function encodeChartSegment(chart) {
      if (!chart) return null;
      if (chart === "speed") return "velocitychart";
      if (chart === "volume") return "vehiclechart";
      return null;
    }

    function buildHashParams() {
      const params = new URLSearchParams();
      const mapValue = encodeMapSegment(hashState.center);
      if (mapValue) params.set("map", mapValue);
      const focusValue = encodeFocusSegment(hashState.focus);
      if (focusValue) params.set("focus", focusValue);
      const chartValue = encodeChartSegment(hashState.chart);
      if (chartValue) params.set("chart", chartValue);
      if (hashState.filters.category) params.set("category", hashState.filters.category);
      if (hashState.filters.variant) params.set("variant", hashState.filters.variant);
      return params;
    }

    function syncHashState() {
      const params = buildHashParams();
      const hashValue = params.toString();
      const normalized = hashValue ? `#${hashValue}` : "";
      const currentHash = window.location.hash || "";
      if (currentHash === normalized) return;
      const base = `${window.location.pathname}${window.location.search}`.replace(/\/\/+/g, "/");
      window.history.replaceState(null, "", `${base}${normalized}`);
    }

    function setHashCenter(center, { skipSync = false } = {}) {
      if (!center) return;
      const lat = Number(center.lat);
      const lon = Number(center.lon);
      const zoom = Number(center.zoom);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      const normalized = {
        lat,
        lon,
        zoom: Number.isFinite(zoom) ? zoom : hashState.center.zoom
      };
      hashState.center = normalized;
      if (!skipSync) syncHashState();
    }

    function setHashFocus(focus, { skipSync = false } = {}) {
      const normalized = (focus && focus.type && focus.id)
        ? { type: focus.type.toLowerCase(), id: String(focus.id || "").trim() }
        : null;
      if (normalized && !HASH_FOCUS_TYPES.has(normalized.type)) return;
      const existing = hashState.focus;
      if (existing?.type === normalized?.type && existing?.id === normalized?.id) return;
      hashState.focus = normalized;
      if (!skipSync) syncHashState();
    }

    function setHashChart(chartType, { skipSync = false } = {}) {
      const normalized = (chartType === "speed" || chartType === "volume") ? chartType : null;
      if (hashState.chart === normalized) return;
      hashState.chart = normalized;
      if (!skipSync) syncHashState();
    }

    function setHashFilters(filters, { skipSync = false } = {}) {
      const categoryVal = (filters?.category && filters.category !== CATEGORY_FILTER_ALL) ? filters.category : null;
      const variantVal = (filters?.variant && filters.variant !== VARIANT_FILTER_ALL) ? filters.variant : null;
      hashState.filters = { category: categoryVal, variant: variantVal };
      if (!skipSync) syncHashState();
    }

    function updateHashCenterFromMap() {
      if (!adapter?.map) return;
      const map = adapter.map;
      const center = map.getCenter ? map.getCenter() : null;
      if (!center) return;
      const lat = Number(center?.lat);
      const lon = Number(center?.lng ?? center?.lon);
      const zoom = Number(map.getZoom?.());
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      setHashCenter({ lat, lon, zoom });
    }

    const scheduleHashCenterSync = debounce(() => {
      updateHashCenterFromMap();
    }, 200);

    function parseMapSegment(segment) {
      if (!segment) return null;
      const parts = segment.split(",").map(part => part.trim());
      if (parts.length !== 3) return null;
      const zoom = Number(parts[0]);
      const lat = Number(parts[1]);
      const lon = Number(parts[2]);
      if (!Number.isFinite(zoom) || !Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return { zoom, lat, lon };
    }

    function parseFocusSegment(segment) {
      if (!segment) return null;
      const idx = segment.indexOf(":");
      if (idx === -1) return null;
      const type = segment.slice(0, idx).toLowerCase();
      const value = decodeURIComponent(segment.slice(idx + 1) || "").trim();
      if (!HASH_FOCUS_TYPES.has(type) || !value) return null;
      return { type, id: value };
    }

    function parseChartSegment(segment) {
      if (!segment) return null;
      const normalized = segment.toLowerCase();
      if (normalized === "velocitychart") return "speed";
      if (normalized === "vehiclechart") return "volume";
      return null;
    }

    function parseHashSpec() {
      const raw = (window.location.hash || "").replace(/^#/, "");
      if (!raw) return null;
      const params = new URLSearchParams(raw);
      return {
        center: parseMapSegment(params.get("map")),
        focus: parseFocusSegment(params.get("focus")),
        chart: parseChartSegment(params.get("chart")),
        filters: {
          category: params.get("category") || null,
          variant: params.get("variant") || null
        }
      };
    }

    initialHashSpec = parseHashSpec();

    async function applyInitialHashSpec(spec) {
      if (!spec) return;
      if (spec.filters) {
        setHashFilters(spec.filters, { skipSync: true });
        if (spec.filters.category) {
          applyCategorySelection(spec.filters.category, { skipHash: true });
        }
      }
      if (spec.chart) {
        setHashChart(spec.chart, { skipSync: true });
        pendingChartFocus = spec.chart;
      }
      if (spec.center) {
        setHashCenter(spec.center, { skipSync: true });
        await adapterReady;
        focusMapOnCoordinates(spec.center.lat, spec.center.lon, spec.center.zoom);
      }
      if (spec.focus) {
        setHashFocus(spec.focus, { skipSync: true });
      }
      if (spec.focus?.type === "route") {
        await loadRoutesCatalog();
        const resolved = resolveBaseIdFromLabel(spec.focus.id) || spec.focus.id;
        if (resolved) {
          applyRouteSelection(resolved);
        }
      } else if (spec.focus?.type === "stop") {
        await preloadStopCatalog();
        const match = stopCatalogEntries.find(entry =>
          entry.stopId === spec.focus.id || entry.displayNumber === spec.focus.id
        );
        openStopScheduleFromSearch(match || { stopId: spec.focus.id, stopName: spec.focus.id || "" });
      } else if (spec.focus?.type === "vehicle") {
        pendingVehicleFocusId = spec.focus.id;
      }
      if (spec.filters?.variant) {
        applyVariantSelection(spec.filters.variant, { skipHash: true });
      }
    }

    function applyPendingVehicleFocusIfNeeded() {
      if (!pendingVehicleFocusId) return;
      const candidate = (String(pendingVehicleFocusId || "")).trim();
      if (!candidate || !Array.isArray(lastVehicles)) return;
      const normalizedTarget = candidate.toLowerCase();
      const match = lastVehicles.find(v => {
        const id = String(v?.id ?? v?.vehicleId ?? v?.vehicle ?? "").trim();
        return id && id.toLowerCase() === normalizedTarget;
      });
      if (!match) return;
      focusMapOnCoordinates(match.lat, match.lon);
      setHashFocus({ type: "vehicle", id: candidate });
      pendingVehicleFocusId = null;
    }

    function extractStopPreviewData(item) {
      if (!item) return null;
      const stopId = (item.dataset.stopId || "").trim();
      if (!stopId) return null;
      const lat = Number(item.dataset.stopLat);
      const lon = Number(item.dataset.stopLon);
      return {
        stopId,
        stopName: item.dataset.stopName || "",
        stopCode: item.dataset.stopCode || "",
        displayNumber: item.dataset.stopCode || stopId,
        lat: Number.isFinite(lat) ? lat : null,
        lon: Number.isFinite(lon) ? lon : null
      };
    }

    async function openStopScheduleFromSearch(stopEntry) {
      const stopId = (stopEntry?.stopId || "").trim();
      if (!stopId) return;
      closeFloatingSearch();
      hideMobileStopCard();
      focusMapOnCoordinates(stopEntry?.lat, stopEntry?.lon);
      const stopName = stopEntry?.stopName || stopEntry?.displayNumber || "Paragem";
      const routePromise = ensureStopRoutes(stopId);
      const schedulePromise = requestStopSchedule(stopId, { contextKey: buildScheduleContextKey() });
      const isMobile = isMobileViewport();
      const initialSchedule = initialScheduleStateForContext();
      const desktopTarget = isMobile
        ? null
        : createDesktopStopPopupTarget({ stopId, stopName, lat: stopEntry?.lat, lon: stopEntry?.lon });
      if (desktopTarget) {
        applyStopPopupContent(desktopTarget, {
          stopName,
          stopId,
          loading: true,
          routes: [],
          schedule: initialSchedule
        });
        activeStopPopup = { stopId, stopName, target: desktopTarget };
      }
      let routes = [];
      let schedule = null;
      try {
        [routes, schedule] = await Promise.all([routePromise, schedulePromise]);
      } catch (err) {
        console.warn("Erro ao carregar dados da paragem:", stopId, err);
      }
      const scheduleState = schedule || { status: "loading" };
      const params = { stopName, stopId, schedule: scheduleState, routes };
      if (desktopTarget) {
        applyStopPopupContent(desktopTarget, { ...params, loading: false });
        activeStopPopup = { stopId, stopName, target: desktopTarget };
        focusMapOnCoordinates(stopEntry?.lat, stopEntry?.lon);
      }
      if (isMobile) {
        showMobileStopCard({
          stopName,
          stopId,
          schedule: scheduleState,
          routes
        });
        activeStopPopup = { stopId, stopName, target: null };
      }
      setHashFocus({ type: "stop", id: stopId });
    }

    function buildSearchPreviewHtml(routeEntries, categoryEntries, stopEntries, { stopFirst = false } = {}) {
      const routeHtml = routeEntries.map(({ id, label }) => {
        const displayLabel = label || id;
        const style = pillStyleForRoute(displayLabel);
        const { code } = parseRouteCodeParts(displayLabel);
        const pillText = code || displayLabel || id;
        const regex = code ? new RegExp(`^${escapeRegex(code)}\\s*`, "i") : null;
        const restLabel = regex ? (displayLabel.replace(regex, "").trim() || displayLabel) : displayLabel;
        const safeLabel = escapeHtml(restLabel);
        const safeId = escapeHtml(id);
        const pill = `<span class="route-pill" aria-hidden="true" style="--pill-bg:${style.bg};--pill-fg:${style.fg};--pill-border:${style.border}">${escapeHtml(pillText)}</span>`;
        return `<div class="preview-item" role="option" data-route-id="${safeId}">
          <span class="preview-label">${pill} ${safeLabel}</span>
        </div>`;
      }).join("");
      const stopHtml = (stopEntries || []).map(stopPreviewItemMarkup).join("");
      const categoryHtml = categoryEntries
        .map(entry => {
          const safeLabel = escapeHtml(entry.label || entry.value || "");
          const safeValue = escapeHtml(entry.value || CATEGORY_FILTER_ALL);
          return `<div class="preview-item preview-category" role="option" data-category="${safeValue}">
            <span class="preview-label">${safeLabel}</span>
          </div>`;
        })
        .join("");
      if (stopFirst) {
        return `${stopHtml}${routeHtml}${categoryHtml}`;
      }
      return `${routeHtml}${stopHtml}${categoryHtml}`;
    }

    function bindSearchPreviewItems(previewEl, { onCategorySelect, onRouteSelect, onStopSelect } = {}) {
      if (!previewEl) return;
      Array.from(previewEl.querySelectorAll(".preview-item")).forEach(item => {
        if (item.dataset.bound === "1") return;
        item.dataset.bound = "1";
        item.addEventListener("mousedown", (ev) => {
          ev.preventDefault();
          const stopId = item.dataset.stopId;
          if (stopId && typeof onStopSelect === "function") {
            const stopData = extractStopPreviewData(item);
            if (stopData) {
              void onStopSelect(stopData);
            }
            return;
          }
          const categoryValue = item.dataset.category;
          if (categoryValue && typeof onCategorySelect === "function") {
            onCategorySelect(categoryValue);
            return;
          }
          const rid = item.dataset.routeId || "";
          if (rid && typeof onRouteSelect === "function") {
            onRouteSelect(rid);
          }
        });
      });
    }

    function renderFloatingRoutePreview(query) {
      if (!floatingRoutePreview) return;
      const trimmedQuery = (query || "").trim();
      const routeEntries = previewEntries(query, { allowEmpty: true });
      const categoryEntries = previewCategoryEntries(query);
      const stopEntries = stopSearchEntries(query, { allowEmpty: true });
      if (!routeEntries.length && !categoryEntries.length && !stopEntries.length) {
        floatingRoutePreview.innerHTML = `<div class="preview-item" aria-hidden="true"><span class="preview-label">Sem resultados</span></div>`;
        return;
      }
      const showStopsFirst = !trimmedQuery && stopEntries.length > 0;
      floatingRoutePreview.innerHTML = buildSearchPreviewHtml(routeEntries, categoryEntries, stopEntries, { stopFirst: showStopsFirst });
      refreshStopPreviewRoutePillsLayouts(floatingRoutePreview);
      bindSearchPreviewItems(floatingRoutePreview, {
        onCategorySelect: (value) => {
          selectCategoryValue(value);
          closeFloatingSearch();
        },
        onRouteSelect: (rid) => {
          applyRouteSelection(rid);
          closeFloatingSearch();
        },
        onStopSelect: (entry) => {
          openStopScheduleFromSearch(entry);
        }
      });
    }


    function openFloatingSearch() {
      if (!floatingSearch || !floatingRouteInput) return;
      floatingSearch.classList.remove("hidden");
      floatingSearch.classList.add("visible");
      if (bodyEl) bodyEl.classList.add("floating-search-open");
      // Keep the preview list text spacing generous when the panel opens.
      if (floatingRoutePreview) {
        floatingRoutePreview.style.lineHeight = "1.5";
      }
      if (!selectedRoute || selectedRoute === ROUTE_FILTER_ALL) {
        floatingRouteInput.value = "";
      } else {
        floatingRouteInput.value = routeLabelById.get(selectedRoute) || resolvePublicRouteLabel(selectedRoute) || "";
      }
      renderFloatingRoutePreview(floatingRouteInput.value || "");
      try { floatingRouteInput.focus({ preventScroll: true }); } catch (e) { floatingRouteInput.focus(); }
      floatingRouteInput.select();
    }

    function handleFloatingRouteCommit() {
      if (!floatingRouteInput) return;
      const value = floatingRouteInput.value || "";
      const resolved = resolveRouteInputValue(value);
      if (resolved === ROUTE_FILTER_ALL) {
        clearRouteSelection();
      } else if (resolved) {
        applyRouteSelection(resolved);
      }
      closeFloatingSearch();
    }

    function wireFloatingContextActions() {
      if (kpiFloatingChip) {
        kpiFloatingChip.addEventListener("click", (ev) => {
          if (ev.target.closest("#kpi-floating-clear")) return;
          ev.preventDefault();
          focusRouteSearchFromFloating();
        });
        kpiFloatingChip.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " ") {
            ev.preventDefault();
            focusRouteSearchFromFloating();
          }
        });
      }
      if (kpiFloatingClear) {
        kpiFloatingClear.addEventListener("click", (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          resetFiltersToGlobal();
        });
      }
    }

    function clearRouteSelection() {
      selectedRoute = ROUTE_FILTER_ALL;
      selectedVariant = VARIANT_FILTER_ALL;
      syncRouteInputValue();
      updateVariantOptions();
      if (Array.isArray(globalVehiclesCache.list) && globalVehiclesCache.list.length) {
        lastVehicles = globalVehiclesCache.list;
      }
      renderVehicles();
      refreshRouteOverlay(true).catch(() => {});
      refreshGlobalStops(true).catch(() => {});
      refreshCharts(true).catch(() => {});
      refreshKpis(true);
      updateRouteClearVisibility();
      renderSelectedRoutePill();
      closeFloatingSearch();
      fetchData({ forceGlobal: true, preferCache: false }).catch(() => {});
      clearCategoryFilter();
      updateRouteChartHintVisibility();
      setHashFocus(null);
      setHashFilters({ category: selectedCategory, variant: selectedVariant });
    }

	    function wireStopPopupPills(containerEl) {
	      if (!containerEl) return;
	      const pills = Array.from(containerEl.querySelectorAll?.(".route-pill[data-route-label]") || []);
	      pills.forEach(pill => {
        if (pill.dataset.bound === "1") return;
        pill.dataset.bound = "1";
        const activate = () => {
          const label = pill.dataset.routeLabel || pill.textContent || "";
          const baseId = resolveBaseIdFromLabel(label);
          if (baseId && baseId !== ROUTE_FILTER_ALL) applyRouteSelection(baseId);
        };
        pill.addEventListener("click", (ev) => { ev.preventDefault(); ev.stopPropagation(); activate(); });
        pill.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " ") {
            ev.preventDefault();
            activate();
          }
        });
      });
    }

    function adapterZoom() {
      if (!adapter?.map || typeof adapter.map.getZoom !== "function") return NaN;
      try {
        return Number(adapter.map.getZoom());
      } catch (e) {
        return NaN;
      }
    }

    function adapterBounds() {
      if (!adapter?.map) return null;
      try {
        // Leaflet: LatLngBounds with getSouthWest/getNorthEast
        if (typeof adapter.map.getBounds === "function") {
          const b = adapter.map.getBounds();
          const sw = b.getSouthWest?.();
          const ne = b.getNorthEast?.();
          if (sw && ne) {
            return { minLat: sw.lat, minLon: sw.lng, maxLat: ne.lat, maxLon: ne.lng };
          }
        }
        // MapLibre: LngLatBounds with getSouthWest/getNorthEast
        if (typeof adapter.map.getBounds === "function") {
          const b = adapter.map.getBounds();
          const sw = b.getSouthWest?.();
          const ne = b.getNorthEast?.();
          if (sw && ne) {
            return { minLat: sw.lat, minLon: sw.lng, maxLat: ne.lat, maxLon: ne.lng };
          }
        }
      } catch (e) {}
      return null;
    }

    function ensureLeafletGlobalStopsLayer() {
      if (!(adapter instanceof LeafletAdapter)) return;
      if (!adapter.globalStopsLayer) {
        adapter.globalStopsLayer = L.layerGroup().addTo(adapter.overlayGroup);
      }
    }

    function fadeOutLeafletLayer(layerGroup, ms = STOP_REMOVE_DELAY_MS) {
      if (!layerGroup || typeof layerGroup.getLayers !== "function") return;
      if (adapter instanceof LeafletAdapter && adapter.globalStopsLayer === layerGroup) {
        renderedStopsMap.clear();
      }
      const layers = layerGroup.getLayers();
      const timeoutMs = Math.max(50, Number.isFinite(ms) ? ms : STOP_REMOVE_DELAY_MS);
      layers.forEach(layer => {
        const el = layer?.getElement?.();
        const inner = el?.querySelector?.(".stop-marker");
        if (inner) {
          inner.classList.remove("stop--shown");
          inner.classList.add("stop--hidden");
        }
        setTimeout(() => {
          try { layerGroup.removeLayer(layer); } catch (e) {}
        }, timeoutMs);
      });
    }

    function renderGlobalStops(payload) {
      if (!payload) return;
      const stops = Array.isArray(payload.stops) ? payload.stops : [];
      const zoom = adapterZoom();
      const belowLod = !Number.isFinite(zoom) || zoom < STOPS_MIN_ZOOM;

      if (adapter instanceof LeafletAdapter) {
        if (belowLod) {
          if (adapter.globalStopsLayer) fadeOutLeafletLayer(adapter.globalStopsLayer);
          return;
        }
        ensureLeafletGlobalStopsLayer();
        const nextKeys = new Set();
        const preferredAngles = stops.map(s => Number(s?.direction_angle));
        const fallbackAngles = estimateAnglesFromNeighbors(stops, preferredAngles);
        const angleDiff = (a, b) => {
          const da = Math.abs(wrapAngleDeg(a) - wrapAngleDeg(b));
          return Math.min(da, 360 - da);
        };

        for (let idx = 0; idx < stops.length; idx++) {
          const s = stops[idx];
          const lat = Number(s?.stop_lat);
          const lon = Number(s?.stop_lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
          const stopId = (s?.stop_id || "").trim();
          const routes = (Array.isArray(s?.routes) ? s.routes : []);
          if (stopId && routes.length) stopRoutesCache.set(stopId, routes);
          const primaryColor = "#ffd400";
          const arrowColor = "#000000";
          const key = stopKeyForStop(s);
          if (!key) continue;
          nextKeys.add(key);

          const angleRaw = Number(s?.direction_angle);
          const local = Number(fallbackAngles[idx] || 0);
          // Prefer payload (backend shape tangent); fallback to neighbor estimate only if missing.
          const angleDeg = Number.isFinite(angleRaw) ? angleRaw : local;
          const angCss = Number.isFinite(angleDeg) ? `${angleDeg}deg` : "0deg";
          const existing = renderedStopsMap.get(key);

          if (!existing) {
            const iconHtml = `<div class="stop-marker stop--hidden" style="--stop-border:${primaryColor}; --stop-arrow:${arrowColor}; --stop-ang:${angCss}; background:#ffffff"><span class="stop-arrow"></span></div>`;
            const icon = L.divIcon({ html: iconHtml, className: "stop-fade", iconSize: [1, 1], iconAnchor: [0, 0] });
            const marker = L.marker([lat, lon], { icon });
            marker.addTo(adapter.globalStopsLayer);

            const schedState = initialScheduleStateForContext();
            marker.bindPopup(
              stopPopupHtml({ stopName: (s.stop_name || "Paragem"), stopId: (s.stop_id || ""), loading: true, schedule: schedState }),
              { ...popupPanOptions(), maxWidth: 320 }
            );

            marker.on("popupopen", async () => {
              const stopId = s?.stop_id || "";
              await hydrateStopPopup(marker, { stopId, stopName: (s.stop_name || "Paragem") });
            });
            marker.on("popupclose", () => hideMobileStopCard());

            marker.on("add", () => {
              const el = marker.getElement?.();
              if (!el) return;
              const inner = el.querySelector?.(".stop-marker");
              if (!inner) return;
              requestAnimationFrame(() => requestAnimationFrame(() => {
                try { inner.getBoundingClientRect(); } catch (e) {}
                inner.classList.remove("stop--hidden");
                inner.classList.add("stop--shown");
              }));
            });

            renderedStopsMap.set(key, { marker, lat, lon, angleDeg: Number.isFinite(angleDeg) ? angleDeg : 0 });
            continue;
          }

          if (Math.abs(existing.lat - lat) > 1e-8 || Math.abs(existing.lon - lon) > 1e-8) {
            existing.marker.setLatLng([lat, lon]);
            existing.lat = lat;
            existing.lon = lon;
          }

          const nextAngle = Number.isFinite(angleDeg) ? angleDeg : 0;
          if (existing.angleDeg !== nextAngle) {
            const el = existing.marker.getElement?.();
            const inner = el?.querySelector?.(".stop-marker");
            if (inner) inner.style.setProperty("--stop-ang", `${nextAngle}deg`);
            existing.angleDeg = nextAngle;
          }
          // No labels to update
        }

        for (const [key, entry] of renderedStopsMap.entries()) {
          if (nextKeys.has(key)) continue;
          const el = entry?.marker?.getElement?.();
          const inner = el?.querySelector?.(".stop-marker");
          if (inner) {
            inner.classList.remove("stop--shown");
            inner.classList.add("stop--hidden");
          }
          setTimeout(() => {
            try { adapter.globalStopsLayer.removeLayer(entry.marker); } catch (e) {}
          }, STOP_REMOVE_DELAY_MS);
          renderedStopsMap.delete(key);
        }
        return;
      }

      if (adapter instanceof MapLibreAdapter) {
        if (belowLod) {
          fadeOutMapLibreStops();
          return;
        }
        if (mapLibreStopsFadeTimer) {
          clearTimeout(mapLibreStopsFadeTimer);
          mapLibreStopsFadeTimer = null;
        }
        adapter.setGlobalStops(payload);
        resetMapLibreStopOpacity();
      }
    }

    async function refreshGlobalStops(force = false) {
      if (!adapter) return;
      if (!force && adapter?.isInteracting) return;
      if (adapter instanceof MapLibreAdapter && adapter.globalStopTilesEnabled) {
        const z = adapterZoom();
        const visible = Number.isFinite(z) && z >= STOPS_MIN_ZOOM && selectedRoute === ROUTE_FILTER_ALL;
        adapter.setGlobalStopTilesVisible(visible);
        if (!visible) {
          clearMapLibreStopLabels();
        } else {
          updateMapLibreStopLabels();
        }
        return;
      }
      if (selectedRoute !== ROUTE_FILTER_ALL) {
        // Clear when leaving global mode
        cancelGlobalStopsFetch();
        if (adapter instanceof LeafletAdapter && adapter.globalStopsLayer) fadeOutLeafletLayer(adapter.globalStopsLayer);
        if (adapter instanceof MapLibreAdapter) adapter.setGlobalStops({ stops: [] });
        if (adapter instanceof MapLibreAdapter) clearMapLibreStopLabels();
        globalStopsKey = null;
        lastRenderedGlobalStopsKey = null;
        return;
      }

      const z = adapterZoom();
      if (!Number.isFinite(z) || z < STOPS_MIN_ZOOM) {
        cancelGlobalStopsFetch();
        if (adapter instanceof LeafletAdapter && adapter.globalStopsLayer) fadeOutLeafletLayer(adapter.globalStopsLayer);
        if (adapter instanceof MapLibreAdapter) {
          // remove global stops by re-rendering empty list
          renderGlobalStops({ stops: [] });
        }
        if (adapter instanceof MapLibreAdapter) clearMapLibreStopLabels();
        globalStopsKey = null;
        lastRenderedGlobalStopsKey = null;
        return;
      }

      const b = adapterBounds();
      if (!b) return;
      const roundedBounds = roundBoundsForStops(b, GLOBAL_STOPS_KEY_PRECISION);
      const effLimit = dynamicGlobalStopsLimit(z);
      const key = JSON.stringify({ ...(roundedBounds || {}), z: Math.round(z * 10) / 10, limit: effLimit });
      const sameViewport = globalStopsKey === key;
      globalStopsKey = key;

      const now = Date.now();
      const cached = globalStopsCache.get(key);
      const cachedFresh = cached && (now - cached.ts) < GLOBAL_STOPS_CACHE_TTL_MS;
      if (cached && lastRenderedGlobalStopsKey !== key) {
        renderGlobalStops(cached.payload);
        lastRenderedGlobalStopsKey = key;
      }
      if (!force && cachedFresh) return;
      if (!force && sameViewport && globalStopsAbort) return;

      cancelGlobalStopsFetch();
      const controller = new AbortController();
      globalStopsAbort = controller;
      (async () => {
        try {
          if (adapter.ready instanceof Promise) await adapter.ready;
        const payload = await fetchFromEndpoints(stopsBboxEndpoints(), {
            min_lat: String(b.minLat),
            max_lat: String(b.maxLat),
            min_lon: String(b.minLon),
            max_lon: String(b.maxLon),
            limit: String(effLimit),
            include_routes: "1"
          }, { signal: controller.signal, timeoutMs: 5000 });
          const stops = Array.isArray(payload) ? payload : (payload?.stops || []);
          const data = { stops };
          globalStopsCache.set(key, { ts: now, payload: data });
          renderGlobalStops(data);
          lastRenderedGlobalStopsKey = key;
        } catch (err) {
          if (controller.signal.aborted) return;
          console.warn("Falha ao carregar paragens (rede global):", err);
          if (cached?.payload) {
            renderGlobalStops(cached.payload);
            lastRenderedGlobalStopsKey = key;
          }
        } finally {
          if (globalStopsAbort === controller) globalStopsAbort = null;
        }
      })();
    }

    function filterVehicles(list) {
      return list.filter(v => {
        if (selectedCategory !== CATEGORY_FILTER_ALL) {
          const resolved = v.categoryResolved || v.category || "";
          if (resolved !== selectedCategory) return false;
        }
        if (selectedRoute !== ROUTE_FILTER_ALL) {
          const variantKey = normalizeOptionKey(v.routeId || v.routeLabel);
          const baseKey = getBaseRouteKey(variantKey);
          if (selectedVariant !== VARIANT_FILTER_ALL) {
            if (!variantKey || variantKey !== selectedVariant) return false;
          } else if (!baseKey || (baseKey !== selectedRoute && variantKey !== selectedRoute)) {
            return false;
          }
        }
        return true;
      });
    }

    function updateStatus(state) {
      if (!statusDot) return;
      statusDot.className = `status-dot ${state}`;
    }

    async function renderVehicles() {
      const baseList = Array.isArray(lastVehicles) ? lastVehicles : [];
      if (adapter.ready instanceof Promise) await adapter.ready;
      // Keep markers for the full feed so switching filters is instant (show/hide instead of destroy/recreate).
      adapter.updateVehicles(baseList);
      const filtered = filterVehicles(baseList);
      const visibleIds = new Set(filtered.map(v => String(v.id)));
      const visibleCount = typeof adapter.setVisibleIds === "function"
        ? adapter.setVisibleIds(visibleIds)
        : filtered.length;
      applyPendingVehicleFocusIfNeeded();
      return visibleCount;
    }

    function normalizeVehicles(data) {
       let list = [];
       if (Array.isArray(data)) list = data;
       else if (data?.features) list = data.features;
       else if (data?.entity) list = data.entity;

       const normalized = list.map((item, idx) => {
          if (item && item.vehicle) {
            const veh = item.vehicle;
            const vehInfo = veh.vehicle || {};
            const pos = veh.position || {};
            const trip = veh.trip || {};
            const speedMs = Number(pos.speed);
            return {
              id: vehInfo.id ?? vehInfo.label ?? `gtfs-${idx}`,
              lat: pos.latitude,
              lon: pos.longitude,
              routeId: trip.routeId ?? trip.tripId ?? "",
              linha: trip.routeId ?? "",
              directionId: trip.directionId ?? trip.direction_id ?? null,
              bearing: pos.bearing ?? pos.heading ?? pos.course ?? null,
              speed: Number.isFinite(speedMs) ? speedMs * 3.6 : 0,
              ts: veh.timestamp ?? pos.timestamp ?? Date.now()
            };
          }
          if (item?.type === "Feature") return featureToVehicle(item, idx);
          return item;
       }).filter(v => v && v.lat);
       return normalized.map(decorateVehicle);
    }

    function normalizeVehicleChapaId(value) {
      if (value == null) return "";
      const candidate = String(value).trim();
      if (!candidate) return "";
      return candidate.replace(/^#/, "");
    }

    function parsePlateChapa(plate) {
      const safePlate = plate == null ? "" : String(plate).trim();
      if (!safePlate) return "";
      const index = safePlate.indexOf("Z");
      if (index > 0) return safePlate.slice(0, index);
      return safePlate;
    }

    function getVehicleChapaEntryById(value) {
      const key = normalizeVehicleChapaId(value);
      if (!key) return null;
      return vehicleChapaMap.get(key) || null;
    }

    function applyChapaUpdates() {
      if (Array.isArray(lastVehicles) && lastVehicles.length) {
        lastVehicles = lastVehicles.map(decorateVehicle);
        renderVehicles().catch(() => {});
      }
      if (Array.isArray(volumeTableRows) && volumeTableRows.length) {
        volumeTableRows = volumeTableRows.map(row => {
          const entry = getVehicleChapaEntryById(row.id);
          const plate = entry?.plate || row.plate || "";
          const chapa = entry?.chapa || row.chapa || parsePlateChapa(plate);
          return { ...row, plate, chapa };
        });
        renderVolumeTableRows();
      }
    }

    async function refreshVehicleChapas(force = false) {
      const now = Date.now();
      if (!force && vehicleChapaMap.size && (now - lastChapaFetchTs) < CHAPA_REFRESH_INTERVAL_MS) {
        return vehicleChapaMap;
      }
      if (chapaFetchAbortController) {
        try { chapaFetchAbortController.abort(); } catch (e) {}
      }
      const controller = new AbortController();
      chapaFetchAbortController = controller;
      try {
        const response = await fetchWithTimeout(
          CHAPA_SNAPSHOTS_ENDPOINT,
          { cache: "no-store", signal: controller.signal },
          CHAPA_FETCH_TIMEOUT_MS
        );
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const payload = await response.json();
        const entries = Array.isArray(payload)
          ? payload
          : (Array.isArray(payload?.vehicles) ? payload.vehicles : (Array.isArray(payload?.data) ? payload.data : []));
        const nextMap = new Map();
        for (const entry of entries) {
          if (!entry) continue;
          const idCandidate = entry?.id ?? entry?.vehicleId ?? entry?.vehicle_id ?? entry?.veiculo ?? "";
          const normalizedId = normalizeVehicleChapaId(idCandidate);
          if (!normalizedId) continue;
          const plateRaw = entry?.plate ?? entry?.placa ?? entry?.vehicle_plate ?? entry?.vehiclePlate ?? "";
          const plate = plateRaw ? String(plateRaw).trim() : "";
          const chapa = parsePlateChapa(plate || entry?.chapa || "");
          nextMap.set(normalizedId, { plate, chapa, route: (entry?.route ?? entry?.linha ?? "").toString().trim() });
        }
        for (const [key, value] of vehicleChapaMap.entries()) {
          if (!nextMap.has(key)) {
            nextMap.set(key, value);
          }
        }
        vehicleChapaMap = nextMap;
        seedVolumeOverlayChapaCacheFromVehicleMap();
        lastChapaFetchTs = now;
        applyChapaUpdates();
        return vehicleChapaMap;
      } catch (err) {
        if (err?.name === "AbortError") return vehicleChapaMap;
        console.warn("Falha ao carregar chapas:", err);
        return vehicleChapaMap;
      } finally {
        if (chapaFetchAbortController === controller) {
          chapaFetchAbortController = null;
        }
      }
    }

    function startChapaRefreshLoop() {
      if (chapaRefreshTimerId) return;
      chapaRefreshTimerId = setInterval(() => {
        refreshVehicleChapas().catch(err => console.warn("Falha ao atualizar chapas:", err));
      }, CHAPA_REFRESH_INTERVAL_MS);
    }

    async function fetchData(options = {}) {
      const { signal = null } = options;
      const requestId = ++vehiclesRequestSeq;

      updateStatus("fetching");

      const applyResult = async (vehicles, statusText, isFallback = false) => {
        if (requestId < vehiclesLatestAppliedId) return false;
        vehiclesLatestAppliedId = requestId;
        lastVehicles = vehicles;
        lastVehicleApplyTs = Date.now();
        if (!isFallback) {
          globalVehiclesCache = { timestamp: Date.now(), list: vehicles };
        }
        updateRouteOptionsFromVehicles(vehicles);
        await renderVehicles();
        updateStatus(statusText);
        return true;
      };

      try {
        // Use the plain realtime feed directly (same behavior as set.html).
        const resp = await fetchWithTimeout(VEHICLE_ENDPOINT, { cache: "no-store", signal }, 5000);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const payload = await resp.json();
        const vehicles = normalizeVehicles(payload);
        const applied = await applyResult(vehicles, "online");
        if (applied) clearAppError();
        return vehicles;
      } catch (err) {
        if (err?.name === "AbortError") return [];
        console.warn("Offline mode:", err);
        const fallback = await loadOfflineVehicles();
        const vehicles = normalizeVehicles(fallback);
        const applied = await applyResult(vehicles, "offline", true);
        if (applied) showAppError(`Falha ao obter veculos: ${err?.message || err}`);
        return vehicles;
      }
    }

    function startPolling() {
      if (window.__pollingTimer) clearTimeout(window.__pollingTimer);
      if (window.__pollingAbort) {
        try { window.__pollingAbort.abort(); } catch (e) {}
      }
      let inFlight = false;
      let currentAbort = null;
      const scheduleNext = (delayMs = REFRESH_RATE_MS) => {
        clearTimeout(window.__pollingTimer);
        window.__pollingTimer = setTimeout(tick, delayMs);
      };
      const tick = async () => {
        if (inFlight) {
          try { currentAbort?.abort(); } catch (e) {}
        }
        const controller = new AbortController();
        currentAbort = controller;
        inFlight = true;
        try {
          await fetchData({ signal: controller.signal });
        } catch (err) {
          if (err?.name !== "AbortError") {
            console.warn("Polling falhou:", err);
          }
        } finally {
          inFlight = false;
          if (currentAbort === controller) currentAbort = null;
          const now = Date.now();
          const age = now - lastVehicleApplyTs;
          const delay = age > VEHICLE_STALE_FORCE_MS ? 0 : REFRESH_RATE_MS;
          scheduleNext(delay);
        }
      };
      scheduleNext(0);
      window.__pollingAbort = () => {
        try { currentAbort?.abort(); } catch (e) {}
        clearTimeout(window.__pollingTimer);
      };
    }

    function startKpiRefreshLoop() {
      fetchCategoryKpis(true).catch(() => {});
      refreshKpis(true).catch(() => {});
      setInterval(() => {
        fetchCategoryKpis(true).catch(() => {});
        // Force refresh to bypass caches so KPIs update even if other polling loops are quiet.
        refreshKpis(true).catch(() => {});
      }, KPI_REFRESH_INTERVAL_MS);
    }

    setSidebarCollapsed(window.matchMedia && window.matchMedia("(max-width: 900px)").matches);
    initCategoryFilter();
    initCategorySearch();
    initRouteFilter();
    initFloatingSearch();
    wireFloatingContextActions();
    initVariantFilter();
    initPreviewCharts();
    updateRouteChartHintVisibility();
    preloadStopCatalog()
      .then(() => {
        if (floatingSearch?.classList.contains("visible")) {
          renderFloatingRoutePreview(floatingRouteInput?.value || "");
        }
        if (routePreview && routeInput && document.activeElement === routeInput) {
          renderRoutePreview(routeInput.value || "");
        }
      })
      .catch(() => {});

(async () => {
      await checkApiHealth().catch(() => {});
      await Promise.allSettled([loadRouteTranslator(), loadRoutesCatalog()]);
      await applyInitialHashSpec(initialHashSpec);
      await refreshCharts(true).catch(() => {});
      startChartRefreshLoop();
      startKpiRefreshLoop();
      refreshVehicleChapas(true).catch(err => console.warn("Falha ao carregar chapas iniciais:", err));
      startChapaRefreshLoop();
      startPolling();
      handlePopupRouteActions();
    })();

  </script>
</body>
</html>
